<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messaging</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    
    <!-- Bootstrap CSS -->
    <script src="https://reelcareer.co/public/js/scripts.js"></script>
    <script src="https://reelcareer.co/public/js/loadScripts.js"></script>

       
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">

    <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
  />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="https://reelcareer.co/public/css/styles.css">
    <style>
        /* Custom styles */

        

#main-content  .container {
    margin-top: 20px;
    background-color: #fff;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

#main-content .row {
    display: flex;
}

/* Contacts List */
#main-content .list-group {
    max-height: 400px;
    overflow-y: auto;
    padding: 10px;
    border-radius: 8px;
    background-color: #f9f9f9;
    border: 1px solid #e0e0e0;
}

#main-content .list-group-item {
    display: flex;
    align-items: center;
    padding: 10px;
    margin-bottom: 5px;
    background-color: #fff;
    border: 1px solid #ddd;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

#main-content .list-group-item:hover {
    background-color: #f0f8ff;
}

#main-content .avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin-right: 10px;
}

/* Messaging Area */
#main-content #messageBox {
    max-height: 400px;
    overflow-y: auto;
    padding: 15px;
    border: 1px solid #ddd;
    border-radius: 8px;
    background-color: #f9f9f9;
    min-height: 300px;
    margin-bottom: .5rem;
    display: grid;
    align-content: stretch;
    align-items: end;
    justify-items: stretch;
}

#main-content .message {
    margin-bottom: 15px;
    padding: 10px;
    border-radius: 8px;
    max-width: 60%;
    word-wrap: break-word;
    position: relative;
}

#main-content .message.sent {
    background-color: #d1f7c4;
    align-self: flex-end;
    margin-left: auto;
}

#main-content .message.received {
    background-color: #f1f0f0;
    align-self: flex-start;
    margin-right: auto;
}

#main-content .media-attachment img,
#main-content .media-attachment video {
    max-width: 100%;
    border-radius: 8px;
    margin-top: 10px;
}

#main-content .timestamp {
    font-size: 0.8em;
    color: #888;
    margin-top: 5px;
}

#main-content .contact-info {
    margin-bottom: 10px;
    background-color: #f9f9f9;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #ddd;
}

/* Input Area */
#main-content .input-group {
    margin-top: 10px;
}

#main-content #messageInput {
    border-radius: 6px;
    border: 1px solid #ccc;
}

#main-content #sendMessageButton {
    background-color: #28a745;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 8px 16px;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

#main-content #sendMessageButton:hover {
    background-color: #218838;
}

#main-content .attachment-area {
    margin-top: 10px;
}

#main-content .attachment-area input {
    border: none;
    border-radius: 6px;
    padding: 5px;
    font-size: 14px;
}

main .row {
    display: flex;
    grid-column-gap: unset;
}



/* Initial style for the sliding panel */


.panel-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.close-btn {
  background-color: transparent;
  border: none;
  font-size: 20px;
  cursor: pointer;
}

.connections-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.connection-item {
    display: flex;
    align-items: stretch;
    border: 1px solid #ddd;
    padding: 20px;
    border-radius: 5px;
    background-color: #f9f9f9;
    width: 100%;
    flex-direction: row;
    flex-wrap: nowrap;
    align-content: space-around;
    gap: 2;
    justify-content: space-between;
}


.connection-item button {
  background-color: #4CAF50;
  color: white;
  border: none;
  padding: 5px 10px;
  cursor: pointer;
}

.connection-item button:hover {
  background-color: #45a049;
}


 
.preview-video,
.preview-image {

    width: 200px;  
}







#main-contact-panel {
    position: relative;
    margin-bottom: 1rem;
}

#main-message-panel {
    position: relative;
    min-height: 300px;
}

#closeSlidePanelBtn {
    color: color-mix(in lch longer hue, #45a049 45%, #f0f8ff 20%);
}
main {
    margin-bottom: 20px;
    overflow: hidden;
}


.slide-panel {
  position: relative;
  top: 0;
  right: -150%; /* Initially hidden */
  width: 100%;
  height: 100%;
  background-color: #fff;
  box-shadow: -2px 0 5px rgba(0, 0, 0, 0.2);
  transition: right 0.3s ease;
  z-index: 1000;
  padding: 20px;
  overflow-y: auto;
}

.slide-panel.open {
  right: 0; /* When open, it slides in */
}


.preview-container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 5px;
    border: 1px solid #ddd;
    border-radius: 5px;
    position: relative;
}

.preview-image, .preview-video {
    max-width: 100%;
    max-height: 150px;
}

.unsupported-file {
    padding: 10px;
    background: #f8f9fa;
    border-radius: 5px;
    font-size: 14px;
}

#messaging-area {

/* Conversation Title Styling */
.conversation-title {
  display: flex;
  align-items: center;
  gap: 10px; /* Spacing between avatar and name */
  padding: 10px;
  border-bottom: 1px solid #e0e0e0;
  background-color: #f9f9f9;
}

.conversation-title .profile-link {
  text-decoration: none;
}

.conversation-title .avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  object-fit: cover;
  box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1);
}

.conversation-title .sender-name {
  font-size: 1rem;
  font-weight: bold;
  color: #333;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 200px;
}

.conversation-title .sender-name:hover {
  color: #007bff;
  text-decoration: underline;
}

/* Contact Info Card */
.contact-info {
  padding: 15px;
  border: 1px solid #ddd;
  border-radius: 8px;
  box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1);
  background-color: #fff;
  margin-top: 10px;
}

.contact-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 8px;
}

.contact-name {
  font-weight: bold;
  color: #444;
}

.connection-status {
  font-size: 0.9rem;
  color: #666;
}

.connected-since {
  font-size: 0.85rem;
  color: #888;
  margin-top: 5px;
}

}



#controls-contactList-area {



/* General Message Styles */
.msg-list-i {
    display: flex;
    align-items: center;
    padding: 10px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    transition: background-color 0.2s;
}

.msg-list-i:hover {
    background-color: #f5f5f5;
}

/* Avatar Styling */
.avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin-right: 10px;
}

/* Message Info */
.message-info {
    display: flex;
    flex-direction: column;
    justify-content: center;
    flex-grow: 1;
}

.sender-name {
    font-weight: bold;
    color: #333;
}

.message-preview {
    font-size: 0.9rem;
    color: #555;
    margin-top: 3px;
}

.message-date {
    font-size: 0.85rem;
    color: #999;
    margin-top: 3px;
}

/* Unread Messages */
.unread-message {
    background-color: #87bcda;
}

.unread-message .sender-name {
    color: #007bff; /* Highlight sender name */
    font-weight: bold;
}

/* Support Messages */
.support-message {
    background-color: #858d92; /* Light yellow background */
}

.support-message .sender-name {
    color: #3dc3a8; /* Orange for Support */
}

}



#main-message-panel {

    .link-preview {
    border: 1px solid #ddd;
    margin: 10px 0;
    padding: 10px;
    border-radius: 8px;
    display: flex;
    background-color: #f9f9f9;
}

.preview-content {
    display: flex;
    gap: 10px;
    align-items: center;
}

.preview-image {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 5px;
}

.preview-text h4 {
    margin: 0;
    font-size: 16px;
}

.preview-text p {
    margin: 5px 0 0;
    color: #555;
    font-size: 14px;
}


}




#controls-contactList-area {
    position: relative;
    min-height: 500px;
    height: auto;
    width: 100% !important; 
}

#controls-contactList-area.open {
    display: block;
}
#controls-contactList-area.close {
 display: none;
}


#messaging-area {
    position: relative;
    min-height: 500px;
    height: auto;
    width: 100% !important;
}

#messaging-area.open {
    display: block;

}

#messaging-area.close {
    display: none;

}
.contactInfo {
    display: flex;
}


.flex {
    display: flex;
    flex-direction: row;
    flex-wrap: nowrap;
    justify-content: flex-start;
}

.max-w {
    width: max-content;
    display: block;
}




    </style>

</head>


<body>
    <script src="https://reelcareer.co/public/js/bodyload.js"></script>
    
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li id="lastBreadcrumb_home" class="breadcrumb-item"><a href="https://reelcareer.co/">Home</a></li>
            <li id="lastBreadcrumb_1" class="breadcrumb-item"><a id="lastBreadcrumb_1_a" href="https://reelcareer.co/u/">View Profile</a></li>


            <li id="breadcrumb-active-title" class="breadcrumb-item active" aria-current="page">Messaging</li>
        </ol>
      </nav>
  
  

      <main id="main-content">

          <div id='controls-contactList-area' class="open">
            <h3 class="header-text" >Connections</h3>
            <!-- Button to open the sliding panel -->
            <button id="openSlidePanelBtn" class="btn btn-primary" hidden>View Connections</button>
      
            <ul class="list-group" id="contactList">
              <!-- Contacts will be populated here -->
            </ul>
            <button class="btn btn-primary mt-2" id="composeButton" hidden>Compose Message</button>
          </div>






          <div id="messaging-area" class="close">
            <div class="panel-header">
                <h3 class="header-text" >Messaging</h3>
                <button id="closeSlidePanelBtn" class="close-btn">X</button>
              </div>
                <!-- Sliding Panel -->
                <div id="connectionsSlidePanel" class=" ">
             
                  <!-- >inside panel -->
      








                  <div id="main-contact-panel">
      
                    <div id="connectionsList" class="connections-list">
                      <!-- Connection items will be dynamically appended here -->
                    </div>
                  </div>
      






                </div>
      
            
      
                <!-- >panel end -->
          
          
      
          
          <div id="main-message-panel">
      
                    <h4 id="conversationTitle">Select a Conversation</h4>
                    <div class="contact-info" id="contactInfo" >
                      <!-- Contact info will be displayed here -->
                      <span>No Contact Available </span>
                    </div>
                    <div class="message-box" id="messageBox">
                      <!-- Messages will be displayed here -->
                       <small  style="text-align: center;">No Messages Available</small>
                    </div>
      
                    <div class="message-panel">
                        <div class="message-input-area">
                        
                          <div id="editableDiv" contenteditable="true" 
                          class="message-content-area" 
                          data-placeholder="Type a message..."></div>

                      <!-- Attachment Preview -->

                        <div id="attachmentPreview" class="attachment-area mt-2 d-none">
                          <div class="preview-container">
                            <img id="unsupportedFile" class="preview-image" src="" alt="Attachment Preview">
                            <img id="attachmentImage" class="preview-image" src="" alt="Attachment Preview">
                            <video id="attachmentVideo" class="preview-video" controls src=""></video>
                          </div>
                          <span id="removePreview" class="remove-attachment">&times;</span>

                        </div>
                      </div>

                        </div>
     <!-- Attachment Button -->
     <div class="attachment-container">
        <button class="btn btn-outline-primary" id="chooseFileButton"><i class="fas fa-paperclip"></i>Choose File</button>
        

      <!-- Send Button -->
      <div class="mt-3">
        <button class="btn btn-primary mt-3" id="sendMessageButton">Send</button>
      </div>


                      </div>
             
                    </div>
      <!-- end msg -->




                  </div>
                  
                  <input type="file" id="attachmentInput" class="d-none">
                  <textarea class="form-control" id="messageInput" placeholder="Type a message..."
                  rows="3" style="display:none;"></textarea>





      
                </main>
          
          
  
    <!-- >Footer -->
    <footer id="dynamic-footer"></footer>
    
    <!-- Firebase configuration/ Login& Out -->
    <script type="module" src="https://reelcareer.co/public/js/main.js"></script> 



    <script >


function showUserDataNotFoundMessage() {

    const lastBreadcrumb_1_a = document.getElementById("lastBreadcrumb_1_a");

    

lastBreadcrumb_1_a.style.display = "block";
lastBreadcrumb_1_a.innerText = "Create a Profile";
lastBreadcrumb_1_a.href = `https://reelcareer.co/views/auth`;

let mainContainer = document.getElementById('main-content');


  mainContainer.innerHTML = '';

    // Create a container div
    const container = document.createElement('div');
    container.className = 'user-data-not-found-container';
    container.style.cssText = `
        display: flex; 
        justify-content: center; 
        align-items: center; 
        height: 100vh; 
    `;
    container.style.transform = 'none';
    container.style.transition = 'none';
    container.style.opacity = '1';
    container.style.display = 'block';

    // Create the card div
    const card = document.createElement('div');
    card.className = 'user-data-not-found-card';
    card.style.cssText = `
        background-color: white; 
        padding: 20px; 
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); 
        border-radius: 8px; 
        text-align: center;
    `;

    // Add a title to the card
    const title = document.createElement('h3');
    title.textContent = 'User Not Found Create A Profile';
    title.style.marginBottom = '15px';
    card.appendChild(title);

    // Add a message inside the card
    const message = document.createElement('p');
    message.textContent = 'The requested user could not be found.';
    message.style.marginBottom = '20px';
    card.appendChild(message);

    // Create a "Go Back" button
    const goBackButton = document.createElement('button');
    goBackButton.textContent = 'Go Back';
    goBackButton.className = 'btn btn-primary m-1'; // Assuming Bootstrap classes, if used
    goBackButton.style.padding = '10px 20px';
    
    // Add an event listener to navigate back
    goBackButton.addEventListener('click', () => {
        window.history.back(); // This takes the user to the previous page
    });

    card.appendChild(goBackButton);

    // Create a "Login" button
    const loginButton = document.createElement('button');
    loginButton.textContent = 'Go to Login Page';
    loginButton.className = 'btn btn-primary m-1'; // Assuming Bootstrap classes, if used
    loginButton.style.padding = '10px 20px';

    // Add an event listener to redirect to the login page
    loginButton.addEventListener('click', () => {
        window.location.href = 'https://reelcareer.co/views/auth'; // Change '/login' to your actual login page URL
    });

    card.appendChild(loginButton);

    // Append the card to the container
    container.appendChild(card);

    // Append the container to the body (or a specific element on your page)
    mainContainer.appendChild(container);
}

window.showUserDataNotFoundMessage = showUserDataNotFoundMessage;
    </script>
  <!-- Firebase JS SDK and Custom Scripts -->

<script type="module">
    import {
        db, getStorage, ref, uploadBytes, getDownloadURL, limit,
  doc, arrayUnion, RecaptchaVerifier, increment, getDoc, arrayRemove, signInWithPhoneNumber,
  query, updateDoc, setDoc, addDoc, signInAnonymously, orderBy, onAuthStateChanged,
  uploadBytesResumable, signInWithPopup, FacebookAuthProvider, GoogleAuthProvider, startAfter,
  OAuthProvider, signOut, deleteDoc, getFirestore, serverTimestamp,
  createUserWithEmailAndPassword, signInWithEmailAndPassword, deleteObject,
  where, getDocs, storage, getAuth, collection, auth, analytics,
  googleProvider,onSnapshot ,
  facebookProvider,
  getUserId // Export the function
    } from 'https://reelcareer.co/js/module.js';

    
    let userId;
    document.addEventListener('DOMContentLoaded', async () => {
    try {
        userId = await getUserId(); // Await here to properly set userId
        console.log("User ID fetched during DOMContentLoaded:", userId);


        if (!userId || userId.trim() === "") {


            showUserDataNotFoundMessage();
            
            return;

        } else {
            loadContacts(userId); // Load contacts if user is authenticated

        }
    } catch (error) {
        showUserDataNotFoundMessage();

        console.error("Error fetching user ID:", error);
        return;

    }
});
const userDataSaved = getUserData() || [];

const lastBreadcrumb_1_a = document.getElementById("lastBreadcrumb_1_a");
lastBreadcrumb_1_a.innerText = userDataSaved.displayName;



    console.log("userDataSaved: ", userDataSaved);




// Elements
const controlsContactListArea = document.getElementById('controls-contactList-area');
const messagingArea = document.getElementById('messaging-area');

const openSlidePanelBtn = document.getElementById('openSlidePanelBtn');
const closeSlidePanelBtn = document.getElementById('closeSlidePanelBtn');

const connectionsList = document.getElementById('connectionsList');

// Fetching Connections from the database (assuming you are using Firebase)
async function fetchConnections() {
  try {
    // Assuming `connections` collection is stored in Firebase Firestore


let connectionssRef = collection(db, 'Connections');
const querySnapshot = query(connectionssRef, where('participants', 'array-contains-any', userDataSaved.userID));

    querySnapshot.forEach(doc => {
      const connectionData = doc.data();
      if (connectionData.status == 'pending' || connectionData.status == 'accepted') { // Only show pending connections
        appendConnection(connectionData, 'contact');
      }
    });
  } catch (error) {
    console.error('Error fetching connections:', error);
  }
}

// Appending a single connection to the list
function appendConnection(connection, type) {


    //console.log(`contact?  ${type} `);


    let connectionId = '';

    if(type == "contect"){

if(connection.from == userId){
    connectionId = connection.to ; // Use a unique identifier (from sender or receiver ID)

}else if(connection.to == userId){
    connectionId = connection.from ; // Use a unique identifier (from sender or receiver ID)

}
    }else{

if(connection.recipientID == userId){
    connectionId = connection.senderID ; // Use a unique identifier (from sender or receiver ID)

}else if(connection.senderID == userId){
    connectionId = connection.recipientID ; // Use a unique identifier (from sender or receiver ID)

}
    }



document.getElementById("connectionsList").innerHTML = '';




const existingConnection = document.querySelector(`[data-connection-id="${connectionId}"]`);
const existingMessager = document.querySelector(`[data-message-id="${connectionId}"]`);
const openEvent = new CustomEvent("click", { detail: "open" });

    // Check if the connection is already in the list
    if (existingConnection) {
        console.log(`Connection with ID ${connectionId} already exists.`);
        openSlidePanelBtn.dispatchEvent(openEvent);

        return; // Exit if the connection already exists
    }

    if (existingMessager) {
        console.log(`Messager with ID ${connectionId} already exists.`);
          openSlidePanelBtn.dispatchEvent(openEvent);
        return; // Exit if the connection already exists
    }

    // Create a new connection item
    const div = document.createElement('div');
    div.classList.add('connection-item');
   // ${userDataSaved.userID}_${data.from}
   const contactInfo = document.getElementById('contactInfo');


    if (type === "message") {


        if (connection.senderID === userDataSaved.userID) {
            const connectionInfo = `
        <div>
          <img src="${connection.recipientProfilePicture}" alt="Profile" 
 class="avatar lazy-image" width="40" height="40">
            <a  class="max-w" href="${connection.recipientProfileURL}" target="_blank">${connection.recipientName}</a>
        </div>
                    <button onclick="viewProfile('${connection.recipientID}')">View Profile</button>

        `;
        div.innerHTML = connectionInfo;

        div.setAttribute('data-message-id', connectionId); 
    }else   if (connection.recipientID === userDataSaved.userID){
   

        const connectionInfo = `
        <div>
          <img src="${connection.senderProfilePicture}" alt="Profile" 
 class="avatar lazy-image" width="40" height="40">
           <a  class="max-w" href="${connection.senderProfileURL}" target="_blank">${connection.senderName}</a>
        </div>
                    <button onclick="viewProfile('${connection.senderID}')">View Profile</button>
        `;
        div.innerHTML = connectionInfo;


  
        div.setAttribute('data-message-id', connectionId); 
    }
  //return;

    } else {

        const noteDiv = document.createElement('div');
        noteDiv.classList.add('connection-note');

        if (connection.status === "pending") {
            if (connection.from === userDataSaved.userID) {
                const connectionInfo = `
<div class="flex">
                  <img src="${connection.toProfilePicture}" alt="Profile" 
 class="avatar lazy-image" width="40" height="40">
                  <a  class="max-w" href="${connection.toProfileURL}" target="_blank">${connection.toName}</a>
                </div>
                  <button onclick="removeConnection('${connection.from}', '${connection.to}')">Remove</button>

                `;
                div.innerHTML = connectionInfo;
                noteDiv.innerHTML = connection.fromNote;
                div.appendChild(noteDiv);

                div.setAttribute('data-connection-id', connectionId); 
                composeMessages(connection.from, connection, "contact",connection.from );

            } else if (connection.to === userDataSaved.userID) {
                const connectionInfo = `
<div class="flex">
                  <img src="${connection.fromProfilePicture}" alt="Profile" 
 class="avatar lazy-image" width="40" height="40">
                 <a  class="max-w"  href="${connection.fromProfileURL}" target="_blank">${connection.fromName}</a>
                </div>
                <button onclick="removeConnection('${connection.from}', '${connection.to}')">Remove</button>
                <button onclick="acceptConnection('${connection.to}', '${connection.from}')">Accept</button>

                `;
                div.innerHTML = connectionInfo;

                div.setAttribute('data-connection-id', connectionId); 
                composeMessages(connection.to, connection, "contact",connection.to );

            }
   

          /*  
 const contactInfoDiv = document.createElement('div');
 contactInfoDiv.classList.add('connection-item');
 const contactInfo = `
                ${connection}
                `;
                contactInfoDiv.innerHTML = contactInfo;
*/
        } else   if (connection.status === "accepted") {


            console.log("userDataSaved.userID: ", userDataSaved.userID);
            console.log("connection.from: ", connection.from);
            console.log("connection.to: ", connection.to);

            if (connection.from == userDataSaved.userID) {
             
                const connectionInfo = `
<div class="flex">
                  <img src="${connection.toProfilePicture}" alt="Profile" 
 class="avatar lazy-image" width="40" height="40">
                  <a  class="max-w"  href="${connection.toProfileURL}" target="_blank">${connection.toName}</a>
                </div>
            <button onclick="viewProfile('${connection.to}')">from View Profile</button>
                `;
                div.innerHTML = connectionInfo;

                contactInfo.innerText = '';
    contactInfo.appendChild(div);




                div.setAttribute('data-connection-id', connectionId); 
            composeMessages(connection.from, connection, "contact",connection.from );

            } else if (connection.to == userDataSaved.userID) {

                const connectionInfo = `
<div class="flex">
              <img src="${connection.fromProfilePicture}" alt="Profile" 
 class="avatar lazy-image" width="40" height="40">
              <a  class="max-w" href="${connection.fromProfileURL}" target="_blank">${connection.fromName}</a>
            </div>
            <button onclick="viewProfile('${connection.from}')">to View Profile</button>
            `;
            div.innerHTML = connectionInfo;

            contactInfo.innerText = '';
    contactInfo.appendChild(div);


           
            div.setAttribute('data-connection-id', connectionId); 
                composeMessages(connection.to, connection, "contact",connection.to );
            }

        
            

            
        }

        
        
    }
    contactInfo.innerText = '';
    contactInfo.appendChild(div);


    openSlidePanelBtn.dispatchEvent(openEvent);

}




let messageSenderID;


// Asynchronous changeGroup function
async function changeGroup(contactId, newGroup, Group, name) { 
  try {
    // Reference to the document in the "Connections" collection
    const connectionRef = doc(db, "Connections", contactId);

    // Dynamically update the field specified by 'Group'
    await updateDoc(connectionRef, { [Group]: newGroup });

    showToast(`Updated ${name} to "${newGroup}" `);
  } catch (error) {
    console.error("Error updating group:", error);
  }
}

// Set the changeGroup function globally
window.changeGroup = changeGroup;



document.getElementById("editableDiv").addEventListener("keydown", (event) => {
  // Check if Enter key is pressed
  if (event.key === "Enter") {
    event.preventDefault(); // Prevent default Enter behavior (e.g., line break)
    const sendMessageButton = document.getElementById("sendMessageButton");

    // Focus on the Send Message button
    sendMessageButton.focus();

    // Optionally, trigger a click if you want to send the message immediately
    // sendMessageButton.click();
  }
});

function viewProfile(userId){
    if (userId) {
      window.location.href = `https://reelcareer.co/u/?u=${userId}`;
    }
}

window.viewProfile = viewProfile;











function composeMessages(conversationID, data, type, conversationRecipientID ) { 

const messageBox = document.getElementById('messageBox');
const conversationTitle = document.getElementById('conversationTitle');

console.log(`composeMessages  ${type} .  `);
/*
console.log(`composeMessages ???????????????????????????????????????????????????????????????????
????????????????????????????????????????????????????????????????????????  `);

console.log("type: ", type);
console.log("userDataSaved.userID: ", userDataSaved.userID);
console.log("userDataSaved.displayName: ", userDataSaved.displayName);
*/
if(type === "contact"){
    /*
console.log("data: ", data);
console.log("data.toName: ", data.toName);
console.log("data.fromName: ", data.fromName);
*/
if(userDataSaved.userID == data.from ){

console.log("YOU ARE THE SENDER CONTACT  ????????????????????????  ");
conversationTitle.setAttribute("data-conversation-recipientID",data.to);
conversationTitle.setAttribute("data-conversation-name",data.toName);
conversationTitle.setAttribute("data-conversation-picture",data.toProfilePicture);

} else if(userDataSaved.userID == data.to ){
console.log("YOU ARE THE RECIPIRNT CONTACT   ????????????????????????  ");
conversationTitle.setAttribute("data-conversation-recipientID",data.from);
conversationTitle.setAttribute("data-conversation-name",data.fromName);
conversationTitle.setAttribute("data-conversation-picture",data.fromProfilePicture);

}
 console.log("composeMessages MESSAGE   ????????????????????????  ");
 console.log("CONTACT DATA: ", data);
}


if(type === "message"){

// console.log("data.recipientName: ", data.recipientName);
// console.log("data.senderName: ", data.senderName);
if(userDataSaved.userID == data.recipientID ){

//console.log("YOU ARE THE SENDER MESSAGE  ????????????????????????  ");
conversationTitle.setAttribute("data-conversation-recipientID",data.senderID);
conversationTitle.setAttribute("data-conversation-name",data.senderName);
conversationTitle.setAttribute("data-conversation-picture",data.senderProfilePicture);

} else if(userDataSaved.userID == data.senderID ){
console.log("YOU ARE THE RECIPIRNT MESSAGE   ????????????????????????  ");
conversationTitle.setAttribute("data-conversation-recipientID",data.recipientID);
conversationTitle.setAttribute("data-conversation-name",data.recipientName);
conversationTitle.setAttribute("data-conversation-picture",data.recipientProfilePicture);
}

//  console.log("MESSAGE DATA: ", data);

}


const recipientName = document.getElementById('conversationTitle')?.getAttribute('data-conversation-name');
const recipientID = document.getElementById('conversationTitle')?.getAttribute('data-conversation-recipientID');

/* 
console.log("recipientName: ", recipientName);
console.log("recipientID: ", recipientID);

console.log(`END  composeMessages ???????????????????????? 
???????????????????????????????????///????????????????????????????????????/ `);


*
const selectInput = document.createElement('div');
selectInput.id = `groupSelect${userDataSaved.userID}`;
selectInput.classList.add('groupSelect');

groupDiv.appendChild(selectInput);
*/
const acceptDate = formatTimestamp(data.acceptDate);

if(type === "contact"){


if (data.to === userDataSaved.userID) {
messageSenderID = data.from;


conversationTitle.setAttribute("data-conversation-id",`${userDataSaved.userID}_${data.from}`);

conversationTitle.innerHTML = `
<div class="flex">
<a href="https://reelcareer.co/u/?u=${data.from}" style="text-decoration: none; color: inherit;">
<img src="${data.fromProfilePicture || 'https://reelcareer.co/images/sq_logo_n_BG_sm.png'}" alt="Avatar" class="avatar lazy-image">
</a>
<span>${data.fromName || 'Unknown Sender'}</span>
</div>
<div class="flex">
<small>
    ${data.status === "accepted" 
        ? '<i class="fas fa-check-circle" style="color: green;"></i> Connected' 
        : '<i class="fas fa-times-circle" style="color: red;"></i> Not Connected'}
</small>

        
</div>
    ${data.status === "accepted"  ? `<p>Connected Since: <small>${acceptDate}</small></p>` : ''}
        `;


// Create the select input element
// Create the select input
const selectInput = document.createElement('select');
selectInput.id = `groupSelect${userDataSaved.userID}`;
selectInput.classList.add('groupSelect');
selectInput.onchange = function () {
        const selectedOption = this.options[this.selectedIndex];
        if (selectedOption.classList.contains('optionBlock')) {
            selectedOption.classList.add('optionBlocked');  // Add 'optionBlocked' when blocked
        }
    
changeGroup(`${userDataSaved.userID}_${data.from}`, selectedOption.value, "fromGroup", `${data.toName}`);
};

// Example groups (single user)
const groups = [
{ groupName: "Co-workers" },
{ groupName: "Recruiters" },
{ groupName: "Networking" },
{ groupName: "Friends" },
{ groupName: "Blocked", class: "optionBlock" } // Example with a custom class
];

// Populate the select input with options
groups.forEach(group => {
const option = document.createElement('option');
option.value = group.groupName; // The group name will be the value
option.textContent = `Contact: (${group.groupName})`; // Display the group name

// Assign a class if provided in the group object
if (group.class) {
    option.classList.add(group.class);
}

selectInput.appendChild(option);
});

// Set the value of the select element
const targetValue = data.fromGroup; // Value to set, e.g., "Recruiters"
if (groups.some(group => group.groupName === targetValue)) {
selectInput.value = targetValue; // Programmatically set the value
} else {
console.warn(`Value "${targetValue}" not found in options. Falling back to default.`);
selectInput.value = groups[0].groupName; // Fallback to the first option
}

// Apply the class for the initially selected option
updateSelectClass(selectInput, selectInput.options[selectInput.selectedIndex]);


const groupDiv = document.createElement('div');
groupDiv.classList.add('connection-group');
groupDiv.appendChild(selectInput);

// Assuming conversationTitle is defined elsewhere
conversationTitle.appendChild(groupDiv);






} else if (data.from === userDataSaved.userID) {
messageSenderID = data.to;

conversationTitle.setAttribute("data-conversation-id",`${userDataSaved.userID}_${data.to}`);

conversationTitle.innerHTML = `
<div class="flex">
<a href="https://reelcareer.co/u/?u=${data.to}" style="text-decoration: none; color: inherit;">
<img src="${data.toProfilePicture || 'https://reelcareer.co/images/sq_logo_n_BG_sm.png'}" alt="Avatar" class="avatar lazy-image">
</a>
<span>${data.toName || 'Unknown Sender'}</span>
</div>
<div class="flex">

<small>
    ${data.status === "accepted" 
        ? '<i class="fas fa-check-circle" style="color: green;"></i> Connected' 
        : '<i class="fas fa-times-circle" style="color: red;"></i> Not Connected'}
</small>

        
</div>
    ${data.status === "accepted"   ? `<p>Connected Since: <small>${acceptDate}</small></p>` : ''}
        `;



// Create the select input element
// Create the select input
const selectInput = document.createElement('select');
selectInput.id = `groupSelect${userDataSaved.userID}`;
selectInput.classList.add('groupSelect');
selectInput.onchange = function () {
        const selectedOption = this.options[this.selectedIndex];
        if (selectedOption.classList.contains('optionBlock')) {
            selectedOption.classList.add('optionBlocked');  // Add 'optionBlocked' when blocked
        }
    
changeGroup(`${data.to}_${userDataSaved.userID}`, selectedOption.value, "toGroup", `${data.toName}`);
};

// Example groups (single user)
const groups = [
{ groupName: "Co-workers" },
{ groupName: "Recruiters" },
{ groupName: "Networking" },
{ groupName: "Friends" },
{ groupName: "Blocked", class: "optionBlock" } // Example with a custom class
];

// Populate the select input with options
groups.forEach(group => {
const option = document.createElement('option');
option.value = group.groupName; // The group name will be the value
option.textContent = `Contact: (${group.groupName})`; // Display the group name

// Assign a class if provided in the group object
if (group.class) {
    option.classList.add(group.class);
}

selectInput.appendChild(option);
});

// Set the value of the select element
const targetValue = data.toGroup; // Value to set, e.g., "Recruiters"
if (groups.some(group => group.groupName === targetValue)) {
selectInput.value = targetValue; // Programmatically set the value

} else {
console.warn(`Value "${targetValue}" not found in options. Falling back to default.`);
selectInput.value = groups[0].groupName; // Fallback to the first option
}

// Apply the class for the initially selected option
updateSelectClass(selectInput, selectInput.options[selectInput.selectedIndex]);


const groupDiv = document.createElement('div');
groupDiv.classList.add('connection-group');
groupDiv.appendChild(selectInput);

// Assuming conversationTitle is defined elsewhere
conversationTitle.appendChild(groupDiv);

} 

}

if (type === "message") {
// message

/*
console.log("data: ", data);
console.log("recipientID: ", data.recipientID);
console.log("message ");
console.log("conversationID: ", conversationID);
console.log("data.to: ", data.from);
console.log("data.from === userDataSaved.userID: ");
console.log("data.to: ", data.toName);
*/
//console.log("MESSAGE !!!!!!!!!!!!!!!!!!!!!!1: ");

if (data.recipientID === userDataSaved.userID) {
    messageSenderID = data.senderID;
    conversationTitle.setAttribute("data-conversation-id",`${userDataSaved.userID}_${data.senderID}`);

conversationTitle.innerHTML = `
<div class="flex">
<a href="${data.senderProfileURL}" style="text-decoration: none; color: inherit;">
<img src="${data.senderProfilePicture || 'https://reelcareer.co/images/sq_logo_n_BG_sm.png'}" alt="Avatar" class="avatar lazy-image">
</a>
<span>${data.senderName || 'Unknown Sender'}</span>

</div>
<div class="flex">
<small>
    ${data.connectedBool == true 
        ? '<i class="fas fa-check-circle" style="color: green;"></i> Connected' 
        : '<i class="fas fa-times-circle" style="color: red;"></i> Not Connected'}
</small>

</div>
    ${data.connectedBool == true ? `<p>Connected Since: <small>${acceptDate}</small></p>` : ''}
        `;

// Create the select input element
// Create the select input
const selectInput = document.createElement('select');
selectInput.id = `groupSelect${userDataSaved.userID}`;
selectInput.classList.add('groupSelect');
selectInput.onchange = function () {
        const selectedOption = this.options[this.selectedIndex];
        if (selectedOption.classList.contains('optionBlock')) {
            selectedOption.classList.add('optionBlocked');  // Add 'optionBlocked' when blocked
        }

changeGroup(`${userDataSaved.userID}_${data.senderID}`, selectedOption.value, "recipientGroup", `${data.recipientName}`);
};

// Example groups (single user)
const groups = [
{ groupName: "Co-workers" },
{ groupName: "Recruiters" },
{ groupName: "Networking" },
{ groupName: "Friends" },
{ groupName: "Blocked", class: "optionBlock" } // Example with a custom class
];

// Populate the select input with options
groups.forEach(group => {
const option = document.createElement('option');
option.value = group.groupName; // The group name will be the value
option.textContent = `Messages: (${group.groupName})`; // Display the group name

// Assign a class if provided in the group object
if (group.class) {
    option.classList.add(group.class);
}

selectInput.appendChild(option);
});

// Set the value of the select element
const targetValue = data.fromGroup; // Value to set, e.g., "Recruiters"
if (groups.some(group => group.groupName === targetValue)) {
selectInput.value = targetValue; // Programmatically set the value
} else {
console.warn(`Value "${targetValue}" not found in options. Falling back to default.`);
selectInput.value = groups[0].groupName; // Fallback to the first option
}

// Apply the class for the initially selected option
updateSelectClass(selectInput, selectInput.options[selectInput.selectedIndex]);


const groupDiv = document.createElement('div');
groupDiv.classList.add('connection-group');
groupDiv.appendChild(selectInput);

// Assuming conversationTitle is defined elsewhere
//conversationTitle.appendChild(groupDiv);

}else 
if (data.senderID === userDataSaved.userID) {
    messageSenderID = data.recipientID;
    conversationTitle.setAttribute("data-conversation-id",`${userDataSaved.userID}_${data.senderID}`);

    conversationTitle.innerHTML = `
<div class="flex">
<a href="${data.recipientProfileURL}" style="text-decoration: none; color: inherit;">
<img src="${data.recipientProfilePicture || 'https://reelcareer.co/images/sq_logo_n_BG_sm.png'}" alt="Avatar" class="avatar lazy-image">
</a>
<span>${data.recipientName || 'Unknown Sender'}</span>
</div>
<div class="flex">
<small>
    ${data.connectedBool == true 
        ? '<i class="fas fa-check-circle" style="color: green;"></i> Connected' 
        : '<i class="fas fa-times-circle" style="color: red;"></i> Not Connected'}
</small>
    </div>
    ${data.connectedBool  == true ? `<p>Connected Since: <small>${acceptDate}</small></p>` : ''}
        `;

// Create the select input element
// Create the select input
const selectInput = document.createElement('select');
selectInput.id = `groupSelect${userDataSaved.userID}`;
selectInput.classList.add('groupSelect');
selectInput.onchange = function () {
        const selectedOption = this.options[this.selectedIndex];
        if (selectedOption.classList.contains('optionBlock')) {
            selectedOption.classList.add('optionBlocked');  // Add 'optionBlocked' when blocked
        }

changeGroup(`${data.recipientID}_${userDataSaved.userID}`, selectedOption.value, "senderGroup", `${data.senderName}`);
};

// Example groups (single user)
const groups = [
{ groupName: "Co-workers" },
{ groupName: "Recruiters" },
{ groupName: "Networking" },
{ groupName: "Friends" },
{ groupName: "Blocked", class: "optionBlock" } // Example with a custom class
];

// Populate the select input with options
groups.forEach(group => {
const option = document.createElement('option');
option.value = group.groupName; // The group name will be the value
option.textContent = `Messages: (${group.groupName})`; // Display the group name

// Assign a class if provided in the group object
if (group.class) {
    option.classList.add(group.class);
}

selectInput.appendChild(option);
});

// Set the value of the select element
const targetValue = data.fromGroup; // Value to set, e.g., "Recruiters"
if (groups.some(group => group.groupName === targetValue)) {
selectInput.value = targetValue; // Programmatically set the value
} else {
console.warn(`Value "${targetValue}" not found in options. Falling back to default.`);
selectInput.value = groups[0].groupName; // Fallback to the first option
}

// Apply the class for the initially selected option
updateSelectClass(selectInput, selectInput.options[selectInput.selectedIndex]);


const groupDiv = document.createElement('div');
groupDiv.classList.add('connection-group');
groupDiv.appendChild(selectInput);

// Assuming conversationTitle is defined elsewhere
//conversationTitle.appendChild(groupDiv);





}




}









loadMessages(data.participants, userDataSaved.userID, messageSenderID);

console.log("conversationID: ", conversationID);


//messageBox.innerHTML = '';

}

window.composeMessages  = composeMessages ;



/**
 * Updates the select element's class based on the selected option's class
 */
 function updateSelectClass(selectElement, selectedOption) {
    // Remove all classes from the select element except the base class
    const baseClass = 'groupSelect';
    selectElement.className = baseClass;

    // Add the selected option's class to the select element if it exists
    Array.from(selectedOption.classList).forEach(cls => {
        if (cls !== baseClass) {
            selectElement.classList.add(cls);
        }
    });
}

// Function to accept a connection
async function removeConnection(fromID, toID) {
  try {
    // Update the status of the connection to 'accepted'
/*
    const docId = userId < userIdFromURL 
      ? `${userId}_${userIdFromURL}`
      : `${userIdFromURL}_${userId}`;
    const connectionRef = doc(db, 'Connections', docId);
*/
    const connectionRef = doc(db, 'Connections', `${fromID}_${toID}`);
    await updateDoc(connectionRef, {
      status: 'denied'
    });
    
    showToast('Connection removed!');
    // Refresh the list of connections
    setTimeout(() => {

connectionsList.innerHTML = '';
fetchConnections();
}, 500); // 1 second delay

  } catch (error) {
    console.error('Error denied connection:', error);
    showToast('Failed to denied connection.');
  }
}
window.removeConnection  = removeConnection ;


// Function to accept a connection
async function acceptConnection(fromID, toID) {
  try {
    // Update the status of the connection to 'accepted'
    const connectionRef = doc(db, 'Connections', `${fromID}_${toID}`);
    await updateDoc(connectionRef, {
      status: 'accepted',
      acceptDate:  new Date(),
    });
    
    showToast('Connection accepted!');
    // Refresh the list of connections
    setTimeout(() => {

    connectionsList.innerHTML = '';
    fetchConnections();
}, 500); // 1 second delay


  } catch (error) {
    console.error('Error accepting connection:', error);
    showToast('Failed to accept connection.');
  }
}
window.acceptConnection  = acceptConnection ;



const breadcrumbActiveTitle = document.getElementById("breadcrumb-active-title");
openSlidePanelBtn.addEventListener('click', (e) => {

 //   console.log("event...: ", e);

    if (e.detail === "open") {
   console.log("Open action triggered.");
    
    

    }


// Open or close the sliding panel on button click
    // Check if the class 'open' is present in the connectionsSlidePanel
    if (!messagingArea.classList.contains('open') || e.detail === "open") {
        // If not open, open the sliding panel and modify the contact list area

        messagingArea.classList.replace('close', 'open');

        controlsContactListArea.classList.replace('open', 'close');

      
        document.title = `ReelCareer.co | ${userDataSaved.displayName} - Messaging`;

        // Set the new title
    } else {
        // If already open, toggle the classes
        messagingArea.classList.replace('open', 'close');
        controlsContactListArea.classList.replace('close', 'open');

      //  controlsContactListArea.classList.remove('open');
     //   controlsContactListArea.classList.add('close');




        // Set the new title
        document.title = `ReelCareer.co | ${userDataSaved.displayName} - Connections`;


    }

    // Toggle the text based on the panel state
    breadcrumbActiveTitle.innerText = messagingArea.classList.contains('open') ? "Messaging" : "Connections";
});


// Add an additional event listener to breadcrumbActiveTitle
breadcrumbActiveTitle.addEventListener('click', () => {
    // You can handle what happens when the breadcrumbActiveTitle is clicked here
    // For example, you could toggle the panel or perform any other action
    console.log('Breadcrumb clicked!');
    // If you want to trigger the openSlidePanelBtn's functionality again
    openSlidePanelBtn.click(); // This will trigger the same functionality as the button click
});


// Close the sliding panel
closeSlidePanelBtn.addEventListener('click', () => {
    messagingArea.classList.replace('open', 'close');
    controlsContactListArea.classList.replace('close', 'open');
    breadcrumbActiveTitle.innerText =  "Connections";
});








// Utility: Format Timestamp
function formatTimestamp(timestamp) {
  // Convert Firebase Timestamp to milliseconds
  const date = new Date(timestamp.seconds * 1000 + Math.floor(timestamp.nanoseconds / 1e6));

  // Format the date as MM/DD/YYYY
  return `${date.getMonth() + 1}/${date.getDate()}/${date.getFullYear()}`;
}


function loadContacts(userID) { 
    console.log("userID:", userID);

    const contactList = document.getElementById('contactList');
    contactList.innerHTML = '';  // Clear the existing content

    const createSection = (sectionTitle) => {
        const sectionDiv = document.createElement('div');
        sectionDiv.classList.add('contact-list');

        const titleDiv = document.createElement('div');
        titleDiv.classList.add('title');
        titleDiv.innerText = sectionTitle;

        sectionDiv.appendChild(titleDiv);
        return sectionDiv;
    };

    const messageSection = createSection('Messages');
contactList.appendChild(messageSection);

// Reference to messages collection
let contactsRef = collection(db, 'Messages');
let messagesQuery = query(contactsRef, where('participants', 'array-contains-any', [userID]));

// Audio notification
const newMessageAudio = new Audio('https://reelcareer.co/media/audio/ding.mp3'); // Replace with your audio file

// Local storage settings
const userDataSaved = getUserData() || [];

const showRead = userDataSaved.showRead === 'true'; // Show read status
const audioAlert = userDataSaved.audioAlert === 'true'; // Play audio alert



// Utility: Truncate message to 50 characters
function truncateMessage(message) {
    return message.length > 50 ? message.substring(0, 50) + '...' : message;
}

// Sorting function: unread first, then timestamp
function sortMessages(a, b) {
    if (a.status === 'unread' && b.status !== 'unread') return -1;
    if (a.status !== 'unread' && b.status === 'unread') return 1;
    return b.timestamp - a.timestamp; // Newest first
}

// Function to update read status
async function updateMessageRead(docID) {
    if (showRead) {
        const messageRef = doc(db, 'Messages', docID);
        await updateDoc(messageRef, { status: 'read' });
    }
}

// Real-time Snapshot Listener
onSnapshot(messagesQuery, (snapshot) => {
    const latestMessages = {}; // Store the most recent message per user

    snapshot.forEach((doc) => {
        const data = doc.data();
        const otherUserID = data.recipientID === userID ? data.senderID : data.recipientID;

        // Keep the most recent message for each user
        if (!latestMessages[otherUserID] || data.timestamp > latestMessages[otherUserID].timestamp) {
            latestMessages[otherUserID] = { ...data, id: doc.id };
        }
    });

    // Convert latestMessages object to an array and sort
    const allMessages = Object.values(latestMessages).sort(sortMessages);

    // Clear previous content
    messageSection.innerHTML = '';

    allMessages.forEach((data) => {
        const otherUserID = data.recipientID === userID ? data.senderID : data.recipientID;
        const recipientName = data.recipientID === userID ?  data.senderName: data.recipientName ;
        const profilePicture = data.recipientID === userID ? data.senderProfilePicture : data.recipientProfilePicture; // || 'https://reelcareer.co/images/sq_logo_n_BG_tie_reel.png';
        const truncatedMessage = truncateMessage(data.content || '');
        const formattedDate = formatTimestamp(data.timestamp);

        
        // Create list item
        const messagesListItem = document.createElement('li');
        messagesListItem.className = 'list-group-item msg-list-i';
        messagesListItem.setAttribute("data-conversation-id", otherUserID);

        // Add unread class and play audio for unread messages
        if (data.status === 'unread') {
            messagesListItem.classList.add('unread-message');
            if (audioAlert) {
                newMessageAudio.play();
            }
        }

        // Special class for Support messages
        if (data.senderID === '000000' || data.senderName === 'Support') {
            messagesListItem.classList.add('support-message');
        }


/*

        const titleCoWorkers = document.createElement('div');
        titleBlocked.classList.add('Group-title');
        titleBlocked.innerHTML = "<small>Blocked</small>";
        messageSection.appendChild(titleBlocked);



        const titleRecruiters = document.createElement('div');
        titleBlocked.classList.add('Group-title');
        titleBlocked.innerHTML = "<small>Blocked</small>";
        messageSection.appendChild(titleBlocked);



        const titleNetworking = document.createElement('div');
        titleBlocked.classList.add('Group-title');
        titleBlocked.innerHTML = "<small>Blocked</small>";
        messageSection.appendChild(titleBlocked);



        const titleFriends = document.createElement('div');
        titleBlocked.classList.add('Group-title');
        titleBlocked.innerHTML = "<small>Blocked</small>";
        messageSection.appendChild(titleBlocked);


        const titleBlocked = document.createElement('div');
        titleBlocked.classList.add('Group-title');
        titleBlocked.innerHTML = "<small>Blocked</small>";
        messageSection.appendChild(titleBlocked);
*/




        // Construct HTML
        messagesListItem.innerHTML = `
            <a href="https://reelcareer.co/u/?u=${otherUserID}" style="text-decoration: none; color: inherit;">
                <img src="${profilePicture}" alt="Avatar" class="avatar lazy-image">
            </a>
            <div class="message-info">
                <span class="sender-name">${recipientName}</span>
                <span class="message-preview">${truncatedMessage}</span>
                <small class="message-date">${formattedDate}</small>
            </div>
        `;

        // On-click handler
        messagesListItem.onclick = () => {
            appendConnection(data, 'message');
            composeMessages(data.participants, data, "message", otherUserID);

            // Update read status if enabled
            if (data.status === 'unread') {
                updateMessageRead(data.id);
            }
        };
  
        
        messageSection.appendChild(messagesListItem);
    });
});





    const connectionsSection = createSection('Connections');
    contactList.appendChild(connectionsSection);

    const titlePending = document.createElement('div');
    titlePending.classList.add('Pending-title');
    titlePending.innerHTML = "<small>Pending</small>";
    connectionsSection.appendChild(titlePending);

    const titleSent = document.createElement('div');
    titleSent.classList.add('Sent-title');
    titleSent.innerHTML = "<small>Sent</small>";
    connectionsSection.appendChild(titleSent);

    const titleAccepted = document.createElement('div');
    titleAccepted.classList.add('Connected-title');
    titleAccepted.innerHTML = "<small>Connected</small>";
    connectionsSection.appendChild(titleAccepted);




    const connectionsRef = collection(db, 'Connections');
    const connectionsQuery = query(connectionsRef, where('participants', 'array-contains', userID));

    // Map to track displayed connections
    const displayedConnections = new Set();

    onSnapshot(connectionsQuery, snapshotConnections => {
        snapshotConnections.forEach(doc => {
            const docID = doc.id;
            if (displayedConnections.has(docID)) return; // Skip if already displayed

            displayedConnections.add(docID); // Mark as displayed
            const data = doc.data();
            const listItem = document.createElement('li');
            listItem.className = 'list-group-item conn-list-i';

            if ((data.status === "pending" || data.status === "accepted") && data.from === userID) {
    // Case where the user is the sender
    listItem.innerHTML = `
        <a href="${data.toProfileURL}" style="text-decoration: none;color: inherit;">
            <img src="${data.toProfilePicture || 'https://reelcareer.co/images/sq_logo_n_BG_tie_reel.png'}" alt="Avatar" class="avatar lazy-image">
        </a>
        <span>${data.toName}</span>
    `;
} else if ((data.status === "pending" || data.status === "accepted") && data.to === userID) {
    // Case where the user is the recipient
    listItem.innerHTML = `
        <a href="${data.fromProfileURL}" style="text-decoration: none;color: inherit;">
            <img src="${data.fromProfilePicture || 'https://reelcareer.co/images/sq_logo_n_BG_tie_reel.png'}" alt="Avatar" class="avatar lazy-image">
        </a>
        <span>${data.fromName}</span>
    `;
} else if ((data.status === "pending" || data.status === "accepted") && data.from !== userID) {
    // Case where the user is neither the sender nor the recipient
    listItem.innerHTML = `
        <a href="${data.fromProfileURL}" style="text-decoration: none;color: inherit;">
            <img src="${data.fromProfilePicture || 'https://reelcareer.co/images/sq_logo_n_BG_tie_reel.png'}" alt="Avatar" class="avatar lazy-image">
        </a>
        <span>${data.fromName}</span>
    `;
}


            listItem.addEventListener('click', () => {
                document.getElementById("messageBox").innerHTML='';

             //   console.log(`appendConnectionSend  ${data} .  `);

    appendConnection(data, 'contact'); // Call your function to append connection
});

            if (data.status === "pending") {
                if (data.from === userID) {
                    titleSent.appendChild(listItem);
                } else {
                    titlePending.appendChild(listItem);
                }
            } else if (data.status === "accepted") {
                titleAccepted.appendChild(listItem);
            }
           // const openEvent = new CustomEvent("click", { detail: "open" });
          //  openSlidePanelBtn.dispatchEvent(openEvent);
        });
    });
}
function loadMessages(participants, recipientID, senderID) {
    console.log("Loading Messages...");
    console.log("Participants: ", participants);

    const messageBox = document.getElementById('messageBox');
    const messagesRef = collection(db, 'Messages');

    // Query messages where both recipient and sender are part of the conversation
    const q = query(messagesRef, where('participants', 'array-contains', recipientID), orderBy('createdAt'));

    onSnapshot(q, snapshot => {
        messageBox.innerHTML = ''; // Clear previous messages

        snapshot.docs.forEach(doc => {
            const data = doc.data();

            // Check if the sender is either the recipient or the sender
            if (data.participants.includes(senderID)) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${data.senderID === auth.currentUser.uid ? 'sent' : 'received'}`;
                messageDiv.textContent = data.content;
                convertTextToLinks(messageDiv);


                // Add media content if present
                if (data.contentType !== 'text') {
                    const mediaDiv = document.createElement('div');
                    mediaDiv.className = 'media-attachment';

                    switch (data.contentType) {
                        case 'image':
                            const img = document.createElement('img');
                            img.src = data.attachmentUrl;
                            img.alt = 'Image Attachment';
                            img.className = 'lazy-image';

                            mediaDiv.appendChild(img);
                            break;
                        case 'video':
                            const video = document.createElement('video');
                            video.src = data.attachmentUrl;
                            video.controls = true;
                            mediaDiv.appendChild(video);
                            break;
                        case 'audio':
                            const audio = document.createElement('audio');
                            audio.src = data.attachmentUrl;
                            audio.controls = true;
                            mediaDiv.appendChild(audio);
                            break;
                        case 'document':
                        case 'office-document':
                            const docLink = document.createElement('a');
                            docLink.href = data.attachmentUrl;
                            docLink.target = '_blank';
                            docLink.textContent = 'View Document';
                            mediaDiv.appendChild(docLink);
                            break;
                        case 'archive':
                            const archiveLink = document.createElement('a');
                            archiveLink.href = data.attachmentUrl;
                            archiveLink.target = '_blank';
                            archiveLink.textContent = 'Download Archive';
                            mediaDiv.appendChild(archiveLink);
                            break;
                        default:
                            const unsupportedMessage = document.createElement('p');
                            unsupportedMessage.textContent = 'Unsupported content type.';
                            mediaDiv.appendChild(unsupportedMessage);
                            break;
                    }
                    messageDiv.appendChild(mediaDiv);
                }



                // Add timestamp
                const timestampDiv = document.createElement('div');
                timestampDiv.className = 'timestamp';
            //    timestampDiv.textContent = new Date(data.createdAt.seconds * 1000).toLocaleString();

// Convert Firebase timestamp to a JS Date object
const createdAtDate = new Date(data.createdAt.seconds * 1000);

// Call the timeAgo function to format the date
timestampDiv.textContent = timeAgo(createdAtDate);






                messageDiv.appendChild(timestampDiv);

                messageBox.appendChild(messageDiv);
            }
        });

        messageBox.scrollTop = messageBox.scrollHeight; // Auto-scroll to the bottom
    }, error => {
        console.error("Error fetching messages:", error.message);
        showToast("Unable to load messages. Please try again.", 'error');
    });
}

async function convertTextToLinks(contentDiv) {
    const urlRegex = /(https?:\/\/[^\s]+|www\.[^\s]+)/g; // Regex to match URLs

    // Helper function to fetch metadata for a URL
    async function fetchMetadataFromProxy(url) {
    try {
        console.log("URL :  ", url);
        const response = await fetch(`/fetch-metadata?url=${encodeURIComponent(url)}`);
        
        // Log the response status and content type
        console.log("Response Status: ", response.status);
        console.log("Response Content-Type: ", response.headers.get("content-type"));
        
        // Check if the response is JSON
        const contentType = response.headers.get("content-type");
        if (!contentType || !contentType.includes("application/json")) {
            throw new Error(`Invalid content type: ${contentType}`);
        }

        const metadata = await response.json();

        return {
            title: metadata.title || url,
            description: metadata.description || "",
            image: metadata.image || "",
            url: metadata.url || url,
        };
    } catch (error) {
        console.error("Error fetching metadata:", error.message);
        return { title: url, description: "", image: "", url };
    }
}

    // Process the text content of the contentDiv
    const text = contentDiv.textContent;
    let parts = text.split(urlRegex);

    const fragment = document.createDocumentFragment();

    for (let part of parts) {
        if (urlRegex.test(part)) {
            const url = part.startsWith("http") ? part : `http://${part}`;
            const metadata = await fetchMetadataFromProxy(url);

            // Create a container for the preview
            const previewDiv = document.createElement("div");
            previewDiv.className = "link-preview";

            previewDiv.innerHTML = `
                <a href="${metadata.url}" target="_blank" rel="noopener noreferrer">
                    <div class="preview-content">
                        ${metadata.image ? `<img src="${metadata.image}" alt="Link Image" class="preview-image">` : ""}
                        <div class="preview-text">
                            <p class="preview-title">${metadata.title}</p>
                            <p class="preview-description">${metadata.description}</p>
                        </div>
                    </div>
                </a>
            `;

            fragment.appendChild(previewDiv);
        } else {
            fragment.appendChild(document.createTextNode(part));
        }
    }

    // Replace the content of the div with the new HTML
    contentDiv.innerHTML = ""; // Clear the current content
    contentDiv.appendChild(fragment);
}

// Select the editableDiv
const editableDiv = document.getElementById("editableDiv");

// Debounce function to optimize event handling
function debounce(func, delay) {
    let timer;
    return function (...args) {
        clearTimeout(timer);
        timer = setTimeout(() => func.apply(this, args), delay);
    };
}

// Initialize the convertTextToLinks function
async function initializeLinkConversion() {
    await convertTextToLinks(editableDiv);
}

// Add event listeners for keyup, paste, and focusout
//editableDiv.addEventListener("keyup", debounce(initializeLinkConversion, 500)); // Delayed to avoid unnecessary calls
editableDiv.addEventListener("paste", debounce(initializeLinkConversion, 500));
editableDiv.addEventListener("focusout", initializeLinkConversion);



function timeAgo(timestamp) {
    const now = new Date();
    const secondsAgo = Math.floor((now - timestamp) / 1000);

    const intervals = [
        { label: 'year', seconds: 31536000 },
        { label: 'month', seconds: 2592000 },
        { label: 'week', seconds: 604800 },
        { label: 'day', seconds: 86400 },
        { label: 'hour', seconds: 3600 },
        { label: 'minute', seconds: 60 },
        { label: 'second', seconds: 1 }
    ];

    for (const interval of intervals) {
        const count = Math.floor(secondsAgo / interval.seconds);
        if (count >= 1) {
            return `${count} ${interval.label}${count > 1 ? 's' : ''} ago`;
        }
    }

    return 'just now'; // If less than a second
}





 document.getElementById('chooseFileButton').addEventListener('click', () => {
    document.getElementById('attachmentInput').click();
});

document.getElementById('attachmentInput').addEventListener('change', (e) => {
    const file = e.target.files[0];
    const fileUrl = file ? URL.createObjectURL(file) : null;

    const attachmentPreview = document.getElementById('attachmentPreview');
    const imagePreview = document.getElementById('attachmentImage');
    const videoPreview = document.getElementById('attachmentVideo');
    const unsupportedFile = document.getElementById('unsupportedFile');
    const fileName = document.getElementById('fileName');

    if (file) {
        attachmentPreview.classList.remove('d-none');
        
        if (file.type.startsWith('image/')) {
            imagePreview.src = fileUrl;
            imagePreview.className = 'lazy-image';

            imagePreview.classList.remove('d-none');
            videoPreview.classList.add('d-none');
            unsupportedFile.classList.add('d-none');
        } else if (file.type.startsWith('video/')) {
            videoPreview.src = fileUrl;
            videoPreview.classList.remove('d-none');
            imagePreview.classList.add('d-none');
            unsupportedFile.classList.add('d-none');
        } else {
            fileName.textContent = file.name;
            unsupportedFile.classList.remove('d-none');
            imagePreview.classList.add('d-none');
            videoPreview.classList.add('d-none');
        }
    }
});

document.getElementById('removePreview').addEventListener('click', () => {
    const attachmentInput = document.getElementById('attachmentInput');
    const attachmentPreview = document.getElementById('attachmentPreview');
    const imagePreview = document.getElementById('attachmentImage');
    const videoPreview = document.getElementById('attachmentVideo');
    const unsupportedFile = document.getElementById('unsupportedFile');

    attachmentInput.value = ''; // Clear input value
    attachmentPreview.classList.add('d-none'); // Hide preview area
    imagePreview.classList.add('d-none');
    videoPreview.classList.add('d-none');
    unsupportedFile.classList.add('d-none');
});

document.addEventListener('DOMContentLoaded', () => {
    const editableDiv = document.getElementById('editableDiv');
  const messageInput = document.getElementById('messageInput');

  // Synchronize text from editableDiv to textarea on keyup
  editableDiv.addEventListener('keyup', () => {
    messageInput.value = editableDiv.innerHTML.trim(); // Keep the value synced
  });


    document.getElementById('sendMessageButton').addEventListener('click', async () => {
    const attachmentInput = document.getElementById('attachmentInput').files[0];
    const conversationID = document.getElementById('conversationTitle')?.getAttribute('data-conversation-id');
   
   console.log("conversationID: ", conversationID);

    const message = messageInput.value.trim();

    if (!message && !attachmentInput) {
        showToast("Please enter a message or attach a file.", 'warning');
        return;
    }

    if (!conversationID) {
        showToast("conversationID 1329 Something is not right. Please refresh the page.", 'warning');
        return;
    }

    try {
        let attachmentUrl = '';
        if (attachmentInput) {
            attachmentUrl = await uploadAttachment(conversationID, attachmentInput);
        }

        await sendMessage(message, attachmentUrl);
        
     // Reset inputs after successful send
     editableDiv.innerHTML = ''; // Clear the editable div
      messageInput.value = ''; // Clear hidden textarea
        document.getElementById('removePreview').click();
        showToast("Message sent successfully!", 'success');
    } catch (error) {
        console.error("Error sending message:", error.message);
        showToast("Failed to send message. Please try again.", 'error');
    }
});

});

async function uploadAttachment(conversationID, file) {
    try {
        // Ensure 'storage' is properly initialized
        const storageInstance = getStorage(); // Use Firebase's getStorage method

        // Create a storage reference dynamically based on conversationID and file name
        const fileRef = ref(storageInstance, `messages/${conversationID}/${file.name}`);

        // Upload the file to Firebase Storage
        const snapshot = await uploadBytes(fileRef, file);

        // Get the download URL for the uploaded file
        return await getDownloadURL(snapshot.ref);
    } catch (error) {
        console.error("Error uploading attachment:", error);
        throw new Error('Failed to upload attachment.'); // Handle this in calling function
    }
}



function sendMessage( message, attachmentUrl = '') { 
    const determineContentType = (url) => {
        const fileExtension = url.split('.').pop().toLowerCase(); // Get file extension
        switch (fileExtension) {
            case 'jpg':
            case 'jpeg':
            case 'png':
            case 'gif':
                return 'image';
            case 'mp4':
            case 'mov':
            case 'avi':
            case 'mkv':
                return 'video';
            case 'mp3':
            case 'wav':
            case 'aac':
                return 'audio';
            case 'pdf':
                return 'document';
            case 'doc':
            case 'docx':
            case 'xls':
            case 'xlsx':
            case 'ppt':
            case 'pptx':
                return 'office-document';
            case 'zip':
            case 'rar':
                return 'archive';
            default:
                return 'unknown';
        }
    };

    const contentType = attachmentUrl ? determineContentType(attachmentUrl) : 'text';

     const userDataSaved = getUserData() || [];
    const senderID = auth.currentUser.uid;

    //console.log("USERDATA: ", USERDATA);
   // console.log("UserData: ", UserData);
   // console.log("UserID: ", UserID);
   // console.log("UserId: ", UserId);

   //works
  //  console.log("senderID: ", senderID);
   // console.log("userDataSaved: ", userDataSaved);

    const conversationID = document.getElementById('conversationTitle')?.getAttribute('data-conversation-id');
    const recipientName = document.getElementById('conversationTitle')?.getAttribute('data-conversation-name');
    const recipientPicture = document.getElementById('conversationTitle')?.getAttribute('data-conversation-picture');
    const recipientID = document.getElementById('conversationTitle')?.getAttribute('data-conversation-recipientID');


    let  connectedBool = document.querySelector(`[data-connection-id="${recipientID}"]`);

if(connectedBool){
    connectedBool = true;

}else{
    connectedBool = false;

}

if(!recipientID){
    showToast("recipientID: undefined");

   // console.log("recipientID: undefined !!!!!!!!!!!!!!!!1111 ");

return;
}

    addDoc(collection(db, 'Messages'), {


        recipientID: recipientID,
        recipientName: recipientName,
        recipientProfileURL: `https://reelcareer.co/u/?u=${recipientID}`,
        recipientProfilePicture:  recipientPicture,
        recipientRead: false,

   
        participants: [userDataSaved.userID, recipientID], // Add this array

  
        senderID: userDataSaved.userID || auth.currentUser.uid || senderID,
        senderName: userDataSaved.displayName,
        senderProfilePicture: userDataSaved.profilePicture,
        senderProfileURL: `https://reelcareer.co/u/?u=${userDataSaved.userID}`,

        group: 'main',
        messageType: 'chat',
        contactLocation: 'Messaging',

        conversationID: conversationID,
        content: message.trim(), // Trim to avoid sending blank spaces
        connectedBool: connectedBool,
        createdAt: new Date(),
        timestamp: serverTimestamp(),
        contentType: contentType,
        status: 'unread',
        attachments: attachmentUrl,
        isDeleted: false
    }).then(() => {
        document.getElementById('editableDiv').innerHTML = ''; // Clear input
        document.getElementById('messageInput').value = ''; // Clear input
        document.getElementById('attachmentInput').value = ''; // Clear attachment
    }).catch(error => {
        showToast("Error sending message: " + error.message, 'error');
    });
}



   </script>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.0.7/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>
</html>
