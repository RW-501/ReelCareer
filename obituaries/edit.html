<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="Create Your Obituary">
    <meta property="og:description" content="Fill in the details to create your obituary page. Leave a legacy that people will cherish.">
    <meta property="og:image" content="https://reelcareer.co/images/8pic_rc.png">
    <meta property="og:url" content="https://reelcareer.co/obituaries/create">
    <meta property="og:type" content="website">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Create Your Obituary">
    <meta name="twitter:description" content="Fill in the details to create your obituary page. Leave a legacy that people will cherish.">
    <meta name="twitter:image" content="https://reelcareer.co/images/8pic_rc.png">
    <meta name="twitter:url" content="https://reelcareer.co/obituaries/create">
    
    <!-- General Meta Tags -->
    <meta name="description" content="Create your personalized obituary page. Add details, photos, and memories to leave a lasting legacy.">
    <meta name="keywords" content="obituary, create obituary, legacy, remembrance, celebration of life">
    <meta name="author" content="ReelCareer">
    <meta name="robots" content="index, follow">
    <meta name="theme-color" content="#ffffff">
          <!-- Canonical Tag for SEO -->
  <link rel="canonical" href="https://reelcareer.co/obituaries/create"> <!-- Ensures search engines index the preferred URL -->

  <!-- Standard Favicon -->
  <link rel="icon" type="image/x-icon" href="https://reelcareer.co/images/favicons/favicon.ico">

    <!-- Schema.org Structured Data -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebPage",
      "url": "https://reelcareer.co/obituaries/create",
      "name": "Create Your Obituary",
      "description": "Create your personalized obituary page. Add details, photos, and memories to leave a lasting legacy.",
      "author": {
        "@type": "Organization",
        "name": "ReelCareer",
        "url": "https://reelcareer.co/"
      },
      "publisher": {
        "@type": "Organization",
        "name": "ReelCareer",
        "url": "https://reelcareer.co/",
        "logo": {
          "@type": "ImageObject",
          "url": "https://reelcareer.co/images/8pic_rc.png",
          "width": 200,
          "height": 60
        }
      },
      "image": {
        "@type": "ImageObject",
        "url": "https://reelcareer.co/images/8pic_rc.png",
        "width": 1200,
        "height": 630
      }
    }
    </script>

    <title>Edit Your Obituary | ReelCareer</title>

<!-- Main Script Loader -->
<script src="https://reelcareer.co/scripts/js/loader.js"></script>

<style>
  main {

    #viewObituary {
    border: 1px solid #f4f4f4;
    padding: 4px;
    min-height: 400px;
    overflow-y: auto;
}
  










  #messageDiv {
    margin-top: 20px;
    font-size: 14px;
    color: red;
  }
  
   












}    
  </style>
  
</head>
<body>

  <!-- Navigation Bar -->
  <nav id="Main-Nav_bar" class="navbar navbar-expand-lg main-navbar-light shadow-sm sticky-top" role="navigation">
    <div class="container d-flex align-items-center justify-content-between">
      <!-- Logo -->
      <a class="navbar-brand embossed" id="MAIN-LOGO-Reel-Career" href="https://reelcareer.co/" aria-label="Go to home page">
        ReelCareer
      </a>

      <!-- Always-visible Icons -->
      <ul class="navbar-nav d-flex flex-row justify-content-center flex-grow-1" id="iconBar">
        
      <li class="nav-item mx-2">
        <a class="nav-link" href="https://reelcareer.co/job-listings" aria-label="Go to job listings page">
          <i class="fa fa-briefcase"></i>
        </a>
      </li>
      <li class="nav-item mx-2">
        <a class="nav-link" href="https://reelcareer.co/reels" aria-label="Go to reels page">
          <i class="fa fa-video"></i>
        </a>
      </li>
      <li class="nav-item mx-2">
        <a class="nav-link" href="https://reelcareer.co/views/membership" aria-label="Go to membership page">
          <i class="fa fa-user"></i>
        </a>
      </li>
      <li class="nav-item mx-2">
        <a class="nav-link" href="https://reelcareer.co/views/blogs" aria-label="Go to blogs page">
          <i class="fa fa-pencil-alt"></i>
        </a>
      </li>
      </ul>

      <!-- Auth Section -->
      <div id="authSection" class="d-flex align-items-center"><button class="btn btn-primary" id="loginButton">Login / Create Account</button></div>
    </div>
  </nav>


<header>
    <h1 id="breadcrumbText">Edit Obituaries</h1>
</header>

   <!-- Breadcrumb Section -->
<div id="main-breadcrumb" class="breadcrumb">
    <a href="https://reelcareer.co/">Home</a> | <a href="https://reelcareer.co/obituaries">Obituaries</a> 
    | <a href="https://reelcareer.co/obituaries/create">Create</a>| <a href="https://reelcareer.co/obituaries/about">About</a>
</div>


    <!-- Main Content Section -->
<main id="main-content">

  <div id="messageDiv"></div>

        <div class="container">
            <select id="obituarySelect" onchange="getSelectedObituary()">
                <option value="">Select an Obituary</option>
                <!-- Obituary options will be dynamically added here -->
            </select>
            
        </div>
      <div class="controls">
        <button id="changeLayoutBtn">Change Layout</button>
        <button id="changeTextBtn">Change Text</button>
        <button id="previewBtn">Preview</button>
        <button id="saveBtn">Save</button>
      </div>
  
      <div id="viewObituary">
        <!-- Content will be dynamically loaded here -->
      </div>
  
      <div id="user-toolbar" class="toolbar">
        <!-- Toolbar buttons will be injected here -->
    </div>
    
    </main>


    <footer class="site-footer">
        <div class="footer-content">
            <p>Leave a lasting legacy. Share your story with the world.</p>
            <nav class="footer-nav">
                <a href="https://reelcareer.co/obituaries/">Obituaries</a> | 
                <a href="https://reelcareer.co/obituaries/create">Create an Obituary</a> | 
                <a href="https://reelcareer.co/obituaries/about">About Career Obituaries</a> | 
                <a href="https://reelcareer.co/">ReelCareer</a>
            </nav>
            <p>&copy; <span id="currentYear"></span> ReelCareer.co. All rights reserved.</p>
        </div>
    </footer>
    
    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.27.2/axios.min.js"></script> <!-- For fetching IP -->


    

        <!-- Include Firebase SDK as a module -->
<script type="module">
    import {
        db, getStorage, ref, uploadBytes, getDownloadURL, limit,
  doc, arrayUnion, RecaptchaVerifier, increment, getDoc, arrayRemove, signInWithPhoneNumber,
  query, updateDoc, setDoc, addDoc, signInAnonymously, orderBy, onAuthStateChanged,
  uploadBytesResumable, signInWithPopup, FacebookAuthProvider, GoogleAuthProvider, startAfter,
  OAuthProvider, signOut, deleteDoc, getFirestore, serverTimestamp,
  createUserWithEmailAndPassword, signInWithEmailAndPassword, deleteObject,
  where, getDocs, storage, getAuth, collection, auth, analytics,
  googleProvider,onSnapshot , linkWithCredential, EmailAuthProvider ,
  getUserId // Export the function
    } from 'https://reelcareer.co/scripts/js/load/module.js';

    
        // Listen for authentication state changes to get the user ID
        let userID = '';
        let pageID = '';
        let pageName = '';
        
        document.addEventListener('DOMContentLoaded', () => {



          onAuthStateChanged(auth, async (user) => {
  if (user) {
    try {
       userID = user.uid;
      console.log("User ID:", userID);

      // Extract pageName and pageID from URL query parameters
      const urlParams = new URLSearchParams(window.location.search);
       pageName = urlParams.get("pageName");
       pageID = urlParams.get("pageID");

      if (!pageID) {
        console.warn("Missing pageID in URL parameters.");
        return;
      }

      const ownerRef = collection(db, `A_Obituaries`);
      const ownerQuery = query(ownerRef, where('userID', '==', userID), where('__name__', '==', pageID));
      const ownerSnapshot = await getDocs(ownerQuery);

      if (ownerSnapshot.empty) {
        console.log("You do not have ownership of this page.");
        return;  // Stop execution if the user does not own the page
      }

      console.log(`Welcome! You are the owner of the page: ${pageName}`);


    // Call this function when the page loads
    loadUserObituaries(userID);

    

    console.log("pageName:", pageName);
    createToolbar(pageID, pageName);

    if (pageName) {
      // Fetch obituary data if pageName exists
      fetchObituary(pageName);
    }
  } catch (error) {
      console.error("Error checking page ownership:", error);
    }


  } else {
    console.log("No user signed in ...");
    
  }

    
});

    
});


let  shadowRoot;
const viewObituary = document.getElementById('viewObituary');
shadowRoot = viewObituary.attachShadow({ mode: 'open' });


function applyViewObituaryStyles() {
  if (!viewObituary) return;


  // Fetch external stylesheet for viewObituary
  fetch('https://reelcareer.co/obituaries/setup/style.css')
    .then(response => response.text())
    .then(css => {
      const styleElement = document.createElement('style');
      styleElement.innerHTML = css;

      // Add drag-and-drop styles directly
      const dragDropStyles = `


 .changeable-area.active {
    border: 2px dashed blue;
    margin: .5rem 0;
    padding: .5rem 0;
    background-color: #f4f4f4;
    border-radius: 5px;
}
   .changeable-text.active {
    border: 2px solid green;
  }
  
   .changeable-area {
    margin: .5rem 0;
    padding: .5rem 0;
    border: none;

}
   .changeable-text {
    border: none;
  }
  





   .editable {
   /* outline: 2px solid rgb(217, 230, 29); */
   display: block;
  }
  
  .changeable-area, .changeable-text {
    cursor: pointer;
  }
  
  .draggable {
  cursor: move;  /* Show a move cursor */
  border: 2px dashed #ccc;  /* Subtle outline indicating draggable area */
}

.dragging {
  opacity: 0.5;  /* Visual feedback for dragging */
}

.drop-zone {
  background-color: #f0f8ff;  /* Highlight the drop zone */
  border: 2px solid #00f;  /* Clear border for the drop target */
}

        .changeable-area.dragging {
          opacity: 0.5;
          background-color: #f0f0f0;
        }
        .changeable-area.highlight {
          border: 2px dashed blue;
          background-color: #f0f8ff;
          transition: background-color 0.3s ease-in-out;
        }
        .changeable-area.active {
          border: 2px dashed blue;
          margin: 0.5rem 0;
          padding: 0.5rem 0;
          background-color: #f4f4f4;
          border-radius: 5px;
        }





      `;
      const styleElement2 = document.createElement('style');


      styleElement2.innerHTML = dragDropStyles;
      shadowRoot.appendChild(styleElement);
      shadowRoot.appendChild(styleElement2);

      // Move inner content to shadow DOM
      while (viewObituary.firstChild) {
        shadowRoot.appendChild(viewObituary.firstChild);
      }
    })
    .catch(error => console.error('Error loading styles:', error));
}



        // Fetch user's IP address using an external service
        async function getUserIP() {
            try {
                const response = await axios.get('https://api.ipify.org?format=json');
                return response.data.ip;
            } catch (error) {
                console.error('Error fetching IP address:', error);
                return 'Unknown IP';
            }
        }

// Function to fetch user IP and location details
async function getUserDetails() {
  try {
    const response = await fetch("https://ipapi.co/json/");
    const data = await response.json();

    return {
      ip: data.ip,
      city: data.city,
      state: data.region,
      country: data.country_name,
      location: {
        latitude: data.latitude,
        longitude: data.longitude,
      },
    };
  } catch (error) {
    console.error("Error fetching user details:", error);
    return null;
  }
}

const fileInput = document.getElementById('mainPhoto');
const imagePreview = document.getElementById('imagePreview');
const imagePreviewContainer = document.getElementById('imagePreviewContainer');
const toggleBnwButton = document.getElementById('toggleBnw');
const rotateButton = document.getElementById('rotateImage');
const zoomInButton = document.getElementById('zoomIn');
const zoomOutButton = document.getElementById('zoomOut');
const resetButton = document.getElementById('resetImage');

// Default image transformations
let isBlackAndWhite = false;
let rotationDegree = 0;
let zoomLevel = 1;

// Function to update image styles and return a modified canvas
function updateImageStylesAndCreateCanvas() {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    // Set canvas size to image size
    canvas.width = imagePreview.naturalWidth;
    canvas.height = imagePreview.naturalHeight;
    
    // Apply transformations: Black & White, Rotation, Zoom
    ctx.filter = isBlackAndWhite ? 'grayscale(100%)' : 'none';
    ctx.save();
    ctx.translate(canvas.width / 2, canvas.height / 2);
    ctx.rotate(rotationDegree * Math.PI / 180); // Convert degree to radians
    ctx.scale(zoomLevel, zoomLevel);
    ctx.drawImage(imagePreview, -canvas.width / 2, -canvas.height / 2);
    ctx.restore();
    
    return canvas;
}
/*

how about scripts? but i do not want the .. https://reelcareer.co/obituaries/setup/interactions.js, loadScript('https://reelcareer.co/obituaries/setup/share.js, https://reelcareer.co/obituaries/setup/footer.js













if(fileInput){

// Handle file selection and display image preview
fileInput.addEventListener('change', function(event) {
    const file = event.target.files[0];

    if (file && file.type.startsWith('image/')) {
        const imageUrl = URL.createObjectURL(file);
        imagePreview.src = imageUrl;
        imagePreview.style.display = 'block'; // Make sure the image preview is visible
        imagePreviewContainer.style.display = 'block'; // Show the image preview container
    }
});


// Event listeners for the transformation buttons
toggleBnwButton.addEventListener('click', function() {
    isBlackAndWhite = !isBlackAndWhite;
    updateImageStyles();
});

rotateButton.addEventListener('click', function() {
    rotationDegree += 90;
    if (rotationDegree >= 360) rotationDegree = 0; // Reset to 0 when it exceeds 360
    updateImageStyles();
});

zoomInButton.addEventListener('click', function() {
    zoomLevel += 0.1;
    updateImageStyles();
});

zoomOutButton.addEventListener('click', function() {
    zoomLevel = Math.max(0.5, zoomLevel - 0.1); // Prevent zooming out too much
    updateImageStyles();
});

resetButton.addEventListener('click', function() {
    isBlackAndWhite = false;
    rotationDegree = 0;
    zoomLevel = 1;
    updateImageStyles();
});

}


// Function to update image styles (for front-end preview)
function updateImageStyles() {
    const canvas = updateImageStylesAndCreateCanvas();
    imagePreview.src = canvas.toDataURL(); // Preview the transformation in real-time
}
  
    // Allow the user to click the preview image to change it
    imagePreview.addEventListener('click', function() {
        fileInput.click(); // Trigger the file input to allow a new image selection
    });



    document.getElementById('category').addEventListener('change', function () {
        const otherCategory = document.getElementById('otherCategoryContainer');
        if (this.value === 'other') {
            otherCategory.style.display = 'block';
        } else {
            otherCategory.style.display = 'none';
        }
    });

    function displayVideoPreview(videoUrl, videoPreviewContainer) {
    console.log('videoPreviewContainer:', videoPreviewContainer);

    // Check if the videoPreviewContainer is null
    if (!videoPreviewContainer) {
        console.error('Error: videoPreviewContainer is null or undefined.');
        return;
    }

    // Clear previous content in the container
    videoPreviewContainer.innerHTML = "";

    // Check if there is a videoUrl to display
    if (videoUrl) {
        // YouTube Video Check
        if (videoUrl.includes("youtube.com") || videoUrl.includes("youtu.be")) {
            const youtubeEmbed = videoUrl.includes("youtube.com") 
                ? videoUrl.replace("watch?v=", "embed/") 
                : videoUrl.replace("youtu.be/", "youtube.com/embed/");
            videoPreviewContainer.innerHTML = `
                <iframe width="560" height="315" src="${youtubeEmbed}" frameborder="0" allowfullscreen></iframe>`;
        }
        // Vimeo Video Check
        else if (videoUrl.includes("vimeo.com")) {
            const vimeoId = videoUrl.split("/").pop();
            videoPreviewContainer.innerHTML = `
                <iframe src="https://player.vimeo.com/video/${vimeoId}" width="560" height="315" frameborder="0" 
                        allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe>`;
        }
        // MP4 Video Check (and other formats like .webm, .ogg)
        else if (videoUrl.match(/\.(mp4|webm|ogg)$/i)) {
            videoPreviewContainer.innerHTML = `
                <video width="560" height="315" controls>
                    <source src="${videoUrl}" type="video/mp4">
                    Your browser does not support the video tag.
                </video>`;
        }
        // Dailymotion Video Check
        else if (videoUrl.includes("dailymotion.com")) {
            const dailymotionId = videoUrl.split("/").pop();
            videoPreviewContainer.innerHTML = `
                <iframe frameborder="0" width="560" height="315" src="https://www.dailymotion.com/embed/video/${dailymotionId}" 
                        allowfullscreen></iframe>`;
        }
        // Twitch Video Check
        else if (videoUrl.includes("twitch.tv")) {
            const twitchId = videoUrl.split("/").pop();
            videoPreviewContainer.innerHTML = `
                <iframe src="https://player.twitch.tv/?video=${twitchId}" height="315" width="560" frameborder="0" 
                        scrolling="no" allowfullscreen></iframe>`;
        }
        // Facebook Video Check
        else if (videoUrl.includes("facebook.com")) {
            const facebookId = videoUrl.split("/").pop();
            videoPreviewContainer.innerHTML = `
                <iframe src="https://www.facebook.com/plugins/video.php?href=https://www.facebook.com/video.php?v=${facebookId}" 
                        width="560" height="315" frameborder="0" allowfullscreen></iframe>`;
        }
        // Instagram Video Check
        else if (videoUrl.includes("instagram.com")) {
            const instagramId = videoUrl.split("/p/").pop().split("/")[0];
            videoPreviewContainer.innerHTML = `
                <iframe src="https://www.instagram.com/p/${instagramId}/embed" width="560" height="315" frameborder="0" 
                        scrolling="no" allowfullscreen></iframe>`;
        }
        // Twitter Video Check
        else if (videoUrl.includes("twitter.com")) {
            const twitterId = videoUrl.split("/status/").pop();
            videoPreviewContainer.innerHTML = `
                <iframe src="https://twitframe.com/show?url=${encodeURIComponent(videoUrl)}" width="560" height="315" 
                        frameborder="0" allowfullscreen></iframe>`;
        }
        // TikTok Video Check
        else if (videoUrl.includes("tiktok.com")) {
            const tiktokId = videoUrl.split("/video/").pop();
            videoPreviewContainer.innerHTML = `
                <iframe src="https://www.tiktok.com/embed/${tiktokId}" width="560" height="315" frameborder="0" 
                        allowfullscreen></iframe>`;
        }
        // Unsupported platform message
        else {
            videoPreviewContainer.innerHTML = "<p>Unsupported video platform. Please enter a URL from a supported platform like YouTube, Vimeo, Dailymotion, Instagram, or MP4.</p>";
        }

    } else {
        // Handle case when there is no videoUrl provided
        videoPreviewContainer.innerHTML = "<p>Please enter a video URL.</p>";
    }
}



    document.getElementById("video").addEventListener("input", function() {
    const videoUrl = this.value.trim();
    const videoPreview = document.getElementById("videoPreview");

    displayVideoPreview(videoUrl, videoPreview);
});
// Display the "Other" category input if selected
document.getElementById('category').addEventListener('change', function() {
    if (this.value === 'other') {
        document.getElementById('otherCategoryContainer').style.display = 'block';
    } else {
        document.getElementById('otherCategoryContainer').style.display = 'none';
    }
});

*/



const changeLayoutBtn = document.getElementById('changeLayoutBtn');
const changeTextBtn = document.getElementById('changeTextBtn');
const previewBtn = document.getElementById('previewBtn');
const saveBtn = document.getElementById('saveBtn');
const breadcrumbText = document.getElementById('breadcrumbText');
let originalHTML = '';  // Store the original HTML content
let newHTML = '';  // Store the modified HTML content



let currentMode = 'layout';  // Current mode (either 'layout' or 'text')

// Function to fetch the obituary HTML from GitHub
async function fetchObituary(pageName) {
  const messageDiv = document.getElementById('messageDiv');

  viewObituary.innerHTML = '';


    if (!pageName) {
        console.log("Please select an obituary.");
        return;
    }

  const owner = "RW-501";
  const repo = "ReelCareer";
  const filePath = `obituaries/celebrating/${pageName}.html`;

// Randomized or complex approach
const parts = ['p', 'h', 'g'];
const randomizePart = (part) => {
    return part.split('').reverse().join('');
};

const part_1 = randomizePart(parts.join(''));
const part_2 = "_akXGrO51HwgEI";
const part_3 = "VWzDIghLbIE";
const part_4 = "G9MnTu0fIjKj";

const token = part_1 + part_2 + part_3 + part_4;


  const url = `https://api.github.com/repos/${owner}/${repo}/contents/${filePath}`;

  try {
    const fileResponse = await fetch(url, {
      method: 'GET',
      headers: {
        Authorization: `Bearer ${token}`,
        'Content-Type': 'application/json',
        Accept: 'application/vnd.github+json',
      },
    });

    if (fileResponse.ok) {
      const fileData = await fileResponse.json();
      const content = atob(fileData.content);  // Decode base64 content
      originalHTML = content;
      //console.log("originalHTML:", originalHTML);

      shadowRoot.innerHTML = content;
      newHTML = content;  // Set the new HTML to be the same as the original at first
   

      applyViewObituaryStyles();

   
   
    } else {
      messageDiv.innerHTML = 'File not found.';
    }
    console.log("fetchObituary fileResponse:", fileResponse);

  } catch (error) {
    console.log("error:", error);

    messageDiv.innerHTML = 'Error fetching the obituary HTML.';
  }


}



async function loadUserObituaries(userID) {
    const userRef = doc(db, "Users", userID);
    const userDoc = await getDoc(userRef);

    if (userDoc.exists()) {
        const data = userDoc.data();
        const obituaryPageIDs = data.obituaryPageID || [];
        const obituaryPageNames = data.obituaryPageName || [];

        // Get the select element
        const selectElement = document.getElementById("obituarySelect");

        // Clear previous options
        selectElement.innerHTML = '<option value="">Select an Obituary</option>';

        // Loop through obituaryPageNames and add them to the select dropdown
        obituaryPageNames.forEach((pageName, index) => {
            const option = document.createElement("option");
            option.value = obituaryPageNames[index]; // Use the page ID as the value
            option.textContent = pageName; // Use the page name as the label
            selectElement.appendChild(option);
        });
    } else {
        console.log("No obituary data found for the user.");
    }
}

document.addEventListener('DOMContentLoaded', () => {

// Function to get the selected value and call fetchObituary with it
function getSelectedObituary() {
    // Get the select element and its selected value
    const selectElement = document.getElementById('obituarySelect');
    const selectedValue = selectElement.value;
    console.log('selectedValue: ',selectedValue);

    // Check if a value is selected
    if (selectedValue) {
        fetchObituary(selectedValue);  // Call the fetchObituary function with the selected value (obituaryPageID)
    } else {
        console.log('No obituary selected.');
    }
}

window.getSelectedObituary = getSelectedObituary;

});


// Change Layout Mode
changeLayoutBtn.addEventListener('click', () => {
  currentMode = 'layout';
  breadcrumbText.textContent = 'Currently in Layout Mode';
  enableLayoutEditing();
});

// Change Text Mode
changeTextBtn.addEventListener('click', () => {
  currentMode = 'text';
  breadcrumbText.textContent = 'Currently in Text Editing Mode';
  enableTextEditing();
});

// Preview Changes
previewBtn.addEventListener('click', () => {
  removeEditingHighlights();
  viewObituary.innerHTML = '';
  viewObituary.innerHTML = newHTML;
  previewBtn.style.visibility = 'hidden';
  saveBtn.style.visibility = 'visible';
});

saveBtn.addEventListener('click', async () => {
  console.log('Save button clicked.');
  removeEditingHighlights();

  const nonChangeableDivs = shadowRoot.querySelectorAll('.nonChangeable');

  console.log('Current nonChangeable divs:');
  nonChangeableDivs.forEach((div, index) => {
    console.log(`Div ${index}:`, div.outerHTML);
  });

  const tempContainer = document.createElement('div');
  tempContainer.innerHTML = originalHTML;
  const originalNonChangeableDivs = tempContainer.querySelectorAll('.nonChangeable');

  console.log('Original nonChangeable divs:');
  originalNonChangeableDivs.forEach((div, index) => {
    console.log(`Div ${index}:`, div.outerHTML);
  });

  // Check if the number of non-changeable divs has changed
  let modified = nonChangeableDivs.length !== originalNonChangeableDivs.length;
  
  // If lengths are the same, compare outerHTML for all non-changeable divs
  if (!modified) {
    modified = Array.from(nonChangeableDivs).some((div, index) => {
      return div.outerHTML !== originalNonChangeableDivs[index].outerHTML;
    });
  }

  console.log('Is content modified:', modified);

  if (modified) {
    messageDiv.innerHTML = 'Changes cannot be saved as non-changeable content was altered.';
  } else {
   // const newHTML = viewObituary.innerHTML;
    await saveHTMLToGitHub(newHTML);
    previewBtn.style.visibility = 'hidden';
    saveBtn.style.visibility = 'hidden';
  }
});

// Handle drag start (grab the entire div, not just the inner element)
function enableLayoutEditing() { 
  removeEditingHighlights();

  previewBtn.style.visibility = 'visible';
  saveBtn.style.visibility = 'visible';

  const changeableAreas = shadowRoot.querySelectorAll('.changeable-area');
  changeableAreas.forEach(area => {
    area.classList.add('active');
    area.style.cursor = 'grab';  // Set initial grab cursor
    area.setAttribute('draggable', 'true');
    area.addEventListener('dragstart', handleDragStart);
    area.addEventListener('dragover', handleDragOver);
    area.addEventListener('drop', handleDrop);
    area.addEventListener('dragenter', handleDragEnter);
    area.addEventListener('dragleave', handleDragLeave);

    // Prevent child elements from triggering drag events
    const childElements = area.querySelectorAll('*');
    childElements.forEach(child => {
      child.setAttribute('draggable', 'false');
    });

    // Change cursor on hover and drag events
    area.addEventListener('mousedown', () => area.style.cursor = 'grabbing');
    area.addEventListener('mouseup', () => area.style.cursor = 'grab');
  });
}

function handleDragStart(e) {
  e.dataTransfer.setData('text/html', e.target.outerHTML);
  e.target.classList.add('dragging');
  e.target.style.cursor = 'grabbing';  // Change cursor to grabbing when dragging
}

function handleDragOver(e) {
  e.preventDefault(); // Allow the drop
}

function handleDrop(e) {
  e.preventDefault();
  const draggedElement = shadowRoot.querySelector('.dragging');
  const droppedElement = e.target.closest('.changeable-area');  // Ensure valid drop target

  if (droppedElement && draggedElement !== droppedElement) {
    const draggedHTML = draggedElement.outerHTML;
    const droppedHTML = droppedElement.outerHTML;

    draggedElement.outerHTML = droppedHTML;
    droppedElement.outerHTML = draggedHTML;

    enableLayoutEditing();  // Reattach event listeners
  }

  draggedElement.classList.remove('dragging');
  draggedElement.style.cursor = 'grab';  // Reset cursor after dropping
}

function handleDragEnter(e) {
  e.preventDefault();
  e.target.classList.add('highlight');
}

function handleDragLeave(e) {
  e.target.classList.remove('highlight');
}


// Enable text editing
function enableTextEditing() {
  removeEditingHighlights();
  previewBtn.style.visibility = 'visible';
  saveBtn.style.visibility = 'visible';

  const changeableTextDivs = shadowRoot.querySelectorAll('.changeable-text');
  changeableTextDivs.forEach(div => {
    div.setAttribute('contenteditable', 'true');
    div.classList.add('editable');
    div.classList.add('active');
    div.addEventListener('focus', () => div.classList.add('active'));  // Add active class on focus
    div.addEventListener('blur', () => div.classList.remove('active'));  // Remove active class on blur
  });
}

// Remove all highlights or outlines
function removeEditingHighlights() {
  const editableDivs = shadowRoot.querySelectorAll('.changeable-text');
  editableDivs.forEach(div => {
    div.removeAttribute('contenteditable');
    div.classList.remove('active');
    div.classList.remove('editable');
   // div.removeAttribute('draggable');

  });

  const changeableAreas = shadowRoot.querySelectorAll('.changeable-area');
  changeableAreas.forEach(area => {
    area.classList.remove('active');
    area.classList.remove('highlight');
    area.classList.remove('dragging');
    area.removeAttribute('draggable');
    area.removeAttribute('style');

  });
}

// Save HTML to GitHub
async function saveHTMLToGitHub(content) {
  console.log('content:', content);
  console.log('pageName:', pageName);


  const owner = "RW-501";
  const repo = "ReelCareer";
  const filePath = `obituaries/celebrating/${pageName}.html`;
  const parts = ['p', 'h', 'g'];
const randomizePart = (part) => {
    return part.split('').reverse().join('');
};

const part_1 = randomizePart(parts.join(''));
const part_2 = "_akXGrO51HwgEI";
const part_3 = "VWzDIghLbIE";
const part_4 = "G9MnTu0fIjKj";

const token = part_1 + part_2 + part_3 + part_4;


  const url = `https://api.github.com/repos/${owner}/${repo}/contents/${filePath}`;
  const encodedContent = btoa(content);  // Encode content in base64

  try {
    const fileResponse = await fetch(url, {
      method: 'GET',
      headers: {
        Authorization: `Bearer ${token}`,
        'Content-Type': 'application/json',
        Accept: 'application/vnd.github+json',
      },
    });

    let sha = '';
    if (fileResponse.ok) {
      const fileData = await fileResponse.json();
      sha = fileData.sha;
    }

    const response = await fetch(url, {
      method: 'PUT',
      headers: {
        Authorization: `Bearer ${token}`,
        'Content-Type': 'application/json',
        Accept: 'application/vnd.github+json',
      },
      body: JSON.stringify({
        message: sha ? `Update ${filePath}` : `Create ${filePath}`,
        content: encodedContent,
        sha: sha,
        branch: 'main',
      }),
    });

    if (!response.ok) {
      throw new Error('Error saving the file.');
    }

    const data = await response.json();
    console.log('File saved successfully!', data);
    messageDiv.innerHTML = 'Changes saved successfully!';

    showToast("Saved successfully!");

  } catch (error) {
    messageDiv.innerHTML = `Error: ${error.message}`;
  }
}
window.saveHTMLToGitHub = saveHTMLToGitHub;






function createToolbar(pageID, pageName) {
    const toolbar = document.createElement('div');
    toolbar.className = 'controls';
    toolbar.innerHTML = `
        <button id="edit_${pageID}">Edit</button>
        <button id="analytics_${pageID}">Analytics</button>
        <button id="view_${pageID}">View</button>
        <button id="userAccount_${pageID}">Account</button>
    `;

    // Append the toolbar to the desired container
    document.getElementById('user-toolbar').appendChild(toolbar);

    // Add event listeners for the buttons
    toolbar.querySelector(`#edit_${pageID}`).addEventListener("click", () => goToEditPage(pageID, pageName));
    toolbar.querySelector(`#analytics_${pageID}`).addEventListener("click", () => goToAnalyticsPage(pageID, pageName));
    toolbar.querySelector(`#view_${pageID}`).addEventListener("click", () => goToViewPage(pageID, pageName));
    toolbar.querySelector(`#userAccount_${pageID}`).addEventListener("click", () => loadUserAccount(pageID, pageName));
}


// Functions to handle button actions
function goToEditPage(pageID, pageName) {
    window.location.href = `https://reelcareer.co/obituaries/edit.html?pageID=${encodeURIComponent(pageID)}&pageName=${encodeURIComponent(pageName)}`;
}
window.goToEditPage = goToEditPage;

function goToAnalyticsPage(pageID, pageName) {
    window.location.href = `https://reelcareer.co/obituaries/analytics.html?pageID=${encodeURIComponent(pageID)}&pageName=${encodeURIComponent(pageName)}`;
}
window.goToAnalyticsPage = goToAnalyticsPage;

function goToViewPage(pageID, pageName) {
    window.location.href = `https://reelcareer.co/obituaries/celebrating/${encodeURIComponent(pageName)}`;
}
window.goToViewPage = goToViewPage;

function loadUserAccount(pageID, pageName) {
    window.location.href = `https://reelcareer.co/obituaries/account.html?pageID=${encodeURIComponent(pageID)}&pageName=${encodeURIComponent(pageName)}`;
}
window.loadUserAccount = loadUserAccount;




</script>

    <script>
        // Dynamically set the current year
        document.getElementById("currentYear").textContent = new Date().getFullYear();
    </script>
    <script src="https://reelcareer.co/obituaries/setup/analytics.js" type="module"></script>
    
    </body>
    
    
    
    </html>
      