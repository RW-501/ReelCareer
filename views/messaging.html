<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messaging</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    
    <!-- Bootstrap CSS -->
    <script src="https://reelcareer.co/public/js/scripts.js"></script>
    <script src="https://reelcareer.co/public/js/loadScripts.js"></script>
    <!-- Custom CSS -->
    <link rel="stylesheet" href="https://reelcareer.co/public/css/styles.css">
    <style>
        /* Custom styles */

        

#main-content  .container {
    margin-top: 20px;
    background-color: #fff;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

#main-content .row {
    display: flex;
}

/* Contacts List */
#main-content .list-group {
    max-height: 400px;
    overflow-y: auto;
    padding: 10px;
    border-radius: 8px;
    background-color: #f9f9f9;
    border: 1px solid #e0e0e0;
}

#main-content .list-group-item {
    display: flex;
    align-items: center;
    padding: 10px;
    margin-bottom: 5px;
    background-color: #fff;
    border: 1px solid #ddd;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

#main-content .list-group-item:hover {
    background-color: #f0f8ff;
}

#main-content .avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin-right: 10px;
}

/* Messaging Area */
#main-content #messageBox {
    max-height: 400px;
    overflow-y: auto;
    padding: 15px;
    border: 1px solid #ddd;
    border-radius: 8px;
    background-color: #f9f9f9;
    min-height: 300px;
    margin-bottom: .5rem;
}

#main-content .message {
    margin-bottom: 15px;
    padding: 10px;
    border-radius: 8px;
    max-width: 60%;
    word-wrap: break-word;
    position: relative;
}

#main-content .message.sent {
    background-color: #d1f7c4;
    align-self: flex-end;
    margin-left: auto;
}

#main-content .message.received {
    background-color: #f1f0f0;
    align-self: flex-start;
    margin-right: auto;
}

#main-content .media-attachment img,
#main-content .media-attachment video {
    max-width: 100%;
    border-radius: 8px;
    margin-top: 10px;
}

#main-content .timestamp {
    font-size: 0.8em;
    color: #888;
    margin-top: 5px;
}

#main-content .contact-info {
    margin-bottom: 10px;
    background-color: #f9f9f9;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #ddd;
}

/* Input Area */
#main-content .input-group {
    margin-top: 10px;
}

#main-content #messageInput {
    border-radius: 6px;
    border: 1px solid #ccc;
}

#main-content #sendMessageButton {
    background-color: #28a745;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 8px 16px;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

#main-content #sendMessageButton:hover {
    background-color: #218838;
}

#main-content .attachment-area {
    margin-top: 10px;
}

#main-content .attachment-area input {
    border: none;
    border-radius: 6px;
    padding: 5px;
    font-size: 14px;
}

main .row {
    display: flex;
    grid-column-gap: unset;
}



/* Initial style for the sliding panel */


.panel-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.close-btn {
  background-color: transparent;
  border: none;
  font-size: 20px;
  cursor: pointer;
}

.connections-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.connection-item {
    
    display: flex;
    justify-content: space-around;
    align-items: flex-end;
    border: 1px solid #ddd;
    padding: 10px;
    border-radius: 5px;
    background-color: #f9f9f9;
    width: 100%;
    flex-direction: row;
    flex-wrap: wrap;
    align-content: space-between;
    gap: 30%; /* 30% */

}


.connection-item button {
  background-color: #4CAF50;
  color: white;
  border: none;
  padding: 5px 10px;
  cursor: pointer;
}

.connection-item button:hover {
  background-color: #45a049;
}


 
.preview-video,
.preview-image {

    width: 200px;  
}

#attachmentPreview {
    display: grid;
    align-content: stretch;
    justify-content: space-evenly;
    justify-items: end;
}

#interaction-panel {
    position: relative;
    min-height: 500px;
    height: auto;
    width: 100%;
}

#mainConnections-panel {
    position: relative;
    height: 100%;


}

#main-contact-panel {
    position: relative;
    margin-bottom: 50px;
}

#main-message-panel {
    position: relative;
    min-height: 300px;
}

#closeSlidePanelBtn {
    color: color-mix(in lch longer hue, #45a049 45%, #f0f8ff 20%);
}

#controls-contactList-area {
    width: 100% !important;
    display: block;  
}

#controls-contactList-area.controls-wide {
    -ms-flex: none;
        flex: none;
        max-width: none; 
}
main {
    margin-bottom: 20px;
    overflow: hidden;
}
.slide-panel {
  position: relative;
  top: 0;
  right: -150%; /* Initially hidden */
  width: 100%;
  height: 100%;
  background-color: #fff;
  box-shadow: -2px 0 5px rgba(0, 0, 0, 0.2);
  transition: right 0.3s ease;
  z-index: 1000;
  padding: 20px;
  overflow-y: auto;
}

.slide-panel.open {
  right: 0; /* When open, it slides in */
}


.preview-container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 5px;
    border: 1px solid #ddd;
    border-radius: 5px;
    position: relative;
}

.preview-image, .preview-video {
    max-width: 100%;
    max-height: 150px;
}

.unsupported-file {
    padding: 10px;
    background: #f8f9fa;
    border-radius: 5px;
    font-size: 14px;
}


    </style>

</head>


<body>
    <script src="https://reelcareer.co/public/js/bodyload.js"></script>
    
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li id="lastBreadcrumb_home" class="breadcrumb-item"><a href="https://reelcareer.co/">Home</a></li>
            <li id="lastBreadcrumb_1" class="breadcrumb-item"><a id="lastBreadcrumb_1_a" href="https://reelcareer.co/views/user">View Profile</a></li>


            <li id="breadcrumb-active-title" class="breadcrumb-item active" aria-current="page">Messaging</li>
        </ol>
      </nav>
  
  

      <main id="main-content">

        <div class="row">
          <div id='controls-contactList-area' class="col-md-4">
            <h4>Contacts</h4>
            <!-- Button to open the sliding panel -->
            <button id="openSlidePanelBtn" class="btn btn-primary" hidden>View Connections</button>
      
            <ul class="list-group" id="contactList">
              <!-- Contacts will be populated here -->
            </ul>
            <button class="btn btn-primary mt-2" id="composeButton">Compose Message</button>
          </div>
          <div class="col-md-8">
            <div id="interaction-panel">
      
              <div id="mainConnections-panel">
                <!-- Sliding Panel -->
                <div id="connectionsSlidePanel" class="slide-panel">
                  <div class="panel-header">
                    <h3 id="slidePanel-header-text">Connections</h3>
                    <button id="closeSlidePanelBtn" class="close-btn">X</button>
                  </div>
                  <!-- >inside panel -->
      








                  <div id="main-contact-panel">
      
                    <div id="connectionsList" class="connections-list">
                      <!-- Connection items will be dynamically appended here -->
                    </div>
                  </div>
      






                  <div id="main-message-panel">
      
                    <h4 id="conversationTitle">Select a Conversation</h4>
                    <div class="contact-info" id="contactInfo">
                      <!-- Contact info will be displayed here -->
                      <span>No Contact Available </span>
                    </div>
                    <div class="message-box" id="messageBox">
                      <!-- Messages will be displayed here -->
                       <small  style="text-align: center;">No Messages Available</small>
                    </div>
      
                    <div class="message-panel">
                        <div class="message-input-area">
                        
                          <div id="editableDiv" contenteditable="true" 
                          class="message-content-area" 
                          data-placeholder="Type a message..."></div>

                      <!-- Attachment Preview -->

                        <div id="attachmentPreview" class="mt-2 d-none">
                          <div class="preview-container">
                            <span id="removePreview" class="remove-preview">&times;</span>
                            <img id="attachmentImage" class="preview-image" src="" alt="Attachment Preview">
                            <video id="attachmentVideo" class="preview-video" controls src=""></video>
                          </div>
                        </div>
                      </div>

                        </div>
     <!-- Attachment Button -->
     <div class="attachment-container">
        <button class="btn btn-outline-primary" id="chooseFileButton"><i class="fas fa-paperclip"></i>Choose File</button>
        

      <!-- Send Button -->
      <div class="mt-3">
        <button class="btn btn-primary mt-3" id="sendMessageButton">Send</button>
      </div>


                      </div>
             
                    </div>
      <!-- end msg -->




                  </div>
                  
                  <input type="file" id="attachmentInput" class="d-none">
                  <textarea class="form-control" id="messageInput" placeholder="Type a message..."
                  rows="3" style="display:none;"></textarea>





                </div>
      
              </div>
      
            </div>
      
            <!-- >panel end -->
      
          </div>
        </div>
      
      </main>
  
    <!-- >Footer -->
    <footer id="dynamic-footer"></footer>
    
    <!-- Firebase configuration/ Login& Out -->
    <script type="module" src="https://reelcareer.co/public/js/main.js"></script> 

  <!-- Firebase JS SDK and Custom Scripts -->

<script type="module">
    import {
        db, getStorage, ref, uploadBytes, getDownloadURL, limit,
  doc, arrayUnion, RecaptchaVerifier, increment, getDoc, arrayRemove, signInWithPhoneNumber,
  query, updateDoc, setDoc, addDoc, signInAnonymously, orderBy, onAuthStateChanged,
  uploadBytesResumable, signInWithPopup, FacebookAuthProvider, GoogleAuthProvider, startAfter,
  OAuthProvider, signOut, deleteDoc, getFirestore, serverTimestamp,
  createUserWithEmailAndPassword, signInWithEmailAndPassword, deleteObject,
  where, getDocs, storage, getAuth, collection, auth, analytics,
  googleProvider,onSnapshot ,
  facebookProvider,
  getUserId // Export the function
    } from 'https://reelcareer.co/js/module.js';

    
    let userId;
    document.addEventListener('DOMContentLoaded', async () => {
    try {
        userId = await getUserId(); // Await here to properly set userId
        console.log("User ID fetched during DOMContentLoaded:", userId);
        if (userId) {
            loadContacts(userId); // Load contacts if user is authenticated
        } else {
            window.location.href = 'https://reelcareer.co/login';
        }
    } catch (error) {
        console.error("Error fetching user ID:", error);
    }
});
const userDataSaved = getUserData() || [];

const lastBreadcrumb_1_a = document.getElementById("lastBreadcrumb_1_a");
lastBreadcrumb_1_a.innerText = userDataSaved.displayName;



    console.log("userDataSaved: ", userDataSaved);




// Elements
const openSlidePanelBtn = document.getElementById('openSlidePanelBtn');
const controlsContactListArea = document.getElementById('controls-contactList-area');
const closeSlidePanelBtn = document.getElementById('closeSlidePanelBtn');
const connectionsSlidePanel = document.getElementById('connectionsSlidePanel');
const connectionsList = document.getElementById('connectionsList');

// Fetching Connections from the database (assuming you are using Firebase)
async function fetchConnections() {
  try {
    // Assuming `connections` collection is stored in Firebase Firestore


let connectionssRef = collection(db, 'Connections');
const querySnapshot = query(connectionssRef, where('participants', 'array-contains', userID));

    querySnapshot.forEach(doc => {
      const connectionData = doc.data();
      if (connectionData.status == 'pending' || connectionData.status == 'accepted') { // Only show pending connections
        appendConnection(connectionData);
      }
    });
  } catch (error) {
    console.error('Error fetching connections:', error);
  }
}

// Appending a single connection to the list
function appendConnection(connection, type) {

    let connectionId = '';
if(connection.from == userId){
    connectionId = connection.to ; // Use a unique identifier (from sender or receiver ID)

}else{
    connectionId = connection.from ; // Use a unique identifier (from sender or receiver ID)

}

document.getElementById("connectionsList").innerHTML = '';




    const existingConnection = document.querySelector(`[data-connection-id="${connectionId}"]`);

    // Check if the connection is already in the list
    if (existingConnection) {
        console.log(`Connection with ID ${connectionId} already exists.`);
        return; // Exit if the connection already exists
    }

    // Create a new connection item
    const div = document.createElement('div');
    div.classList.add('connection-item');
    div.setAttribute('data-connection-id', connectionId); // Add a unique attribute
   

    if (type === "message") {
        if (connection.senderID === userDataSaved.userID) {

        const connectionInfo = `
        <div>
          <img src="${connection.senderProfilePicture}" alt="Profile" width="40" height="40">
          <a href="https://reelcareer.co/views/user?u=${connection.senderID}" target="_blank">${connection.senderName}</a>
        </div>
        <button onclick="acceptConnection('${connection.senderID}', '${connection.recipientID}')">Accept</button>
        `;
    }else   if (connection.recipientID === userDataSaved.userID){
        const connectionInfo = `
        <div>
          <img src="${connection.profilePicture}" alt="Profile" width="40" height="40">
          <a href="https://reelcareer.co/views/user?u=${connection.recipientID}" target="_blank">${connection.recipientName}</a>
        </div>
        <button onclick="acceptConnection('${connection.recipientID}', '${connection.senderID}')">Accept</button>
        `;


    }
        div.innerHTML = connectionInfo;

    } else {

        const noteDiv = document.createElement('div');
        noteDiv.classList.add('connection-note');

        if (connection.status === "pending") {
            if (connection.from === userDataSaved.userID) {
                const connectionInfo = `
                <div>
                  <img src="${connection.toProfilePicture}" alt="Profile" width="40" height="40">
                  <a href="${connection.toProfileURL}" target="_blank">${connection.toName}</a>
                </div>
                <button onclick="acceptConnection('${connection.to}', '${connection.from}')">Accept</button>
                `;
                div.innerHTML = connectionInfo;
                noteDiv.innerHTML = connection.fromNote;
                div.appendChild(noteDiv);


                composeMessages(connection.from, connection);

            } else if (connection.to === userDataSaved.userID) {
                const connectionInfo = `
                <div>
                  <img src="${connection.fromProfilePicture}" alt="Profile" width="40" height="40">
                  <a href="${connection.fromProfileURL}" target="_blank">${connection.fromName}</a>
                </div>
                <button onclick="removeConnection('${connection.from}', '${connection.to}')">Remove</button>
                `;
                div.innerHTML = connectionInfo;


                composeMessages(connection.to, connection);

            }
   

            
 const contactInfoDiv = document.createElement('div');
 contactInfoDiv.classList.add('connection-item');
 const contactInfo = `
                ${connection}"
                `;
                contactInfoDiv.innerHTML = contactInfo;

        } else   if (connection.status === "accepted") {



            console.log("userDataSaved.userID: ", userDataSaved.userID);
            console.log("connection.from: ", connection.from);
            console.log("connection.to: ", connection.to);

            if (connection.from == userDataSaved.userID) {
             
                const connectionInfo = `
                <div>
                  <img src="${connection.toProfilePicture}" alt="Profile" width="40" height="40">
                  <a href="${connection.toProfileURL}" target="_blank">${connection.toName}</a>
                </div>
            <button onclick="viewProfile('${connection.to}')">from View Profile</button>
                `;
                div.innerHTML = connectionInfo;




           
            composeMessages(connection.from, connection);

            } else if (connection.to == userDataSaved.userID) {

                const connectionInfo = `
            <div>
              <img src="${connection.fromProfilePicture}" alt="Profile" width="40" height="40">
              <a href="${connection.fromProfileURL}" target="_blank">${connection.fromName}</a>
            </div>
            <button onclick="viewProfile('${connection.from}')">to View Profile</button>
            `;
            div.innerHTML = connectionInfo;
   
           

                composeMessages(connection.to, connection);
            }



            
        }
    }
    // Append the new connection to the list
    connectionsList.appendChild(div);

    const openEvent = new CustomEvent("click", { detail: "open" });
    openSlidePanelBtn.dispatchEvent(openEvent);

}


// Asynchronous changeGroup function
async function changeGroup(contactId, newGroup, Group) { 
  try {
    // Example using Firestore
    const connectionRef = doc(firestore, "Connections", contactId);
    await updateDoc(connectionRef, { Group: newGroup });
    console.log(`Group updated to "${newGroup}" for contact "${contactId}"`);
  } catch (error) {
    console.error("Error updating group:", error);
  }
}

// Set the changeGroup function globally
window.changeGroup = changeGroup;



document.getElementById("editableDiv").addEventListener("keydown", (event) => {
  // Check if Enter key is pressed
  if (event.key === "Enter") {
    event.preventDefault(); // Prevent default Enter behavior (e.g., line break)
    const sendMessageButton = document.getElementById("sendMessageButton");

    // Focus on the Send Message button
    sendMessageButton.focus();

    // Optionally, trigger a click if you want to send the message immediately
    // sendMessageButton.click();
  }
});

function viewProfile(userId){
    if (userId) {
      window.location.href = `https://reelcareer.co/views/user?u=${userId}`;
    }
}

window.viewProfile = viewProfile;

function composeMessages(conversationID, data) {

console.log("data: ", data);

const messageBox = document.getElementById('messageBox');
const conversationTitle = document.getElementById('conversationTitle');
const contactInfo = document.getElementById('contactInfo');

 if (data.to === userDataSaved.userID) {

conversationTitle.innerHTML = `
<a href="https://reelcareer.co/views/user?u=${data.from}" style="text-decoration: none; color: inherit;">
    <img src="${data.fromProfilePicture || 'default-image-url'}" alt="Avatar" class="avatar">
</a>
<span>${data.fromName || 'Unknown Sender'}</span>
`;  
contactInfo.setAttribute("data-conversation-id",conversationID);
contactInfo.setAttribute("data-conversation-name",data.fromName);
contactInfo.setAttribute("data-conversation-picture",data.fromProfilePicture);
contactInfo.innerHTML = `<p>Contact: ${data.fromName}</p>
<p>Connection: <small>${data.status}</small></p>`; 


// Create the select input element
const selectInput = document.createElement('select');
selectInput.id = `groupSelect${group.groupName}`;
selectInput.onchange = function () {
    const selectedOption = this.options[this.selectedIndex];
    changeGroup(userDataSaved.userID, selectedOption.value, "toGroup");
};

// Example groups (single user)
const groups = [
    { groupName: "Co-workers" },
    { groupName: "Recruiters" },
    { groupName: "Networking" },
    { groupName: "Friends" },
    { groupName: "Blocked" }
];

// Populate the select input with groups
groups.forEach(group => {
    const option = document.createElement('option');
    option.value = group.groupName; // The group name will be the value
    option.textContent = `Group: (${group.groupName})`; // Display the group name
    selectInput.appendChild(option);
});


const groupDiv = document.createElement('div');
groupDiv.classList.add('connection-group');
groupDiv.appendChild(selectInput);

// Assuming conversationTitle is defined elsewhere
conversationTitle.appendChild(groupDiv);




} else if (data.from === userDataSaved.userID) {
    conversationTitle.innerHTML = `
<a href="https://reelcareer.co/views/user?u=${data.to}" style="text-decoration: none; color: inherit;">
    <img src="${data.toProfilePicture || 'default-image-url'}" alt="Avatar" class="avatar">
</a>
<span>${data.toName || 'Unknown Sender'}</span>
`;  
contactInfo.setAttribute("data-conversation-id",conversationID);
contactInfo.setAttribute("data-conversation-name",data.toName);
contactInfo.setAttribute("data-conversation-picture",data.toProfilePicture);
contactInfo.innerHTML = `<p>Contact: ${data.toName}</p>
<p>Connection: <small>${data.status}</small></p>`;  

// Create the select input element
const selectInput = document.createElement('select');
selectInput.id = `groupSelect${group.groupName}`;
selectInput.onchange = function () {
    const selectedOption = this.options[this.selectedIndex];
    changeGroup(userDataSaved.userID, selectedOption.value, "fromGroup");
};

// Example groups (single user)
const groups = [
    { groupName: "Co-workers" },
    { groupName: "Recruiters" },
    { groupName: "Networking" },
    { groupName: "Friends" },
    { groupName: "Blocked" }
];

// Populate the select input with groups
groups.forEach(group => {
    const option = document.createElement('option');
    option.value = group.groupName; // The group name will be the value
    option.textContent = `Group: (${group.groupName})`; // Display the group name
    selectInput.appendChild(option);
});

const groupDiv = document.createElement('div');
groupDiv.classList.add('connection-group');
groupDiv.appendChild(selectInput);

// Assuming conversationTitle is defined elsewhere
conversationTitle.appendChild(groupDiv);

}

loadMessages(data.participants);

console.log("conversationID: ", conversationID);


//messageBox.innerHTML = '';

}
window.composeMessages  = composeMessages ;




// Function to accept a connection
async function removeConnection(fromID, toID) {
  try {
    // Update the status of the connection to 'accepted'
/*
    const docId = userId < userIdFromURL 
      ? `${userId}_${userIdFromURL}`
      : `${userIdFromURL}_${userId}`;
    const connectionRef = doc(db, 'Connections', docId);
*/
    const connectionRef = doc(db, 'Connections', `${fromID}_${toID}`);
    await updateDoc(connectionRef, {
      status: 'denied'
    });
    
    showToast('Connection removed!');
    // Refresh the list of connections
    connectionsList.innerHTML = '';
    fetchConnections();
  } catch (error) {
    console.error('Error denied connection:', error);
    showToast('Failed to denied connection.');
  }
}
window.removeConnection  = removeConnection ;


// Function to accept a connection
async function acceptConnection(fromID, toID) {
  try {
    // Update the status of the connection to 'accepted'
    const connectionRef = doc(db, 'Connections', `${fromID}_${toID}`);
    await updateDoc(connectionRef, {
      status: 'accepted'
    });
    
    showToast('Connection accepted!');
    // Refresh the list of connections
    connectionsList.innerHTML = '';
    fetchConnections();
  } catch (error) {
    console.error('Error accepting connection:', error);
    showToast('Failed to accept connection.');
  }
}
window.acceptConnection  = acceptConnection ;



const breadcrumbActiveTitle = document.getElementById("breadcrumb-active-title");
openSlidePanelBtn.addEventListener('click', (e) => {

    console.log("event...: ", e);

    if (e.detail === "open") {
    console.log("Open action triggered.");
    
    

    }


// Open or close the sliding panel on button click
    // Check if the class 'open' is present in the connectionsSlidePanel
    if (!connectionsSlidePanel.classList.contains('open') || e.detail === "open") {
        // If not open, open the sliding panel and modify the contact list area
        connectionsSlidePanel.classList.add('open');
        controlsContactListArea.classList.replace('controls-narrow', 'controls-wide');
        // Set the new title
document.title = `ReelCareer.co | ${userDataSaved.profilePicture} - Connections`;
    } else {
        // If already open, toggle the classes
        connectionsSlidePanel.classList.remove('open');
        controlsContactListArea.classList.remove('controls-wide');
        controlsContactListArea.classList.add('controls-narrow');
        // Set the new title
document.title = `ReelCareer.co | ${userDataSaved.profilePicture} - Messaging`;
    }

    // Toggle the text based on the panel state
    breadcrumbActiveTitle.innerText = connectionsSlidePanel.classList.contains('open') ? "Messaging" : "Connections";
});


// Add an additional event listener to breadcrumbActiveTitle
breadcrumbActiveTitle.addEventListener('click', () => {
    // You can handle what happens when the breadcrumbActiveTitle is clicked here
    // For example, you could toggle the panel or perform any other action
    console.log('Breadcrumb clicked!');
    // If you want to trigger the openSlidePanelBtn's functionality again
    openSlidePanelBtn.click(); // This will trigger the same functionality as the button click
});


// Close the sliding panel
closeSlidePanelBtn.addEventListener('click', () => {
  connectionsSlidePanel.classList.remove('open');
  controlsContactListArea.classList.remove('controls-wide');
  breadcrumbActiveTitle.innerText =  "Connections";
});










function loadContacts(userID) { 
    console.log("userID:", userID);

    const contactList = document.getElementById('contactList');
    contactList.innerHTML = '';  // Clear the existing content

    const createSection = (sectionTitle) => {
        const sectionDiv = document.createElement('div');
        sectionDiv.classList.add('contact-list');

        const titleDiv = document.createElement('div');
        titleDiv.classList.add('title');
        titleDiv.innerText = sectionTitle;

        sectionDiv.appendChild(titleDiv);
        return sectionDiv;
    };

    const messageSection = createSection('Messages');
    contactList.appendChild(messageSection);

    let contactsRef = collection(db, 'Messages');
    let messagesQuery = query(contactsRef, where('participants', 'array-contains', userID));
    
    // Map to track displayed messages
    const displayedMessages = new Set();

    onSnapshot(messagesQuery, snapshot => {
        snapshot.forEach(doc => {
            const docID = doc.id;
            if (displayedMessages.has(docID)) return; // Skip if already displayed
            
            displayedMessages.add(docID); // Mark as displayed
            const data = doc.data();
            const listItem = document.createElement('li');
            listItem.className = 'list-group-item msg-list-i';

            listItem.innerHTML = `
                <a href="https://reelcareer.co/views/user?u=${data.senderID}" style="text-decoration: none;color: inherit;">
                    <img src="${data.senderProfilePicture || 'https://reelcareer.co/images/sq_logo_n_BG_tie_reel.png'}" alt="Avatar" class="avatar">
                </a>
                <span>${data.senderName}</span>
            `;

            listItem.onclick = () => appendConnection(data, "message"), composeMessages(data.participants, data),
            messageSection.appendChild(listItem);
        });
    });

    const connectionsSection = createSection('Connections');
    contactList.appendChild(connectionsSection);

    const titlePending = document.createElement('div');
    titlePending.classList.add('Pending-title');
    titlePending.innerHTML = "<small>Pending</small>";
    connectionsSection.appendChild(titlePending);

    const titleSent = document.createElement('div');
    titleSent.classList.add('Sent-title');
    titleSent.innerHTML = "<small>Sent</small>";
    connectionsSection.appendChild(titleSent);

    const titleAccepted = document.createElement('div');
    titleAccepted.classList.add('Connected-title');
    titleAccepted.innerHTML = "<small>Connected</small>";
    connectionsSection.appendChild(titleAccepted);

    const connectionsRef = collection(db, 'Connections');
    const connectionsQuery = query(connectionsRef, where('participants', 'array-contains', userID));

    // Map to track displayed connections
    const displayedConnections = new Set();

    onSnapshot(connectionsQuery, snapshotConnections => {
        snapshotConnections.forEach(doc => {
            const docID = doc.id;
            if (displayedConnections.has(docID)) return; // Skip if already displayed

            displayedConnections.add(docID); // Mark as displayed
            const data = doc.data();
            const listItem = document.createElement('li');
            listItem.className = 'list-group-item conn-list-i';

            if ((data.status === "pending" || data.status === "accepted") && data.from === userID) {
    // Case where the user is the sender
    listItem.innerHTML = `
        <a href="${data.toProfileURL}" style="text-decoration: none;color: inherit;">
            <img src="${data.toProfilePicture || 'https://reelcareer.co/images/sq_logo_n_BG_tie_reel.png'}" alt="Avatar" class="avatar">
        </a>
        <span>${data.toName}</span>
    `;
} else if ((data.status === "pending" || data.status === "accepted") && data.to === userID) {
    // Case where the user is the recipient
    listItem.innerHTML = `
        <a href="${data.fromProfileURL}" style="text-decoration: none;color: inherit;">
            <img src="${data.fromProfilePicture || 'https://reelcareer.co/images/sq_logo_n_BG_tie_reel.png'}" alt="Avatar" class="avatar">
        </a>
        <span>${data.fromName}</span>
    `;
} else if ((data.status === "pending" || data.status === "accepted") && data.from !== userID) {
    // Case where the user is neither the sender nor the recipient
    listItem.innerHTML = `
        <a href="${data.fromProfileURL}" style="text-decoration: none;color: inherit;">
            <img src="${data.fromProfilePicture || 'https://reelcareer.co/images/sq_logo_n_BG_tie_reel.png'}" alt="Avatar" class="avatar">
        </a>
        <span>${data.fromName}</span>
    `;
}


            listItem.addEventListener('click', () => {
    appendConnection(data); // Call your function to append connection
});

            if (data.status === "pending") {
                if (data.from === userID) {
                    titleSent.appendChild(listItem);
                } else {
                    titlePending.appendChild(listItem);
                }
            } else if (data.status === "accepted") {
                titleAccepted.appendChild(listItem);
            }
            const openEvent = new CustomEvent("click", { detail: "open" });
            openSlidePanelBtn.dispatchEvent(openEvent);
        });
    });
}

    function loadMessages(participants, data) {

        console.log("data: ", data);

        const messageBox = document.getElementById('messageBox');
        const conversationTitle = document.getElementById('conversationTitle');
        const contactInfo = document.getElementById('contactInfo');

     

        
        messageBox.innerHTML = '';
        const messagesRef = collection(db, 'Messages'); //array-contains
        const q = query(messagesRef, where('participants', 'array-contains-any', participants), orderBy('createdAt'));
   
        
        onSnapshot(q, snapshot => {
            messageBox.innerHTML = ''; // Clear previous messages
            snapshot.forEach(doc => {
                const data = doc.data();
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${data.senderID === auth.currentUser.uid ? 'sent' : 'received'}`;
                messageDiv.textContent = data.content;

                if (data.contentType !== 'text') {
    const mediaDiv = document.createElement('div');
    mediaDiv.className = 'media-attachment';

    if (data.contentType === 'image') {
        const img = document.createElement('img');
        img.src = data.attachmentUrl;
        img.alt = 'Image Attachment';
        mediaDiv.appendChild(img);
    } else if (data.contentType === 'video') {
        const video = document.createElement('video');
        video.src = data.attachmentUrl;
        video.controls = true;
        mediaDiv.appendChild(video);
    } else if (data.contentType === 'audio') {
        const audio = document.createElement('audio');
        audio.src = data.attachmentUrl;
        audio.controls = true;
        mediaDiv.appendChild(audio);
    } else if (data.contentType === 'document' || data.contentType === 'office-document') {
        const docLink = document.createElement('a');
        docLink.href = data.attachmentUrl;
        docLink.target = '_blank';
        docLink.textContent = 'View Document';
        mediaDiv.appendChild(docLink);
    } else if (data.contentType === 'archive') {
        const archiveLink = document.createElement('a');
        archiveLink.href = data.attachmentUrl;
        archiveLink.target = '_blank';
        archiveLink.textContent = 'Download Archive';
        mediaDiv.appendChild(archiveLink);
    } else {
        const unsupportedMessage = document.createElement('p');
        unsupportedMessage.textContent = 'Unsupported content type.';
        mediaDiv.appendChild(unsupportedMessage);
    }

   

                    messageDiv.appendChild(mediaDiv);
                }
                const timestampDiv = document.createElement('div');
timestampDiv.className = 'timestamp';
timestampDiv.textContent = new Date(data.createdAt.seconds * 1000).toLocaleString();
messageDiv.appendChild(timestampDiv);

                messageBox.appendChild(messageDiv);
            });
            messageBox.scrollTop = messageBox.scrollHeight;
        }, 
    error => {
        console.error("Error fetching messages:", error.message);
        showToast("Unable to load messages. Please try again.", 'error');
    }
);
    }
 document.getElementById('chooseFileButton').addEventListener('click', () => {
    document.getElementById('attachmentInput').click();
});

document.getElementById('attachmentInput').addEventListener('change', (e) => {
    const file = e.target.files[0];
    const fileUrl = file ? URL.createObjectURL(file) : null;

    const attachmentPreview = document.getElementById('attachmentPreview');
    const imagePreview = document.getElementById('attachmentImage');
    const videoPreview = document.getElementById('attachmentVideo');
    const unsupportedFile = document.getElementById('unsupportedFile');
    const fileName = document.getElementById('fileName');

    if (file) {
        attachmentPreview.classList.remove('d-none');
        
        if (file.type.startsWith('image/')) {
            imagePreview.src = fileUrl;
            imagePreview.classList.remove('d-none');
            videoPreview.classList.add('d-none');
            unsupportedFile.classList.add('d-none');
        } else if (file.type.startsWith('video/')) {
            videoPreview.src = fileUrl;
            videoPreview.classList.remove('d-none');
            imagePreview.classList.add('d-none');
            unsupportedFile.classList.add('d-none');
        } else {
            fileName.textContent = file.name;
            unsupportedFile.classList.remove('d-none');
            imagePreview.classList.add('d-none');
            videoPreview.classList.add('d-none');
        }
    }
});

document.getElementById('removePreview').addEventListener('click', () => {
    const attachmentInput = document.getElementById('attachmentInput');
    const attachmentPreview = document.getElementById('attachmentPreview');
    const imagePreview = document.getElementById('attachmentImage');
    const videoPreview = document.getElementById('attachmentVideo');
    const unsupportedFile = document.getElementById('unsupportedFile');

    attachmentInput.value = ''; // Clear input value
    attachmentPreview.classList.add('d-none'); // Hide preview area
    imagePreview.classList.add('d-none');
    videoPreview.classList.add('d-none');
    unsupportedFile.classList.add('d-none');
});

document.addEventListener('DOMContentLoaded', () => {
    const editableDiv = document.getElementById('editableDiv');
  const messageInput = document.getElementById('messageInput');

  // Synchronize text from editableDiv to textarea on keyup
  editableDiv.addEventListener('keyup', () => {
    messageInput.value = editableDiv.innerHTML.trim(); // Keep the value synced
  });


    document.getElementById('sendMessageButton').addEventListener('click', async () => {
    const attachmentInput = document.getElementById('attachmentInput').files[0];
    const conversationID = document.getElementById('conversationTitle')?.getAttribute('data-conversation-id');
   

    const message = messageInput.value.trim();

    if (!message && !attachmentInput) {
        showToast("Please enter a message or attach a file.", 'warning');
        return;
    }

    if (!conversationID) {
        showToast("Something is not right. Please refresh the page.", 'warning');
        return;
    }

    try {
        let attachmentUrl = '';
        if (attachmentInput) {
            attachmentUrl = await uploadAttachment(conversationID, attachmentInput);
        }

        await sendMessage(message, attachmentUrl);
        
     // Reset inputs after successful send
     editableDiv.innerHTML = ''; // Clear the editable div
      messageInput.value = ''; // Clear hidden textarea
        document.getElementById('removePreview').click();
        showToast("Message sent successfully!", 'success');
    } catch (error) {
        console.error("Error sending message:", error.message);
        showToast("Failed to send message. Please try again.", 'error');
    }
});

});

async function uploadAttachment(conversationID, file) {
    try {
        // Create a storage reference dynamically based on conversationID and file name
        const fileRef = storageRef(storage, `messages/${conversationID}/${file.name}`);

        // Upload the file to Firebase Storage
        const snapshot = await uploadBytes(fileRef, file);

        // Get the download URL for the uploaded file
        return await getDownloadURL(snapshot.ref);
    } catch (error) {
        console.error("Error uploading attachment:", error);
        throw new Error('Failed to upload attachment.'); // Handle this in calling function
    }
}


function sendMessage( message, attachmentUrl = '') { 
    const determineContentType = (url) => {
        const fileExtension = url.split('.').pop().toLowerCase(); // Get file extension
        switch (fileExtension) {
            case 'jpg':
            case 'jpeg':
            case 'png':
            case 'gif':
                return 'image';
            case 'mp4':
            case 'mov':
            case 'avi':
            case 'mkv':
                return 'video';
            case 'mp3':
            case 'wav':
            case 'aac':
                return 'audio';
            case 'pdf':
                return 'document';
            case 'doc':
            case 'docx':
            case 'xls':
            case 'xlsx':
            case 'ppt':
            case 'pptx':
                return 'office-document';
            case 'zip':
            case 'rar':
                return 'archive';
            default:
                return 'unknown';
        }
    };

    const contentType = attachmentUrl ? determineContentType(attachmentUrl) : 'text';

     const userDataSaved = getUserData() || [];
    const senderID = auth.currentUser.uid;

    console.log("USERDATA: ", USERDATA);
    console.log("UserData: ", UserData);
    console.log("UserID: ", UserID);
    console.log("UserId: ", UserId);
    console.log("senderID: ", senderID);
    console.log("userDataSaved: ", userDataSaved);

    const conversationID = document.getElementById('conversationTitle')?.getAttribute('data-conversation-id');
    const conversationtName = document.getElementById('conversationTitle')?.getAttribute('data-conversation-name');
    const conversationPicture = document.getElementById('conversationTitle')?.getAttribute('data-conversation-picture');

    addDoc(collection(db, 'Messages'), {


        recipientID: conversationID,
        recipientName: conversationtName,
        recipientProfileURL: `https://reelcareer.co/views/user?u=${conversationID}`,
        recipientProfilePicture:  conversationPicture,
        recipientRead: false,

   
        participants: [userDataSaved.userID, conversationID], // Add this array

  
        senderID: userDataSaved.userID || auth.currentUser.uid || senderID,
        senderName: userDataSaved.displayName,
        senderProfilePicture: userDataSaved.profilePicture,
        senderProfileURL: `https://reelcareer.co/views/user?u=${userDataSaved.userID}`,

        group: 'main',
        messageType: 'chat',
        type: 'message',

        conversationID: conversationID,
        content: message.trim(), // Trim to avoid sending blank spaces
        connectedBool: connectedBool,
        createdAt: new Date(),
        timestamp: serverTimestamp(),
        contentType: contentType,
        status: 'unread',
        attachments: attachmentUrl,
        isDeleted: false
    }).then(() => {
        document.getElementById('editableDiv').innerHTML = ''; // Clear input
        document.getElementById('messageInput').value = ''; // Clear input
        document.getElementById('attachmentInput').value = ''; // Clear attachment
    }).catch(error => {
        showToast("Error sending message: " + error.message, 'error');
    });
}



   </script>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.0.7/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>
</html>
