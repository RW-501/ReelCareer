<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messaging</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    
    <!-- Bootstrap CSS -->
    <script src="https://reelcareer.co/public/js/scripts.js"></script>
    <script src="https://reelcareer.co/public/js/loadScripts.js"></script>
    <!-- Custom CSS -->
    <link rel="stylesheet" href="https://reelcareer.co/public/css/styles.css">
    <style>
        /* Custom styles */

        

#main-content  .container {
    margin-top: 20px;
    background-color: #fff;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

#main-content .row {
    display: flex;
}

/* Contacts List */
#main-content .list-group {
    max-height: 400px;
    overflow-y: auto;
    padding: 10px;
    border-radius: 8px;
    background-color: #f9f9f9;
    border: 1px solid #e0e0e0;
}

#main-content .list-group-item {
    display: flex;
    align-items: center;
    padding: 10px;
    margin-bottom: 5px;
    background-color: #fff;
    border: 1px solid #ddd;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

#main-content .list-group-item:hover {
    background-color: #f0f8ff;
}

#main-content .avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin-right: 10px;
}

/* Messaging Area */
#main-content #messageBox {
    max-height: 400px;
    overflow-y: auto;
    padding: 15px;
    border: 1px solid #ddd;
    border-radius: 8px;
    background-color: #f9f9f9;
}

#main-content .message {
    margin-bottom: 15px;
    padding: 10px;
    border-radius: 8px;
    max-width: 60%;
    word-wrap: break-word;
    position: relative;
}

#main-content .message.sent {
    background-color: #d1f7c4;
    align-self: flex-end;
    margin-left: auto;
}

#main-content .message.received {
    background-color: #f1f0f0;
    align-self: flex-start;
    margin-right: auto;
}

#main-content .media-attachment img,
#main-content .media-attachment video {
    max-width: 100%;
    border-radius: 8px;
    margin-top: 10px;
}

#main-content .timestamp {
    font-size: 0.8em;
    color: #888;
    margin-top: 5px;
}

#main-content .contact-info {
    margin-bottom: 10px;
    background-color: #f9f9f9;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #ddd;
}

/* Input Area */
#main-content .input-group {
    margin-top: 10px;
}

#main-content #messageInput {
    border-radius: 6px;
    border: 1px solid #ccc;
}

#main-content #sendMessageButton {
    background-color: #28a745;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 8px 16px;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

#main-content #sendMessageButton:hover {
    background-color: #218838;
}

#main-content .attachment-area {
    margin-top: 10px;
}

#main-content .attachment-area input {
    border: none;
    border-radius: 6px;
    padding: 5px;
    font-size: 14px;
}

main .row {
    display: flex;
    grid-column-gap: unset;
}
    </style>

</head>


<body>
    <script src="https://reelcareer.co/public/js/bodyload.js"></script>
    
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li id="lastBreadcrumb_home" class="breadcrumb-item"><a href="https://reelcareer.co/">Home</a></li>
          <li class="breadcrumb-item active" aria-current="page">Messaging</li>
        </ol>
      </nav>

      <main id="main-content">

            <div class="row">
                <div class="col-md-4">
                    <h4>Contacts</h4>
                    <ul class="list-group" id="contactList">
                        <!-- Contacts will be populated here -->
                    </ul>
                    <button class="btn btn-primary mt-2" id="composeButton">Compose Message</button>
                </div>
                <div class="col-md-8">
                    <h4 id="conversationTitle">Select a Conversation</h4>
                    <div class="contact-info" id="contactInfo">
                        <!-- Contact info will be displayed here -->
                    </div>
                    <div class="message-box" id="messageBox">
                        <!-- Messages will be displayed here -->
                    </div>
                    <div class="input-group mt-3">
                        <input type="text" class="form-control" id="messageInput" placeholder="Type a message...">
                        <div class="input-group-append">
                            <button class="btn btn-success" id="sendMessageButton">Send</button>
                        </div>
                    </div>
                    <div class="attachment-area mt-2">
                        <input type="file" id="attachmentInput" class="form-control-file">
                    </div>
                </div>
            </div>

        </main>
  
    <!-- >Footer -->
    <footer id="dynamic-footer"></footer>
    
    <!-- Firebase configuration/ Login& Out -->
    <script type="module" src="https://reelcareer.co/public/js/main.js"></script> 

  <!-- Firebase JS SDK and Custom Scripts -->

<script type="module">
    import {
        getUserId, db, doc, getDoc, query, updateDoc,
        setDoc, ref, signInWithPopup, orderBy,onSnapshot ,
         
        uploadBytes, OAuthProvider, arrayUnion, getStorage,
        signOut, addDoc, increment, onAuthStateChanged,
        createUserWithEmailAndPassword, signInWithEmailAndPassword,
        where, getDocs, storage, collection, deleteObject, 
        auth, analytics, deleteDoc, getDownloadURL
    } from 'https://reelcareer.co/js/module.js';

   let userId;
    document.addEventListener('DOMContentLoaded', async () => {
    try {
        userId = await getUserId(); // Await here to properly set userId
        console.log("User ID fetched during DOMContentLoaded:", userId);
        if (userId) {
            loadContacts(userId); // Load contacts if user is authenticated
        } else {
            window.location.href = 'https://reelcareer.co/login';
        }
    } catch (error) {
        console.error("Error fetching user ID:", error);
    }
});



    function loadContacts(userID) {
        console.log("userID: ", userID);

        const contactList = document.getElementById('contactList');
        contactList.innerHTML = '';

        let contactsRef = collection(db, 'Messages');
        let q = query(contactsRef, where('recipientID', '==', userID));

        onSnapshot(q, snapshot => {

            snapshot.forEach(doc => {
                const data = doc.data();
                const listItem = document.createElement('li');
                listItem.className = 'list-group-item';
                listItem.innerHTML = `
      <a href="https://reelcareer.co/views/user/?u=${data.senderID}" style="text-decoration: none;color: inherit;">
        <img src="${data.senderProfilePicture || 'https://reelcareer.co/images/sq_logo_n_BG_tie_reel.png'}" alt="Avatar" class="avatar"></a>
    <span>${data.senderName}</span>
`;
listItem.onclick = () => loadMessages(data.conversationID, data);
contactList.appendChild(listItem);
            });
        });

         contactsRef = collection(db, 'Connections');
         q = query(contactsRef, where('recipientID', '==', userID));

        onSnapshot(q, snapshot => {

            snapshot.forEach(doc => {
                const data = doc.data();
                const listItem = document.createElement('li');
                listItem.className = 'list-group-item';
                listItem.innerHTML = `
    <img src="${data.senderProfilePicture || 'https://reelcareer.co/images/sq_logo_n_BG_tie_reel.png'}" alt="Avatar" class="avatar">
    <span>${data.to}</span>
`;
                listItem.onclick = () => loadMessages(data.conversationID, data);
                contactList.appendChild(listItem);
            });
        });


    }

    function loadMessages(conversationID, data) {

        console.log("data: ", data);

        const messageBox = document.getElementById('messageBox');
        const conversationTitle = document.getElementById('conversationTitle');
        const contactInfo = document.getElementById('contactInfo');

        
        conversationTitle.innerHTML = `Conversation with <a href="https://reelcareer.co/views/user/?u=${data.senderID}" style="text-decoration: none;color: inherit;">
        <img src="${data.senderProfilePicture || 'https://reelcareer.co/images/sq_logo_n_BG_tie_reel.png'}" alt="Avatar" class="avatar"></a>
    <span>${data.senderName}</span>  data-conversation-id="${conversationID}"
`;
        contactInfo.innerHTML = `<p>Contact: ${data.senderName}</p><p>Status: Online</p>`; // Display contact info dynamically
        console.log("conversationID: ", conversationID);
        console.log("contactID: ", data.contactID);

        messageBox.innerHTML = '';
        const messagesRef = collection(db, 'Messages');
        const q = query(messagesRef, where('conversationID', '==', conversationID), orderBy('createdAt'));

        onSnapshot(q, snapshot => {
            messageBox.innerHTML = ''; // Clear previous messages
            snapshot.forEach(doc => {
                const data = doc.data();
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${data.senderID === auth.currentUser.uid ? 'sent' : 'received'}`;
                messageDiv.textContent = data.content;

                if (data.contentType !== 'text') {
                    const mediaDiv = document.createElement('div');
                    mediaDiv.className = 'media-attachment';
                    if (data.contentType === 'image') {
                        const img = document.createElement('img');
                        img.src = data.attachmentUrl;
                        img.alt = 'Image Attachment';
                        mediaDiv.appendChild(img);
                    } else if (data.contentType === 'video') {
                        const video = document.createElement('video');
                        video.src = data.attachmentUrl;
                        video.controls = true;
                        mediaDiv.appendChild(video);
                    }
                    messageDiv.appendChild(mediaDiv);
                }
                const timestampDiv = document.createElement('div');
timestampDiv.className = 'timestamp';
timestampDiv.textContent = new Date(data.createdAt.seconds * 1000).toLocaleString();
messageDiv.appendChild(timestampDiv);

                messageBox.appendChild(messageDiv);
            });
            messageBox.scrollTop = messageBox.scrollHeight;
        }, 
    error => {
        console.error("Error fetching messages:", error.message);
        showToast("Unable to load messages. Please try again.", 'error');
    }
);
    }

    document.getElementById('sendMessageButton').onclick = async () => {
    const messageInput = document.getElementById('messageInput');
    const conversationID = document.getElementById('conversationTitle').getAttribute('data-conversation-id');
    const message = messageInput.value;
    const attachmentInput = document.getElementById('attachmentInput').files[0];
    const profilePic = document.getElementById('nav-bar-profilePic').src;

    if (!message && !attachmentInput) {
        showToast("Please enter a message or attach a file.", 'warning');
        return;
    }

    try {
        let attachmentUrl = '';
        if (attachmentInput) {
            attachmentUrl = await uploadAttachment(conversationID, attachmentInput);
        }
        await sendMessage(conversationID, message, attachmentUrl);
        messageInput.value = ''; // Clear input
        document.getElementById('attachmentInput').value = ''; // Clear attachment
    } catch (error) {
        console.error("Error sending message:", error.message);
        showToast("Failed to send message. Please try again.", 'error');
    }
};


function sendMessage(conversationID, message, attachmentUrl = '') {
        addDoc(collection(db, 'Messages'), {
            senderID: auth.currentUser.uid,
            recipientID: conversationID,
            conversationID: conversationID,
            profilePicture: profilePic,
            content: message,
            contentType: attachmentUrl ? (attachmentUrl.match(/\.(jpg|png)$/) ? 'image' : 'video') : 'text',
            attachments: attachmentUrl,

            messageType: 'contact',
            group: 'main',
            createdAt: serverTimestamp(),

    read: false,
    status: "unread",
    isDeleted: false
        }).then(() => {
            document.getElementById('messageInput').value = ''; // Clear input
            document.getElementById('attachmentInput').value = ''; // Clear attachment
        }).catch(error => {
            showToast("Error sending message: " + error.message, 'error');
        });
    }    
    
    async function uploadAttachment(conversationID, file) {
    const fileRef = storageRef(storage, `messages/${conversationID}/${file.name}`);
    const snapshot = await uploadBytes(fileRef, file);
    return getDownloadURL(snapshot.ref);
}

    
    
    </script>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.0.7/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>
</html>
