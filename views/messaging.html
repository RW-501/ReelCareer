<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messaging</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    
    <!-- Bootstrap CSS -->
    <script src="https://reelcareer.co/public/js/scripts.js"></script>
    <script src="https://reelcareer.co/public/js/loadScripts.js"></script>
    <!-- Custom CSS -->
    <link rel="stylesheet" href="https://reelcareer.co/public/css/styles.css">
    <style>
        /* Custom styles */

        

#main-content  .container {
    margin-top: 20px;
    background-color: #fff;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

#main-content .row {
    display: flex;
}

/* Contacts List */
#main-content .list-group {
    max-height: 400px;
    overflow-y: auto;
    padding: 10px;
    border-radius: 8px;
    background-color: #f9f9f9;
    border: 1px solid #e0e0e0;
}

#main-content .list-group-item {
    display: flex;
    align-items: center;
    padding: 10px;
    margin-bottom: 5px;
    background-color: #fff;
    border: 1px solid #ddd;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

#main-content .list-group-item:hover {
    background-color: #f0f8ff;
}

#main-content .avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin-right: 10px;
}

/* Messaging Area */
#main-content #messageBox {
    max-height: 400px;
    overflow-y: auto;
    padding: 15px;
    border: 1px solid #ddd;
    border-radius: 8px;
    background-color: #f9f9f9;
}

#main-content .message {
    margin-bottom: 15px;
    padding: 10px;
    border-radius: 8px;
    max-width: 60%;
    word-wrap: break-word;
    position: relative;
}

#main-content .message.sent {
    background-color: #d1f7c4;
    align-self: flex-end;
    margin-left: auto;
}

#main-content .message.received {
    background-color: #f1f0f0;
    align-self: flex-start;
    margin-right: auto;
}

#main-content .media-attachment img,
#main-content .media-attachment video {
    max-width: 100%;
    border-radius: 8px;
    margin-top: 10px;
}

#main-content .timestamp {
    font-size: 0.8em;
    color: #888;
    margin-top: 5px;
}

#main-content .contact-info {
    margin-bottom: 10px;
    background-color: #f9f9f9;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #ddd;
}

/* Input Area */
#main-content .input-group {
    margin-top: 10px;
}

#main-content #messageInput {
    border-radius: 6px;
    border: 1px solid #ccc;
}

#main-content #sendMessageButton {
    background-color: #28a745;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 8px 16px;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

#main-content #sendMessageButton:hover {
    background-color: #218838;
}

#main-content .attachment-area {
    margin-top: 10px;
}

#main-content .attachment-area input {
    border: none;
    border-radius: 6px;
    padding: 5px;
    font-size: 14px;
}

main .row {
    display: flex;
    grid-column-gap: unset;
}



/* Initial style for the sliding panel */
.slide-panel {
  position: fixed;
  top: 0;
  right: -350px; /* Initially hidden */
  width: 350px;
  height: 100%;
  background-color: #fff;
  box-shadow: -2px 0 5px rgba(0, 0, 0, 0.2);
  transition: right 0.3s ease;
  z-index: 1000;
  padding: 20px;
  overflow-y: auto;
}

.slide-panel.open {
  right: 0; /* When open, it slides in */
}

.panel-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.close-btn {
  background-color: transparent;
  border: none;
  font-size: 20px;
  cursor: pointer;
}

.connections-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.connection-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  border: 1px solid #ddd;
  padding: 10px;
  border-radius: 5px;
  background-color: #f9f9f9;
}

.connection-item button {
  background-color: #4CAF50;
  color: white;
  border: none;
  padding: 5px 10px;
  cursor: pointer;
}

.connection-item button:hover {
  background-color: #45a049;
}


 
.preview-video,
.preview-image {

    width: 200px;  
}

#attachmentPreview {
    display: grid;
    align-content: stretch;
    justify-content: space-evenly;
    justify-items: end;
}

#interaction-panel {
    position: relative;
    min-height: 500px;
    height: auto;
    display: flex;
}

#mainConnections-panel {
    position: relative;


}

#main-contact-panel {
    position: relative;
    height: 100%;
}

#main-message-panel {
    position: relative;
    height: 100%;
}

#closeSlidePanelBtn {
    color: color-mix(in lch longer hue, #45a049 45%, #f0f8ff 20%);
}
    </style>

</head>


<body>
    <script src="https://reelcareer.co/public/js/bodyload.js"></script>
    
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li id="lastBreadcrumb_home" class="breadcrumb-item"><a href="https://reelcareer.co/">Home</a></li>
            <li id="lastBreadcrumb_1" class="breadcrumb-item"><a id="lastBreadcrumb_1_a" href="https://reelcareer.co/views/user">View Profile</a></li>

            <li id="lastBreadcrumb_last" class="breadcrumb-item">Connections</li>

            <li id="breadcrumb-active-title" class="breadcrumb-item active" aria-current="page">Messaging</li>
        </ol>
      </nav>
  
  

      <main id="main-content">

        <div class="row">
          <div class="col-md-4">
            <h4>Contacts</h4>
            <!-- Button to open the sliding panel -->
            <button id="openSlidePanelBtn" class="btn btn-primary">View Connections</button>
      
            <ul class="list-group" id="contactList">
              <!-- Contacts will be populated here -->
            </ul>
            <button class="btn btn-primary mt-2" id="composeButton">Compose Message</button>
          </div>
          <div class="col-md-8">
            <div id="interaction-panel">
      
              <div id="mainConnections-panel">
                <!-- Sliding Panel -->
                <div id="connectionsSlidePanel" class="slide-panel">
                  <div class="panel-header">
                    <h3 id="slidePanel-header-text">Connections</h3>
                    <button id="closeSlidePanelBtn" class="close-btn">X</button>
                  </div>
                  <!-- >inside panel -->
      








                  <div id="main-contact-panel">
      
                    <div id="connectionsList" class="connections-list">
                      <!-- Connection items will be dynamically appended here -->
                    </div>
                  </div>
      






                  <div id="main-message-panel">
      
                    <h4 id="conversationTitle">Select a Conversation</h4>
                    <div class="contact-info" id="contactInfo">
                      <!-- Contact info will be displayed here -->
                    </div>
                    <div class="message-box" id="messageBox">
                      <!-- Messages will be displayed here -->
                    </div>
      
                    <div class="message-panel">
                      <div class="message-input-area">
                        <textarea class="form-control" id="messageInput" placeholder="Type a message..." rows="3"></textarea>
                      </div>
      
                      <!-- Attachment Button and Preview -->
                      <div class="attachment-area mt-2">
                        <button class="btn btn-outline-primary" id="chooseFileButton">Choose File</button>
                        <input type="file" id="attachmentInput" class="d-none">
                        <div id="attachmentPreview" class="mt-2 d-none">
                          <div class="preview-container">
                            <span id="removePreview" class="remove-preview">&times;</span>
                            <img id="attachmentImage" class="preview-image" src="" alt="Attachment Preview">
                            <video id="attachmentVideo" class="preview-video" controls src=""></video>
                          </div>
                        </div>
                      </div>
      
                      <!-- Send Button -->
                      <div class="mt-3">
                        <button class="btn btn-success" id="sendMessageButton">Send</button>
                      </div>
      
                    </div>
                  </div>
      
                </div>
      
              </div>
      
            </div>
      
            <!-- >panel end -->
      
          </div>
        </div>
      
      </main>
  
    <!-- >Footer -->
    <footer id="dynamic-footer"></footer>
    
    <!-- Firebase configuration/ Login& Out -->
    <script type="module" src="https://reelcareer.co/public/js/main.js"></script> 

  <!-- Firebase JS SDK and Custom Scripts -->

<script type="module">
    import {
        db, getStorage, ref, uploadBytes, getDownloadURL, limit,
  doc, arrayUnion, RecaptchaVerifier, increment, getDoc, arrayRemove, signInWithPhoneNumber,
  query, updateDoc, setDoc, addDoc, signInAnonymously, orderBy, onAuthStateChanged,
  uploadBytesResumable, signInWithPopup, FacebookAuthProvider, GoogleAuthProvider, startAfter,
  OAuthProvider, signOut, deleteDoc, getFirestore, serverTimestamp,
  createUserWithEmailAndPassword, signInWithEmailAndPassword, deleteObject,
  where, getDocs, storage, getAuth, collection, auth, analytics,
  googleProvider,onSnapshot ,
  facebookProvider,
  getUserId // Export the function
    } from 'https://reelcareer.co/js/module.js';

   let userId;
    document.addEventListener('DOMContentLoaded', async () => {
    try {
        userId = await getUserId(); // Await here to properly set userId
        console.log("User ID fetched during DOMContentLoaded:", userId);
        if (userId) {
            loadContacts(userId); // Load contacts if user is authenticated
        } else {
            window.location.href = 'https://reelcareer.co/login';
        }
    } catch (error) {
        console.error("Error fetching user ID:", error);
    }
});
const userDataSaved = getUserData() || [];

const lastBreadcrumb_1_a = document.getElementById("lastBreadcrumb_1_a");
lastBreadcrumb_1_a.innerText = userDataSaved.displayName;
const breadcrumbActiveTitle = document.getElementById("breadcrumb-active-title");

const lastBreadcrumb_last = document.getElementById("lastBreadcrumb_last");






// Elements
const openSlidePanelBtn = document.getElementById('openSlidePanelBtn');
const closeSlidePanelBtn = document.getElementById('closeSlidePanelBtn');
const connectionsSlidePanel = document.getElementById('connectionsSlidePanel');
const connectionsList = document.getElementById('connectionsList');

// Fetching Connections from the database (assuming you are using Firebase)
async function fetchConnections() {
  try {
    // Assuming `connections` collection is stored in Firebase Firestore
    const userDataSaved = await getUserData() || {};
  let userID =  userDataSaved.userId;
    
 
let connectionssRef = collection(db, 'Connections');
const querySnapshot = query(connectionssRef, where('from', '==', userID));

    querySnapshot.forEach(doc => {
      const connectionData = doc.data();
      if (connectionData.status === 'pending') { // Only show pending connections
        appendConnection(connectionData);
      }
    });
  } catch (error) {
    console.error('Error fetching connections:', error);
  }
}

// Appending a single connection to the list
function appendConnection(connection) {
  const div = document.createElement('div');
  div.classList.add('connection-item');
  
  // Display Connection Information
  const connectionInfo = `
    <div>
      <img src="${connection.fromProfilePicture}" alt="Profile" width="40" height="40">
      <a href="${connection.fromProfileURL}" target="_blank">${connection.fromName}</a>
    </div>
    <button onclick="acceptConnection('${connection.from}', '${connection.to}')">Accept</button>
  `;
  div.innerHTML = connectionInfo;
  
  connectionsList.appendChild(div);
}

// Function to accept a connection
async function acceptConnection(fromID, toID) {
  try {
    // Update the status of the connection to 'accepted'
    const connectionRef = doc(db, 'Connections', `${fromID}_${toID}`);
    await updateDoc(connectionRef, {
      status: 'accepted'
    });
    
    showToast('Connection accepted!');
    // Refresh the list of connections
    connectionsList.innerHTML = '';
    fetchConnections();
  } catch (error) {
    console.error('Error accepting connection:', error);
    showToast('Failed to accept connection.');
  }
}
window.acceptConnection  = acceptConnection ;


// Open the sliding panel
openSlidePanelBtn.addEventListener('click', () => {
  connectionsSlidePanel.classList.add('open');
  fetchConnections(); // Load connections when opening the panel
});

// Close the sliding panel
closeSlidePanelBtn.addEventListener('click', () => {
  connectionsSlidePanel.classList.remove('open');
});














    function loadContacts(userID) {
        console.log("userID: ", userID);

        const contactList = document.getElementById('contactList');
        contactList.innerHTML = '';

        // Create the div for the title
const titleDiv = document.createElement('div');
titleDiv.classList.add('title');
titleDiv.innerText = 'Messages'; // Set the title text
contactList.appendChild(titleDiv);




// Create the div for the contact list
const contactListDiv = document.createElement('div');
contactListDiv.classList.add('contact-list');


        let contactsRef = collection(db, 'Messages');
        let q = query(contactsRef, where('recipientID', '==', userID));


        onSnapshot(q, snapshot => {

            snapshot.forEach(doc => {
                const data = doc.data();
                const listItem = document.createElement('li');
                listItem.className = 'list-group-item';
                listItem.innerHTML = `
      <a href="https://reelcareer.co/views/user/u=${data.senderID}" style="text-decoration: none;color: inherit;">
        <img src="${data.senderProfilePicture || 'https://reelcareer.co/images/sq_logo_n_BG_tie_reel.png'}" alt="Avatar" class="avatar"></a>
    <span>${data.senderName}</span>
`;
listItem.onclick = () => loadMessages(data.conversationID, data);
contactList.appendChild(listItem);
            });
        });

// Create the div for the title
const titleDiv2 = document.createElement('div');
titleDiv2.classList.add('title');
titleDiv2.innerText = 'Connections'; // Set the title text
contactListDiv.appendChild(titleDiv2);






// Create the div for the contact list
const ConnectionstDiv = document.createElement('div');
ConnectionstDiv.classList.add('contact-list');



let connectionssRef = collection(db, 'Connections');
         q = query(connectionssRef, where('to', '==', userID));

         onSnapshot(q, snapshotConnections => {
            snapshotConnections.forEach(doc => {
        const data = doc.data();

        // Create a list item for the contact
        const listItem = document.createElement('li');
        listItem.className = 'list-group-item';

        // Add contact info with the "View Contact" button
        listItem.innerHTML = `
            <a href="https://reelcareer.co/views/user?u=${data.from}" style="text-decoration: none;color: inherit;">
                <img src="${data.fromProfilePicture || 'https://reelcareer.co/images/sq_logo_n_BG_tie_reel.png'}" alt="Avatar" class="avatar">
            </a>
            <span>${data.fromName}</span>
            <button class="btn btn-secondary btn-sm view-contact-btn">View Contact</button>
        `;

        // Add the onclick listener to the "View Contact" button
        const viewContactBtn = listItem.querySelector('.view-contact-btn');
        viewContactBtn.addEventListener('click', () => {
            appendConnection(data); // Call your appendConnection function with the contact data
        });


   
               // listItem.onclick = () => loadMessages(data.conversationID, data);
                contactList.appendChild(listItem);
            });
        });


    }

    function loadMessages(conversationID, data) {

        console.log("data: ", data);

        const messageBox = document.getElementById('messageBox');
        const conversationTitle = document.getElementById('conversationTitle');
        const contactInfo = document.getElementById('contactInfo');

        
        conversationTitle.innerHTML = `
        <a href="https://reelcareer.co/views/user?u=${data.senderID}" style="text-decoration: none; color: inherit;">
            <img src="${data.senderProfilePicture || 'default-image-url'}" alt="Avatar" class="avatar">
        </a>
        <span>${data.senderName || 'Unknown Sender'}</span>
    `;  
    contactInfo.setAttribute("data-conversation-id",conversationID);


        contactInfo.innerHTML = `<p>Contact: ${data.senderName}</p><p>Status: Online</p>`; // Display contact info dynamically
        console.log("conversationID: ", conversationID);

        
        messageBox.innerHTML = '';
        const messagesRef = collection(db, 'Messages');
        const q = query(messagesRef, where('conversationID', '==', conversationID), orderBy('createdAt'));

        onSnapshot(q, snapshot => {
            messageBox.innerHTML = ''; // Clear previous messages
            snapshot.forEach(doc => {
                const data = doc.data();
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${data.senderID === auth.currentUser.uid ? 'sent' : 'received'}`;
                messageDiv.textContent = data.content;

                if (data.contentType !== 'text') {
                    const mediaDiv = document.createElement('div');
                    mediaDiv.className = 'media-attachment';
                    if (data.contentType === 'image') {
                        const img = document.createElement('img');
                        img.src = data.attachmentUrl;
                        img.alt = 'Image Attachment';
                        mediaDiv.appendChild(img);
                    } else if (data.contentType === 'video') {
                        const video = document.createElement('video');
                        video.src = data.attachmentUrl;
                        video.controls = true;
                        mediaDiv.appendChild(video);
                    }
                    messageDiv.appendChild(mediaDiv);
                }
                const timestampDiv = document.createElement('div');
timestampDiv.className = 'timestamp';
timestampDiv.textContent = new Date(data.createdAt.seconds * 1000).toLocaleString();
messageDiv.appendChild(timestampDiv);

                messageBox.appendChild(messageDiv);
            });
            messageBox.scrollTop = messageBox.scrollHeight;
        }, 
    error => {
        console.error("Error fetching messages:", error.message);
        showToast("Unable to load messages. Please try again.", 'error');
    }
);
    }
    document.getElementById('chooseFileButton').onclick = () => {
    document.getElementById('attachmentInput').click(); // Trigger file input dialog
};

// Handle file input change event to show the preview
document.getElementById('attachmentInput').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        const fileUrl = URL.createObjectURL(file);
        const attachmentPreview = document.getElementById('attachmentPreview');
        const imagePreview = document.getElementById('attachmentImage');
        const videoPreview = document.getElementById('attachmentVideo');
        
        // Show the preview area and set the file type (image or video)
        attachmentPreview.classList.remove('d-none');
        
        if (file.type.startsWith('image/')) {
            imagePreview.src = fileUrl;
            imagePreview.classList.remove('d-none');
            videoPreview.classList.add('d-none');
        } else if (file.type.startsWith('video/')) {
            videoPreview.src = fileUrl;
            videoPreview.classList.remove('d-none');
            imagePreview.classList.add('d-none');
        }
    }
});

// Remove the attachment preview
document.getElementById('removePreview').onclick = () => {
    document.getElementById('attachmentInput').value = ''; // Reset the file input
    document.getElementById('attachmentPreview').classList.add('d-none'); // Hide preview
    document.getElementById('attachmentImage').classList.add('d-none');
    document.getElementById('attachmentVideo').classList.add('d-none');
};

// Send message function with attachment
document.getElementById('sendMessageButton').onclick = async () => {
    const messageInput = document.getElementById('messageInput');
    const conversationID = document.getElementById('conversationTitle').getAttribute('data-conversation-id');
    const message = messageInput.value;
    const attachmentInput = document.getElementById('attachmentInput').files[0];
    const profilePic = document.getElementById('nav-bar-profilePic').src;

    if (!message && !attachmentInput) {
        showToast("Please enter a message or attach a file.", 'warning');
        return;
    }

    try {
        let attachmentUrl = '';
        if (attachmentInput) {
            attachmentUrl = await uploadAttachment(conversationID, attachmentInput);
        }
        await sendMessage(conversationID, message, attachmentUrl);
        messageInput.value = ''; // Clear input
        document.getElementById('attachmentInput').value = ''; // Clear attachment
        document.getElementById('attachmentPreview').classList.add('d-none'); // Hide preview after send
    } catch (error) {
        console.error("Error sending message:", error.message);
        showToast("Failed to send message. Please try again.", 'error');
    }
};

function sendMessage(conversationID, message, attachmentUrl = '') {
    addDoc(collection(db, 'Messages'), {
        senderID: auth.currentUser.uid,
        recipientID: conversationID,
        conversationID: conversationID,
        profilePicture: profilePic,
        content: message,
        contentType: attachmentUrl ? (attachmentUrl.match(/\.(jpg|png)$/) ? 'image' : 'video') : 'text',
        attachments: attachmentUrl,
        messageType: 'contact',
        group: 'main',
        createdAt: serverTimestamp(),
        read: false,
        status: "unread",
        isDeleted: false
    }).then(() => {
        document.getElementById('messageInput').value = ''; // Clear input
        document.getElementById('attachmentInput').value = ''; // Clear attachment
    }).catch(error => {
        showToast("Error sending message: " + error.message, 'error');
    });
}

async function uploadAttachment(conversationID, file) {
    const fileRef = storageRef(storage, `messages/${conversationID}/${file.name}`);
    
    
  
    const snapshot = await uploadBytes(fileRef, file);
    return getDownloadURL(snapshot.ref);
}
   </script>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.0.7/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>
</html>
