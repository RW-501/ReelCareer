<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reel Career Blog</title>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<!--
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
-->
   <style>
    
    .blog-post {
            margin-bottom: 30px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            background-color: #ffffff;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .blog-post:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }

        .blog-image {
            height: 200px;
            object-fit: cover;
            border-radius: 10px;
        }

          .author-date {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .blog-content {
            color: #495057;
        }


        .search-bar {
            margin-bottom: 30px;
        }




        .blog-post {
    margin: 20px 0; /* Space between blog posts */
    display: flex; /* Align items if needed */
    justify-content: center; /* Center the blog card */
}

.blog-card {
    background: #fff; /* White background for the card */
    border-radius: 10px; /* Rounded corners */
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); /* Subtle shadow */
    padding: 20px; /* Inner padding */
    width: 80%; /* Width of the card */
    max-width: 600px; /* Maximum width */
    transition: transform 0.3s; /* Smooth transform on hover */
}

.blog-card:hover {
    transform: scale(1.02); /* Scale effect on hover */
}

.blog-image {
    width: 100%; /* Responsive image */
    height: auto; /* Maintain aspect ratio */
    border-radius: 5px; /* Rounded corners for the image */
}

.blog-content {
    font-size: 16px; /* Font size for content */
    line-height: 1.6; /* Line height for better readability */
}

.button-container {
    margin-top: 15px; /* Space above buttons */
}

#blog-container  {
    margin: auto;
    width: fit-content;
    display: block;
}

    </style>
   <!-- Bootstrap CSS -->
   <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    
    <script src="../public/js/scripts.js"></script>
    <script src="../public/js/loadScripts.js"></script>
    <link rel="stylesheet" href="../public/css/styles.css">

</head>


<body>
    <script src="../public/js/bodyload.js"></script>
    <nav></nav>

    <div class="container mt-5">
        <h1 class="text-center mb-4">Reel Career Blog</h1>

        <!-- Search Bar -->
        <div class="row">
            <div class="col-md-12 search-bar">
                <input type="text" id="search-input" class="form-control" placeholder="Search blogs...">
            </div>
        </div>

        <div id="blog-container" class="row"></div>

        <!-- Pagination Controls -->
        <div class="row">
            <div class="col-md-12 text-center">
                <nav aria-label="Page navigation">
                    <ul class="pagination" id="pagination-controls">
                        <li class="page-item disabled" id="prev-page">
                            <a class="page-link" href="#" tabindex="-1">Previous</a>
                        </li>
                        <li class="page-item active"><a class="page-link" href="#" id="page-1">1</a></li>
                        <li class="page-item" id="next-page">
                            <a class="page-link" href="#">Next</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- Blog Detail Modal -->
    <div class="modal fade hide" id="blogDetailModal" tabindex="-1" aria-labelledby="blogDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="blogDetailModalLabel">Blog Title</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <img id="modal-blog-image" src="" alt="Blog Image" class="img-fluid mb-3" />
                    <p id="modal-blog-author-date" class="author-date"></p>
                    <p id="modal-blog-content" class="blog-content"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    

    <!-- Footer -->
    <footer id="dynamic-footer"></footer>
    
    <!-- Firebase configuration/ Login& Out -->
    <script type="module" src="../public/js/main.js"></script> 

   
    

    <script type="module">
     import { db } from '../public/js/main.js'; // Adjust the path based on your structure
    import { doc, query, where, orderBy, limit, collection, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

        function getQueryParam(param) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
    }  
    

let page = 1;
let postsPerPage = 1; // Define your posts per page
let currentPage = 1;
let totalPosts = 0; // Track total number of posts
let lastVisibleDoc = null; // For pagination tracking (Firestore pagination)
let firstVisibleDoc = null; // For backward navigation

// Fetch total number of active blogs from Firestore to calculate total pages
async function fetchTotalPosts() {
    const blogsRef = collection(db, "Blogs");
    const totalQuery = query(blogsRef, where("activate", "==", true));
    const totalSnapshot = await getDocs(totalQuery);
    totalPosts = totalSnapshot.size; // Get the total number of posts
    return totalPosts;
}

        // Fetch blogs from Firestore
        async function fetchBlogs(page) { 
    try {
        const blogContainer = document.getElementById("blog-container");
        blogContainer.innerHTML = ""; // Clear existing blogs

        // Check if the URL has a 'b' parameter (blogId)
        const blogId = getQueryParam("b");

        console.log("????????????  ",blogId);
        let querySnapshot;
if (blogId) {
    const docRef = doc(db, "Blogs", blogId);
    const docSnap = await getDoc(docRef);
    if (docSnap.exists()) {
        querySnapshot = [docSnap]; // Wrap in an array to simulate array for single doc
    } else {
        blogContainer.innerHTML = "<p>Blog not found.</p>";
        return;
    }
} else {
    const blogsRef = collection(db, "Blogs");
    let blogsQuery = query(blogsRef, where("activate", "==", true), limit(postsPerPage));

        // Handle pagination using Firestore's `startAfter`
        if (page > 1 && lastVisibleDoc) {
            blogsQuery = query(blogsRef, where("activate", "==", true), startAfter(lastVisibleDoc), limit(postsPerPage));
        }
        console.log("???blogsQuery??????  ",blogsQuery);

        const querySnapshot = await getDocs(blogsQuery);
}

  
// Iterate and create blog posts
if (querySnapshot && !querySnapshot.empty) {
    
    
    firstVisibleDoc = querySnapshot.docs[0];

// Store the last visible document for pagination
lastVisibleDoc = querySnapshot.docs[querySnapshot.docs.length - 1];

console.log("Query Snapshot:", querySnapshot);
console.log("Query lastVisibleDoc:", lastVisibleDoc);
console.log("Query firstVisibleDoc:", firstVisibleDoc);

    querySnapshot.forEach((doc) => {
        const blogData = doc.data();
   
      
            // Create blog card or element here based on your design
            const blogCard = document.createElement("div");
            blogCard.className = "blog-post"; // Add your CSS classes

            // Build the inner HTML with all the specified fields and action buttons
            blogCard.innerHTML = `
  <div class="blog-card" style="
      box-shadow: 0 8px 16px rgba(0,0,0,0.1); 
      padding: 20px; 
      border-radius: 10px;
      background-color: #ffffff;
      margin-bottom: 30px;
      overflow: hidden;
      transition: transform 0.3s ease;
      ">
      <h3 style="
          font-size: 24px; 
          color: #333; 
          font-weight: 700; 
          margin-bottom: 15px;">${blogData.title}</h3>

      <img src="${blogData.imageUrl}" alt="${blogData.imageCaption}" style="
          width: 100%; 
          height: auto; 
          border-radius: 8px; 
          margin-bottom: 20px; 
          object-fit: cover;"/>

      <p style="
          font-size: 18px; 
          color: #555; 
          line-height: 1.6;
          margin-bottom: 15px;">${blogData.content}</p>
      
      <hr style="border: 0; border-top: 1px solid #e0e0e0; margin-bottom: 15px;">

      <div style="
          display: flex; 
          justify-content: space-between; 
          align-items: center; 
          font-size: 14px; 
          color: #999;">
          <p><strong>Category:</strong> ${blogData.category}</p>
          <p><strong>Published:</strong> ${new Date(blogData.postDate).toLocaleDateString()}</p>
      </div>

      <div style="
          display: flex; 
          justify-content: space-between; 
          align-items: center; 
          font-size: 14px; 
          color: #999; 
          margin-bottom: 20px;">
          <p><strong>Posted by:</strong> ${blogData.postedBy}</p>
          <p><strong>ID:</strong> ${blogData.postedById}</p>
      </div>

      <div style="
          display: flex; 
          justify-content: space-between; 
          font-size: 14px; 
          color: #999;">
          <p><strong>Views:</strong> ${blogData.viewCount}</p>
          <p><strong>Tags:</strong> ${blogData.tags.join(', ')}</p>
      </div>

      <hr style="border: 0; border-top: 1px solid #e0e0e0; margin-bottom: 20px;">

      <div style="
          display: flex; 
          justify-content: space-around; 
          align-items: center;">
          <div style="text-align: center;">
              <button onclick="likePost('${doc.id}')" style="
                  background-color: #007bff; 
                  color: white; 
                  border: none; 
                  padding: 10px 20px; 
                  border-radius: 5px; 
                  cursor: pointer;
                  transition: background-color 0.3s ease;">üëç Like</button>
              <p><strong>Likes:</strong> <span id="likes-${doc.id}">${blogData.likes}</span></p>
          </div>

          <div style="text-align: center;">
              <button onclick="lovePost('${doc.id}')" style="
                  background-color: #ff3860; 
                  color: white; 
                  border: none; 
                  padding: 10px 20px; 
                  border-radius: 5px; 
                  cursor: pointer;
                  transition: background-color 0.3s ease;">‚ù§Ô∏è Love</button>
              <p><strong>Loves:</strong> <span id="loves-${doc.id}">${blogData.loves}</span></p>
          </div>

          <div style="text-align: center;">
              <button onclick="markHelpful('${doc.id}')" style="
                  background-color: #23d160; 
                  color: white; 
                  border: none; 
                  padding: 10px 20px; 
                  border-radius: 5px; 
                  cursor: pointer;
                  transition: background-color 0.3s ease;">‚úîÔ∏è Helpful</button>
              <p><strong>Helpful:</strong> <span id="helpful-${doc.id}">${blogData.helpful}</span></p>
          </div>
      </div>
  </div>
  `;


            // Append the blog card to the container
            blogContainer.appendChild(blogCard);
        });
        // Update pagination controls
            updatePagination();
        } else {
            blogContainer.innerHTML = "<p>No blogs available.</p>";
        }

    } catch (error) {
        console.error("Error fetching blogs: ", error);
        document.getElementById("blog-container").innerHTML = "<p>Error fetching blogs. Please try again later.</p>";
    }
}



// Function to handle liking a post
function likePost(postId) {
    const likesElement = document.getElementById(`likes-${postId}`);
    let currentLikes = parseInt(likesElement.textContent);
    currentLikes += 1;
    likesElement.textContent = currentLikes;

    // Update the database (Firestore)
    const postRef = firebase.firestore().collection('blogs').doc(postId);
    postRef.update({ likes: currentLikes })
        .then(() => {
            console.log("Like count updated successfully");
        })
        .catch((error) => {
            console.error("Error updating like count: ", error);
        });
}

// Function to handle loving a post
function lovePost(postId) {
    const lovesElement = document.getElementById(`loves-${postId}`);
    let currentLoves = parseInt(lovesElement.textContent);
    currentLoves += 1;
    lovesElement.textContent = currentLoves;

    // Update the database (Firestore)
    const postRef = firebase.firestore().collection('blogs').doc(postId);
    postRef.update({ loves: currentLoves })
        .then(() => {
            console.log("Love count updated successfully");
        })
        .catch((error) => {
            console.error("Error updating love count: ", error);
        });
}

// Function to handle marking a post as helpful
function markHelpful(postId) {
    const helpfulElement = document.getElementById(`helpful-${postId}`);
    let currentHelpful = parseInt(helpfulElement.textContent);
    currentHelpful += 1;
    helpfulElement.textContent = currentHelpful;

    // Update the database (Firestore)
    const postRef = firebase.firestore().collection('blogs').doc(postId);
    postRef.update({ helpful: currentHelpful })
        .then(() => {
            console.log("Helpful count updated successfully");
        })
        .catch((error) => {
            console.error("Error updating helpful count: ", error);
        });
}
        // Show blog detail in modal
        function showBlogDetail(title, image, author, date, content) {
            document.getElementById("blogDetailModalLabel").innerText = title;
            document.getElementById("modal-blog-image").src = image;
            document.getElementById("modal-blog-author-date").innerText = `By ${author} on ${date}`;
            document.getElementById("modal-blog-content").innerText = content;
            const modal = new bootstrap.Modal(document.getElementById('blogDetailModal'));
            modal.show();
        }

     
// Update pagination controls
function updatePagination() {
    const paginationControls = document.getElementById("pagination-controls");
    const totalPages = Math.ceil(totalPosts / postsPerPage); // Calculate total pages

    paginationControls.innerHTML = `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}" id="prev-page">
            <a class="page-link" href="#" tabindex="-1">Previous</a>
        </li>
        <li class="page-item active"><a class="page-link" href="#" id="page-${currentPage}">${currentPage}</a></li>
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}" id="next-page">
            <a class="page-link" href="#">Next</a>
        </li>
    `;

    // Add event listeners for pagination controls
    document.getElementById("prev-page").onclick = () => {
        if (currentPage > 1) {
            currentPage--;
            fetchBlogs(currentPage);
        }
    };

    document.getElementById("next-page").onclick = () => {
        if (currentPage < totalPages) {
            currentPage++;
            fetchBlogs(currentPage);
        }
    };
}

        // Search Blogs Functionality
        document.getElementById("search-input").addEventListener("input", function () {
            const searchTerm = this.value.toLowerCase();
            const blogPosts = document.querySelectorAll(".blog-post");
            blogPosts.forEach((post) => {
                const title = post.querySelector("h3").textContent.toLowerCase();
                if (title.includes(searchTerm)) {
                    post.style.display = "block"; // Show matching post
                } else {
                    post.style.display = "none"; // Hide non-matching post
                }
            });
        });


// Initial call to fetch total posts and blogs for the first page
(async function init() {
    await fetchTotalPosts(); // Get the total number of posts
    fetchBlogs(currentPage); // Fetch the first page
})();
    </script>

    <!-- Schema Markup for SEO -->
    <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "Blog",
            "name": "User Blog",
            "url": "https://www.example.com/user-blog",
            "description": "Explore the latest blog posts from our users.",
            "publisher": {
                "@type": "Organization",
                "name": "Your Organization Name",
                "logo": {
                    "@type": "ImageObject",
                    "url": "https://www.example.com/logo.png"
                }
            },
            "blogPost": [
                {
                    "@type": "BlogPosting",
                    "headline": "Sample Blog Post",
                    "image": "https://www.example.com/image.jpg",
                    "author": {
                        "@type": "Person",
                        "name": "Author Name"
                    },
                    "datePublished": "2024-10-10T08:00:00+08:00",
                    "mainEntityOfPage": "https://www.example.com/user-blog/sample-post",
                    "description": "This is a brief description of the blog post."
                }
            ]
        }
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
