<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="User profile page for managing bio, resumes, messaging, and job applications.">
    <meta name="keywords" content="job applications, resumes, video resumes, job seeking, career management">
    <meta name="author" content="ReelCareer">
    <title>User Profile | ReelCareer</title>

    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="style.css" rel="stylesheet">

    <!-- SEO Schema Markup -->
    <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "WebPage",
            "name": "User Profile",
            "description": "User profile for managing bio, resumes, and applications.",
            "publisher": {
                "@type": "Organization",
                "name": "ReelCareer"
            }
        }
    </script>
<style>
    .tags-container {
    margin-top: 10px;
}

.badge {
    background-color: #007bff;
    color: white;
    padding: 5px 10px;
    border-radius: 5px;
}
</style>
    <script src="../public/js/scripts.js"></script>
    <script src="../public/js/loadScripts.js"></script>
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="../index.html">ReelCareer</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                    <a class="nav-link" href="news.html">News</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="jobs.html">Jobs</a>
                </li>
                <li class="nav-item active">
                    <a class="nav-link" href="user.html">Profile</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="messaging.html">Messages</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link btn btn-danger" href="logout.html">Logout</a>
                </li>
            </ul>
        </div>
    </nav>

    <!-- User Profile Section -->
    <div class="container mt-5">
        <div class="row">
            <div class="col-md-4">
                <!-- User Info Section -->
                <div class="card">
                    <div class="card-body text-center">
                        <img src="/images/sq_logo_n_BG_tie_reel.png" alt="User Profile Picture" class="img-fluid rounded-circle mb-3" style="width: 150px;">
                        <h3 id="user-name">User Name</h3>
                        <p id="user-bio">This is a short bio about the user...</p>
                        <span id="membership-badge" class="badge badge-success">Premium Member</span>
                        <span id="verified-badge" class="badge badge-info">Verified</span>
                        <p id="user-location">Location: <span id="location-text">City, State</span></p>
                        <div id="tags-container"></div>

                        
        <button class="btn btn-primary btn-block" id="send-message-btn">Send Message</button>
        <button class="btn btn-primary btn-block"  id="share-profile-btn">Share Profile</button>
        <button class="btn btn-primary btn-block" id="connect-btn">Connect</button>
    </div>
</div>
                    

                <!-- Digital Resume Link -->
                <div class="card mt-3">
                    <div class="card-body">
                        <h5>Digital Resume</h5>
                        <a href="#" id="digital-resume-link" class="btn btn-primary">View Resume</a>
                    </div>
                </div>

                <!-- Social Media and Websites -->
                <div class="card mt-3">
                    <div class="card-body">
                        <h5>Social Media & Websites</h5>
                        <ul id="social-media-list">
                            <!-- Social media links will be dynamically listed here -->
                        </ul>
                    </div>
                </div>

                <!-- Video Resumes -->
                <div class="card mt-3">
                    <div class="card-body">
                        <h5>Video Resumes</h5>
                        <ul id="video-resume-list">
                            <!-- Video resume files will be dynamically listed here -->
                        </ul>
                        <button class="btn btn-primary btn-block" onclick="location.href='dashboard.html'">Edit Video Resumes</button>
                    </div>
                </div>                </div>
            </div>                </div>
        </div>
           


            <div class="col-md-8">
                <!-- Open Jobs Section -->
                <div class="card mt-3">
                    <div class="card-body">
                        <h5>Open Jobs</h5>
                        <ul id="open-jobs-list">
                            <!-- Open jobs will be dynamically listed here -->
                        </ul>
                    </div>
                </div>

                <!-- Blogs Section -->
                <div class="card mt-3">
                    <div class="card-body">
                        <h5>Blogs</h5>
                        <ul id="blogs-list">
                            <!-- Blogs will be dynamically listed here -->
                        </ul>
                    </div>
                </div>

                <!-- Companies Section -->
                <div class="card mt-3">
                    <div class="card-body">
                        <h5>Companies</h5>
                        <ul id="companies-list">
                            <!-- Companies will be dynamically listed here -->
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

<!-- Send Message Modal -->
<div class="modal fade" id="sendMessageModal" tabindex="-1" aria-labelledby="sendMessageModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sendMessageModalLabel">Send Message</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="sendMessageForm">
                    <div class="form-group">
                        <label for="message-content">Message</label>
                        <textarea class="form-control" id="message-content" rows="4" required></textarea>
                    </div>
                    <input type="hidden" id="recipient-id" value="">
                    <div class="form-group">
                        <label for="message-attachments">Attachments</label>
                        <input type="file" class="form-control-file" id="message-attachments">
                    </div>
                    <button type="submit" class="btn btn-primary">Send</button>
                </form>
            </div>
        </div>
    </div>
</div>


    <!-- Footer -->
    <footer id="dynamic-footer"></footer>

    <!-- Firebase configuration/ Login& Out -->
    <script type="module" src="../public/js/main.js"></script>

    <script type="module">
        import { db, auth } from '../public/js/main.js';
        import { doc, getDoc, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

        const urlParams = new URLSearchParams(window.location.search);
        const userIdFromURL = urlParams.get('u');

        async function checkUser() {
            const user = auth.currentUser;

            if (user) {
                const userId = user.uid;

                // Fetch profile information based on userId in the URL
                const profileDoc = doc(db, 'Users', userIdFromURL);
                const profileSnapshot = await getDoc(profileDoc);

                if (profileSnapshot.exists()) {
                    const profileData = profileSnapshot.data();

console.log("user data  ",profileData);

                    // Check if the profile is public
                    if (profileData.profilePublic) {
                        await loadUserData(profileData); // Load user data if public
                        await loadUserJobs(userIdFromURL);
                        await loadUserBlogs(userIdFromURL);
                        await loadUserCompanies(userIdFromURL);
                        await loadUserVideoResumes(userIdFromURL);
                        await loadSocialMedia(profileData);
                        await loadTags(profileData);
                    } else {
                        alert('This profile is private.');
                       // window.location.href = 'user.html';
                    }
                } else {
                    console.error("No such user document!");
                    alert('User data not found.');
                }
            } else {
                alert('Please log in to access this page.');
               // window.location.href = 'login.html';
            }
        }

        async function loadUserData(profileData) {
            document.getElementById('user-name').innerText = profileData.displayName || 'User Name';
            document.getElementById('user-bio').innerText = profileData.bio || 'This is a short bio about the user...';
            document.getElementById('location-text').innerText = profileData.location || 'City, State';

            
        async function loadTags(profileData) {

            const tagsContainer = document.getElementById('tags-container');

            if (!profileData.tags) {
                tagsContainer.innerHTML = '<p>No tags found.</p>';
                return;
            }

            const tags = [];
            profileData.tags.forEach(doc => {
                tags.push(doc.data().tag);
            });

            tagsContainer.innerHTML = '<strong>Tags: </strong>' + tags.join(', ');
        }
            // Membership Badge
            async function loadMembershipBadge(membership) {
            const badge = document.getElementById('membership-badge');
            if (membership) {
                badge.innerHTML = `<span class="badge">Membership Level: ${membership}</span>`;
            }
        }

        async function loadVerifiedBadge(verified) {
            const badge = document.getElementById('verified-badge');
            if (verified) {
                badge.innerHTML = `<span class="badge">Verified</span>`;
            }
        }

            // Digital Resume Link
            const digitalResumeLink = document.getElementById('digital-resume-link');
            digitalResumeLink.href = profileData.digitalResumeUrl || '#';
            digitalResumeLink.innerText = profileData.digitalResumeUrl ? 'View Resume' : 'No Resume Available';
        }

        async function loadUserJobs(userId) {
            const jobsRef = collection(db, 'Jobs');
            const q = query(jobsRef, where("createdByID", "==", userId));
            const jobSnapshot = await getDocs(q);
            const jobsList = document.getElementById('open-jobs-list');

            if (jobSnapshot.empty) {
                jobsList.innerHTML = '<li>No open jobs found.</li>';
                return;
            }

            jobSnapshot.forEach(doc => {
                const jobData = doc.data();
                const listItem = document.createElement('li');
                listItem.innerText = jobData.title || 'Job Title';
                jobsList.appendChild(listItem);
            });
        }


        async function loadUserBlogs(userId) {
            const blogsRef = collection(db, 'Blogs');
            const q = query(blogsRef, where("createdByID", "==", userId));
            const blogSnapshot = await getDocs(q);
            const blogsList = document.getElementById('blogs-list');

            if (blogSnapshot.empty) {
                blogsList.innerHTML = '<li>No blogs found.</li>';
                return;
            }

            blogSnapshot.forEach(doc => {
                const blogData = doc.data();
                const listItem = document.createElement('li');
                listItem.innerText = blogData.title || 'Blog Title';
                blogsList.appendChild(listItem);
            });
        }

        async function loadUserCompanies(userId) {
            const companiesRef = collection(db, 'Companies');
            const q = query(companiesRef, where("createdByID", "==", userId));
            const companySnapshot = await getDocs(q);
            const companiesList = document.getElementById('companies-list');

            if (companySnapshot.empty) {
                companiesList.innerHTML = '<li>No companies found.</li>';
                return;
            }

            companySnapshot.forEach(doc => {
                const companyData = doc.data();
                const listItem = document.createElement('li');
                listItem.innerText = companyData.name || 'Company Name';
                companiesList.appendChild(listItem);
            });
        }

        async function loadUserVideoResumes(userId) {
            const videoResumesRef = collection(db, 'VideoResumes');
            const q = query(videoResumesRef, where("createdByID", "==", userId));
            const videoSnapshot = await getDocs(q);
            const videoResumeList = document.getElementById('video-resume-list');

            if (videoSnapshot.empty) {
                videoResumeList.innerHTML = '<li>No video resumes found.</li>';
                return;
            }

            videoSnapshot.forEach(doc => {
                const videoData = doc.data();
                const listItem = document.createElement('li');
                listItem.innerText = videoData.title || 'Video Resume Title';
                listItem.addEventListener('click', () => playVideo(videoData.videoUrl));
                videoResumeList.appendChild(listItem);
            });
        }

        function playVideo(videoUrl) {
            // Add logic to play video in a modal or a new page
            alert(`Playing video from URL: ${videoUrl}`);
        }

        async function loadSocialMedia(profileData) {
            const socialMediaListContainer = document.getElementById('social-media-list');

            if (!profileData.socialMediaList) {
                socialMediaListContainer.innerHTML = '<li>No social media links found.</li>';
                return;
            }

            profileData.socialMediaList.forEach(doc => {
                const socialData = doc.data();
                const listItem = document.createElement('li');
                listItem.innerHTML = `<a href="${socialData.link}" target="_blank">${socialData.platform}</a>`;
                socialMediaListContainer.appendChild(listItem);
            });
        }
        document.getElementById('share-profile-btn').addEventListener('click', () => {
            const userId = "currentUserId"; // Replace with actual user ID
            const shareUrl = `${window.location.origin}/profile/${userId}`; // Construct share URL
            navigator.clipboard.writeText(shareUrl).then(() => {
                alert('Profile link copied to clipboard!');
            }).catch(err => {
                console.error('Could not copy text: ', err);
            });
        });

        document.getElementById('connect-btn').addEventListener('click', async () => {
            const userId = "currentUserId"; // Replace with actual user ID
            const currentUserId = "loggedInUserId"; // Replace with actual logic to get logged in user ID

            if (userId !== currentUserId) {
                const connectionRef = collection(db, 'Connections');
                await addDoc(connectionRef, {
                    from: currentUserId,
                    to: userId,
                    status: 'pending', // or 'accepted' based on your logic
                });
                alert('Connection request sent!');
            } else {
                alert('You cannot connect with yourself.');
            }
        });


        document.getElementById('send-message-btn').addEventListener('click', function() {
    // Set recipient ID from the profile data
    document.getElementById('recipient-id').value = userIdFromURL; // Assuming userIdFromURL is the recipient ID.
    $('#sendMessageModal').modal('show'); // Show the modal
});


document.getElementById('sendMessageForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const senderID = auth.currentUser.uid;
    const recipientID = document.getElementById('recipient-id').value;
    const content = document.getElementById('message-content').value;
    const attachments = document.getElementById('message-attachments').files[0] || '';
    
    const messageData = {
        recipientID: recipientID,
        senderID: senderID,
        type: 'message',
        content: content,
        attachments: attachments ? attachments.name : '',
        isDeleted: false,
        read: false,
        createdAt: new Date(),
    };
    
    try {
        const messagesCollection = collection(db, 'Messages');
        await addDoc(messagesCollection, messageData);
        
        alert('Message sent successfully!');
        $('#sendMessageModal').modal('hide'); // Hide the modal after sending the message
    } catch (error) {
        console.error("Error sending message: ", error);
        alert('Failed to send message. Please try again.');
    }
});
/*
service cloud.firestore {
  match /databases/{database}/documents {
    match /Messages/{message} {
      allow create: if request.auth != null && request.resource.data.senderID == request.auth.uid;
      allow read, update: if request.auth != null && (resource.data.recipientID == request.auth.uid || resource.data.senderID == request.auth.uid);
    }
  }
}


*/






















        checkUser();
    </script>
</body>

</html>
