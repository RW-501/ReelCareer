<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Application Page</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    
    <!-- Bootstrap CSS -->
    <script src="../public/js/scripts.js"></script>
    <script src="../public/js/loadScripts.js"></script>
    <!-- Custom CSS -->
    <link rel="stylesheet" href="../public/css/styles.css">

</head>


<body>
    <script src="../public/js/bodyload.js"></script>
    
<!-- Navigation Bar -->
<nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">

</nav>

<div class="container mt-5 mb-5">
    <h1 class="text-center mb-4">Job Application</h1>
    <form id="applicationForm" class="shadow p-4 rounded bg-white" novalidate>
        <!-- Progress Indicator -->
        <div class="progress mb-3" style="height: 20px;">
            <div id="progressBar" class="progress-bar bg-success" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
        </div>

        <!-- Applicant Information -->
        <h3 class="border-bottom pb-2">Applicant Information</h3>
        <div class="form-group">
            <label for="firstName">First Name</label>
            <input type="text" id="firstName" class="form-control" required>
            <div class="invalid-feedback">Please enter your first name.</div>
        </div>
        <div class="form-group">
            <label for="lastName">Last Name</label>
            <input type="text" id="lastName" class="form-control" required>
            <div class="invalid-feedback">Please enter your last name.</div>
        </div>
        <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" class="form-control" required>
            <div class="invalid-feedback">Please enter a valid email address.</div>
        </div>
        <div class="form-group">
            <label for="phone">Phone</label>
            <input type="tel" id="phone" class="form-control" required>
            <div class="invalid-feedback">Please enter a valid phone number.</div>
        </div>

        <!-- Custom Questions -->
        <h5 class="text-muted">The following questions are provided by the recruiter and are optional.</h5>
        <div id="customQuestionsContainer"></div>

        <!-- Nondisclosure Questions -->
<!-- Optional EEO Self-Identification Section -->
<div class="form-group mb-3">
    <p class="text-muted"><strong>Voluntary Self-Identification</strong></p>
    <p>This section is optional. Your response will not affect your application and is used solely for Equal Employment Opportunity (EEO) reporting purposes.</p>
    
    <!-- Gender (optional) -->
    <label for="gender">Gender</label>
    <select class="form-control" id="gender">
        <option value="">Prefer not to answer</option>
        <option value="Male">Male</option>
        <option value="Female">Female</option>
        <option value="Non-Binary">Non-Binary</option>
    </select>

    <!-- Race/Ethnicity (optional) -->
    <label for="race">Race/Ethnicity</label>
    <select class="form-control" id="race">
        <option value="">Prefer not to answer</option>
        <option value="White">White</option>
        <option value="Black or African American">Black or African American</option>
        <option value="Asian">Asian</option>
        <option value="Hispanic or Latino">Hispanic or Latino</option>
        <option value="Native American or Alaska Native">Native American or Alaska Native</option>
    </select>

    <!-- Veteran Status (optional) -->
    <label for="veteran">Veteran Status</label>
    <select class="form-control" id="veteran">
        <option value="">Prefer not to answer</option>
        <option value="Yes">Yes</option>
        <option value="No">No</option>
    </select>

    <!-- Disability (optional) -->
    <label for="disability">Disability Status</label>
    <select class="form-control" id="disability">
        <option value="">Prefer not to answer</option>
        <option value="Yes">Yes</option>
        <option value="No">No</option>
    </select>
</div>


<div class="form-group">
    <div class="form-check">
        <input type="checkbox" id="shareInfo" required class="form-check-input">
        <label for="shareInfo" class="form-check-label">
            I consent to the collection and sharing of my personal information as described in the 
            <a href="#" class="text-primary">Privacy Policy</a>.
        </label>
    </div>
    
    <div class="form-group mt-3">
        <label for="disclosureName" class="form-label">Your Name</label>
        <input type="text" id="disclosureName" placeholder="Enter your name" class="form-control" required>
    </div>
    
    <div class="form-group mt-3">
        <label for="disclosureDate" class="form-label">Date</label>
        <input type="date" id="disclosureDate" class="form-control" required>
    </div>
</div>


        <!-- Resume Submission Options -->
        <h3 class="border-bottom pb-2">Resume Submission</h3>
        <div class="form-group">
            <label for="noteToRecruiter">Note to Recruiter</label>
            <textarea id="noteToRecruiter" class="form-control" rows="3" placeholder="Write a brief note to the recruiter..."></textarea>
        </div>
        <div class="form-group">
            <label for="portfolio">Portfoio</label>
            <input type="url" id="portfolio" class="form-control" >
            <div class="invalid-feedback">Please enter your Portfio Url</div>
        </div>
        <div class="form-group">
            <label for="videoResumeUpload">Upload Video Resume (optional)</label>
            <input type="file" id="videoResumeUpload" class="form-control-file">
            <button type="button" id="createVideoResume" class="btn btn-link text-primary">Create One</button>
        </div>
        <div class="form-group">
            <label for="resumeUpload">Upload New Resume <span class="text-danger">*</span></label>
            <input type="file" id="resumeUpload" class="form-control-file" required>
            <div class="invalid-feedback">Please upload your resume.</div>
        </div>

        <div class="form-group text-center">
            <button type="button" id="boostApplication" class="btn btn-warning btn-lg mx-2">Boost Application</button>
            <button type="button" id="previewApplication" class="btn btn-info btn-lg mx-2">Preview Application</button>
            <button type="button" id="saveForLater" class="btn btn-secondary btn-lg mx-2">Save for Later</button>
            <button type="submit" id="submitApplication" class="btn btn-success btn-lg mx-2">Submit Application</button>
        </div>

        <!-- Job Posted By Area -->
        <h3 class="border-bottom pb-2">Job Posted By</h3>
        <div id="jobPostedByArea" class="bg-light p-3 rounded mb-3"></div>
        <div class="d-flex justify-content-between mt-4">
            <button type="button" id="messageRecruiter" class="btn btn-primary">Message Recruiter</button>
            <button type="button" id="backToJobPost" class="btn btn-light">Back to Job Post</button>
        </div>
    </form>
</div>



<style>
    /* Custom styles for enhanced UI/UX */
    body {
        font-family: 'Arial', sans-serif;
        background-color: #f8f9fa;
    }

    .navbar {
        transition: background-color 0.3s;
    }

    .navbar:hover {
        background-color: #e9ecef;
    }

    .form-group {
        transition: box-shadow 0.3s, transform 0.3s;
    }

    .form-group:hover {
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        transform: scale(1.02);
    }

    .progress {
        height: 20px;
    }

    /* Tooltip styles */
    .tooltip-inner {
        background-color: #5cb85c;
    }

    .tooltip-arrow {
        border-top-color: #5cb85c;
    }

    /* Mobile responsiveness */
    @media (max-width: 768px) {
        .navbar {
            flex-direction: column;
        }
    }
</style>



    
    <script>












    // Load Custom Questions
    function loadCustomQuestions(customQuestions) {
        const customQuestionsContainer = document.getElementById('customQuestionsContainer');
        console.log("customQuestions ?????????/   ",customQuestions);
     
        customQuestions.forEach(question => {
            let inputElement;
            switch (question.type) {
                case 'multiple_choice':
                    inputElement = `<div class="form-group">
                                        <label>${question.question}</label>
                                        ${question.options.map(option => `<div><input type="radio" name="${question.id}" value="${option}">${option}</div>`).join('')}
                                    </div>`;
                    break;
                case 'text_area':
                    inputElement = `<div class="form-group">
                                        <label>${question.question}</label>
                                        <textarea class="form-control" id="${question.id}"></textarea>
                                    </div>`;
                    break;
                case 'input_field':
                    inputElement = `<div class="form-group">
                                        <label>${question.question}</label>
                                        <input type="text" class="form-control" id="${question.id}">
                                    </div>`;
                    break;
                case 'future_test':
                    // Placeholder for future question types
                    inputElement = `<div class="form-group">
                                        <label>${question.question}</label>
                                        <input type="text" class="form-control" id="${question.id}">
                                    </div>`;
                    break;
            }
            customQuestionsContainer.insertAdjacentHTML('beforeend', inputElement);
        });
    }


document.getElementById('previewApplication').addEventListener('click', () => {
console.log("????????previewApplication ????????");

const firstName = document.getElementById('firstName').value;
const lastName = document.getElementById('lastName').value;
const email = document.getElementById('email').value;
const phone = document.getElementById('phone').value;
const noteToRecruiter = document.getElementById('noteToRecruiter').value;
console.log("previewApplication   ");

// Collecting custom questions responses
const customQuestionsResponses = [];
const customQuestions = document.querySelectorAll('#customQuestionsContainer input');

customQuestions.forEach(question => {
    customQuestionsResponses.push({
        questionId: question.id,
        answer: question.value,
    });
});

// Create preview content
const previewContent = `
    <h3>Application Preview</h3>
    <p><strong>First Name:</strong> ${firstName}</p>
    <p><strong>Last Name:</strong> ${lastName}</p>
    <p><strong>Email:</strong> ${email}</p>
    <p><strong>Phone:</strong> ${phone}</p>
    <p><strong>Note to Recruiter:</strong> ${noteToRecruiter}</p>
    <h4>Custom Questions</h4>
    <ul>
        ${customQuestionsResponses.map(response => `<li>${response.questionId}: ${response.answer}</li>`).join('')}
    </ul>
`;

// Display the preview in a modal or a new section
const previewModal = document.createElement('div');
previewModal.className = 'modal fade';
previewModal.innerHTML = `
<!-- Preview Area -->
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Application Preview</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                ${previewContent}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
`;

document.body.appendChild(previewModal);
previewModal.classList.add('show');
});





  



</script>



    <!-- Footer -->
    <footer id="dynamic-footer"></footer>
    
    <!-- Firebase configuration/ Login& Out -->
    <script type="module" src="../public/js/main.js"></script> 

    <!-- Dynamic Schema Markup -->
    <script type="module">
    import { db, storage, analytics,auth, app  } from '../public/js/main.js'; // Adjust the path based on your structure
    import { query, where, getDoc, doc, orderBy, limit,  collection, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
    


// Function to extract the user ID from URL parameters
function getUserIdFromURL() {
    const params = new URLSearchParams(window.location.search);
    return params.get('userId');
}

// Function to retrieve jobId from the URL
function getJobIdFromURL() {
    const params = new URLSearchParams(window.location.search);
    return params.get('jobId');
}


let jobTitle = '';

let companyData = '';
let jobData = '';
let jobId = '';
let userIdURL = '';

    let userId = '';
    async function initializeUserId() {
        try {
            // Wait for the Firebase Auth state to initialize
            await auth.onAuthStateChanged((user) => {
                if (user) {
                     userId = user.uid; // Access the user ID
                    console.log("User ID:", userId);
                    // You can call your functions that require userId here
                    
// Example usage
 userIdURL = getUserIdFromURL();
 jobId = getJobIdFromURL();

console.log("jobId   ",jobId,"  userIdURL  ",userIdURL);

const jobDocRef = doc(db, 'Jobs', jobId); // Reference to the job document

// Load job and company info on page load
fetchJobAndCompanyInfo(jobDocRef);

} else {
                    console.error("No user is signed in.");
                    // Handle the case where the user is not signed in
                }
            });
        } catch (error) {
            console.error("Error initializing user ID:", error);
        }
    }

    initializeUserId(); // Call the function to initialize user ID

// Assuming userIdURL is defined and accessible
if (userIdURL !== userId) {
    console.warn("Unauthorized access attempt detected! User ID mismatch.");
    console.log("What are you doing?");
    // Optionally, you could redirect the user or show a warning in the UI
    // window.location.href = 'error.html'; // Redirect example
    // showToast("You are not authorized to view this page.", "error"); // Example toast message
} else {
    console.log("Access granted. Proceeding with the operation.");
}

document.getElementById('backToJobPost').addEventListener('click', () => {
    window.history.back(); // Back to the previous page
});

// Show loading spinner
function showLoading() {
    document.getElementById('loadingSpinner').style.display = 'block';
}

function hideLoading() {
    document.getElementById('loadingSpinner').style.display = 'none';
}



// Function to retrieve answers from custom questions
function getCustomAnswers(customQuestions) {
    const customAnswers = {};
    
    customQuestions.forEach(question => {
        let answer;
        
        switch (question.type) {
            case 'multiple_choice':
                const selectedOption = document.querySelector(`input[name="${question.id}"]:checked`);
                answer = selectedOption ? selectedOption.value : null; // If no option selected, return null
                break;
            case 'text_area':
                answer = document.getElementById(question.id).value.trim();
                break;
            case 'input_field':
                answer = document.getElementById(question.id).value.trim();
                break;
        }
        
        // Add the question ID and answer to the customAnswers object
        customAnswers[question.id] = answer;
    });
    
    return customAnswers;
}


// Fetch Job and Company Information
async function fetchJobAndCompanyInfo(jobDocRef) {
    try {
        const jobDoc = await getDoc(jobDocRef); // Get the job document
        if (!jobDoc.exists()) {
            throw new Error('Job not found.');
        }

         jobData = jobDoc.data();
        const companyDoc = await getDoc(doc(db, 'Companies', jobData.companyId)); // Assuming you have a reference to company ID
         companyData = companyDoc.data();
        jobTitle = jobData.title;

        // Populate job information and company information
        document.getElementById('jobPostedByArea').innerHTML = `
            <p>Job Title: ${jobData.title}</p>
            <p>Company: ${companyData.name}</p>
            <p>Location: ${companyData.location}</p>
        `;
        console.log("jobData.customQuestions   ",jobData.customQuestions,"  jobData.title  ",jobData.title);

        loadCustomQuestions(jobData.customQuestions);
    } catch (error) {
        console.error('Error fetching job and company info:', error);
        showToast('Failed to load job information. Please try again.', 'error');
    }
}




// Event listener for messaging the recruiter

document.getElementById('messageRecruiter').addEventListener('click', async () => {
    const messageContent = sanitizeInput(document.getElementById('messageContent').value);
    const userId = getUserIdFromURL();
    const jobID = getJobIdFromURL();

    if (!recruiterEmail || !messageContent) {
        showToast('Please fill in all fields.', 'error');
        return;
    }

    try {
        // Construct message object
        const message = {
            senderId: userId,
            jobID: jobID,
            recipientID: jobData.recruiterID,
            subject: jobData.title,
            senderStatus: "active",
            recipientStatus: "active",
            recipientRead: false,
            content: messageContent,
            timestamp:  new Date().toLocaleString(),
        };

        // Save message to Firestore
        await addDoc(collection(db, "Messages"), message);

        window.location.href = `messaging.html?userId=${userId}`;
    } catch (error) {
        console.error("Error sending message: ", error);
        showToast('Failed to send the message. Please try again.', 'error');
    }
});

// Function to sanitize user input
function sanitizeInput(input) {
    return input.trim().replace(/<[^>]*>/g, ''); // Basic HTML tag removal for sanitization
}

// Form Validation
function validateForm() {
    const requiredFields = ['firstName', 'lastName', 'email', 'phone'];
    for (const field of requiredFields) {
        const value = sanitizeInput(document.getElementById(field).value);
        if (!value) {
            showToast(`${field} is required.`, 'error');
            return false;
        }
        document.getElementById(field).value = value; // Update the input with sanitized value
    }

    // Email validation
    const email = document.getElementById('email').value;
    const emailPattern = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6}$/;
    if (!emailPattern.test(email)) {
        showToast('Invalid email format.', 'error');
        return false;
    }

    // Phone validation (simple numeric check)
    const phone = document.getElementById('phone').value;
    if (!/^\d+$/.test(phone)) {
        showToast('Phone number must be numeric.', 'error');
        return false;
    }

    return true;
}


// Function to handle application submission
async function submitApplication(boosted = false) {
    const userId = auth.currentUser ? auth.currentUser.uid : null; // Get user ID
    if (!userId) {
        showToast('You must be logged in to apply.', 'error');
        return;
    }
    
    if (jobData.applicationAvailableBool) {
        // Validate form fields before proceeding
        if (!validateForm()) {
            return;
        }

        const userId = getUserIdFromURL();
        const jobId = getJobIdFromURL();

        // Assuming these values are populated elsewhere
        const jobTitle = jobData.title; 
        const companyName = jobData.companyName; 
        const companyId = jobData.companyId; 

        // Retrieve answers for custom questions
        const customAnswers = getCustomAnswers(jobData.customQuestions);

        // Prepare main application data
        const applicationData = {
            firstName: sanitizeInput(document.getElementById('firstName').value),
            lastName: sanitizeInput(document.getElementById('lastName').value),
            email: sanitizeInput(document.getElementById('email').value),
            phone: sanitizeInput(document.getElementById('phone').value),
            notes: sanitizeInput(document.getElementById('noteToRecruiter').value),
            portfolio: sanitizeInput(document.getElementById('portfolio').value),
            jobTitle: jobTitle,
            companyName: companyName,
            companyId: companyId,
            boostedApp: boosted,  // Set to true if boosting
            jobId: jobId,
            status: "active",
            interviewRequestBool: false,
            interviewRequestDate: '',
            testRequestBool: false,
            testRequestExpireDate: '',
            testRequestNames: [],
            views: 0,
            resumeViews: 0,
            videoResumeViews: 0,
            userId: userId,
            customAnswers: customAnswers, // Add custom answers to the data
            applyDate: new Date().toLocaleString(),
        };

        // Prepare applicant PDC data (Personal Data Compliance)
        const applicant_PDC = {
            gender: sanitizeInput(document.getElementById('gender').value),
            race: sanitizeInput(document.getElementById('race').value),
            veteran: sanitizeInput(document.getElementById('veteran').value),
            disability: sanitizeInput(document.getElementById('disability').value),
            shareInfo: document.getElementById('shareInfo').checked,
            disclosureName: sanitizeInput(document.getElementById('disclosureName').value),
            disclosureDate: sanitizeInput(document.getElementById('disclosureDate').value),
            jobId: jobId,
            submitted: new Date().toLocaleString(),
        };

        try {
            // Show loading indicator if you have one
            showLoading();

            // Upload files
            await uploadFile('resumeUpload', 'resumes', applicationData, 'resumeUrl');
            await uploadFile('videoResumeUpload', 'video_resumes', applicationData, 'videoResumeUrl');

            // Submit the application data to Firestore
            await addDoc(collection(db, 'Applications'), applicationData);

            // Send the applicant's personal data compliance (PDC) information
            await sendToAppDataCompliance(applicant_PDC);

                     // Update user's document with the job application info
                     const userDocRef = doc(db, 'Users', userId); // Reference to the user's document
            await updateDoc(userDocRef, {
                userApps: arrayUnion({ jobId, jobTitle, companyName, status, boostedApp, applyDate: new Date().toISOString() })
            });

            // Show success message
            showToast('Application submitted successfully!', 'success');
        } catch (error) {
            console.error('Error submitting application:', error);
            showToast('Error submitting application. Please try again.', 'error');
        } finally {
            // Hide loading indicator
            hideLoading();
        }
    }
}

// Event listener for submit application button
document.getElementById('submitApplication').addEventListener('click', () => {
    submitApplication(false); // Regular application
});

// Event listener for boost application button
document.getElementById('boostApplication').addEventListener('click', () => {
    submitApplication(true); // Boosted application
});



// Function to upload files and add their URLs to the applicantData
async function uploadFile(inputId, folder, applicantData, urlKey) {
    const file = document.getElementById(inputId).files[0];
    if (file) {
        const fileRef = storage.ref(`${folder}/${file.name}`);
        await fileRef.put(file);
        applicantData[urlKey] = await fileRef.getDownloadURL();
    }
}

// Function to send applicant_PDC to AppDataCompliance collection
async function sendToAppDataCompliance(applicantData) {
    try {
        const docRef = await addDoc(collection(db, 'AppDataCompliance'), applicantData);
        console.log('Document written with ID: ', docRef.id);
    } catch (error) {
        console.error('Error adding document to AppDataCompliance:', error);
    }
}


</script>

</body>
</html>
