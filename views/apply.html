<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Application Page</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
   </head>
<body>

<!-- Navigation Bar -->
<nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
    <a class="navbar-brand" href="../index.html">ReelCareer</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ml-auto">
            <li class="nav-item">
                <a class="nav-link" href="../index.html">Home</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="job-listings.html">Job Listings</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="company-pages.html">Company Pages</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="job-seeker.html">Job Seeker</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="recruiter-dashboard.html">Recruiter Dashboard</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="news.html">News</a>
            </li>
        </ul>
    </div>
</nav>

<div class="container mt-5 mb-5">
    <h1 class="text-center mb-4">Job Application</h1>
    <form id="applicationForm" class="shadow p-4 rounded bg-white">
        <!-- Applicant Information -->
        <h3 class="border-bottom pb-2">Applicant Information</h3>
        <div class="form-group">
            <label for="firstName">First Name</label>
            <input type="text" id="firstName" class="form-control" required>
        </div>
        <div class="form-group">
            <label for="lastName">Last Name</label>
            <input type="text" id="lastName" class="form-control" required>
        </div>
        <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" class="form-control" required>
        </div>
        <div class="form-group">
            <label for="phone">Phone</label>
            <input type="tel" id="phone" class="form-control" required>
        </div>

        <!-- Custom Questions -->
        <h5 class="text-muted">The following questions are provided by the recruiter and are optional.</h5>
        <div id="customQuestionsContainer"></div>

        <!-- Nondisclosure Questions -->
        <h3 class="border-bottom pb-2">Nondisclosure Questions</h3>
        <h5 class="text-muted">Please provide accurate information as required by law. Your responses will remain confidential.</h5>
        
        <div class="form-group gray-box">
            <label for="sex">Sex</label>
            <input type="text" id="sex" class="form-control" placeholder="e.g., Male, Female" required>
        </div>
        <div class="form-group gray-box">
            <label for="age">Age</label>
            <input type="number" id="age" class="form-control" placeholder="Your Age" required>
        </div>
        <div class="form-group gray-box">
            <label for="veteranStatus">Veteran Status</label>
            <input type="text" id="veteranStatus" class="form-control" placeholder="e.g., Yes, No">
        </div>
        <div class="form-group gray-box">
            <label for="sexualOrientation">Sexual Orientation</label>
            <input type="text" id="sexualOrientation" class="form-control" placeholder="e.g., Straight, LGBTQ+">
        </div>
        
        <div class="form-group form-check">
            <input type="checkbox" id="shareInfo" required class="form-check-input">
            <label for="shareInfo" class="form-check-label">I consent to share my information as per the company's policies.</label>
            <input type="text" id="disclosureName" placeholder="Your Name" class="form-control mt-2" required>
            <input type="date" id="disclosureDate" class="form-control mt-2" required>
        </div>

        <!-- Resume Submission Options -->
        <h3 class="border-bottom pb-2">Resume Submission</h3>
        <div class="form-group">
            <label for="noteToRecruiter">Note to Recruiter</label>
            <textarea id="noteToRecruiter" class="form-control" rows="3"></textarea>
        </div>
        <div class="form-group">
            <label for="videoResumeUpload">Upload Video Resume</label>
            <input type="file" id="videoResumeUpload" class="form-control-file">
            <button type="button" id="createVideoResume" class="btn btn-link text-primary">Create One</button>
        </div>
        <div class="form-group">
            <label for="resumeUpload">Upload New Resume</label>
            <input type="file" id="resumeUpload" class="form-control-file" required>
        </div>

        <div class="form-group">
            <button type="button" id="boostApplication" class="btn btn-warning btn-lg">Boost Application</button>
            <button type="button" id="previewApplication" class="btn btn-info btn-lg">Preview Application</button>
            <button type="button" id="saveForLater" class="btn btn-secondary btn-lg">Save for Later</button>
            <button type="submit" id="submitApplication" class="btn btn-success btn-lg">Submit Application</button>
        </div>

        <!-- Job Posted By Area -->
        <h3 class="border-bottom pb-2">Job Posted By</h3>
        <div id="jobPostedByArea"></div>
        <div class="d-flex justify-content-between mt-4">
            <button type="button" id="messageRecruiter" class="btn btn-primary">Message Recruiter</button>
            <button type="button" id="backToJobPost" class="btn btn-light">Back to Job Post</button>
        </div>
    </form>
</div>

<!-- Footer -->
<footer class="bg-light text-center py-4 mt-5 shadow-sm">
    <p>&copy; 2024 ReelCareer. All Rights Reserved.</p>
</footer>

<style>
    .gray-box {
        background-color: #f7f7f7;
        border: 1px solid #e0e0e0;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 15px;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .btn-lg {
            width: 100%;
            margin-bottom: 10px;
        }
    }

    /* Additional Styling for Input Focus */
    input:focus, textarea:focus {
        border-color: #007bff;
        box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
    }
</style>




    
    <script>
// Function to extract the user ID from URL parameters
function getUserIdFromURL() {
    const urlParams = new URLSearchParams(window.location.search);
    console.log("urlParams   ",urlParams);

    return urlParams.get('userId'); // Assuming userId is the parameter name in the URL
}

        // Get Job ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const jobId = urlParams.get('jobId');
        console.log("jobId   ",jobId);


    </script>
   <!-- Firebase configuration/ Login& Out -->
   <script type="module" src="../public/js/main.js"></script> 
   

   <script type="module">
    import { db, storage, analytics, app, collection, getDocs } from '../public/js/main.js'; // Adjust the path based on your structure
    import { doc, addDoc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";


/*
    const jobDocRef = doc(db, 'Jobs', jobId); // Reference to the job document

        // Fetch Job and Company Information
        async function fetchJobAndCompanyInfo(getDoc) {
    // Fetch the job document

        const jobDoc = await getDoc(jobDocRef); // Get the job document

        console.log('No draft applications found.');

        const jobData = jobDoc.data();
            const companyData = companyDoc.data();

            // Populate job information and company information
            document.getElementById('jobPostedByArea').innerHTML = `
                <p>Job Title: ${jobData.title}</p>
                <p>Company: ${companyData.name}</p>
                <p>Location: ${companyData.location}</p>
            `;
            loadCustomQuestions(jobData.customQuestions);
        }

        // Load Custom Questions
        function loadCustomQuestions(customQuestions) {
            const customQuestionsContainer = document.getElementById('customQuestionsContainer');
            customQuestions.forEach(question => {
                let inputElement;
                switch (question.type) {
                    case 'multiple_choice':
                        inputElement = `<div class="form-group">
                                            <label>${question.question}</label>
                                            ${question.options.map(option => `<div><input type="radio" name="${question.id}" value="${option}">${option}</div>`).join('')}
                                        </div>`;
                        break;
                    case 'text_area':
                        inputElement = `<div class="form-group">
                                            <label>${question.question}</label>
                                            <textarea class="form-control" id="${question.id}"></textarea>
                                        </div>`;
                        break;
                    case 'input_field':
                        inputElement = `<div class="form-group">
                                            <label>${question.question}</label>
                                            <input type="text" class="form-control" id="${question.id}">
                                        </div>`;
                        break;
                    case 'future_test':
                        // Placeholder for future question types
                        inputElement = `<div class="form-group">
                                            <label>${question.question}</label>
                                            <input type="text" class="form-control" id="${question.id}">
                                        </div>`;
                        break;
                }
                customQuestionsContainer.insertAdjacentHTML('beforeend', inputElement);
            });
        }

*/
// Event listener for messaging the recruiter

document.getElementById('messageRecruiter').addEventListener('click', async () => {
    const recruiterEmail = document.getElementById('recruiterEmail').value;
    const messageContent = document.getElementById('messageContent').value;
    const userId = getUserIdFromURL();

    if (!recruiterEmail || !messageContent) {
        alert('Please fill in all fields.');
        return;
    }

    try {
        // Construct message object
        const message = {
            senderId: userId,
            recipientEmail: recruiterEmail,
            content: messageContent,
            timestamp: new Date() // Use Date for timestamp
        };

        // Save message to Firestore
        await addDoc(collection(db, "Messages"), message);

        // Redirect to messaging page
        window.location.href = `messaging.html?userId=${userId}`;
    } catch (error) {
        console.error("Error sending message: ", error);
        alert('Failed to send the message. Please try again.');
    }
});
/*
// Function to get draft applications from Firestore
async function getDraftApplications(userId) {
    try {
        // Create a query to fetch draft applications for the specified user
        const draftQuery = query(
            collection(db, 'Applications'),
            where('userId', '==', userId), // Assuming userId is stored in each application
            where('status', '==', 'draft') // Only get drafts
        );

        // Fetch the draft applications
        const querySnapshot = await getDocs(draftQuery);

        // Array to hold draft applications
        const draftApps = [];

        // Loop through the query results
        querySnapshot.forEach(doc => {
            // Push each draft application to the array
            draftApps.push({ id: doc.id, ...doc.data() });
        });

        // Check if there are any drafts
        if (draftApps.length === 0) {
            console.log('No draft applications found.');
            return [];
        }

        // Return the array of draft applications
        return draftApps;
    } catch (error) {
        console.error('Error fetching draft applications: ', error);
        return []; // Return an empty array on error
    }
}
*/
// Example usage
const userId = getUserIdFromURL(); // Function to get the user ID from the URL
/*
getDraftApplications(userId).then(draftApps => {
    if (draftApps.length > 0) {
        console.log('Draft Applications:', draftApps);
        // You can now render these applications in your UI
    } else {
        console.log('No draft applications available.');
    }
});
*/
        document.getElementById('backToJobPost').addEventListener('click', () => {
            window.history.back(); // Back to the previous page
        });

 
        

    
        // Function to handle application submission
        document.getElementById('submitApplication')
        .addEventListener('click', async () => {

            const applicantData = {
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                notes: document.getElementById('noteToRecruiter').value,
                sex: document.getElementById('sex').value,
                age: document.getElementById('age').value,
                veteranStatus: document.getElementById('veteranStatus').value,
                sexualOrientation: document.getElementById('sexualOrientation').value,
                shareInfo: document.getElementById('shareInfo').checked,
                disclosureName: document.getElementById('disclosureName').value,
                disclosureDate: document.getElementById('disclosureDate').value,
                jobId: jobId,
                // Collect custom questions responses here
  
            };
            console.log("submitApplication  called"); // Debugging log

            // Upload resume if available
            const resumeFile = document.getElementById('resumeUpload').files[0];
            if (resumeFile) {
                const resumeRef = storage.ref(`resumes/${resumeFile.name}`);
                await resumeRef.put(resumeFile);
                applicantData.resumeUrl = await resumeRef.getDownloadURL();
            }

            // Upload video resume if available
            const videoFile = document.getElementById('videoResumeUpload').files[0];
            if (videoFile) {
                const videoRef = storage.ref(`video_resumes/${videoFile.name}`);
                await videoRef.put(videoFile);
                applicantData.videoResumeUrl = await videoRef.getDownloadURL();
            }

            // Save application data to Firestore
            await addDoc(collection(db, 'Applications'), applicantData);
                        alert('Application submitted successfully!');
                    });


        // Event Listeners
        document.getElementById('boostApplication').addEventListener('click', async () => {
            console.log("boostApplication   ");

    const applicationId = "APPLICATION_ID"; // Replace with actual application ID.
    const userId = "USER_ID"; // Replace with the user's ID, if applicable.

    try {
        // Reference to the Firestore collection where applications are stored
        const applicationRef = doc(collection(db, 'Applications'), applicationId);

        // Update the boost status in Firestore
        await applicationRef.update({
            boosted: true, // Assuming there is a 'boosted' field to indicate boost status
            boostTimestamp: firebase.firestore.FieldValue.serverTimestamp(), // Optional: timestamp for when it was boosted
        });

        alert('Application boosted successfully!');
    } catch (error) {
        console.error("Error boosting application: ", error);
        alert('Failed to boost the application. Please try again.');
    }
});

document.getElementById('previewApplication').addEventListener('click', () => {
    const firstName = document.getElementById('firstName').value;
    const lastName = document.getElementById('lastName').value;
    const email = document.getElementById('email').value;
    const phone = document.getElementById('phone').value;
    const noteToRecruiter = document.getElementById('noteToRecruiter').value;
    console.log("previewApplication   ");

    // Collecting custom questions responses
    const customQuestionsResponses = [];
    const customQuestions = document.querySelectorAll('#customQuestionsContainer input');

    customQuestions.forEach(question => {
        customQuestionsResponses.push({
            questionId: question.id,
            answer: question.value,
        });
    });

    // Create preview content
    const previewContent = `
        <h3>Application Preview</h3>
        <p><strong>First Name:</strong> ${firstName}</p>
        <p><strong>Last Name:</strong> ${lastName}</p>
        <p><strong>Email:</strong> ${email}</p>
        <p><strong>Phone:</strong> ${phone}</p>
        <p><strong>Note to Recruiter:</strong> ${noteToRecruiter}</p>
        <h4>Custom Questions</h4>
        <ul>
            ${customQuestionsResponses.map(response => `<li>${response.questionId}: ${response.answer}</li>`).join('')}
        </ul>
    `;

    // Display the preview in a modal or a new section
    const previewModal = document.createElement('div');
    previewModal.className = 'modal fade';
    previewModal.innerHTML = `
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Application Preview</h5>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    ${previewContent}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(previewModal);
    $(previewModal).modal('show'); // Use jQuery to display the modal
});


        document.getElementById('saveForLater').addEventListener('click', () => {
            console.log("saveForLater   ");

            // Save for later functionality
            const applicationData = {
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                // Include other relevant fields as needed
            };
            localStorage.setItem(`application_${jobId}`, JSON.stringify(applicationData));
            alert('Application saved for later!');
        });


       // Load job and company info on page load
       fetchJobAndCompanyInfo();
</script>

</body>
</html>
