<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Application Page</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    
    <!-- Bootstrap CSS -->
    <script src="../public/js/scripts.js"></script>
    <script src="../public/js/loadScripts.js"></script>
    <!-- Custom CSS -->
    <link rel="stylesheet" href="../public/css/styles.css">

</head>

<body>
<!-- Navigation Bar -->
<nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">

</nav>

<div class="container mt-5 mb-5">
    <h1 class="text-center mb-4">Job Application</h1>
    <form id="applicationForm" class="shadow p-4 rounded bg-white" novalidate>
        <!-- Progress Indicator -->
        <div class="progress mb-3" style="height: 20px;">
            <div id="progressBar" class="progress-bar bg-success" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
        </div>

        <!-- Applicant Information -->
        <h3 class="border-bottom pb-2">Applicant Information</h3>
        <div class="form-group">
            <label for="firstName">First Name</label>
            <input type="text" id="firstName" class="form-control" required>
            <div class="invalid-feedback">Please enter your first name.</div>
        </div>
        <div class="form-group">
            <label for="lastName">Last Name</label>
            <input type="text" id="lastName" class="form-control" required>
            <div class="invalid-feedback">Please enter your last name.</div>
        </div>
        <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" class="form-control" required>
            <div class="invalid-feedback">Please enter a valid email address.</div>
        </div>
        <div class="form-group">
            <label for="phone">Phone</label>
            <input type="tel" id="phone" class="form-control" required>
            <div class="invalid-feedback">Please enter a valid phone number.</div>
        </div>

        <!-- Custom Questions -->
        <h5 class="text-muted">The following questions are provided by the recruiter and are optional.</h5>
        <div id="customQuestionsContainer"></div>

        <!-- Nondisclosure Questions -->
<!-- Optional EEO Self-Identification Section -->
<div class="form-group mb-3">
    <p class="text-muted"><strong>Voluntary Self-Identification</strong></p>
    <p>This section is optional. Your response will not affect your application and is used solely for Equal Employment Opportunity (EEO) reporting purposes.</p>
    
    <!-- Gender (optional) -->
    <label for="gender">Gender</label>
    <select class="form-control" id="gender">
        <option value="">Prefer not to answer</option>
        <option value="Male">Male</option>
        <option value="Female">Female</option>
        <option value="Non-Binary">Non-Binary</option>
    </select>

    <!-- Race/Ethnicity (optional) -->
    <label for="race">Race/Ethnicity</label>
    <select class="form-control" id="race">
        <option value="">Prefer not to answer</option>
        <option value="White">White</option>
        <option value="Black or African American">Black or African American</option>
        <option value="Asian">Asian</option>
        <option value="Hispanic or Latino">Hispanic or Latino</option>
        <option value="Native American or Alaska Native">Native American or Alaska Native</option>
    </select>

    <!-- Veteran Status (optional) -->
    <label for="veteran">Veteran Status</label>
    <select class="form-control" id="veteran">
        <option value="">Prefer not to answer</option>
        <option value="Yes">Yes</option>
        <option value="No">No</option>
    </select>

    <!-- Disability (optional) -->
    <label for="disability">Disability Status</label>
    <select class="form-control" id="disability">
        <option value="">Prefer not to answer</option>
        <option value="Yes">Yes</option>
        <option value="No">No</option>
    </select>
</div>


<div class="form-group">
    <div class="form-check">
        <input type="checkbox" id="shareInfo" required class="form-check-input">
        <label for="shareInfo" class="form-check-label">
            I consent to the collection and sharing of my personal information as described in the 
            <a href="#" class="text-primary">Privacy Policy</a>.
        </label>
    </div>
    
    <div class="form-group mt-3">
        <label for="disclosureName" class="form-label">Your Name</label>
        <input type="text" id="disclosureName" placeholder="Enter your name" class="form-control" required>
    </div>
    
    <div class="form-group mt-3">
        <label for="disclosureDate" class="form-label">Date</label>
        <input type="date" id="disclosureDate" class="form-control" required>
    </div>
</div>


        <!-- Resume Submission Options -->
        <h3 class="border-bottom pb-2">Resume Submission</h3>
        <div class="form-group">
            <label for="noteToRecruiter">Note to Recruiter</label>
            <textarea id="noteToRecruiter" class="form-control" rows="3" placeholder="Write a brief note to the recruiter..."></textarea>
        </div>
        <div class="form-group">
            <label for="videoResumeUpload">Upload Video Resume (optional)</label>
            <input type="file" id="videoResumeUpload" class="form-control-file">
            <button type="button" id="createVideoResume" class="btn btn-link text-primary">Create One</button>
        </div>
        <div class="form-group">
            <label for="resumeUpload">Upload New Resume <span class="text-danger">*</span></label>
            <input type="file" id="resumeUpload" class="form-control-file" required>
            <div class="invalid-feedback">Please upload your resume.</div>
        </div>

        <div class="form-group text-center">
            <button type="button" id="boostApplication" class="btn btn-warning btn-lg mx-2">Boost Application</button>
            <button type="button" id="previewApplication" class="btn btn-info btn-lg mx-2">Preview Application</button>
            <button type="button" id="saveForLater" class="btn btn-secondary btn-lg mx-2">Save for Later</button>
            <button type="submit" id="submitApplication" class="btn btn-success btn-lg mx-2">Submit Application</button>
        </div>

        <!-- Job Posted By Area -->
        <h3 class="border-bottom pb-2">Job Posted By</h3>
        <div id="jobPostedByArea" class="bg-light p-3 rounded mb-3"></div>
        <div class="d-flex justify-content-between mt-4">
            <button type="button" id="messageRecruiter" class="btn btn-primary">Message Recruiter</button>
            <button type="button" id="backToJobPost" class="btn btn-light">Back to Job Post</button>
        </div>
    </form>
</div>



<style>
    /* Custom styles for enhanced UI/UX */
    body {
        font-family: 'Arial', sans-serif;
        background-color: #f8f9fa;
    }

    .navbar {
        transition: background-color 0.3s;
    }

    .navbar:hover {
        background-color: #e9ecef;
    }

    .form-group {
        transition: box-shadow 0.3s, transform 0.3s;
    }

    .form-group:hover {
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        transform: scale(1.02);
    }

    .progress {
        height: 20px;
    }

    /* Tooltip styles */
    .tooltip-inner {
        background-color: #5cb85c;
    }

    .tooltip-arrow {
        border-top-color: #5cb85c;
    }

    /* Mobile responsiveness */
    @media (max-width: 768px) {
        .navbar {
            flex-direction: column;
        }
    }
</style>



    
    <script>
// Function to extract the user ID from URL parameters
function getUserIdFromURL() {
    const urlParams = new URLSearchParams(window.location.search);
    console.log("urlParams   ",urlParams);

    return urlParams.get('userId'); // Assuming userId is the parameter name in the URL
}

        // Get Job ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const jobId = urlParams.get('jobId');
        console.log("jobId   ",jobId);
 // JavaScript for form submission and error handling
 document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('applicationForm');
        const progressBar = document.getElementById('progressBar');

        // Form validation
        form.addEventListener('submit', function (event) {
            event.preventDefault();
            if (!form.checkValidity()) {
                event.stopPropagation();
                form.classList.add('was-validated');
            } else {
                submitApplication();
            }
        });
    });


    </script>



    <!-- Footer -->
    <footer id="dynamic-footer"></footer>
    
    <!-- Firebase configuration/ Login& Out -->
    <script type="module" src="../public/js/main.js"></script> 

    <!-- Dynamic Schema Markup -->
    <script type="module">
    import { db, storage, analytics, app  } from '../public/js/main.js'; // Adjust the path based on your structure
    import { query, where, orderBy, limit,  collection, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
    
  


    const jobDocRef = doc(db, 'Jobs', jobId); // Reference to the job document

        // Fetch Job and Company Information
        async function fetchJobAndCompanyInfo(getDoc) {
    // Fetch the job document

        const jobDoc = await getDoc(jobDocRef); // Get the job document

        console.log('No draft applications found.');

        const jobData = jobDoc.data();
            const companyData = companyDoc.data();

            // Populate job information and company information
            document.getElementById('jobPostedByArea').innerHTML = `
                <p>Job Title: ${jobData.title}</p>
                <p>Company: ${companyData.name}</p>
                <p>Location: ${companyData.location}</p>
            `;
            loadCustomQuestions(jobData.customQuestions);
        }

        // Load Custom Questions
        function loadCustomQuestions(customQuestions) {
            const customQuestionsContainer = document.getElementById('customQuestionsContainer');
            customQuestions.forEach(question => {
                let inputElement;
                switch (question.type) {
                    case 'multiple_choice':
                        inputElement = `<div class="form-group">
                                            <label>${question.question}</label>
                                            ${question.options.map(option => `<div><input type="radio" name="${question.id}" value="${option}">${option}</div>`).join('')}
                                        </div>`;
                        break;
                    case 'text_area':
                        inputElement = `<div class="form-group">
                                            <label>${question.question}</label>
                                            <textarea class="form-control" id="${question.id}"></textarea>
                                        </div>`;
                        break;
                    case 'input_field':
                        inputElement = `<div class="form-group">
                                            <label>${question.question}</label>
                                            <input type="text" class="form-control" id="${question.id}">
                                        </div>`;
                        break;
                    case 'future_test':
                        // Placeholder for future question types
                        inputElement = `<div class="form-group">
                                            <label>${question.question}</label>
                                            <input type="text" class="form-control" id="${question.id}">
                                        </div>`;
                        break;
                }
                customQuestionsContainer.insertAdjacentHTML('beforeend', inputElement);
            });
        }


// Event listener for messaging the recruiter

document.getElementById('messageRecruiter').addEventListener('click', async () => {
    const recruiterEmail = document.getElementById('recruiterEmail').value;
    const messageContent = document.getElementById('messageContent').value;
    const userId = getUserIdFromURL();

    if (!recruiterEmail || !messageContent) {
        alert('Please fill in all fields.');
        return;
    }

    try {
        // Construct message object
        const message = {
            senderId: userId,
            recipientEmail: recruiterEmail,
            content: messageContent,
            timestamp: new Date() // Use Date for timestamp
        };

        // Save message to Firestore
        await addDoc(collection(db, "Messages"), message);

        // Redirect to messaging page
        window.location.href = `messaging.html?userId=${userId}`;
    } catch (error) {
        console.error("Error sending message: ", error);
        alert('Failed to send the message. Please try again.');
    }
});


// Function to get draft applications from Firestore
async function getDraftApplications(userId) {
    try {
        // Create a query to fetch draft applications for the specified user
        const draftQuery = query(
            collection(db, 'Applications'),
            where('userId', '==', userId), // Assuming userId is stored in each application
            where('status', '==', 'draft') // Only get drafts
        );

        // Fetch the draft applications
        const querySnapshot = await getDocs(draftQuery);

        // Array to hold draft applications
        const draftApps = [];

        // Loop through the query results
        querySnapshot.forEach(doc => {
            // Push each draft application to the array
            draftApps.push({ id: doc.id, ...doc.data() });
        });

        // Check if there are any drafts
        if (draftApps.length === 0) {
            console.log('No draft applications found.');
            return [];
        }

        // Return the array of draft applications
        return draftApps;
    } catch (error) {
        console.error('Error fetching draft applications: ', error);
        return []; // Return an empty array on error
    }
}



 
// Example usage
const userId = getUserIdFromURL(); // Function to get the user ID from the URL
/*
getDraftApplications(userId).then(draftApps => {
    if (draftApps.length > 0) {
        console.log('Draft Applications:', draftApps);
        // You can now render these applications in your UI
    } else {
        console.log('No draft applications available.');
    }
});
*/
        document.getElementById('backToJobPost').addEventListener('click', () => {
            window.history.back(); // Back to the previous page
        });

 
    

    
        // Function to handle application submission
        document.getElementById('submitApplication')
        .addEventListener('click', async () => {

            const applicantData = {
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                notes: document.getElementById('noteToRecruiter').value,
                jobId: jobId,

                // Collect custom questions responses here
  
            };
//Personal Data Collected from Candidates
            const applicant_PDC = {
                gender: document.getElementById('gender').value,
                race: document.getElementById('race').value,
                veteran: document.getElementById('veteran').value,
                disability: document.getElementById('disability').value,
                shareInfo: document.getElementById('shareInfo').checked,
                disclosureName: document.getElementById('disclosureName').value,
                disclosureDate: document.getElementById('disclosureDate').value,
                jobId: jobId,
            },

            console.log("submitApplication  called"); // Debugging log

            // Upload resume if available
            const resumeFile = document.getElementById('resumeUpload').files[0];
            if (resumeFile) {
                const resumeRef = storage.ref(`resumes/${resumeFile.name}`);
                await resumeRef.put(resumeFile);
                applicantData.resumeUrl = await resumeRef.getDownloadURL();
            }

            // Upload video resume if available
            const videoFile = document.getElementById('videoResumeUpload').files[0];
            if (videoFile) {
                const videoRef = storage.ref(`video_resumes/${videoFile.name}`);
                await videoRef.put(videoFile);
                applicantData.videoResumeUrl = await videoRef.getDownloadURL();
            }

            // Save application data to Firestore
            await addDoc(collection(db, 'Applications'), applicantData);
 // Simulate form submission
 let progress = 0;
            progressBar.style.width = '0%';
            const interval = setInterval(() => {
                progress += 10;
                progressBar.style.width = progress + '%';
                progressBar.setAttribute('aria-valuenow', progress);
                if (progress >= 100) {
                    clearInterval(interval);
                    alert('Application submitted successfully!');
                    form.reset();
                    progressBar.style.width = '0%';
                }
            }, 300);
                            
        });
    

        // Event Listeners
        document.getElementById('boostApplication')
        .addEventListener('click', async () => {
            console.log("boostApplication   ");

    const applicationId = "APPLICATION_ID"; // Replace with actual application ID.
    const userId = "USER_ID"; // Replace with the user's ID, if applicable.

    try {
        // Reference to the Firestore collection where applications are stored
        const applicationRef = doc(collection(db, 'Applications'), applicationId);

        // Update the boost status in Firestore
        await applicationRef.update({
            boosted: true, // Assuming there is a 'boosted' field to indicate boost status
            boostTimestamp: firebase.firestore.FieldValue.serverTimestamp(), // Optional: timestamp for when it was boosted
        });

        alert('Application boosted successfully!');
    } catch (error) {
        console.error("Error boosting application: ", error);
        alert('Failed to boost the application. Please try again.');
    }
});

document.getElementById('previewApplication').addEventListener('click', () => {
    const firstName = document.getElementById('firstName').value;
    const lastName = document.getElementById('lastName').value;
    const email = document.getElementById('email').value;
    const phone = document.getElementById('phone').value;
    const noteToRecruiter = document.getElementById('noteToRecruiter').value;
    console.log("previewApplication   ");

    // Collecting custom questions responses
    const customQuestionsResponses = [];
    const customQuestions = document.querySelectorAll('#customQuestionsContainer input');

    customQuestions.forEach(question => {
        customQuestionsResponses.push({
            questionId: question.id,
            answer: question.value,
        });
    });

    // Create preview content
    const previewContent = `
        <h3>Application Preview</h3>
        <p><strong>First Name:</strong> ${firstName}</p>
        <p><strong>Last Name:</strong> ${lastName}</p>
        <p><strong>Email:</strong> ${email}</p>
        <p><strong>Phone:</strong> ${phone}</p>
        <p><strong>Note to Recruiter:</strong> ${noteToRecruiter}</p>
        <h4>Custom Questions</h4>
        <ul>
            ${customQuestionsResponses.map(response => `<li>${response.questionId}: ${response.answer}</li>`).join('')}
        </ul>
    `;

    // Display the preview in a modal or a new section
    const previewModal = document.createElement('div');
    previewModal.className = 'modal fade';
    previewModal.innerHTML = `
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Application Preview</h5>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    ${previewContent}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(previewModal);
    $(previewModal).modal('show'); // Use jQuery to display the modal
});


        document.getElementById('saveForLater').addEventListener('click', () => {
            console.log("saveForLater   ");

            // Save for later functionality
            const applicationData = {
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                // Include other relevant fields as needed
            };
            localStorage.setItem(`application_${jobId}`, JSON.stringify(applicationData));
            alert('Application saved for later!');
        });

 
       // Load job and company info on page load
       fetchJobAndCompanyInfo();

</script>

</body>
</html>
