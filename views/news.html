<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Stay updated with the latest news articles submitted by users, recruiters, and companies.">
    <meta name="keywords" content="Career Tips, Industry News, Recruiter Insights">
    <title>News Portal</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="styles.css">
    


    <!-- Dynamic Schema Markup -->
    <script type="application/ld+json" id="dynamicSchema">
    {
        "@context": "https://schema.org",
        "@type": "WebPage",
        "name": "News Page",
        "description": "Latest news articles submitted by users, recruiters, and companies.",
        "url": "http://www.example.com/news",
        "mainEntity": {
            "@type": "WebSite",
            "name": "News Portal",
            "url": "http://www.example.com"
        }
    }
    </script>
</head>
<body>

    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="../index.html">ReelCareer</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
            aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item"><a class="nav-link" href="../index.html">Home</a></li>
                <li class="nav-item"><a class="nav-link" href="job-listings.html">Job Listings</a></li>
                <li class="nav-item"><a class="nav-link" href="company-pages.html">Company Pages</a></li>
                <li class="nav-item"><a class="nav-link" href="job-seeker.html">Job Seeker</a></li>
                <li class="nav-item"><a class="nav-link" href="recruiter-dashboard.html">Recruiter Dashboard</a></li>
                <li class="nav-item"><a class="nav-link" href="news.html">News</a></li>
            </ul>
        </div>
    </nav>
<header class="bg-dark text-white text-center p-4">
    <h1>News Portal</h1>
    <nav>
        <ul class="nav justify-content-center">
            <li class="nav-item"><a class="nav-link text-white" href="#submission">Submit Article</a></li>
            <li class="nav-item"><a class="nav-link text-white" href="#news-feed">News Feed</a></li>
        </ul>
    </nav>
</header>

<main class="container my-5">
    <section id="submission" class="mb-5">
        <h2>Submit Your Article</h2>
        <div id="article-form" onsubmit="submitArticle()">
          <!--  <form id="article-form" onsubmit="submitArticle(event)"> -->
                <div class="form-group">
                <label for="title">Title:</label>
                <input type="text" class="form-control" id="title" required>
            </div>
            <div class="form-group">
                <label for="content">Content:</label>
                <textarea class="form-control" id="content" required></textarea>
            </div>
            <div class="form-group">
                <label for="tags">Tags (select relevant tags):</label>
                <select class="form-control" id="tags" multiple required>
                    <option value="Job Search Tips">Job Search Tips</option>
                    <option value="Career Development">Career Development</option>
                    <option value="Industry News">Industry News</option>
                    <option value="Remote Work">Remote Work</option>
                    <option value="Hiring Trends">Hiring Trends</option>
                </select>
            </div>
            <div class="form-group">
                <label for="category">Category:</label>
                <select class="form-control" id="category" required>
                    <option value="Career Tips">Career Tips</option>
                    <option value="Industry News">Industry News</option>
                    <option value="Recruiter Insights">Recruiter Insights</option>
                </select>
            </div>
            <div class="form-group">
                <label for="media">Upload Media (images/videos/documents):</label>
                <input type="file" class="form-control" id="media" multiple accept="image/*,video/*,application/pdf">
                <small>Recommended image size: 1200x800 pixels.</small>
            </div>
            <button type="submit" class="btn btn-success" onclick="submitArticle();">Submit Article</button>
            <button type="button" class="btn btn-secondary" onclick="previewArticleFunc();">Preview</button>
        </div> 
        <div id="preview" class="mt-4"></div>
    </section>

    <section id="news-feed">
        <h2>Latest News</h2>
        <div id="articles" class="row">Loading articles...</div>

    </section>
</main>

<footer class="text-center p-4 bg-dark text-white">
    <p>&copy; 2024 News Portal</p>
</footer>

<!-- CKEditor for rich text editing -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/ckeditor/4.16.0/ckeditor.js"></script>

    
   <!-- Firebase configuration/ Login& Out -->
   <script type="module" src="../public/js/main.js"></script>


<script type="module">
    import { db, storage, analytics, app, collection, getDocs } from '../public/js/main.js'; // Adjust the path based on your structure
  
 // Initialize CKEditor for rich text editing
 CKEDITOR.replace('content');
/*

// Auto-save drafts feature
const autoSaveInterval = setInterval(() => {
    const title = document.getElementById('title').value;
    const content = CKEDITOR.instances['content'].getData();
    const tags = Array.from(document.getElementById('tags').selectedOptions).map(option => option.value);
    const category = document.getElementById('category').value;

    if (title || content) {
        const draftData = { title, content, tags, category };
        localStorage.setItem('draftArticle', JSON.stringify(draftData));
    }
}, 30000); // Auto-save every 30 seconds

*/

// Implement spam detection
const spamDetection = (submission) => {
    const spamKeywords = ["spam", "fake"];
    return !spamKeywords.some(keyword => submission.includes(keyword));
};





// Function to submit an article
async function submitArticle() { 
    console.log("submitArticle function called");

    // Get article details from form elements
    const title = document.getElementById('title').value;
    const content = CKEDITOR.instances['content'].getData();
    const tags = Array.from(document.getElementById('tags').selectedOptions).map(option => option.value);
    const category = document.getElementById('category').value;
    const mediaFiles = document.getElementById('media').files;

    // Validate for forbidden words (basic filter for bad language or SQL injections)
    const forbiddenWords = ["badword1", "badword2"];
    if (forbiddenWords.some(word => content.includes(word))) {
        alert("Your content contains inappropriate language.");
        return;
    }

    let mediaURLs = [];

    if (mediaFiles.length > 0) {
        console.log("Starting media upload...");

        // Handle media file uploads
        const uploadPromises = Array.from(mediaFiles).map(file => {
            const fileRef = ref(storage, `media/${file.name}`); // Create reference for each file
            const uploadTask = uploadBytesResumable(fileRef, file); // Upload file

            return uploadTask.then(snapshot => getDownloadURL(snapshot.ref)); // Get download URL after upload
        });

        try {
            // Wait for all media files to be uploaded
            mediaURLs = await Promise.all(uploadPromises);
        } catch (uploadError) {
            console.error("Error uploading media files:", uploadError);
            alert("An error occurred while uploading media files.");
            return; // Stop the submission if media upload fails
        }
    } else {
        console.log("No media files to upload.");
    }

    // Prepare article data to be stored in Firestore
    const newArticle = {
        title,
        content,
        tags,
        category,
        mediaFiles: mediaURLs,  // This will be an empty array if no media files were uploaded
        authorID: 'user123',  // Replace with the actual user ID
        authorType: 'user',   // Adjust author type if needed
        status: 'pending',    // Articles may be reviewed before going live
        createdAt: new Date() // Timestamp for when the article is created
    };

    try {
        // Add article to Firestore
        await addDoc(collection(db, 'Articles'), newArticle);
        console.log('Article successfully added!');

        // Handle actions after successful submission
        alert('Article submitted successfully!');
        displayArticles(); // Refresh the displayed list of articles (this function needs to be defined)

        // Clear form inputs
        document.getElementById('article-form').reset();
        CKEDITOR.instances['content'].setData('');  // Clear the CKEditor content

        // Clear any draft article stored in localStorage
        localStorage.removeItem('draftArticle');
    } catch (error) {
        console.error("Error adding article:", error);
        alert("An error occurred while submitting the article. Please try again.");
    }
}


// Function to display articles
async function displayArticles() {
console.log("displayArticles function called"); // Debugging log

const articlesContainer = document.getElementById('articles');
if (!articlesContainer) {
    console.error('No articles container found in DOM'); // Check if the element exists
    return;
}

articlesContainer.innerHTML = ''; // Clear previous content
const articlesCollectionRef = collection(db, 'Articles'); // Reference to the Articles collection

try {
    const articlesSnapshot = await getDocs(articlesCollectionRef);
    console.log("Fetched snapshot: ", articlesSnapshot);

    articlesSnapshot.forEach((doc) => {
        const article = doc.data();
        console.log("Fetched article: ", article);

        const articleId = doc.id;

        const articleElement = document.createElement('div');
        articleElement.className = 'col-md-4 mb-4';
        articleElement.innerHTML = `
            <div class="card">
                <img src="${article.mediaFiles[0] || 'default-image-url'}" class="card-img-top" alt="${article.title}">
                <div class="card-body">
                    <h5 class="card-title">${article.title}</h5>
                    <p class="card-text">${article.content.substring(0, 100)}...</p>
                    <p>Tags: ${article.tags ? article.tags.join(', ') : 'No tags'}</p>
                    <p>Category: ${article.category || 'Uncategorized'}</p>
                    <a href="article.html?id=${articleId}" class="btn btn-primary">Read More</a>
                </div>
            </div>
        `;
        articlesContainer.appendChild(articleElement);
    });

} catch (error) {
    console.error("Error fetching articles:", error);
}

console.log("Articles display finished.");
}



// Function to update the HTML and display the articles
function updateNewsFeed(articles) {
    const articlesContainer = document.getElementById('articles');
    articlesContainer.innerHTML = ''; // Clear the placeholder text

    if (articles.length === 0) {
        articlesContainer.innerHTML = '<p>No articles available at the moment.</p>';
        return;
    }

    // Create article cards for each article
    articles.forEach(article => {
        const articleCard = document.createElement('div');
        articleCard.classList.add('col-md-4');

        articleCard.innerHTML = `
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">${article.title}</h5>
                    <p class="card-text">${article.content.substring(0, 100)}...</p>
                    <a href="#" class="btn btn-primary">Read More</a>
                </div>
            </div>
        `;

        articlesContainer.appendChild(articleCard);
    });
}

// Call the function to display articles when the page loads
window.onload = () => {
    displayArticles();
};

function previewArticleFunc() {
        console.log("Preview Article Function Called");

        const title = document.getElementById('title').value;
        const content = CKEDITOR.instances['content'].getData();
        const tags = Array.from(document.getElementById('tags').selectedOptions).map(option => option.value);
        const category = document.getElementById('category').value;

        document.getElementById('preview').innerHTML = `
            <h3>${title}</h3>
            <div>${content}</div>
            <p>Tags: ${tags.join(', ')}</p>
            <p>Category: ${category}</p>
        `;
    }

   
    





</script>

</body>
</html>
