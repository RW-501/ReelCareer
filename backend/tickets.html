<!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Admin Ticket Page</title>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://reelcareer.co/backend/css/styles.css">
        <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    </head>
    
    <body>
        <script src="https://reelcareer.co/public/js/bodyload.js"></script>
        
     <!-- Navbar section -->
     <nav id="Main_Nav" class="navbar navbar-expand-lg navbar-light bg-light" role="navigation" aria-label="Main Navigation">
        <a class="navbar-brand" href="https://reelcareer.co">ReelCareer.co</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav">
      
                              <!-- Dashboard and New Group -->
                              <div class="navGroup" title="Dashboard and Analytics">
                                  <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/notes">Notes</a></li>
                                  <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/titles-fix">Title Fix</a></li>
                        </div>
      
                  <!-- Dashboard and Analytics Group -->
                  <div class="navGroup" title="Dashboard and Analytics">
                      <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/dashboard">Dashboard</a></li>
                      <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/analytics">Analytics</a></li>
                      <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/state-labour-market">State Labour Market</a></li>
                      <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/ping">Ping</a></li>
                      <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/page-editor">Page Editor</a></li>
                      <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/notes">Notes</a></li>
                  </div>
                  <!-- Management Tools -->
                  <div class="navGroup" title="Management Tools">
                      <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/content-management">Content <small>Management</small></a></li>
                      <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/user-management">User <small>Management</small></a></li>
                      <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/job-management">Job <small>Management</small></a></li>
                      <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/application-management">Application <small>Management</small></a></li>
                  </div>
                  <!-- General Settings and Utilities -->
                  <div class="navGroup" title="General Settings and Utilities">
                      <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/contact">Contact</a></li>
                      <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/settings">Settings</a></li>
                      <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/support">Support</a></li>
                      <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/chatbot">Chatbot</a></li>
                      <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/notifications-management">Notifications <small>Management</small></a></li>
                      <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/system-logs">System Logs</a></li>
                  </div>
                  <!-- Finance and Monetization -->
                  <div class="navGroup" title="Finance and Monetization">
                      <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/transactions">Transactions</a></li>
                      <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/integration-management">Integration <small>Management</small></a></li>
                      <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/payments">Payments</a></li>
                      <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/monetization">Monetization</a></li>
                  </div>
                  <!-- SEO and Cleanup -->
                  <div class="navGroup" title="SEO and Cleanup">
                      <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/delete-dup">Delete Dup</a></li>
                      <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/seo-helper">SEO Helper</a></li>
                  </div>
                  <!-- Role and Personality Management -->
                  <div class="navGroup" title="Role and Personality Management">
                      <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/role-management">Role <small>Management</small></a></li>
                      <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/trait-personality-management">Trait Personality <small>Management</small></a></li>
                  </div>
              </ul>
          </div>
      </nav>    
    
       
      <style>
        /* Basic Styles for Table */
        table {
          width: 100%;
          border-collapse: collapse;
        }
    
        th, td {
          padding: 12px;
          text-align: left;
          border: 1px solid #ddd;
        }
    
        th {
          background-color: #f2f2f2;
        }
    
        tr:nth-child(even) {
          background-color: #f9f9f9;
        }
    
        .collapsible {
          display: none;
          background-color: #f9f9f9;
          padding: 10px;
        }
    
        .expand-btn {
          cursor: pointer;
          background-color: #007BFF;
          color: white;
          border: none;
          padding: 5px 10px;
          margin-top: 10px;
        }
    
        .status-dropdown {
          margin: 10px 0;
          padding: 5px;
        }
    
        .follow-up-btn {
          margin-top: 10px;
          padding: 5px 10px;
          background-color: #28a745;
          color: white;
          border: none;
          cursor: pointer;
        }
    
        .search-box {
          margin: 20px 0;
          padding: 10px;
          width: 100%;
          border: 1px solid #ddd;
        }


        /* Modal background */
.modal {
    display: none;
    position: fixed;
    z-index: 1;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgb(0,0,0);
    background-color: rgba(0,0,0,0.4);
    padding-top: 60px;
}

/* Modal content */
.modal-content {
    background-color: #fefefe;
    margin: 5% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
    max-width: 600px;
}

/* Close button */
.close-btn {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
}

.close-btn:hover,
.close-btn:focus {
    color: black;
    text-decoration: none;
    cursor: pointer;
}

      </style>
   

   <main id="main-content">
    <title>Admin Ticket Page</title>

    <section id="analytics-cards">
        <!-- Search Bar -->
        <input type="text" id="searchBox" class="search-box" placeholder="Search tickets..." onkeyup="searchTickets()" />

        <!-- Table for Tickets -->
        <table id="ticketsTable">
            <thead>
                <tr>
                    <th id="typeHeader">Type</th>
                    <th id="submittedByHeader">Submitted By</th>
                    <th id="dateHeader">Date</th>
                    <th>Status</th>
                    <th>Details</th>
                </tr>
            </thead>
            <tbody id="ticketsList">
                <!-- Dynamic ticket rows will go here -->
            </tbody>
        </table>
    </section>
</main>

    <!-- Modal for sending follow-up message -->
<div id="ticketModal" class="modal">
    <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h3>Ticket Information</h3>
        <p><strong>Ticket Type:</strong> <span id="ticketType"></span></p>
        <p><strong>Submitted By:</strong> <span id="ticketSubmittedBy"></span></p>
        <p><strong>Submitted At:</strong> <span id="ticketSubmittedAt"></span></p>
        <p><strong>Message:</strong> <span id="ticketMessage"></span></p>
        
        <h4>Choose a Prewritten Message</h4>
        <select id="messageDropdown">
            <option value="message1">Follow-up on Ticket</option>
            <option value="message2">Urgent: Need More Information</option>
            <option value="message3">Ticket Status Update</option>
            <option value="message4">Ticket Review in Progress</option>
            <option value="message5">Thank You for Your Submission</option>
        </select>
        
        
        <button id="sendMessageBtn">Send Message</button>
    </div>
</div>

    
        <!-- Footer -->
        <footer id="dynamic-footer"></footer>
        
        <!-- Firebase configuration/ Login& Out -->
        <script type="module" src="https://reelcareer.co/public/js/main.js"></script> 
    
        <!-- Firebase JS SDK and Custom Scripts -->
    
<script type="module">
    import {
        db, doc, getDoc, query, updateDoc, setDoc, ref, signInWithPopup, orderBy,
        uploadBytes, OAuthProvider, arrayUnion, getStorage, signOut, addDoc, increment,
        onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword,
        where, getDocs, storage, collection, deleteObject, auth, analytics, deleteDoc, getDownloadURL
    } from 'https://reelcareer.co/js/module.js';

   // Array to hold tickets 
let tickets = []; 

// Helper function to create a table row from a ticket
function createTicketRow(ticket, ticketId) {
    const row = document.createElement("tr");
    
    // Safely format submittedAt
    let submittedAt = "";
    if (ticket.submittedAt && ticket.submittedAt.seconds) {
        submittedAt = new Date(ticket.submittedAt.seconds * 1000).toLocaleString();
    } else {
        submittedAt = "Date not available";
    }

    // Safely format reasons (check if it’s an array)
    const reasons = Array.isArray(ticket.reasons) ? ticket.reasons.join(", ") : "No reasons provided";

    row.innerHTML = `
        <td>${ticket.type || 'N/A'}</td>
        <td>${ticket.submittedBy || 'N/A'}</td>
        <td>${submittedAt}</td>
        <td>
            <select class="status-dropdown" onchange="updateStatus('${ticketId}')">
                <option value="submitted" ${ticket.status === 'submitted' ? 'selected' : ''}>Submitted</option>
                <option value="pending" ${ticket.status === 'pending' ? 'selected' : ''}>Pending</option>
                <option value="complete" ${ticket.status === 'complete' ? 'selected' : ''}>Complete</option>
            </select>
        </td>
        <td>
            <button class="expand-btn" onclick="toggleDetails('${ticketId}')">Details</button>
            <div class="collapsible" id="details-${ticketId}">
                <p><strong>UserName:</strong> ${ticket.submittedByUserName || 'N/A'}</p>
                <p><strong>Message:</strong> ${ticket.message || 'No message provided'}</p>
                <p><strong>Reasons:</strong> ${reasons}</p>
                <p><strong>URL:</strong> <a href="${ticket.URL || '#'}" target="_blank">${ticket.URL || 'No URL provided'}</a></p>
                ${ticket.submittedBy === 'user' ? `<button class="follow-up-btn" onclick="sendFollowUp('${ticketId}', ${JSON.stringify(ticket)})">Send Follow-Up</button>` : ''}
            </div>
        </td>
    `;
    return row;
}



// Function to fetch tickets from Firestore and render them
async function fetchTickets() {
    const ticketsList = document.getElementById("ticketsList");
    ticketsList.innerHTML = ""; // Clear previous rows

    try {
        // Fetch tickets from Firestore SupportTickets collection
        const querySnapshot = await getDocs(collection(db, 'SupportTickets'));

        // Loop through the documents and create rows
        tickets = []; // Reset tickets array
        querySnapshot.forEach((doc) => {
            const ticket = doc.data();
            tickets.push(ticket); // Add ticket data to tickets array

            const row = createTicketRow(ticket, doc.id); // Create row using helper function
            ticketsList.appendChild(row); // Append row to the table
        });
    } catch (error) {
        console.error("Error fetching tickets: ", error);
    }
}

// Function to toggle ticket details visibility
function toggleDetails(ticketId) {
    const details = document.getElementById(`details-${ticketId}`);
    details.style.display = details.style.display === "none" ? "block" : "none";
}

window.toggleDetails = toggleDetails;

// Function to update ticket status in Firestore
async function updateStatus(ticketId) {
    const status = document.querySelector(`#${ticketId} .status-dropdown`).value;

    try {
        // Update the status in Firestore
        await updateDoc(doc(db, 'SupportTickets', ticketId), {
            status: status
        });
        showToast(`Updated status for ticket ${ticketId} to ${status}`);
    } catch (error) {
        console.error("Error updating status: ", error);
    }
}

// Function to send a follow-up message to the "Messages" collection
// Function to open the modal and populate ticket data
function openTicketModal(ticketId, ticketData) {
    const modal = document.getElementById("ticketModal");
    
    // Populate the modal with ticket data
    document.getElementById("ticketType").textContent = ticketData.type;
    document.getElementById("ticketSubmittedBy").textContent = ticketData.submittedBy;
    document.getElementById("ticketSubmittedAt").textContent = new Date(ticketData.submittedAt.seconds * 1000).toLocaleString();
    document.getElementById("ticketMessage").textContent = ticketData.message;

    // Show the modal
    modal.style.display = "block";

    // Add event listener to close the modal when clicked
    document.querySelector(".close-btn").addEventListener("click", () => {
        modal.style.display = "none";
    });

    // Add event listener to send message when button clicked
    document.getElementById("sendMessageBtn").onclick = () => sendFollowUp(ticketId, ticketData);
}

// Function to send a prewritten follow-up message to the user
async function sendFollowUp(ticketId, ticketData) {
    const messageDropdown = document.getElementById("messageDropdown");
    const selectedMessage = messageDropdown.value;

    let message = "";
    
    // Use ticketData to replace placeholders in the message
    if (selectedMessage === "message1") {
        message = `Hello ${ticketData.submittedByUserName},\n\n` +
                  `We are following up regarding your ticket related to the job position: ${ticketData.jobTitle}. ` +
                  `Our team is currently working diligently to resolve your concern regarding "${ticketData.reasons}". ` +
                  `We will update you as soon as there is a resolution.\n\n` +
                  `Thank you for your patience.\n\n` +
                  `Best regards,\nReelCareer Support`;
    } else if (selectedMessage === "message2") {
        message = `Hello ${ticketData.submittedByUserName},\n\n` +
                  `We urgently need more details regarding your ticket about the job position: ${ticketData.jobTitle}. ` +
                  `You mentioned the following reason: "${ticketData.reasons}", but we require additional information to proceed. ` +
                  `Could you kindly provide more context?\n\n` +
                  `Looking forward to your response.\n\n` +
                  `Best regards,\nReelCareer Support`;
    } else if (selectedMessage === "message3") {
        message = `Hello ${ticketData.submittedByUserName},\n\n` +
                  `This is a status update regarding your ticket for the job position: ${ticketData.jobTitle}. ` +
                  `We are actively addressing your concern and the team is working on resolving it. ` +
                  `Please review the updates on your ticket.\n\n` +
                  `If you need further assistance, feel free to reach out.\n\n` +
                  `Best regards,\nReelCareer Support`;
    } else if (selectedMessage === "message4") {
        message = `Hello ${ticketData.submittedByUserName},\n\n` +
                  `We wanted to inform you that your ticket regarding the job position: ${ticketData.jobTitle} is being reviewed. ` +
                  `The reason you submitted was: "${ticketData.reasons}", and we are looking into it to ensure everything is properly addressed.\n\n` +
                  `Our team will keep you updated as we progress.\n\n` +
                  `Best regards,\nReelCareer Support`;
    } else if (selectedMessage === "message5") {
        message = `Hello ${ticketData.submittedByUserName},\n\n` +
                  `Thank you for submitting your ticket regarding the position: ${ticketData.jobTitle}. ` +
                  `We are currently evaluating your issue, which was described as: "${ticketData.reasons}". ` +
                  `Our support team will reach out with any updates or when we need further clarification.\n\n` +
                  `Thanks for your cooperation.\n\n` +
                  `Best regards,\nReelCareer Support`;
    }

    // Prepare message data
    const messageData = {
        recipientID: "000000",
        recipientName: ticketData.submittedByUserName,
        recipientProfileURL: `https://reelcareer.co/u/?u=${ticketData.submittedByUserID}`,
        recipientProfilePicture: "",
        recipientRead: false,
        participants: ["000000", ticketData.submittedByUserID],
        senderID: "000000",
        senderName: "Support",
        senderProfilePicture: "https://reelcareer.co/Images/logo.png",
        senderProfileURL: `https://reelcareer.co/support`,
        group: "main",
        messageType: "support",
        contactLocation: "platform",
        conversationID: `conversation_${ticketId}`,
        content: message.trim(),
        connectedBool: true,
        createdAt: new Date(),
        timestamp: serverTimestamp(),
        contentType: "notification",
        status: "unread",
        attachments: ""
    };

    try {
        // Send message to the "Messages" collection in Firestore
        await addDoc(collection(db, "Messages"), messageData);
        console.log(`Follow-up message sent for ticket ${ticketId}: ${message}`);
        
        // Close the modal after sending the message
        document.getElementById("ticketModal").style.display = "none";
    } catch (error) {
        console.error("Error sending follow-up message: ", error);
    }
}


// Function to search through tickets based on user input
function searchTickets() {
    const searchValue = document.getElementById("searchBox").value.toLowerCase();
    const filteredTickets = tickets.filter(ticket => {
        return ticket.jobTitle.toLowerCase().includes(searchValue) ||
               ticket.message.toLowerCase().includes(searchValue) ||
               ticket.submittedBy.toLowerCase().includes(searchValue) ||
               (ticket.submittedByUserName && ticket.submittedByUserName.toLowerCase().includes(searchValue));
    });
    renderTickets(filteredTickets); // Render filtered tickets
}

// Function to render tickets dynamically
function renderTickets(filteredTickets) {
    const ticketsList = document.getElementById("ticketsList");
    ticketsList.innerHTML = ""; // Clear previous rows

    filteredTickets.forEach(ticket => {
        const row = createTicketRow(ticket, ticket.id); // Use helper function for each ticket
        ticketsList.appendChild(row); // Append row to the table
    });
}

// Sorting tickets table by column
function sortTable(columnIndex) {
    const rows = Array.from(document.querySelector("#ticketsList").rows);
    const sortedRows = rows.sort((a, b) => {
        const aText = a.cells[columnIndex].textContent.trim().toLowerCase();
        const bText = b.cells[columnIndex].textContent.trim().toLowerCase();
        return aText.localeCompare(bText);
    });
    const ticketsList = document.getElementById("ticketsList");
    ticketsList.innerHTML = "";
    sortedRows.forEach(row => ticketsList.appendChild(row));
}


// Fetch and render tickets on load
window.onload = function () {
    fetchTickets();

    // Add event listener to follow-up button (in your existing ticket row)
document.querySelector('.follow-up-btn').addEventListener('click', () => {
    openTicketModal(ticketId, ticketData); // Call the modal function with ticket data
});

// Add event listeners to table headers for sorting
document.getElementById("typeHeader").addEventListener("click", () => sortTable(0));
document.getElementById("submittedByHeader").addEventListener("click", () => sortTable(1));
document.getElementById("dateHeader").addEventListener("click", () => sortTable(2));

};
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
            
        </script>
    </body>
    </html>
    