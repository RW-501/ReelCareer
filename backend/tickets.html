<!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Admin Ticket Page</title>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://reelcareer.co/backend/css/styles.css">
        <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    </head>
    
    <body>
        <script src="https://reelcareer.co/public/js/bodyload.js"></script>
        
     <!-- Navbar section -->
     <nav id="Main_Nav" class="navbar navbar-expand-lg navbar-light bg-light" role="navigation" aria-label="Main Navigation">
        <a class="navbar-brand" href="https://reelcareer.co">ReelCareer.co</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav">
      
                              <!-- Dashboard and New Group -->
                              <div class="navGroup" title="Dashboard and Analytics">
                                  <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/notes">Notes</a></li>
                                  <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/titles-fix">Title Fix</a></li>
                        </div>
      
                  <!-- Dashboard and Analytics Group -->
                  <div class="navGroup" title="Dashboard and Analytics">
                      <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/dashboard">Dashboard</a></li>
                      <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/analytics">Analytics</a></li>
                      <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/state-labour-market">State Labour Market</a></li>
                      <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/ping">Ping</a></li>
                      <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/page-editor">Page Editor</a></li>
                      <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/notes">Notes</a></li>
                  </div>
                  <!-- Management Tools -->
                  <div class="navGroup" title="Management Tools">
                      <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/content-management">Content <small>Management</small></a></li>
                      <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/user-management">User <small>Management</small></a></li>
                      <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/job-management">Job <small>Management</small></a></li>
                      <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/application-management">Application <small>Management</small></a></li>
                  </div>
                  <!-- General Settings and Utilities -->
                  <div class="navGroup" title="General Settings and Utilities">
                      <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/contact">Contact</a></li>
                      <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/settings">Settings</a></li>
                      <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/support">Support</a></li>
                      <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/chatbot">Chatbot</a></li>
                      <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/notifications-management">Notifications <small>Management</small></a></li>
                      <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/system-logs">System Logs</a></li>
                  </div>
                  <!-- Finance and Monetization -->
                  <div class="navGroup" title="Finance and Monetization">
                      <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/transactions">Transactions</a></li>
                      <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/integration-management">Integration <small>Management</small></a></li>
                      <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/payments">Payments</a></li>
                      <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/monetization">Monetization</a></li>
                  </div>
                  <!-- SEO and Cleanup -->
                  <div class="navGroup" title="SEO and Cleanup">
                      <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/delete-dup">Delete Dup</a></li>
                      <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/seo-helper">SEO Helper</a></li>
                  </div>
                  <!-- Role and Personality Management -->
                  <div class="navGroup" title="Role and Personality Management">
                      <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/role-management">Role <small>Management</small></a></li>
                      <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/trait-personality-management">Trait Personality <small>Management</small></a></li>
                  </div>
              </ul>
          </div>
      </nav>    
    
       
      <style>
        /* Basic Styles for Table */
        table {
          width: 100%;
          border-collapse: collapse;
        }
    
        th, td {
          padding: 12px;
          text-align: left;
          border: 1px solid #ddd;
        }
    
        th {
          background-color: #f2f2f2;
        }
    
        tr:nth-child(even) {
          background-color: #f9f9f9;
        }
    
        .collapsible {
          display: none;
          background-color: #f9f9f9;
          padding: 10px;
        }
    
        .expand-btn {
          cursor: pointer;
          background-color: #007BFF;
          color: white;
          border: none;
          padding: 5px 10px;
          margin-top: 10px;
        }
    
        .status-dropdown {
          margin: 10px 0;
          padding: 5px;
        }
    
        .follow-up-btn {
          margin-top: 10px;
          padding: 5px 10px;
          background-color: #28a745;
          color: white;
          border: none;
          cursor: pointer;
        }
    
        .search-box {
          margin: 20px 0;
          padding: 10px;
          width: 100%;
          border: 1px solid #ddd;
        }
      </style>
   


<main id="main-content">


    <title>Admin Ticket Page</title>



    <section id="analytics-cards">
   
       
        
          <!-- Search Bar -->
          <input type="text" id="searchBox" class="search-box" placeholder="Search tickets..." onkeyup="searchTickets()" />
        
          <!-- Table for Tickets -->
          <table id="ticketsTable">
            <thead>
                <tr>
                  <th id="typeHeader">Type</th>
                  <th id="submittedByHeader">Submitted By</th>
                  <th id="dateHeader">Date</th>
                  <th>Status</th>
                  <th>Details</th>
                </tr>
              </thead>
            <tbody id="ticketsList">
              <!-- Dynamic ticket rows will go here -->
            </tbody>
          </table>
        
      
        
        </section>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
        
    
    
    
    
    

    </main>
    
    
        <!-- Footer -->
        <footer id="dynamic-footer"></footer>
        
        <!-- Firebase configuration/ Login& Out -->
        <script type="module" src="https://reelcareer.co/public/js/main.js"></script> 
    
        <!-- Firebase JS SDK and Custom Scripts -->
    
        <script type="module">
            import {
                db, doc, getDoc, query, updateDoc,
                setDoc, ref, signInWithPopup, orderBy,
                 
                uploadBytes, OAuthProvider, arrayUnion, getStorage,
                signOut, addDoc, increment, onAuthStateChanged,
                createUserWithEmailAndPassword, signInWithEmailAndPassword,
                where, getDocs, storage, collection, deleteObject, 
                auth, analytics, deleteDoc, getDownloadURL
            } from 'https://reelcareer.co/js/module.js';
    
    
    
    
         
            // Sample tickets data (you'll fetch this from Firebase or backend)
// Function to fetch tickets from Firestore and render them
async function fetchTickets() {
      const ticketsList = document.getElementById("ticketsList");
      ticketsList.innerHTML = ""; // Clear previous rows

      try {
        // Fetch tickets from Firestore SupportTickets collection
        const querySnapshot = await db.collection('SupportTickets').get();
        
        // Loop through the documents and create rows
        querySnapshot.forEach((doc, index) => {
          const ticket = doc.data();
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${ticket.type}</td>
            <td>${ticket.submittedBy}</td>
            <td>${new Date(ticket.submittedAt.seconds * 1000).toLocaleString()}</td>
            <td>
              <select class="status-dropdown" onchange="updateStatus(${index}, '${doc.id}')">
                <option value="submitted" ${ticket.status === 'submitted' ? 'selected' : ''}>Submitted</option>
                <option value="pending" ${ticket.status === 'pending' ? 'selected' : ''}>Pending</option>
                <option value="complete" ${ticket.status === 'complete' ? 'selected' : ''}>Complete</option>
              </select>
            </td>
            <td>
              <button class="expand-btn" onclick="toggleDetails(${index})">Details</button>
              <div class="collapsible" id="details-${index}">
                <p><strong>Message:</strong> ${ticket.message}</p>
                <p><strong>Reasons:</strong> ${ticket.reasons.join(", ")}</p>
                <p><strong>URL:</strong> <a href="${ticket.URL}" target="_blank">${ticket.URL}</a></p>
                ${ticket.submittedBy === 'user' ? `<button class="follow-up-btn" onclick="sendFollowUp(${index}, '${doc.id}')">Send Follow-Up</button>` : ''}
              </div>
            </td>
          `;
          ticketsList.appendChild(row);
        });
      } catch (error) {
        console.error("Error fetching tickets: ", error);
      }
    }
window.fetchTickets = fetchTickets;

    // Toggle ticket details visibility
    function toggleDetails(index) {
      const details = document.getElementById(`details-${index}`);
      details.style.display = details.style.display === "none" ? "block" : "none";
    }

    // Update ticket status in Firestore
    async function updateStatus(index, ticketId) {
      const status = document.querySelector(`#ticketsList tr:nth-child(${index + 1}) .status-dropdown`).value;

      try {
        // Update the status in Firestore
        await db.collection('SupportTickets').doc(ticketId).update({
          status: status
        });
        console.log(`Updated status for ticket ${ticketId} to ${status}`);
      } catch (error) {
        console.error("Error updating status: ", error);
      }
    }

    // Send follow-up message to "Messages" collection
    async function sendFollowUp(index, ticketId) {
      const ticket = tickets[index];
      const message = `Follow-up on ticket related to ${ticket.jobTitle}`;
      
      try {
        // Send message to the "Messages" collection
        await db.collection('Messages').add({
          ticketId: ticketId,
          message: message,
          submittedAt: new Date().toISOString(),
          submittedBy: 'admin'
        });
        console.log(`Follow-up message sent for ticket ${ticketId}: ${message}`);
      } catch (error) {
        console.error("Error sending follow-up message: ", error);
      }
    }

    // Function to search through tickets
    function searchTickets() {
      const searchValue = document.getElementById("searchBox").value.toLowerCase();
      const filteredTickets = tickets.filter(ticket => {
        return ticket.jobTitle.toLowerCase().includes(searchValue) ||
               ticket.message.toLowerCase().includes(searchValue) ||
               ticket.submittedBy.toLowerCase().includes(searchValue);
      });
      renderTickets(filteredTickets);
    }

    // Sorting tickets table by column
    function sortTable(columnIndex) {
      const rows = Array.from(document.querySelector("#ticketsList").rows);
      const sortedRows = rows.sort((a, b) => {
        const aText = a.cells[columnIndex].textContent.trim().toLowerCase();
        const bText = b.cells[columnIndex].textContent.trim().toLowerCase();
        return aText.localeCompare(bText);
      });
      const ticketsList = document.getElementById("ticketsList");
      ticketsList.innerHTML = "";
      sortedRows.forEach(row => ticketsList.appendChild(row));
    }

    // Add event listeners to table headers for sorting
    document.getElementById("typeHeader").addEventListener("click", () => sortTable(0));
    document.getElementById("submittedByHeader").addEventListener("click", () => sortTable(1));
    document.getElementById("dateHeader").addEventListener("click", () => sortTable(2));

          
    
        
    
    window.onload = function () {
               
             // Initial render
             fetchTickets();
               
    
            };
        
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
            
        </script>
    </body>
    </html>
    