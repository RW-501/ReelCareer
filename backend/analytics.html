<script>

/*

<button id="applyNowButton" class="btn btn-primary">Apply Now</button>

    document.getElementById('applyNowButton').addEventListener('click', function() {
        firebase.analytics().logEvent('button_click', { button_name: 'Apply Now' });
    });

firebase.analytics().logEvent('form_submission', { form_name: 'Job Application' });

firebase.analytics().logEvent('page_view', { page_name: 'Job Listings' });
firebase.analytics().logEvent('page_view', { page_name: 'Job Listings' });

firebase.analytics().logEvent('content_view', { content_type: 'FAQ', content_title: 'How to Apply' });
firebase.analytics().logEvent('job_post_action', { action: 'view', job_id: '1234' });
firebase.analytics().logEvent('application_start', { job_id: '1234' });
firebase.analytics().logEvent('session_duration', { duration: 300 }); // duration in seconds
firebase.analytics().logEvent('user_retention', { user_id: 'user123' });
firebase.analytics().logEvent('feedback_submission', { feedback_type: 'Job Quality', user_id: 'user123' });
firebase.analytics().logEvent('referral_participation', { referrer_id: 'user456' });




*/
</script>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - Admin</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <script src="../public/js/bodyload.js"></script>
    
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="#">Reelcareer Admin</a>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav">
                <li class="nav-item"><a class="nav-link" href="../dashboard.html">Dashboard</a></li>
                <li class="nav-item"><a class="nav-link" href="../user-management.html">User Management</a></li>
                <li class="nav-item"><a class="nav-link"  href="../job-management.html">Job Management</a></li>
                <li class="nav-item"><a class="nav-link" href="../application-management.html">Application Management</a></li>
                <li class="nav-item"><a class="nav-link" href="../content-management.html">Content Management</a></li>
                <li class="nav-item"><a class="nav-link" href="../chatbot.html">Chatbot</a></li>
                <li class="nav-item"><a class="nav-link" href="../support.html">Support</a></li>
                <li class="nav-item"><a class="nav-link" href="../monetization.html">Monetization</a></li>
                <li class="nav-item"><a class="nav-link" href="../payments.html">Payments</a></li>
                <li class="nav-item"><a class="nav-link" href="../settings.html">Settings</a></li>
                <li class="nav-item"><a class="nav-link" href="/index.html">Home</a></li>
            </ul>
        </div>
    </nav>

    <div class="container mt-4">
        <h1>Analytics & Reporting</h1>


        <div class="col-md-3">
            <div class="card analytics-card shadow-sm">
                <div class="card-body">
                    <h5 class="section-title">Total Messages</h5>
                    <p id="msgCountDisplay" class="display-4">Loading...</p>
                    <div class="loading-spinner loading" id="loadingUserEngagement"></div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card analytics-card shadow-sm">
                <div class="card-body">
                    <h5 class="section-title">Total Users:</h5>
                    <p id="usersDisplay" class="display-4">Loading...</p>
                    <div class="loading-spinner loading" id="loadingEventPurchases"></div>
                </div>
            </div>
        </div>

        <!-- User Engagement Section -->
        <div class="card mb-4">
            <div class="card-body">
                <h4>User Engagement</h4>
                <canvas id="userEngagementChart"></canvas>
                <p id="engagementMetrics">Loading...</p>
            </div>
        </div>

        <!-- Job Posting Performance Section -->
        <div class="card mb-4">
            <div class="card-body">
                <h4>Job Posting Performance</h4>
                <canvas id="jobPerformanceChart"></canvas>
                <p id="jobPerformanceMetrics">Loading...</p>
            </div>
        </div>

        <!-- Job Activity Insights Section -->
        <div class="card mb-4">
            <div class="card-body">
                <h4>Job Activity Insights</h4>
                <canvas id="jobActivityChart"></canvas>
                <p id="jobActivityMetrics">Loading...</p>
            </div>
        </div>

        <!-- User Demographics Section -->
        <div class="card mb-4">
            <div class="card-body">
                <h4>User Demographics</h4>
                <canvas id="userDemographicsChart"></canvas>
                <p id="userDemographicsMetrics">Loading...</p>
            </div>
        </div>






















        <section>
            <title>User Analytics</title>
            <style>
              main {
                font-family: Arial, sans-serif;
                margin: 20px;
                background-color: #f4f4f9;
              }
              table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 20px;
              }
              th, td {
                padding: 12px;
                text-align: left;
                border: 1px solid #ddd;
              }
              th {
                background-color: #4CAF50;
                color: white;
              }
              tr:nth-child(even) {
                background-color: #f2f2f2;
              }

              section {
                margin: 3rem;
              }
            </style>
       
       
            <h1>User Analytics</h1>
            <div id="userAnalyticsTableContainer">
              <!-- The table will be injected here -->
            </div>
        </section>




        <section>

            <title>Contacts Management</title>
            <style>
        
        
                #contacts-container {
                    display: flex;
                    flex-wrap: wrap;
                    gap: 20px;
                }
        
                .contact-card {
                    border: 1px solid #ccc;
                    border-radius: 8px;
                    padding: 20px;
                    width: 300px;
                    background-color: #f9f9f9;
                    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                }
        
                .contact-card h3 {
                    margin-top: 0;
                    color: #333;
                }
        
                .contact-card p {
                    margin: 5px 0;
                    color: #555;
                }
        
                .view-btn {
                    display: inline-block;
                    padding: 10px 15px;
                    border: none;
                    border-radius: 5px;
                    background-color: #007BFF;
                    color: white;
                    cursor: pointer;
                    text-decoration: none;
                    font-size: 14px;
                }
        
                .view-btn:hover {
                    background-color: #0056b3;
                }
            </style>
            <h1>Contact Messages</h1>
            <div id="contacts-container"></div>
        
        </section>
        










        <!-- Custom Report Generation Section -->
        <div class="card mb-4">
            <div class="card-body">
                <h4>Generate Custom Reports</h4>
                <form id="reportForm">
                    <div class="form-group">
                        <label for="reportType">Select Report Type</label>
                        <select class="form-control" id="reportType">
                            <option value="userEngagement">User Engagement</option>
                            <option value="jobPerformance">Job Posting Performance</option>
                            <option value="jobActivity">Job Activity Insights</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="startDate">Start Date</label>
                        <input type="date" class="form-control" id="startDate" required>
                    </div>
                    <div class="form-group">
                        <label for="endDate">End Date</label>
                        <input type="date" class="form-control" id="endDate" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Generate Report</button>
                </form>
                <div id="reportOutput" class="mt-3"></div>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
    apiKey: "AIzaSyDiwC3Dmd88-t3N9iRV5cZ3snVkEXinclg",
    authDomain: "reelcareer-cb4b0.firebaseapp.com",
    projectId: "reelcareer-cb4b0",
    storageBucket: "reelcareer-cb4b0.appspot.com",
    messagingSenderId: "365163764840",
    appId: "1:365163764840:web:21c44f8625c9b6831e6fdd",
    measurementId: "G-LBTK319K2X"
};

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const analytics = firebase.analytics(app);
        const db = firebase.firestore();







/**
 * Helper function to format date and time based on specified options
 * @param {string} dateString - The date string to format
 * @param {Object} options - Formatting options
 * @returns {string} - Formatted date and time
 */
 function formatDate(dateInput, options = {}) {
  let date;

  // Check if the input is a Firestore timestamp object (with seconds and nanoseconds)
  if (dateInput && dateInput.seconds && dateInput.nanoseconds) {
    // Convert Firestore timestamp to JavaScript Date object
    date = new Date(dateInput.seconds * 1000 + dateInput.nanoseconds / 1000000);
  } else {
    // Parse the date string into a Date object
    date = new Date(dateInput);
  }

  // Check if the date is valid
  if (isNaN(date)) {
    console.error("Invalid date string:", dateInput);
    return "Invalid Date";
  }

  // Default formatting options
  const defaultOptions = {
    weekday: "long", // "Monday"
    year: "numeric", // "2024"
    month: "long", // "November"
    day: "numeric", // "21"
    hour: "numeric", // "12"
    minute: "numeric", // "11"
    second: "numeric", // "26"
    hour12: true // Use 12-hour clock with AM/PM
  };

  // Merge user options with defaults
  const finalOptions = { ...defaultOptions, ...options };

  // Return formatted date
  return date.toLocaleString("en-US", finalOptions);
}



// Function to format the "viewedBy" data into an HTML structure
function formatViewedBy(viewedByData = {}) {
  return `
    <ul>
      <li><strong>Duration of View:</strong> ${viewedByData.durationOfView || 'N/A'} seconds</li>
      <li><strong>Contact Views:</strong> ${viewedByData.contactViews || 'N/A'}</li>
      <li><strong>View Method:</strong> ${viewedByData.viewMethod || 'N/A'}</li>
      <li><strong>View Source:</strong> ${viewedByData.viewSource || 'N/A'}</li>
      <li><strong>View Date:</strong> ${viewedByData.viewDate ? formatDate(viewedByData.viewDate) : 'N/A'}</li>
    </ul>
  `;
}

// Function to toggle visibility of detail rows
function toggleDetailSection(rowId) {
  const detailRow = document.getElementById(`details-${rowId}`);
  if (detailRow) {
    detailRow.style.display = detailRow.style.display === 'none' ? 'table-row' : 'none';
  }
}

// Main function to display user analytics
async function displayUserAnalytics() {
  const analyticsData = await fetchUserAnalyticsData(); // Fetch the data
  const totalUsers = analyticsData.length;

  // Display the total user count
  document.getElementById('usersDisplay').innerHTML = `<h3>${totalUsers}</h3>`;

  // Construct the table structure
  let tableHTML = `
    <table>
      <thead>
        <tr>
          <th>IP Address</th>
          <th>City</th>
          <th>Country</th>
          <th>State</th>
          <th>Last View Date</th>
          <th>Total Duration (Seconds)</th>
          <th>Activities Count</th>
          <th>User Blocked</th>
        </tr>
      </thead>
      <tbody>
  `;

  analyticsData.forEach(user => {
    // Add main row
    tableHTML += `
      <tr>
        <td><button class="collapsible" onclick="toggleDetailSection('${user.ipAddress}')">${user.ipAddress}</button></td>
        <td>${user.city || 'N/A'}</td>
        <td>${user.country || 'N/A'}</td>
        <td>${user.state || 'N/A'}</td>
        <td>${user.lastViewDate ? formatDate(user.lastViewDate) : 'N/A'}</td>
        <td>${user.totalDuration || 0}</td>
        <td>${user.userActivitiesCount || 0}</td>
        <td>${user.userBlocked ? 'Yes' : 'No'}</td>
      </tr>
    `;

    // Filter out invalid `viewedBy` data
    const viewedByDetails = [
      user.contactViewedBy,
      user.eventDetailsViewedBy,
      user.homeViewedBy,
      user.aboutViewedBy,
      user.confirmationViewedBy,
      user.eventsViewedBy,
      user.galleryViewedBy
    ]
      .filter(detail => detail) // Exclude undefined, null, or empty values
      .map(detail => formatViewedBy(detail)) // Format valid entries
      .join(""); // Combine them into a single string

    // Only include the collapsible row if there are valid details
    if (viewedByDetails) {
      tableHTML += `
        <tr id="details-${user.ipAddress}" class="details-row" style="display: none;">
          <td colspan="8">
            <div class="user-details">
              <h4>Details for ${user.ipAddress}</h4>
              ${viewedByDetails}
            </div>
          </td>
        </tr>
      `;
    }
  });

  // Close table
  tableHTML += '</tbody></table>';

  // Insert the table into the container
  document.getElementById('userAnalyticsTableContainer').innerHTML = tableHTML;
}

// Fetch user analytics data from Firestore
async function fetchUserAnalyticsData() {
  const analyticsCollection = collection(db, "Analytics"); // Reference to the Analytics collection
  const analyticsSnapshot = await getDocs(analyticsCollection); // Fetch all documents
  const analyticsList = analyticsSnapshot.docs.map(doc => ({
    ipAddress: doc.id, // IP address as doc ID
    city: doc.data().city,
    country: doc.data().country,
    state: doc.data().state,
    totalDuration: doc.data().totalDuration,
    userActivitiesCount: doc.data().userActivitiesCount,
    userBlocked: doc.data().userBlocked || false,
    contactViewedBy: doc.data().contactViewedBy || {}, // Ensure fallback is an empty object
    eventDetailsViewedBy: doc.data().eventDetailsViewedBy || {}, 
    homeViewedBy: doc.data().homeViewedBy || {}, 
    aboutViewedBy: doc.data().aboutViewedBy || {}, 
    confirmationViewedBy: doc.data().confirmationViewedBy || {}, 
    eventsViewedBy: doc.data().eventsViewedBy || {}, 
    galleryViewedBy: doc.data().galleryViewedBy || {}, 
    lastViewDate: doc.data().lastViewDate,
  }));
  return analyticsList;
}

// Execute the function on page load
displayUserAnalytics();








        async function fetchAndRenderContacts() {
    // Reference to the Contacts collection in Firebase
    const contactsCollection = collection(db, "Contacts"); // Reference to the Contacts collection in Firestore
    
    try {
        // Fetch documents from the Contacts collection
        const snapshot = await getDocs(contactsCollection);
        const contacts = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
        }));

        // Render the contacts in the UI
        renderContacts(contacts);
    } catch (error) {
        console.error("Error fetching contacts:", error);
    }
}

function renderContacts(contacts) {
    const container = document.getElementById('contacts-container');
    if (!container) {
        console.error("Container not found!");
        return; // Exit if the container element is not found
    }

    container.innerHTML = ""; // Clear the container

    let unReadMsg = 0; // Counter for unread messages

    contacts.forEach(contact => {
        // Create a card for each contact
        const card = document.createElement('div');
        card.className = 'contact-card';

        // Populate the card with contact details
        card.innerHTML = `
            <h3>${contact.name || "No Name Provided"}</h3>
            <p><strong>Status:</strong> ${contact.status || "No Status"}</p>
            <p><strong>Subject:</strong> ${contact.subject || "No Subject"}</p>
            <p><strong>Messages:</strong> ${contact.messages || 0}</p>
            <p><strong>Timestamp:</strong> ${contact.timestamp ? new Date(contact.timestamp).toLocaleString() : "No Timestamp"}</p>
            <button class="view-btn" onclick="goToAdminContact('${contact.id}')">View Details</button>
        `;

        // Increment unread message count if the status is "unread"
        if (contact.status === "unread") {
            unReadMsg += 1;
        }

        // Append the card to the container
        container.appendChild(card);
    });

    // Update the display for total messages and unread messages
    const msgCountDisplay = document.getElementById('msgCountDisplay');
    if (msgCountDisplay) {
        msgCountDisplay.innerHTML = `
            <h3>Total Messages: ${contacts.length}</h3>
            <p>Unread Messages: ${unReadMsg}</p>
        `;
    } else {
        console.error("Message count display element not found.");
    }
}

function goToAdminContact(docId) {
    // Redirect to the admin contact page with the docId in the query string
    window.location.href = `/admin/contact?msg=${docId}`;
}








window.onload = function () {
            const urlParams = new URLSearchParams(window.location.search);
            const eventId = urlParams.get("eventId");


            // my Analyics
     
            fetchUserAnalyticsData();
   // Display user analytics when the page loads
   displayUserAnalytics();
  
// Call the function on page load
fetchAndRenderContacts();

fetchAndRender();


        };
    

































        // Log custom event for user engagement
        function logUserEngagement(eventName) {
            analytics.logEvent(eventName);
        }

        // Load User Engagement Metrics and Chart
        function loadUserEngagementMetrics() {
            // Fetch engagement data from Firestore or Analytics API
            const engagementData = {
                activeUsers: 1200,
                newUsers: 300,
                averageSessionDuration: "5m 30s"
            };
            document.getElementById('engagementMetrics').innerText = 
                `Active Users: ${engagementData.activeUsers}, New Users: ${engagementData.newUsers}, Average Session Duration: ${engagementData.averageSessionDuration}`;
            
            // Populate Chart
            const ctx = document.getElementById('userEngagementChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Active Users', 'New Users'],
                    datasets: [{
                        label: 'User Engagement',
                        data: [engagementData.activeUsers, engagementData.newUsers],
                        backgroundColor: ['rgba(75, 192, 192, 0.2)', 'rgba(153, 102, 255, 0.2)'],
                        borderColor: ['rgba(75, 192, 192, 1)', 'rgba(153, 102, 255, 1)'],
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            logUserEngagement('view_engagement_metrics');
        }

        // Load Job Posting Performance Metrics and Chart
        function loadJobPerformanceMetrics() {
            const jobData = {
                totalJobsPosted: 250,
                jobsFilled: 180,
                jobViews: 5000
            };
            document.getElementById('jobPerformanceMetrics').innerText = 
                `Total Jobs Posted: ${jobData.totalJobsPosted}, Jobs Filled: ${jobData.jobsFilled}, Job Views: ${jobData.jobViews}`;
            
            // Populate Chart
            const ctx = document.getElementById('jobPerformanceChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Jobs Posted', 'Jobs Filled', 'Job Views'],
                    datasets: [{
                        label: 'Job Performance',
                        data: [jobData.totalJobsPosted, jobData.jobsFilled, jobData.jobViews],
                        borderColor: 'rgba(255, 159, 64, 1)',
                        fill: false
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            logUserEngagement('view_job_performance_metrics');
        }

        // Load Job Activity Insights
        function loadJobActivityInsights() {
            // Simulated data
            const jobActivityData = {
                jobTypes: ['Developer', 'Data Scientist', 'Web Designer', 'Software Engineer', 'Customer Service'],
                jobViews: [1200, 800, 600, 900, 700],
                activityDays: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'],
                activityCounts: [100, 150, 200, 250, 300]
            };
            document.getElementById('jobActivityMetrics').innerText = 
                `Most Active Job Types: ${jobActivityData.jobTypes.join(', ')} with views ${jobActivityData.jobViews.join(', ')}`;
            
            // Populate Job Activity Chart
            const ctx = document.getElementById('jobActivityChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: jobActivityData.jobTypes,
                    datasets: [{
                        label: 'Job Views',
                        data: jobActivityData.jobViews,
                        backgroundColor: 'rgba(255, 206, 86, 0.2)',
                        borderColor: 'rgba(255, 206, 86, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            logUserEngagement('view_job_activity_insights');
        }

        // Load User Demographics
        function loadUserDemographics() {
            const demographicsData = {
                ageGroups: ['18-24', '25-34', '35-44', '45-54', '55+'],
                userCounts: [200, 500, 300, 200, 100]
            };
            document.getElementById('userDemographicsMetrics').innerText = 
                `User Demographics: ${demographicsData.ageGroups.join(', ')} with counts ${demographicsData.userCounts.join(', ')}`;
            
            // Populate Demographics Chart
            const ctx = document.getElementById('userDemographicsChart').getContext('2d');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: demographicsData.ageGroups,
                    datasets: [{
                        label: 'User Demographics',
                        data: demographicsData.userCounts,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.2)',
                            'rgba(54, 162, 235, 0.2)',
                            'rgba(255, 206, 86, 0.2)',
                            'rgba(75, 192, 192, 0.2)',
                            'rgba(153, 102, 255, 0.2)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true
                }
            });
            logUserEngagement('view_user_demographics');
        }

        // Handle Custom Report Generation
        $('#reportForm').on('submit', function (e) {
            e.preventDefault();
            const reportType = $('#reportType').val();
            const startDate = $('#startDate').val();
            const endDate = $('#endDate').val();
            // Simulated report generation
            $('#reportOutput').html(`<p>Report for ${reportType} from ${startDate} to ${endDate} generated successfully!</p>`);
            logUserEngagement('generate_custom_report');
        });

        // Initial load
        loadUserEngagementMetrics();
        loadJobPerformanceMetrics();
        loadJobActivityInsights();
        loadUserDemographics();
    </script>
</body>
</html>
