<script>

/*

<button id="applyNowButton" class="btn btn-primary">Apply Now</button>

    document.getElementById('applyNowButton').addEventListener('click', function() {
        firebase.analytics().logEvent('button_click', { button_name: 'Apply Now' });
    });

firebase.analytics().logEvent('form_submission', { form_name: 'Job Application' });

firebase.analytics().logEvent('page_view', { page_name: 'Job Listings' });
firebase.analytics().logEvent('page_view', { page_name: 'Job Listings' });

firebase.analytics().logEvent('content_view', { content_type: 'FAQ', content_title: 'How to Apply' });
firebase.analytics().logEvent('job_post_action', { action: 'view', job_id: '1234' });
firebase.analytics().logEvent('application_start', { job_id: '1234' });
firebase.analytics().logEvent('session_duration', { duration: 300 }); // duration in seconds
firebase.analytics().logEvent('user_retention', { user_id: 'user123' });
firebase.analytics().logEvent('feedback_submission', { feedback_type: 'Job Quality', user_id: 'user123' });
firebase.analytics().logEvent('referral_participation', { referrer_id: 'user456' });




*/
</script>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - Admin</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://reelcareer.co/backend/css/styles.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <script src="https://reelcareer.co/public/js/bodyload.js"></script>
    
 <!-- Navbar section -->
<nav id="Main_Nav" class="main_Navbar" role="navigation" aria-label="Main Navigation" itemscope itemtype="https://schema.org/WebPage">
    <!-- Logo/Brand Name -->
    <a class="navbar-brand" href="https://reelcareer.co">ReelCareer.co</a>

    <!-- Menu toggle checkbox and label -->
    <input type="checkbox" id="nav-toggle">
    <label for="nav-toggle" class="nav-toggle-label">
        <span class="bar1"></span>
        <span class="bar2"></span>
        <span class="bar3"></span>
    </label>

    <div class="nav-links">
        <!-- Navigation links -->
        <ul  id="navbarNav">
            <!-- Dashboard and Analytics Group -->
            <div class="navGroup" title="Dashboard and Analytics">
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/dashboard">Dashboard</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/analytics">Analytics</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/state-labour-market">State Labour Market</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/ping">Ping</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/page-editor">Page Editor</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/notes">Notes</a></li>
            </div>
            <!-- Management Tools -->
            <div class="navGroup" title="Management Tools">
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/content-management">Content <small>Management</small></a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/user-management">User <small>Management</small></a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/job-management">Job <small>Management</small></a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/application-management">Application <small>Management</small></a></li>
            </div>
            <!-- General Settings and Utilities -->
            <div class="navGroup" title="General Settings and Utilities">
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/contact">Contact</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/settings">Settings</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/support">Support</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/chatbot">Chatbot</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/notifications-management">Notifications <small>Management</small></a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/system-logs">System Logs</a></li>
            </div>
            <!-- Finance and Monetization -->
            <div class="navGroup" title="Finance and Monetization">
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/transactions">Transactions</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/integration-management">Integration <small>Management</small></a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/payments">Payments</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/monetization">Monetization</a></li>
            </div>
            <!-- SEO and Cleanup -->
            <div class="navGroup" title="SEO and Cleanup">
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/delete-dup">Delete Dup</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/seo-helper">SEO Helper</a></li>
            </div>
            <!-- Role and Personality Management -->
            <div class="navGroup" title="Role and Personality Management">
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/role-management">Role <small>Management</small></a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/trait-personality-management">Trait Personality <small>Management</small></a></li>
            </div>
        </ul>
    </div>
</nav>


    <div class="container mt-4">
        <h1>Analytics & Reporting</h1>
<style>

    #analytics-cards {
       gap: 1.5rem;
    width: 100%;
    display: flex;
    flex-wrap: wrap;
    flex-direction: row;
    }


    .analytics-card {
    gap: .5rem;
    display: flex;
    overflow: hidden;
    flex-wrap: wrap;
    justify-content: space-between;
    width: 100%;
    flex-direction: row;
}
















</style>
<section id="analytics-cards">
        <div class="col-md-3 card analytics-card shadow-sm">
                <div class="card-body">
                    <h5 class="section-title">Total Messages</h5>
                    <p id="msgCountDisplay" class="display-4">Loading...</p>
                    <div class="loading-spinner loading" id="loadingUserEngagement"></div>
                </div>
            </div>

            <div class="col-md-3 card analytics-card shadow-sm">
                <div class="card-body">
                    <h5 class="section-title">Total Users:</h5>
                    <p id="usersDisplay" class="display-4">Loading...</p>
                    <div class="loading-spinner loading" id="loadingEventPurchases"></div>
                </div>
            </div>

            
        <!-- User Engagement Section -->
        <div class="col-md-3 card analytics-card shadow-sm">
            <div class="card-body">
                <h4>User Engagement</h4>
                <canvas id="userEngagementChart"></canvas>
                <p id="engagementMetrics">Loading...</p>
            </div>
        </div>

        <!-- Job Posting Performance Section -->
        <div class="col-md-3 card analytics-card shadow-sm">
            <div class="card-body">
                <h4>Job Posting Performance</h4>
                <canvas id="jobPerformanceChart"></canvas>
                <p id="jobPerformanceMetrics">Loading...</p>
            </div>
        </div>

        <!-- Job Activity Insights Section -->
        <div class="col-md-3 card analytics-card shadow-sm">
            <div class="card-body">
                <h4>Job Activity Insights</h4>
                <canvas id="jobActivityChart"></canvas>
                <p id="jobActivityMetrics">Loading...</p>
            </div>
        </div>

        <!-- User Demographics Section -->
        <div class="col-md-3 card analytics-card shadow-sm">            <div class="card-body">
                <h4>User Demographics</h4>
                <canvas id="userDemographicsChart"></canvas>
                <p id="userDemographicsMetrics">Loading...</p>
            </div>
        </div>
    </section>





















        <section>
            <title>User Analytics</title>
            <style>
              main {
                font-family: Arial, sans-serif;
                margin: 20px;
                background-color: #f4f4f9;
              }
              table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 20px;
              }
              th, td {
                padding: 12px;
                text-align: left;
                border: 1px solid #ddd;
              }
              th {
                background-color: #4CAF50;
                color: white;
              }
              tr:nth-child(even) {
                background-color: #f2f2f2;
              }

              section {
                margin: 3rem;
              }
            </style>
       
       
            <h1>User Analytics</h1>
            <div id="userAnalyticsTableContainer">
              <!-- The table will be injected here -->
            </div>
        </section>




        <section>

            <title>Contacts Management</title>
            <style>
        
        
                #contacts-container {
                    display: flex;
                    flex-wrap: wrap;
                    gap: 20px;
                }
        
                .contact-card {
                    border: 1px solid #ccc;
                    border-radius: 8px;
                    padding: 20px;
                    width: 300px;
                    background-color: #f9f9f9;
                    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                }
        
                .contact-card h3 {
                    margin-top: 0;
                    color: #333;
                }
        
                .contact-card p {
                    margin: 5px 0;
                    color: #555;
                }
        
                .view-btn {
                    display: inline-block;
                    padding: 10px 15px;
                    border: none;
                    border-radius: 5px;
                    background-color: #007BFF;
                    color: white;
                    cursor: pointer;
                    text-decoration: none;
                    font-size: 14px;
                }
        
                .view-btn:hover {
                    background-color: #0056b3;
                }
            </style>
            <h1>Contact Messages</h1>
            <div id="contacts-container"></div>
        
        </section>
        










        <!-- Custom Report Generation Section -->
        <div class="card mb-4">
            <div class="card-body">
                <h4>Generate Custom Reports</h4>
                <form id="reportForm">
                    <div class="form-group">
                        <label for="reportType">Select Report Type</label>
                        <select class="form-control" id="reportType">
                            <option value="userEngagement">User Engagement</option>
                            <option value="jobPerformance">Job Posting Performance</option>
                            <option value="jobActivity">Job Activity Insights</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="startDate">Start Date</label>
                        <input type="date" class="form-control" id="startDate" required>
                    </div>
                    <div class="form-group">
                        <label for="endDate">End Date</label>
                        <input type="date" class="form-control" id="endDate" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Generate Report</button>
                </form>
                <div id="reportOutput" class="mt-3"></div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer id="dynamic-footer"></footer>
    
    <!-- Firebase configuration/ Login& Out -->
    <script type="module" src="https://reelcareer.co/public/js/main.js"></script> 

    <!-- Firebase JS SDK and Custom Scripts -->

    <script type="module">
        import {
            db, doc, getDoc, query, updateDoc,
            setDoc, ref, signInWithPopup, orderBy,
             
            uploadBytes, OAuthProvider, arrayUnion, getStorage,
            signOut, addDoc, increment, onAuthStateChanged,
            createUserWithEmailAndPassword, signInWithEmailAndPassword,
            where, getDocs, storage, collection, deleteObject, 
            auth, analytics, deleteDoc, getDownloadURL
        } from 'https://reelcareer.co/js/module.js';







        
// Function to format dates with added support for Firestore timestamps
function formatDate(dateInput, options = {}) {
  let date;

  if (dateInput && dateInput.seconds && dateInput.nanoseconds) {
    date = new Date(dateInput.seconds * 1000 + dateInput.nanoseconds / 1000000);
  } else {
    date = new Date(dateInput);
  }

  if (isNaN(date)) {
    console.error("Invalid date string:", dateInput);
    return "Invalid Date";
  }

  const defaultOptions = {
    weekday: "long",
    year: "numeric",
    month: "long",
    day: "numeric",
    hour: "numeric",
    minute: "numeric",
    second: "numeric",
    hour12: true,
  };

  const finalOptions = { ...defaultOptions, ...options };
  return date.toLocaleString("en-US", finalOptions);
}

// Function to format the "viewedBy" data into an HTML structure
function formatViewedBy(viewedByData = {}) {
  return `
    <ul>
      <li><strong>Duration of View:</strong> ${viewedByData.durationOfView || 'N/A'} seconds</li>
      <li><strong>Contact Views:</strong> ${viewedByData.viewsCount || 'N/A'}</li>
      <li><strong>View Method:</strong> ${viewedByData.viewMethod || 'N/A'}</li>
      <li><strong>View Source:</strong> ${viewedByData.viewSource || 'N/A'}</li>
      <li><strong>View Date:</strong> ${viewedByData.viewDate ? formatDate(viewedByData.viewDate) : 'N/A'}</li>
    </ul>
  `;
}

// Function to toggle visibility of detail rows
function toggleDetailSection(rowId) {
  const detailRow = document.getElementById(`details-${rowId}`);
  if (detailRow) {
    detailRow.style.display = detailRow.style.display === 'none' ? 'table-row' : 'none';
  }
}

// Main function to display user analytics
async function displayUserAnalytics() {
  const analyticsData = await fetchUserAnalyticsData();
  const totalUsers = analyticsData.length;

  document.getElementById('usersDisplay').innerHTML = `<h3>${totalUsers}</h3>`;

  let tableHTML = `
    <table>
      <thead>
        <tr>
          <th>IP Address</th>
          <th>City</th>
          <th>Country</th>
          <th>State</th>
          <th>Last View Date</th>
          <th>Total Duration (Seconds)</th>
          <th>Activities Count</th>
          <th>User Blocked</th>
        </tr>
      </thead>
      <tbody>
  `;

  analyticsData.forEach(user => {
    tableHTML += `
      <tr>
        <td><button class="collapsible" onclick="toggleDetailSection('${user.ipAddress}')">${user.ipAddress}</button></td>
        <td>${user.city || 'N/A'}</td>
        <td>${user.country || 'N/A'}</td>
        <td>${user.state || 'N/A'}</td>
        <td>${user.lastViewDate ? formatDate(user.lastViewDate) : 'N/A'}</td>
        <td>${user.totalDuration || 0}</td>
        <td>${user.userActivitiesCount || 0}</td>
        <td>${user.userBlocked ? 'Yes' : 'No'}</td>
      </tr>
    `;

    const viewedByDetails = [
      user.contactViewedBy,
      user.eventDetailsViewedBy,
      user.homeViewedBy,
      user.aboutViewedBy,
      user.confirmationViewedBy,
      user.eventsViewedBy,
      user.galleryViewedBy,
    ]
      .filter(detail => detail)
      .map(detail => formatViewedBy(detail))
      .join("");

    if (viewedByDetails) {
      tableHTML += `
        <tr id="details-${user.ipAddress}" class="details-row" style="display: none;">
          <td colspan="8">
            <div class="user-details">
              <h4>Details for ${user.ipAddress}</h4>
              ${viewedByDetails}
            </div>
          </td>
        </tr>
      `;
    }
  });

  tableHTML += '</tbody></table>';
  document.getElementById('userAnalyticsTableContainer').innerHTML = tableHTML;
}

// Fetch user analytics data from Firestore
async function fetchUserAnalyticsData() {
  const analyticsCollection = collection(db, "Analytics");
  const analyticsSnapshot = await getDocs(analyticsCollection);
  return analyticsSnapshot.docs.map(doc => ({
    ipAddress: doc.id,
    city: doc.data().city,
    country: doc.data().country,
    state: doc.data().state,
    totalDuration: doc.data().totalDuration,
    userActivitiesCount: doc.data().userActivitiesCount,
    userBlocked: doc.data().userBlocked || false,
    contactViewedBy: doc.data().contactViewedBy || {},
    eventDetailsViewedBy: doc.data().eventDetailsViewedBy || {},
    homeViewedBy: doc.data().homeViewedBy || {},
    aboutViewedBy: doc.data().aboutViewedBy || {},
    confirmationViewedBy: doc.data().confirmationViewedBy || {},
    eventsViewedBy: doc.data().eventsViewedBy || {},
    galleryViewedBy: doc.data().galleryViewedBy || {},
    lastViewDate: doc.data().lastViewDate,
  }));
}


// Example view data collection object
const viewData = {
  viewedByField: {
    viewDate: new Date().toISOString(),
    viewMethod: navigator.userAgentData?.mobile ? "mobile" : "desktop",
    durationOfView: durationOfView,
    maxScrollDepth: maxScrollDepth,
    viewsCount: increment(1),
    viewSource: getViewSource(),
    actionTrack: actionTrack,
    actionName: actionName,
    pageTitle: pageTitle,
    jobTitleName: jobTitleName,
    lastViewDate: new Date().toISOString(),
  },
  ipAddress: ipAddress || userData.ipAddress,
  name: userData.name || 'N/A',
  displayName: userData.displayName || 'N/A',
  userID: userData.userID || 'N/A',
  lastLogin: userData.lastLogin || 'N/A',
  city: locationData.city || 'N/A',
  state: locationData.region || 'N/A',
  zip: locationData.postal || 'N/A',
  country: locationData.country_name || 'N/A',
  browser: navigator.userAgentData?.brands?.[0]?.brand || navigator.userAgent,
  os: navigator.platform || 'N/A',
  screenResolution: `${screen.width}x${screen.height}`,
  viewportSize: `${window.innerWidth}x${window.innerHeight}`,
  devicePixelRatio: window.devicePixelRatio,
  referrer: document.referrer || 'Direct',
  entryURL: window.location.href,
  networkType: navigator.connection?.effectiveType || 'N/A',
  connectionSpeed: navigator.connection?.downlink || 'N/A',
  timezone: Intl.DateTimeFormat().resolvedOptions().timeZone || 'N/A',
  language: navigator.language || 'N/A',
  lastUpdate: new Date().toISOString(),
  userActivitiesCount: increment(1),
  totalDuration: increment(durationOfView),
  userBlocked: false,
};







        async function fetchAndRenderContacts() {
    // Reference to the Contacts collection in Firebase
    const contactsCollection = collection(db, "ContactMessages"); // Reference to the Contacts collection in Firestore
    
    try {
        // Fetch documents from the Contacts collection
        const snapshot = await getDocs(contactsCollection);
        const contacts = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
        }));

        // Render the contacts in the UI
        renderContacts(contacts);
    } catch (error) {
        console.error("Error fetching contacts:", error);
    }
}

function renderContacts(contacts) {
    const container = document.getElementById('contacts-container');
    if (!container) {
        console.error("Container not found!");
        return; // Exit if the container element is not found
    }

    container.innerHTML = ""; // Clear the container

    let unReadMsg = 0; // Counter for unread messages

    contacts.forEach(contact => {
        // Create a card for each contact
        const card = document.createElement('div');
        card.className = 'contact-card';

        // Populate the card with contact details
        card.innerHTML = `
            <h3>${contact.name || "No Name Provided"}</h3>
            <p><strong>Status:</strong> ${contact.status || "No Status"}</p>
            <p><strong>Subject:</strong> ${contact.subject || "No Subject"}</p>
            <p><strong>Messages:</strong> ${contact.messages || 0}</p>
            <p><strong>Timestamp:</strong> ${contact.timestamp ? new Date(contact.timestamp).toLocaleString() : "No Timestamp"}</p>
            <button class="view-btn" onclick="goToAdminContact('${contact.id}')">View Details</button>
        `;

        // Increment unread message count if the status is "unread"
        if (contact.status === "unread") {
            unReadMsg += 1;
        }

        // Append the card to the container
        container.appendChild(card);
    });

    // Update the display for total messages and unread messages
    const msgCountDisplay = document.getElementById('msgCountDisplay');
    if (msgCountDisplay) {
        msgCountDisplay.innerHTML = `
            <h3>Total Messages: ${contacts.length}</h3>
            <p>Unread Messages: ${unReadMsg}</p>
        `;
    } else {
        console.error("Message count display element not found.");
    }
}

function goToAdminContact(docId) {
    // Redirect to the admin contact page with the docId in the query string
    window.location.href = `/admin/contact?msg=${docId}`;
}








window.onload = function () {
           
    
            // my Analyics
     
            fetchUserAnalyticsData();
   // Display user analytics when the page loads
   displayUserAnalytics();
  


        };
    

































        
    </script>
</body>
</html>
