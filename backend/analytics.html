<script>

/*

<button id="applyNowButton" class="btn btn-primary">Apply Now</button>

    document.getElementById('applyNowButton').addEventListener('click', function() {
        firebase.analytics().logEvent('button_click', { button_name: 'Apply Now' });
    });

firebase.analytics().logEvent('form_submission', { form_name: 'Job Application' });

firebase.analytics().logEvent('page_view', { page_name: 'Job Listings' });
firebase.analytics().logEvent('page_view', { page_name: 'Job Listings' });

firebase.analytics().logEvent('content_view', { content_type: 'FAQ', content_title: 'How to Apply' });
firebase.analytics().logEvent('job_post_action', { action: 'view', job_id: '1234' });
firebase.analytics().logEvent('application_start', { job_id: '1234' });
firebase.analytics().logEvent('session_duration', { duration: 300 }); // duration in seconds
firebase.analytics().logEvent('user_retention', { user_id: 'user123' });
firebase.analytics().logEvent('feedback_submission', { feedback_type: 'Job Quality', user_id: 'user123' });
firebase.analytics().logEvent('referral_participation', { referrer_id: 'user456' });




*/
</script>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - Admin</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://reelcareer.co/backend/css/styles.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

    <style>

.analytics-container {
  padding: 20px;
  font-family: Arial, sans-serif;
}

.filter-section {
  margin-bottom: 15px;
}

.filter-section input, .filter-section select {
  padding: 8px;
  margin-right: 10px;
  border: 1px solid #ccc;
  border-radius: 4px;
}

.analytics-table {
  width: 100%;
  border-collapse: collapse;
}

.analytics-table th, .analytics-table td {
  border: 1px solid #ddd;
  padding: 8px;
  text-align: left;
}

.analytics-table th {
  cursor: pointer;
  background-color: #f4f4f4;
}

.analytics-table tr:nth-child(even) {
  background-color: #f9f9f9;
}

    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <script src="https://reelcareer.co/public/js/bodyload.js"></script>
    
 <!-- Navbar section -->
<nav id="Main_Nav" class="navbar navbar-expand-lg navbar-light bg-light" role="navigation" aria-label="Main Navigation">
  <a class="navbar-brand" href="https://reelcareer.co">ReelCareer.co</a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="navbarNav">
    <ul class="navbar-nav">
            <!-- Dashboard and Analytics Group -->
            <div class="navGroup" title="Dashboard and Analytics">
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/dashboard">Dashboard</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/analytics">Analytics</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/state-labour-market">State Labour Market</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/ping">Ping</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/page-editor">Page Editor</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/notes">Notes</a></li>
            </div>
            <!-- Management Tools -->
            <div class="navGroup" title="Management Tools">
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/content-management">Content <small>Management</small></a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/user-management">User <small>Management</small></a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/job-management">Job <small>Management</small></a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/application-management">Application <small>Management</small></a></li>
            </div>
            <!-- General Settings and Utilities -->
            <div class="navGroup" title="General Settings and Utilities">
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/contact">Contact</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/settings">Settings</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/support">Support</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/chatbot">Chatbot</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/notifications-management">Notifications <small>Management</small></a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/system-logs">System Logs</a></li>
            </div>
            <!-- Finance and Monetization -->
            <div class="navGroup" title="Finance and Monetization">
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/transactions">Transactions</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/integration-management">Integration <small>Management</small></a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/payments">Payments</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/monetization">Monetization</a></li>
            </div>
            <!-- SEO and Cleanup -->
            <div class="navGroup" title="SEO and Cleanup">
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/delete-dup">Delete Dup</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/seo-helper">SEO Helper</a></li>
            </div>
            <!-- Role and Personality Management -->
            <div class="navGroup" title="Role and Personality Management">
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/role-management">Role <small>Management</small></a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/trait-personality-management">Trait Personality <small>Management</small></a></li>
            </div>
        </ul>
    </div>
</nav>


    <div class="container mt-4">
        <h1>Analytics & Reporting</h1>
<style>

    #analytics-cards {
       gap: 1.5rem;
    width: 100%;
    display: flex;
    flex-wrap: wrap;
    flex-direction: row;
    }


    .analytics-card {
    gap: .5rem;
    display: flex;
    overflow: hidden;
    flex-wrap: wrap;
    justify-content: space-between;
    width: 100%;
    flex-direction: row;
}
















</style>
<section id="analytics-cards">
        <div class="col-md-3 card analytics-card shadow-sm">
                <div class="card-body">
                    <h5 class="section-title">Total Messages</h5>
                    <p id="msgCountDisplay" class="display-4">Loading...</p>
                    <div class="loading-spinner loading" id="loadingUserEngagement"></div>
                </div>
            </div>

            <div class="col-md-3 card analytics-card shadow-sm">
                <div class="card-body">
                    <h5 class="section-title">Total Users:</h5>
                    <p id="usersDisplay" class="display-4">Loading...</p>
                    <div class="loading-spinner loading" id="loadingEventPurchases"></div>
                </div>
            </div>

            
        <!-- User Engagement Section -->
        <div class="col-md-3 card analytics-card shadow-sm">
            <div class="card-body">
                <h4>User Engagement</h4>
                <canvas id="userEngagementChart"></canvas>
                <p id="engagementMetrics">Loading...</p>
            </div>
        </div>

        <!-- Job Posting Performance Section -->
        <div class="col-md-3 card analytics-card shadow-sm">
            <div class="card-body">
                <h4>Job Posting Performance</h4>
                <canvas id="jobPerformanceChart"></canvas>
                <p id="jobPerformanceMetrics">Loading...</p>
            </div>
        </div>

        <!-- Job Activity Insights Section -->
        <div class="col-md-3 card analytics-card shadow-sm">
            <div class="card-body">
                <h4>Job Activity Insights</h4>
                <canvas id="jobActivityChart"></canvas>
                <p id="jobActivityMetrics">Loading...</p>
            </div>
        </div>

        <!-- User Demographics Section -->
        <div class="col-md-3 card analytics-card shadow-sm">            <div class="card-body">
                <h4>User Demographics</h4>
                <canvas id="userDemographicsChart"></canvas>
                <p id="userDemographicsMetrics">Loading...</p>
            </div>
        </div>
    </section>





















        <section>
            <title>User Analytics</title>
            <style>
              main {
                font-family: Arial, sans-serif;
                margin: 20px;
                background-color: #f4f4f9;
              }
              table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 20px;
              }
              th, td {
                padding: 12px;
                text-align: left;
                border: 1px solid #ddd;
              }
              th {
                background-color: #4CAF50;
                color: white;
              }
              tr:nth-child(even) {
                background-color: #f2f2f2;
              }

              section {
                margin: 3rem;
              }
            </style>
       
       
            <h1>User Analytics</h1>
            <div id="analytics-header">

              <div class="filter-section">
                <input type="text" id="searchInput" placeholder="Search by Name, Country, or Browser" oninput="filterTable()" />
                <select id="countryFilter" onchange="filterTable()">
                  <option value="">All Countries</option>
                  <option value="USA">USA</option>
                  <option value="India">India</option>
                  <option value="Germany">Germany</option>
                </select>
              </div>

              <div class="sort-section">

            </div>
            
          
          </div>
            <div id="userAnalyticsTableContainer">
              <!-- The table will be injected here -->
            </div>
        </section>




        <section>

           
          
        
        </section>
        










        <!-- Custom Report Generation Section -->
        <div class="card mb-4">
            <div class="card-body">
                <h4>Generate Custom Reports</h4>
                <form id="reportForm">
                    <div class="form-group">
                        <label for="reportType">Select Report Type</label>
                        <select class="form-control" id="reportType">
                            <option value="userEngagement">User Engagement</option>
                            <option value="jobPerformance">Job Posting Performance</option>
                            <option value="jobActivity">Job Activity Insights</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="startDate">Start Date</label>
                        <input type="date" class="form-control" id="startDate" required>
                    </div>
                    <div class="form-group">
                        <label for="endDate">End Date</label>
                        <input type="date" class="form-control" id="endDate" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Generate Report</button>
                </form>
                <div id="reportOutput" class="mt-3"></div>
            </div>
        </div>
    </div>



    <script>

function filterTable() {
  const searchInput = document.getElementById('searchInput').value.toLowerCase();
  const countryFilter = document.getElementById('countryFilter').value;
  const rows = document.querySelectorAll('#analyticsBody tr');

  rows.forEach(row => {
    const [user, , , , country] = row.children;
    const matchesSearch = user.textContent.toLowerCase().includes(searchInput);
    const matchesCountry = !countryFilter || country.textContent === countryFilter;

    row.style.display = matchesSearch && matchesCountry ? '' : 'none';
  });
}

function sortTable(colIndex) {
  const table = document.querySelector('.analytics-table tbody');
  const rows = Array.from(table.rows);
  const isAscending = table.getAttribute('data-sort-asc') === 'true';

  rows.sort((a, b) => {
    const valA = a.children[colIndex].textContent.trim();
    const valB = b.children[colIndex].textContent.trim();

    return isAscending ? valA.localeCompare(valB) : valB.localeCompare(valA);
  });

  rows.forEach(row => table.appendChild(row));
  table.setAttribute('data-sort-asc', !isAscending);
}

    </script>


    <!-- Footer -->
    <footer id="dynamic-footer"></footer>
    
    <!-- Firebase configuration/ Login& Out -->
    <script type="module" src="https://reelcareer.co/public/js/main.js"></script> 

    <!-- Firebase JS SDK and Custom Scripts -->

    <script type="module">
        import {
            db, doc, getDoc, query, updateDoc,
            setDoc, ref, signInWithPopup, orderBy,
             
            uploadBytes, OAuthProvider, arrayUnion, getStorage,
            signOut, addDoc, increment, onAuthStateChanged,
            createUserWithEmailAndPassword, signInWithEmailAndPassword,
            where, getDocs, storage, collection, deleteObject, 
            auth, analytics, deleteDoc, getDownloadURL
        } from 'https://reelcareer.co/js/module.js';







        
// Function to format dates with added support for Firestore timestamps
function formatDate(dateInput, options = {}) {
  let date;

  if (dateInput && dateInput.seconds && dateInput.nanoseconds) {
    date = new Date(dateInput.seconds * 1000 + dateInput.nanoseconds / 1000000);
  } else {
    date = new Date(dateInput);
  }

  if (isNaN(date)) {
    console.error("Invalid date string:", dateInput);
    return "Invalid Date";
  }

  const defaultOptions = {
    weekday: "long",
    year: "numeric",
    month: "long",
    day: "numeric",
    hour: "numeric",
    minute: "numeric",
    second: "numeric",
    hour12: true,
  };

  const finalOptions = { ...defaultOptions, ...options };
  return date.toLocaleString("en-US", finalOptions);
}

// Function to format the "viewedBy" data into an HTML structure
function formatViewedBy(viewedByData = {}) {
  return `
    <ul ${viewedByData.durationOfView ? 'class= "show"' : 'class= "hidden"'}>

      <li><strong>View pageTitle:</strong> ${viewedByData.pageTitle || 'N/A'}</li>
      <li><strong>Duration of View:</strong> ${viewedByData.durationOfView || 'N/A'} seconds</li>
      <li><strong>Max Scroll Depth:</strong> ${viewedByData.maxScrollDepth || 'N/A'}</li>
      <li><strong>Views:</strong> ${viewedByData.viewsCount || viewedByData.contactViews  || 1}</li>
      <li><strong>Date:</strong> ${viewedByData.viewDate ? formatDate(viewedByData.viewDate) : 'N/A'}</li>
      <li><strong>Last View Date:</strong> ${viewedByData.lastViewDate || 'N/A'}</li>
<hr>
      <li><strong>View Method:</strong> ${viewedByData.viewMethod || 'N/A'}</li>
      <li><strong>View Source:</strong> ${viewedByData.viewSource || 'N/A'}</li>
      <li><strong>Referrer:</strong> ${viewedByData.referrer || 'N/A'}</li>
<hr>
      <li><strong>Job Title Name:</strong> ${viewedByData.jobTitleName || 'N/A'}</li>
      <li><strong>View Exit Track:</strong> ${viewedByData.exitTrack || 'N/A'}</li>
      <li><strong>View Action Name:</strong> ${viewedByData.actionName || 'N/A'}</li>
     


    </ul>
  `;
}

// Function to toggle visibility of detail rows
function toggleDetailSection(rowId) {
  const detailRow = document.getElementById(`details-${rowId}`);
  if (detailRow) {
    detailRow.style.display = detailRow.style.display === 'none' ? 'table-row' : 'none';
  }
}

// Main function to display user analytics
async function displayUserAnalytics() {
  const analyticsData = await fetchUserAnalyticsData();
  const totalUsers = analyticsData.length;

  document.getElementById('usersDisplay').innerHTML = `<h3>${totalUsers}</h3>`;

  let tableHTML = `
    <table>
      <thead>
        <tr>
          <th>IP Address</th>
          <th onclick="sortTable(0)">City</th>
          <th onclick="sortTable(1)">State</th>
          <th>Country</th>
          <th onclick="sortTable(2)">Last View Date</th>
          <th  onclick="sortTable(3)">Total Duration (Seconds)</th>
          <th  onclick="sortTable(4)">Activities Count</th>
          <th  onclick="sortTable(5)">Member</th>
          <th>User Blocked</th>
        </tr>
      </thead>
      <tbody>
  `;

  analyticsData.forEach(user => {
    tableHTML += `
      <tr>
        <td><button class="collapsible" onclick="toggleDetailSection('${user.ipAddress}')">${user.ipAddress}</button></td>
        <td>${user.city || 'N/A'}</td>
        <td>${user.state || 'N/A'}</td>
        <td>${user.country || 'N/A'}</td>
        <td>${user.lastViewDate ? formatDate(user.lastViewDate) : 'N/A'}</td>
        <td>${user.totalDuration || 0}</td>
        <td>${user.userActivitiesCount || 0}</td>
        <td>${user.userBlocked ? 'Yes' : 'No'}</td>
        <td>${user.userID ? 'Yes' : 'No'}</td>
      </tr>
    `;

   
      tableHTML += `
        <tr id="details-${user.ipAddress}" class="details-row" style="display: none;">
          <td colspan="8">
            <div class="user-details">
              <h4>Details for ${user.ipAddress}</h4>

              <div class="userAnalyicsBody" >
              <p>User: ${user.displayName}</p>
              <p>User Name: ${user.name}</p>
              <p>User ID: ${user.userID}</p>
              <p>Last Login: ${user.lastLogin}</p>
              <p>Last Update: ${user.lastUpdate}</p>
              <p>Last View Date: ${user.lastViewDate}</p>
              <p>User Activities Count: ${user.userActivitiesCount}</p>
              <p>Total Duration: ${user.totalDuration}</p>
              <p>Last View Date: ${user.lastViewDate}</p>
              <p>Entry URL: ${user.entryURL}</p>
              <p>Referrer URL: ${user.referrer}</p>
<hr>
              <p>Timezone: ${user.timezone}</p>
              <p>Language: ${user.language}</p>
              <p>Country: ${user.country}</p>
              <p>State: ${user.state}</p>
              <p>City: ${user.city}</p>
              <p>Zip: ${user.zip}</p>
<hr>
              <p>Browser: ${user.browser}</p>
              <p>Network Type: ${user.networkType}</p>
              <p>OS: ${user.os}</p>
              <p>Connection Speed: ${user.connectionSpeed}</p>
              <p>Screen Resolution: ${user.screenResolution}</p>
              <p>View Port Size: ${user.viewportSize}</p>
              <p>Screen Resolution: ${user.screenResolution}</p>
<hr>

              


              <p>User Blocked: ${user.userBlocked}</p>

                            </div>

        


          
      `;
      const viewedByDetails = []
      .filter(detail => detail)
      .map(detail => formatViewedBy(detail))
      .join("");

    if (viewedByDetails) {
      tableHTML += `
        <div class="userAnalyicsViewedbyInfo" >
              ${viewedByDetails}
              </div>

     `;
  
    }
  });






  
  tableHTML += `   </div>
          </td>
        </tr>  </tbody></table>  `;
  document.getElementById('userAnalyticsTableContainer').innerHTML = tableHTML;
}

// Fetch user analytics data from Firestore
async function fetchUserAnalyticsData() {
  const analyticsCollection = collection(db, "Analytics");
  const analyticsSnapshot = await getDocs(analyticsCollection);
  return analyticsSnapshot.docs.map(doc => ({
    ipAddress: doc.id,
    city: doc.data().city,
    country: doc.data().country,
    state: doc.data().state,
    totalDuration: doc.data().totalDuration,
    userActivitiesCount: doc.data().userActivitiesCount,
    userBlocked: doc.data().userBlocked || false,
    lastViewDate: doc.data().lastViewDate,

    contactViewedBy: doc.data().contactViewedBy || {},
    applyViewedBy: doc.data().applyhtmlViewedBy || doc.data().applyViewedBy || {},
    homeViewedBy: doc.data().homeViewedBy || doc.data().indexViewedBy|| {},
    aboutViewedBy: doc.data().aboutViewedBy || {},
    authViewedBy: doc.data().authViewedBy || {},
    blogViewedBy: doc.data().blogViewedBy || {},
    companypageViewedBy: doc.data().companypageViewedBy || {},
   
    jobdetailsViewedBy: doc.data().jobdetailsViewedBy || {},
    joblistingsViewedBy: doc.data().joblistingsViewedBy || {},
    locationsViewedBy: doc.data().locationsViewedBy || {},
    privacyViewedBy: doc.data().privacyViewedBy || {},
    recruiterdashboardViewedBy: doc.data().recruiterdashboardViewedBy || {},
    stateViewedBy: doc.data().stateViewedBy || {},
    cityViewedBy: doc.data().cityViewedBy || {},

    otherPagesViewedBy: doc.data().stateViewedBy || {},

  }));
}






window.toggleDetailSection  = toggleDetailSection ;


window.onload = function () {
           
    
            // my Analyics
     
            fetchUserAnalyticsData();
   // Display user analytics when the page loads
   displayUserAnalytics();
  


        };
    

































        
    </script>
</body>
</html>
