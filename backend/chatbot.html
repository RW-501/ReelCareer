<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot Management - Admin</title>
    
    <link rel="stylesheet" href="https://reelcareer.co/backend/css/styles.css">



    <!-- Bootstrap CSS -->
     
    
  
    

    

    <style>
        /* Custom styles for a user-friendly design */
        .form-group {
            position: relative;
        }
        .tooltip {
            position: absolute;
            top: -5px;
            left: 105%;
            background-color: #f9f9f9;
            border: 1px solid #ccc;
            padding: 5px;
            z-index: 100;
            display: none;
        }
        .form-group:hover .tooltip {
            display: block;
        }



        body {
  font-family: Arial, sans-serif;
  padding: 20px;
}

h1 {
  font-size: 2em;
}

h2, h3 {
  margin-top: 20px;
}

#general-questions-list, #predefined-questions-list {
  list-style-type: none;
}

button {
  margin-top: 10px;
  padding: 5px 10px;
  cursor: pointer;
}

textarea {
  width: 100%;
}

form input, form textarea, form select {
  display: block;
  margin: 10px 0;
  padding: 5px;
  width: 100%;
}
main {
    width: 90%;
    margin: .5rem auto;
    padding: 2rem;
    height: 100%;
    display: grid
;
    font-family: 'Roboto', sans-serif;
}

.drop-zone {
    min-height: 50px;
    padding: 10px;
    border: 2px dashed #ccc;
    padding: 2rem;
    margin: 1rem;
}

.drop-zone.highlight {
    border-color: #4CAF50;
    background-color: #f0fff0;
}

li.dragging {
    opacity: 0.5;
    background-color: #f9f9f9;
    cursor: grabbing;
}
.question-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px;
    border: 1px solid #ddd;
    margin: 5px 0;
    border-radius: 5px;
}

.button-container {
    display: flex;
    gap: 5px;
}

.edit-button,
.remove-button {
    background-color: #007bff;
    color: #fff;
    border: none;
    border-radius: 3px;
    padding: 5px 8px;
    cursor: pointer;
    font-size: 12px;
}

.remove-button {
    background-color: #dc3545;
}

.edit-button:hover {
    background-color: #0056b3;
}

.remove-button:hover {
    background-color: #c82333;
}

#autoUploadControls {
    margin: 2rem auto;
    width: 100%;
    display: flex;
}
    </style>
<!-- Main Script Loader -->
    <script src="https://reelcareer.co/scripts/js/loader.js"></script>
</head>

<body>
    
    <script defer src="https://reelcareer.co/backend/js/admin.js"></script>

   <!-- Navbar section -->
<nav id="Main_Nav" class="navbar navbar-expand-lg navbar-light bg-light" role="navigation" aria-label="Main Navigation">
  <a class="navbar-brand" href="https://reelcareer.co">ReelCareer.co</a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="navbarNav">
    <ul class="navbar-nav">

                        <!-- Dashboard and New Group -->
                        <div class="navGroup" title="Dashboard and Analytics">
                            <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/notes">Notes</a></li>
                            <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/titles-fix">Title Fix</a></li>
                  </div>

            <!-- Dashboard and Analytics Group -->
            <div class="navGroup" title="Dashboard and Analytics">
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/dashboard">Dashboard</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/analytics">Analytics</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/state-labour-market">State Labour Market</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/ping">Ping</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/page-editor">Page Editor</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/notes">Notes</a></li>
            </div>
            <!-- Management Tools -->
            <div class="navGroup" title="Management Tools">
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/content-management">Content <small>Management</small></a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/user-management">User <small>Management</small></a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/job-management">Job <small>Management</small></a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/application-management">Application <small>Management</small></a></li>
            </div>
            <!-- General Settings and Utilities -->
            <div class="navGroup" title="General Settings and Utilities">
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/contact">Contact</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/settings">Settings</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/support">Support</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/chatbot">Chatbot</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/notifications-management">Notifications <small>Management</small></a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/system-logs">System Logs</a></li>
            </div>
            <!-- Finance and Monetization -->
            <div class="navGroup" title="Finance and Monetization">
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/transactions">Transactions</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/integration-management">Integration <small>Management</small></a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/payments">Payments</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/monetization">Monetization</a></li>
            </div>
            <!-- SEO and Cleanup -->
            <div class="navGroup" title="SEO and Cleanup">
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/delete-dup">Delete Dup</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/seo-helper">SEO Helper</a></li>
            </div>
            <!-- Role and Personality Management -->
            <div class="navGroup" title="Role and Personality Management">
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/role-management">Role <small>Management</small></a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/trait-personality-management">Trait Personality <small>Management</small></a></li>
            </div>
        </ul>
    </div>
</nav>

<main id="main-content">
    <h1>Chatbot Management</h1>

        <!-- Chatbot Configuration Section -->
        <div class="card mb-4">
            <h3>Add New Question</h3>
            <form id="new-question-form">
                <label for="question">Question</label>
                <input type="text" id="question" required>

                <label for="questionID">Question ID</label>

                <input type="text" id="questionID" disabled>

                <label for="answer">Answer</label>
                <textarea id="answer" required></textarea>
            
                <label for="category">Category</label>
                <select id="category">
                    <option value="General">General</option>
                    <option value="Predefined">Predefined</option>
                </select>
            
                <label for="tags">Tags (comma-separated)</label>
                <div id="tagsContainertagsSET-tags">
                    <input type="text" class="form-control" id="tagsSET-tags" placeholder="e.g., support, contact, help">
                   </div>

                   <label for="status">Status</label>
                   <select id="status">
                       <option value="review">Review</option>
                       <option value="active">Active</option>
                   </select>

                   <label for="topic">Topic</label>
                   <select id="topic">
                       <option value="obituaries">Career Obituaries</option>
                       <option value="chatbot">Chatbot Support</option>
                       <option value="jobsearch">Job Search</option>
                       <option value="recruiter">Recruiter Tools</option>
                       <option value="videoreel">Video Reel & Resume</option>
                       <option value="profile">User Profile</option>
                       <option value="account">Account Management</option>
                       <option value="membership">Membership & Payments</option>
                       <option value="analytics">Analytics & Insights</option>
                       <option value="notifications">Notifications & Alerts</option>
                       <option value="privacy">Privacy & Security</option>
                   </select>
                   
                   

                <label for="link">Add Link (Optional)</label>
                <input type="text" id="link" placeholder="https://reelcareer.co/bot">
            
                <label for="supportURL">Support URL (Optional)</label>
                <input type="text" id="supportURL" placeholder="https://reelcareer.co/support">

                <label for="searchableQuestion">Searchable Question</label>
                <input type="text" id="searchableQuestion" placeholder="searchableQuestion">
            
                <button type="submit">Add Question</button>
            </form>
            
            <!-- Buttons for Export and Upload -->
            <div style="margin-top: 20px;">
                <button id="copy-json-btn">Copy Questions as JSON</button>
            </div>
            
            <!-- JSON Output Area -->
            <h4>JSON Output</h4>
            <button id="upload-to-db">Upload to Database</button>

            <div id="autoUploadControls"></div>
            <button id="upload-to-db-new">Upload All Database</button>

            <textarea id="json-output" rows="10" cols="50" readonly></textarea>
            
            <h3>General Questions</h3>
            <ul id="general-questions" class="drop-zone" ondragover="allowDrop(event)" ondrop="drop(event)">
            </ul>
            
            <h3>Predefined Questions</h3>
            <ul id="predefined-questions" class="drop-zone" ondragover="allowDrop(event)" ondrop="drop(event)">
            </ul>
            <h3>New Questions</h3>
            <ul id="new-questions" class="drop-zone" ondragover="allowDrop(event)" ondrop="drop(event)">
            </ul>

        </div>

        <!-- Search Bar for Interaction Logs -->
        <div class="mb-3">
            <input type="text" id="searchInput" class="form-control" placeholder="Search Interaction Logs..." onkeyup="filterLogs()">
        </div>

        <!-- Chatbot Interaction Logs Section -->
        <div class="card mb-4">
            <div class="card-body">
                <h4>Chatbot Interaction Logs</h4>
                <table class="table table-bordered" id="interactionTable">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>User Input</th>
                            <th>Answer</th>
                            <th>Helpful </th>
                            <th>Views</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="interactionBody">
                        <tr>
                            <td colspan="3">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        

 
        
</main>


    <!-- Footer -->
    <footer id="dynamic-footer"></footer>
    
    <!-- Firebase configuration/ Login& Out -->
     

    <!-- Firebase JS SDK and Custom Scripts -->

    <script type="module">
        import {
            db, doc, getDoc, query, updateDoc,
            setDoc, ref, signInWithPopup, orderBy,
            serverTimestamp ,
            uploadBytes, OAuthProvider, arrayUnion, getStorage,
            signOut, addDoc, increment, onAuthStateChanged,
            createUserWithEmailAndPassword, signInWithEmailAndPassword,
            where, getDocs, storage, collection, deleteObject, 
            auth, analytics, deleteDoc, getDownloadURL,writeBatch 
        } from 'https://reelcareer.co/scripts/js/load/module.js';


       // Initialize arrays for questions
       let generalQuestions = [];
let predefinedQuestions = [];
let newQuestions = [];


        async function loadInteractionLogs() {
    const interactionBody = document.getElementById('interactionBody');
    interactionBody.innerHTML = '<tr><td colspan="6">Loading...</td></tr>'; // Loading state

    try {
        // Reference 'ChatbotInteractions' collection and order by timestamp
        const q = query(collection(db, 'ChatbotInteractions'), orderBy('timestamp', 'desc'));
        const querySnapshot = await getDocs(q);
        console.log("loadInteractionLogs");

        interactionBody.innerHTML = ''; // Clear loading message

        querySnapshot.forEach((doc, index) => {
            const data = doc.data();

            // Create a row dynamically
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${new Date(data.timestamp.seconds * 1000).toLocaleString()}</td>
                <td>${data.question}</td>
                <td>${data.answer}</td>
                <td>${data.helpful}</td>
                <td>${data.views}</td>
                <td>${data.status}</td>
            `;

            // Add click event to trigger createQuestionElement
            row.addEventListener('click', () => {
    createQuestionElement(data, "New", newQuestions.length);
    console.log("clicked createQuestionElement", data.question);
});


            // Append row to the table body
            interactionBody.appendChild(row);
        });

        if (querySnapshot.empty) {
            interactionBody.innerHTML = '<tr><td colspan="6">No data available.</td></tr>';
        }
    } catch (error) {
        console.error("Error loading interactions: ", error);
        interactionBody.innerHTML = '<tr><td colspan="6">Error loading data.</td></tr>';
    }
}


// Filter interaction logs based on user input
function filterLogs() {
    const input = document.getElementById('searchInput').value.toLowerCase();
    const rows = document.querySelectorAll('#interactionBody tr');
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(input) ? '' : 'none';
    });
}

// Initialize search filter
document.getElementById('searchInput').addEventListener('input', filterLogs);

// Load the logs when the page is ready
window.onload = loadInteractionLogs;

    

        















 


async function fetchChatbotData() {
  try {
    const response = await fetch('https://reelcareer.co/bot/chat_bot.json');
    const data = await response.json();

    console.log("Fetched Chatbot Data:", data);

    // Check and fallback to empty arrays if properties are missing
    const safeGeneralQuestions = Array.isArray(data.generalQuestions) ? data.generalQuestions : [];
    const safePredefinedQuestions = Array.isArray(data.predefinedQuestions) ? data.predefinedQuestions : [];
    const safeNewQuestions = Array.isArray(data.newQuestions) ? data.newQuestions : [];

    // Push data into arrays
    generalQuestions.push(...safeGeneralQuestions);
    predefinedQuestions.push(...safePredefinedQuestions);
    newQuestions.push(...safeNewQuestions);

    renderQuestions(); // Render the questions if data is valid
  } catch (error) {
    console.error("Error fetching data:", error.message);
  }
}



let  jsonOutput = {
        generalQuestions,
        predefinedQuestions,
        newQuestions
    };








         



                
// Firestore Batch Upload Function
async function batchUpdateChatbotInteractions() {
    const batch = writeBatch(db); // Get the batch reference
    const collectionRef = collection(db, "ChatbotInteractions"); // Reference to the "ChatbotInteractions" collection

    // Function to process each question in the given category
    function processQuestions(questions, category,topic) {
        questions.forEach((question) => {
            const docID = question.id || generateRandom6DigitNumber(); // Ensure unique ID
            const docRef = doc(collectionRef, docID.toString()); // Reference to document in Firestore

            const updatedQuestion = {
                id: docID,
                question: question.question,
                answer: question.answer,
                category: category,
                tags: question.tags || [],
                supportURL: question.supportURL || null,
                helpfulCount: question.helpfulCount || 0,
                views: question.views || 0,
                confidenceScore: question.confidenceScore || 0,

                    
                    activate: true,
                    status: "review",


                    feedback: "",
                    topic: topic,

    timestamp: serverTimestamp(), // Firestore server-side timestamp for consistency
    lastUpdated: serverTimestamp(),
                createdAt: question.createdAt || new Date()
            };

            batch.set(docRef, updatedQuestion, { merge: true }); // Set the document data
        });
    }

    // Access jsonOutput directly (make sure jsonOutput is defined elsewhere)
    processQuestions(jsonOutput.generalQuestions, "General",jsonOutput.topic);
    processQuestions(jsonOutput.predefinedQuestions, "Predefined",jsonOutput.topic);
    processQuestions(jsonOutput.newQuestions, "New",jsonOutput.topic);

    // Commit the batch
    try {
        await batch.commit(); // Await for the commit to finish
        console.log("Data successfully uploaded to Firestore!");
    } catch (error) {
        console.error("Error uploading data: ", error);
    }
}


document.getElementById("upload-to-db").addEventListener("click", batchUpdateChatbotInteractions);


// Helper Function: Generate Random 6-Digit Number
function generateRandom6DigitNumber() {
    return Math.floor(100000 + Math.random() * 900000);
}

let editIndex = null; // Index of the question being edited
let editCategory = null; // Category of the question being edited

async function doesQuestionIDExist(questionID) {
    const collectionRef = collection(db, "ChatbotInteractions");
    const querySnapshot = await getDocs(query(collectionRef, where("faq_ID", "==", questionID)));
    return !querySnapshot.empty;
}

function calculateDifficultyLevel(question) {
    const complexWords = new Set(["algorithm", "analytics", "configuration", "performance", "optimization",
        "metrics", "compliance", "visibility", "customization", "integration", "encryption",
        "authentication", "obfuscation", "complexity"]);
    const questionWords = question.toLowerCase().replace(/[^\w\s]/g, "").split(/\s+/);
    const complexWordCount = questionWords.filter(word => complexWords.has(word)).length;
    const wordCount = questionWords.length;
    const sentenceCount = question.split(/[.!?]+/).filter(Boolean).length;

    let difficulty = 1; // Base difficulty
    if (complexWordCount > 1) difficulty += 1;
    if (wordCount > 10) difficulty += 1;
    if (sentenceCount > 1) difficulty += 1;

    return Math.min(difficulty, 5); // Cap difficulty between 1 and 5
}

document.getElementById("new-question-form").addEventListener("submit", async function (e) {
    e.preventDefault();

    const questionID = document.getElementById("questionID").value.trim() || generateRandom6DigitNumber();
    const question = document.getElementById("question").value.trim();
    const answer = document.getElementById("answer").value.trim();
    let category = document.getElementById("category").value.trim();
    const status = document.getElementById("status").value.trim();
    const link = document.getElementById("link").value.trim();
    const supportURL = document.getElementById("supportURL").value.trim();
    let topic = document.getElementById("topic").value.trim();
    const tagsInput = document.getElementById('tagsSET-tags').value.trim();
    const tags = tagsInput ? tagsInput.split(",").map(item => item.toLowerCase().trim()) : [];
    const allowedCategories = ["Predefined", "General"];
    category = allowedCategories.includes(category) ? category : "General";

    if (!topic && tags.length > 0) topic = tags[0];

    const stopWords = ["a", "i", "do", "how", "what", "and", "the", "is", "in", "or", "for"];
    const sanitizedQuestion = question.toLowerCase()
        .replace(/[^\w\s]/g, "")
        .split(/\s+/)
        .filter(word => !stopWords.includes(word))
        .slice(0, 15);  // Firebase indexing limit: keep searchable array small

    if (await doesQuestionIDExist(questionID)) {
        showToast("Error: Duplicate question ID detected. Please use a different ID.");
        console.error(`Duplicate question ID (${questionID}) detected.`);
        return;
    }

    const difficultyLevel = calculateDifficultyLevel(question);

    const updatedQuestion = {
        faq_ID: questionID,
        question: question,
        answer: answer,
        link: link,
        category: category,
        searchableQuestion: sanitizedQuestion.join(","),
        topic: topic,
        tags: tags,
        supportURL: supportURL || null,
        status: status,
        feedback: "",
        confidenceScore: 0,
        helpfulCount: 0,
        views: 0,
        popularityScore: 0,
        relatedQuestions: [],
        difficultyLevel: difficultyLevel,
        categoriesHierarchy: '',
        attachments: [],
        isArchived: false,
        lastUpdatedBy: "ReelCareer",
        createdBy: "ReelCareer",
        createdAt: new Date(),
        timestamp: serverTimestamp(),
        lastUpdated: new Date()
    };

    try {
        const docRef = doc(collection(db, "ChatbotInteractions"));
        await setDoc(docRef, updatedQuestion, { merge: true });
        updatedQuestion.id = docRef.id;
        showToast("Question successfully added/updated!");
    } catch (error) {
        console.error("Error adding/updating question:", error);
        showToast("Error: Could not add/update question. Please try again.");
    }

    if (editIndex !== null && editCategory !== null) {
        const targetArray = editCategory === "General" ? generalQuestions :
            editCategory === "Predefined" ? predefinedQuestions : newQuestions;
        targetArray[editIndex] = updatedQuestion;
        editIndex = null;
        editCategory = null;
    } else {
        const targetArray = category === "General" ? generalQuestions :
            category === "Predefined" ? predefinedQuestions : newQuestions;
        targetArray.push(updatedQuestion);
    }

    renderQuestions();
    document.getElementById("new-question-form").reset();
});


let isProcessing = false;
let generalIndex = parseInt(localStorage.getItem("generalIndex") || "0");
let predefinedIndex = parseInt(localStorage.getItem("predefinedIndex") || "0");

function createProgressBar() {
    const progressContainer = document.createElement('div');
    progressContainer.id = 'progress-container';
    progressContainer.style.width = '100%';
    progressContainer.style.height = '25px';
    progressContainer.style.backgroundColor = '#f3f3f3';
    
    const progressBar = document.createElement('div');
    progressBar.id = 'progress-bar';
    progressBar.style.width = '0%';
    progressBar.style.height = '100%';
    progressBar.style.backgroundColor = '#4caf50';
    
    progressContainer.appendChild(progressBar);
    
    const progressMessage = document.createElement('div');
    progressMessage.id = 'progress-message';
    progressMessage.style.marginTop = '10px';
    progressMessage.textContent = "Processing...";

    document.getElementById("autoUploadControls").appendChild(progressContainer);
    document.getElementById("autoUploadControls").appendChild(progressMessage);
}

function updateProgressBar(percent) {
    const progressBar = document.getElementById('progress-bar');
    const progressMessage = document.getElementById('progress-message');
    progressBar.style.width = `${percent}%`;
    progressMessage.textContent = `Processing... ${percent}% completed`;
}

function uploadQuestionsToDB() {
    isProcessing = true;
    createProgressBar(); // Create progress bar UI elements

    const generalQuestions = document.querySelectorAll("#general-questions .question-item");
    const predefinedQuestions = document.querySelectorAll("#predefined-questions .question-item");

    const totalQuestions = generalQuestions.length + predefinedQuestions.length;

    function processQuestion(questions, category) {
        if (!isProcessing || generalIndex >= generalQuestions.length && predefinedIndex >= predefinedQuestions.length) {
            console.log("Processing complete or stopped.");
            updateProgressBar(100); // Set progress to 100% when done
            return;
        }

        const index = category === "General" ? generalIndex : predefinedIndex;
        if (index >= questions.length) {
            console.log(`No more questions in ${category} to process.`);
            return;
        }

        const questionItem = questions[index];
        const editButton = questionItem.querySelector(".edit-button");
        const removeButton = questionItem.querySelector(".remove-button");

        if (!editButton || !removeButton) {
            console.error(`Missing buttons in question-item at index ${index}`);
            return;
        }

        setTimeout(() => {
            editButton.click(); // Simulate edit click
            console.log(`Editing question: ${questionItem.innerText.trim()}`);
            const dataIndex = questionItem.getAttribute("data-index");
            console.log(`Data-index: ${dataIndex}`);

            removeButton.click(); // Simulate remove click
            console.log("Question removed");

            // Update index and save progress
            if (category === "General") {
                generalIndex++;
                localStorage.setItem("generalIndex", generalIndex);
            } else {
                predefinedIndex++;
                localStorage.setItem("predefinedIndex", predefinedIndex);
            }

            // Update progress bar after processing each question
            const completed = (generalIndex + predefinedIndex) / totalQuestions * 100;
            updateProgressBar(completed);

            setTimeout(() => {
                document.getElementById("new-question-form").click(); // Simulate adding new question
                console.log("Simulated new question form submission");

                // Continue processing
                processQuestion(questions, category);
            }, 5000); // Adjustable delay between actions
        }, 5000); // Adjustable delay for each action
    }

    processQuestion(generalQuestions, "General");
    processQuestion(predefinedQuestions, "Predefined");
}

function stopProcessing() {
    isProcessing = false;
    console.log("Processing stopped.");
    const progressMessage = document.getElementById('progress-message');
    progressMessage.textContent = "Processing stopped.";
}

document.getElementById("stop-button").addEventListener("click", stopProcessing);

// Start process button
document.getElementById("start-button").addEventListener("click", () => {
    if (!isProcessing) {
        uploadQuestionsToDB();
    }
});


document.getElementById("upload-to-db-new").addEventListener("click", uploadQuestionsToDB);







function renderQuestions() {
    const generalList = document.getElementById("general-questions");
    const predefinedList = document.getElementById("predefined-questions");
    const newList = document.getElementById("new-questions");

    generalList.innerHTML = "";
    predefinedList.innerHTML = "";
    newList.innerHTML = "";

    // Render General Questions
    generalQuestions.forEach((q, index) => {
        const li = createQuestionElement(q, "General", index);
        li.setAttribute("draggable", "true");
        li.setAttribute("data-index", index);
        li.setAttribute("data-category", "General");
        li.addEventListener("dragstart", dragStart);
        li.addEventListener("dragend", dragEnd);
        generalList.appendChild(li);
    });

    // Render Predefined Questions
    predefinedQuestions.forEach((q, index) => {
        const li = createQuestionElement(q, "Predefined", index);
        li.setAttribute("draggable", "true");
        li.setAttribute("data-index", index);
        li.setAttribute("data-category", "Predefined");
        li.addEventListener("dragstart", dragStart);
        li.addEventListener("dragend", dragEnd);
        predefinedList.appendChild(li);
        });

            // Render newQuestions Questions
            newQuestions.forEach((q, index) => {
        const li = createQuestionElement(q, "New", index);
        li.setAttribute("draggable", "true");
        li.setAttribute("data-index", index);
        li.setAttribute("data-category", "New");
        li.addEventListener("dragstart", dragStart);
        li.addEventListener("dragend", dragEnd);
        newList.appendChild(li);
        });
}


function createQuestionElement(question, category, index) {
    const li = document.createElement("li");
    li.className = "question-item";
    li.textContent = question.question;

    // Edit Button
    const editButton = document.createElement("button");
    editButton.textContent = "Edit";
    editButton.className = "edit-button";
    editButton.addEventListener("click", (e) => {
        e.stopPropagation();
        populateForm(question, category, index);
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    // Remove Button
    const removeButton = document.createElement("button");
    removeButton.textContent = "Remove";
    removeButton.className = "remove-button";
    removeButton.addEventListener("click", (e) => {
        e.stopPropagation();
        removeQuestion(category, index);
    });

    // Append buttons to the li
    const buttonContainer = document.createElement("div");
    buttonContainer.className = "button-container";
    buttonContainer.appendChild(editButton);
    buttonContainer.appendChild(removeButton);

    li.appendChild(buttonContainer);

    // Append to the list
    document.getElementById("new-questions").appendChild(li);
    return li;
}











function populateForm(questionData, category, index) {

console.log("populateForm  ",questionData)

// Populate form fields
document.getElementById("questionID").value = questionData.id || "";
document.getElementById("question").value = questionData.question || "";
document.getElementById("answer").value = questionData.answer
    ? questionData.answer.split(" Here's the link:")[0]
    : "";
document.getElementById("link").value = extractLink(questionData.answer) || "";
document.getElementById("category").value = category;
document.getElementById("supportURL").value = questionData.supportURL || "";
document.getElementById("topic").value = questionData.topic || "";

// Check if tags are empty
if (!questionData.tags || questionData.tags.length === 0) {
    // Extract words from the question title
    questionData.tags = questionData.question
        ? questionData.question
              .toLowerCase() // Convert to lowercase
              .replace(/[^a-z0-9\s]/g, "") // Remove special characters
              .split(" ") // Split into an array of words
              .filter(Boolean) // Remove empty strings
        : [];
}

// Populate tags field
document.getElementById('tagsSET-tags').value = questionData.tags.join(", ");
document.getElementById('searchableQuestion').value = questionData.searchableQuestion || '';

// Populate tags list dynamically
const tagsContainer = document.getElementById('tagsList');
tagsContainer.innerHTML = ""; // Clear any existing tags

questionData.tags.forEach(tag => {
    const tagElement = document.createElement('div');
    tagElement.className = 'tag';
    tagElement.innerHTML = `
        <span class="tag badge tag-primary mr-1">
            ${tag}
            <button class="ml-1 btn btn-sm tag" onclick="removeTag(this)">x</button>
        </span>
    `;
    tagsContainer.appendChild(tagElement);
});

// Set edit state
editIndex = index;
editCategory = category;
}










function removeQuestion(category, index) {
    if (category === "General") {
        generalQuestions.splice(index, 1);
    } else if (category === "Predefined") {
        predefinedQuestions.splice(index, 1);
    }else {
        newQuestions.splice(index, 1);

    }
    renderQuestions();
}

function extractLink(answer) {
    if (answer && answer.includes("Here's the link:")) {
        const regex = /\[.*?\]\((.*?)\)/; // Regex to match the link inside markdown format
        const match = answer.match(regex);
        return match ? match[1] : "";
    }
    return "";
}

// Drag start event handler
function dragStart(e) {
    e.target.classList.add("dragging"); // Highlight the dragged item
    e.dataTransfer.setData("text/plain", JSON.stringify({
        index: e.target.getAttribute("data-index"),
        category: e.target.getAttribute("data-category")
    }));
}

// Drag end event handler
function dragEnd(e) {
    e.target.classList.remove("dragging"); // Remove dragging highlight
    document.querySelectorAll(".drop-zone").forEach(zone => zone.classList.remove("highlight")); // Remove zone highlight
    jsonOutput = {
        generalQuestions,
        predefinedQuestions,
        newQuestions
    };

    const jsonText = JSON.stringify(jsonOutput, null, 2);
    document.getElementById("json-output").value = jsonText;

}
window.dragEnd = dragEnd;

// Allow drop event handler
function allowDrop(e) {
    e.preventDefault();
    if (e.target.classList.contains("drop-zone")) {
        e.target.classList.add("highlight");
    }
}
window.allowDrop = allowDrop;

// Drop event handler
function drop(e) {
    e.preventDefault();
    e.target.classList.remove("highlight");

    const data = e.dataTransfer.getData("text/plain");
    const { index, category } = JSON.parse(data);

    let questionToMove;
    let sourceArray;
    let targetArray;

    // Identify the source and target arrays
    if (category === "General") {
        sourceArray = generalQuestions;
        targetArray = predefinedQuestions;
    } else if (category === "Predefined") {
        sourceArray = predefinedQuestions;
        targetArray = generalQuestions;
    }else{
        sourceArray = newQuestions;
        targetArray = predefinedQuestions;
    }

    // Move the question
    questionToMove = sourceArray.splice(index, 1)[0];
    targetArray.push(questionToMove);

    // Re-render the updated lists
    renderQuestions();

    // Log updated arrays
    console.log("General Questions:", generalQuestions);
    console.log("Predefined Questions:", predefinedQuestions);
    console.log("new  Questions:", newQuestions);
}
window.drop = drop;

// Export questions as JSON
document.getElementById("copy-json-btn").addEventListener("click", function () {
     jsonOutput = {
        generalQuestions,
        predefinedQuestions,
        newQuestions
    };

    const jsonText = JSON.stringify(jsonOutput, null, 2);
    document.getElementById("json-output").value = jsonText;
    copyToClipboard(jsonText);
});

// Copy to clipboard
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        alert("JSON copied to clipboard!");
    }).catch(err => {
        console.error("Error copying to clipboard", err);
    });
}




// Call viewDidLoad when the window is fully loaded
window.addEventListener('load', function() {
   // Assuming createTagInputSystem is a function that initializes a tag input system
   const generalTags = createTagInputSystem({
        tagsContainerId: "tagsContainertagsSET-tags",
        badgeClass: "tag-primary" // Custom badge class for general tags
    });

});



// Initial data loading
loadInteractionLogs();


// Initial fetch and render on page load
fetchChatbotData();





    </script>
</body>
</html>
