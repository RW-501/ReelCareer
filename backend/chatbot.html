<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot Management - Admin</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://reelcareer.co/backend/css/styles.css">
    <style>
        /* Custom styles for a user-friendly design */
        .form-group {
            position: relative;
        }
        .tooltip {
            position: absolute;
            top: -5px;
            left: 105%;
            background-color: #f9f9f9;
            border: 1px solid #ccc;
            padding: 5px;
            z-index: 100;
            display: none;
        }
        .form-group:hover .tooltip {
            display: block;
        }



        body {
  font-family: Arial, sans-serif;
  padding: 20px;
}

h1 {
  font-size: 2em;
}

h2, h3 {
  margin-top: 20px;
}

#general-questions-list, #predefined-questions-list {
  list-style-type: none;
}

button {
  margin-top: 10px;
  padding: 5px 10px;
  cursor: pointer;
}

textarea {
  width: 100%;
}

form input, form textarea, form select {
  display: block;
  margin: 10px 0;
  padding: 5px;
  width: 100%;
}
main {
    width: 90%;
    margin: .5rem auto;
    padding: 2rem;
    height: 100%;
    display: grid
;
    font-family: 'Roboto', sans-serif;
}
    </style>
</head>

<body>
    <script src="https://reelcareer.co/public/js/bodyload.js"></script>
    
   <!-- Navbar section -->
<nav id="Main_Nav" class="navbar navbar-expand-lg navbar-light bg-light" role="navigation" aria-label="Main Navigation">
  <a class="navbar-brand" href="https://reelcareer.co">ReelCareer.co</a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="navbarNav">
    <ul class="navbar-nav">

                        <!-- Dashboard and New Group -->
                        <div class="navGroup" title="Dashboard and Analytics">
                            <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/notes">Notes</a></li>
                            <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/titles-fix">Title Fix</a></li>
                  </div>

            <!-- Dashboard and Analytics Group -->
            <div class="navGroup" title="Dashboard and Analytics">
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/dashboard">Dashboard</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/analytics">Analytics</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/state-labour-market">State Labour Market</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/ping">Ping</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/page-editor">Page Editor</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/notes">Notes</a></li>
            </div>
            <!-- Management Tools -->
            <div class="navGroup" title="Management Tools">
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/content-management">Content <small>Management</small></a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/user-management">User <small>Management</small></a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/job-management">Job <small>Management</small></a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/application-management">Application <small>Management</small></a></li>
            </div>
            <!-- General Settings and Utilities -->
            <div class="navGroup" title="General Settings and Utilities">
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/contact">Contact</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/settings">Settings</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/support">Support</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/chatbot">Chatbot</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/notifications-management">Notifications <small>Management</small></a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/system-logs">System Logs</a></li>
            </div>
            <!-- Finance and Monetization -->
            <div class="navGroup" title="Finance and Monetization">
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/transactions">Transactions</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/integration-management">Integration <small>Management</small></a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/payments">Payments</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/monetization">Monetization</a></li>
            </div>
            <!-- SEO and Cleanup -->
            <div class="navGroup" title="SEO and Cleanup">
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/delete-dup">Delete Dup</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/seo-helper">SEO Helper</a></li>
            </div>
            <!-- Role and Personality Management -->
            <div class="navGroup" title="Role and Personality Management">
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/role-management">Role <small>Management</small></a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/trait-personality-management">Trait Personality <small>Management</small></a></li>
            </div>
        </ul>
    </div>
</nav>

<main id="main-content">
    <h1>Chatbot Management</h1>

        <!-- Chatbot Configuration Section -->
        <div class="card mb-4">
            <h3>Add New Question</h3>
            <form id="new-question-form">
                <label for="question">Question</label>
                <input type="text" id="question" required>
            
                <label for="answer">Answer</label>
                <textarea id="answer" required></textarea>
            
                <label for="category">Category</label>
                <select id="category">
                    <option value="General">General</option>
                    <option value="Predefined">Predefined</option>
                </select>
            
                <label for="tags">Tags (comma-separated)</label>
                <input type="text" id="tags" placeholder="e.g., support, contact, help">
            
                <label for="link">Add Link (Optional)</label>
                <input type="text" id="link" placeholder="https://example.com">
            
                <label for="supportURL">Support URL (Optional)</label>
                <input type="text" id="supportURL" placeholder="https://reelcareer.com/support">
            
                <button type="submit">Add Question</button>
            </form>
            
            <!-- Buttons for Export and Upload -->
            <div style="margin-top: 20px;">
                <button id="copy-json-btn">Copy Questions as JSON</button>
                <input type="file" id="upload-json-btn" accept=".json">
            </div>
            
            <!-- JSON Output Area -->
            <h4>JSON Output</h4>
            <textarea id="json-output" rows="10" cols="50" readonly></textarea>
            
            <!-- Question Lists -->
            <h4>General Questions</h4>
            <ul id="general-questions"></ul>
            
            <h4>Predefined Questions</h4>
            <ul id="predefined-questions"></ul>
            
        </div>

        <!-- Search Bar for Interaction Logs -->
        <div class="mb-3">
            <input type="text" id="searchInput" class="form-control" placeholder="Search Interaction Logs..." onkeyup="filterLogs()">
        </div>

        <!-- Chatbot Interaction Logs Section -->
        <div class="card mb-4">
            <div class="card-body">
                <h4>Chatbot Interaction Logs</h4>
                <table class="table table-bordered" id="interactionTable">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>User Input</th>
                            <th>Answer</th>
                            <th>Helpful </th>
                            <th>Views</th>
                        </tr>
                    </thead>
                    <tbody id="interactionBody">
                        <tr>
                            <td colspan="3">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        

 
        
</main>


    <!-- Footer -->
    <footer id="dynamic-footer"></footer>
    
    <!-- Firebase configuration/ Login& Out -->
    <script type="module" src="https://reelcareer.co/public/js/main.js"></script> 

    <!-- Firebase JS SDK and Custom Scripts -->

    <script type="module">
        import {
            db, doc, getDoc, query, updateDoc,
            setDoc, ref, signInWithPopup, orderBy,
             
            uploadBytes, OAuthProvider, arrayUnion, getStorage,
            signOut, addDoc, increment, onAuthStateChanged,
            createUserWithEmailAndPassword, signInWithEmailAndPassword,
            where, getDocs, storage, collection, deleteObject, 
            auth, analytics, deleteDoc, getDownloadURL
        } from 'https://reelcareer.co/js/module.js';





async function loadInteractionLogs() {
    const interactionBody = document.getElementById('interactionBody');
    interactionBody.innerHTML = '<tr><td colspan="3">Loading...</td></tr>'; // Loading state

    try {
        // Reference the 'ChatbotInteractions' collection and order it
        const q = query(collection(db, 'ChatbotInteractions'), orderBy('timestamp', 'desc'), limit(10));
        const querySnapshot = await getDocs(q);

        interactionBody.innerHTML = ''; // Clear loading message

        querySnapshot.forEach((doc) => {
            const data = doc.data();
            const row = `
                <tr>
                    <td>${new Date(data.timestamp).toLocaleString()}</td>
                    <td>${data.question}</td>
                    <td>${data.answer}</td>
                    <td>${data.helpful}</td>
                    <td>${data.views}</td>
                </tr>
            `;
            interactionBody.innerHTML += row;
        });

        if (querySnapshot.empty) {
            interactionBody.innerHTML = '<tr><td colspan="3">No data available.</td></tr>';
        }
    } catch (error) {
        console.error("Error loading interactions: ", error);
        interactionBody.innerHTML = '<tr><td colspan="3">Error loading data.</td></tr>';
    }
}
    
        // Filter interaction logs based on user input
        function filterLogs() {
            const input = document.getElementById('searchInput').value.toLowerCase();
            const rows = document.querySelectorAll('#interactionBody tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(input) ? '' : 'none';
            });
        }

    

        




















        // Initialize arrays for questions
let generalQuestions = [];
let predefinedQuestions = [];


// Fetch /chat_bot.json on page load (for real data)
async function fetchChatbotData() {
  try {
    const response = await fetch('https://reelcareer.co/bot/chat_bot.json');
    const data = await response.json();
    generalQuestions.push(...data.generalQuestions);
    predefinedQuestions.push(...data.predefinedQuestions);
    renderQuestions();
  } catch (error) {
    console.error("Error fetching data:", error);
  }
}





// Add new question form submission
document.getElementById("new-question-form").addEventListener("submit", function (e) {
    e.preventDefault();

    // Get form values
    const question = document.getElementById("question").value.trim();
    const answer = document.getElementById("answer").value.trim();
    const category = document.getElementById("category").value;
    const tagsInput = document.getElementById("tags").value.trim();
    const link = document.getElementById("link").value.trim();
    const supportURL = document.getElementById("supportURL").value.trim();

    // Process tags
    const tags = tagsInput ? tagsInput.split(",").map(tag => tag.trim()) : [];

    // New question object
    const newQuestion = {
        question: question,
        answer: link ? `${answer} Here's the link: [${link}](${link})` : answer,
        category: category,
        tags: tags,
        supportURL: supportURL || null,
        helpful: 0,
        views: 0,
        createdAt: new Date().toISOString()
    };

    // Add to respective category
    if (category === "General") {
        generalQuestions.push(newQuestion);
    } else {
        predefinedQuestions.push(newQuestion);
    }

    // Re-render the questions and reset form
    renderQuestions();
    document.getElementById("new-question-form").reset();
});

// Render questions
function renderQuestions() {
    const generalList = document.getElementById("general-questions");
    const predefinedList = document.getElementById("predefined-questions");

    generalList.innerHTML = "";
    predefinedList.innerHTML = "";

    generalQuestions.forEach((q, index) => {
        const li = document.createElement("li");
        li.textContent = q.question;
        li.setAttribute("draggable", "true");
        li.setAttribute("data-index", index);
        li.setAttribute("data-category", "General");
        li.addEventListener("dragstart", dragStart);
        generalList.appendChild(li);
    });

    predefinedQuestions.forEach((q, index) => {
        const li = document.createElement("li");
        li.textContent = q.question;
        li.setAttribute("draggable", "true");
        li.setAttribute("data-index", index);
        li.setAttribute("data-category", "Predefined");
        li.addEventListener("dragstart", dragStart);
        predefinedList.appendChild(li);
    });
}

// Drag start event handler
function dragStart(e) {
    e.dataTransfer.setData("text/plain", JSON.stringify({
        index: e.target.getAttribute("data-index"),
        category: e.target.getAttribute("data-category")
    }));
}

// Allow drop event handler
function allowDrop(e) {
    e.preventDefault();
}

// Drop event handler
function drop(e) {
    e.preventDefault();

    const data = e.dataTransfer.getData("text/plain");
    const { index, category } = JSON.parse(data);

    let questionToMove;
    let sourceArray;
    let targetArray;

    // Find the question to move based on the category
    if (category === "General") {
        sourceArray = generalQuestions;
        targetArray = predefinedQuestions;
    } else {
        sourceArray = predefinedQuestions;
        targetArray = generalQuestions;
    }

    questionToMove = sourceArray.splice(index, 1)[0]; // Remove the question from the source array

    // Add it to the target array
    targetArray.push(questionToMove);

    // Re-render the lists
    renderQuestions();
}

// Export questions as JSON
document.getElementById("copy-json-btn").addEventListener("click", function () {
    const jsonOutput = {
        generalQuestions,
        predefinedQuestions
    };

    const jsonText = JSON.stringify(jsonOutput, null, 2);
    document.getElementById("json-output").value = jsonText;
    copyToClipboard(jsonText);
});

// Copy to clipboard
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        alert("JSON copied to clipboard!");
    }).catch(err => {
        console.error("Error copying to clipboard", err);
    });
}

// Upload JSON file and populate fields
document.getElementById("upload-json-btn").addEventListener("change", function (event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function (e) {
        try {
            const data = JSON.parse(e.target.result);

            // Populate the arrays
            generalQuestions = data.generalQuestions || [];
            predefinedQuestions = data.predefinedQuestions || [];

            // Re-render the lists
            renderQuestions();
            alert("Questions loaded successfully!");
        } catch (error) {
            alert("Invalid JSON file.");
            console.error("Error parsing JSON:", error);
        }
    };
    reader.readAsText(file);
});











// Initial data loading
loadInteractionLogs();


// Initial fetch and render on page load
fetchChatbotData();

    </script>
</body>
</html>
