<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://reelcareer.co/backend/css/styles.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.6.0/chart.min.js"></script>
    <title>Sitemap Generator</title>
    <style>

.controls { margin-bottom: 20px; }
        .controls button { margin-right: 10px; }
        .progress-bar { width: 100%; background-color: #f3f3f3; border: 1px solid #ccc; height: 20px; margin: 10px 0; position: relative; }
        .progress { height: 100%; width: 0%; background-color: #4caf50; transition: width 0.3s; }
        .table-container { height: 300px; overflow-y: auto; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 8px; border: 1px solid #ccc; text-align: left; }
        th { cursor: pointer; }
        textarea { width: 100%; height: 150px; margin-top: 10px; }
        .error-log { margin-top: 20px; }
        .preview { margin-top: 20px; border: 1px solid #ccc; padding: 10px; }
        .filters { margin-top: 10px; }

        main {
    width: 100%;
    margin: 2rem auto;
    padding: 2rem;
    overflow: hidden;
    height: 100%;
    display: grid;
    font-family: 'Roboto', sans-serif;
}
      </style>
</head>

<body>
    <script src="https://reelcareer.co/public/js/bodyload.js"></script>
    
   <!-- Navbar section -->
<nav id="Main_Nav" class="navbar navbar-expand-lg navbar-light bg-light" role="navigation" aria-label="Main Navigation">
  <a class="navbar-brand" href="https://reelcareer.co">ReelCareer.co</a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="navbarNav">
    <ul class="navbar-nav">

                        <!-- Dashboard and New Group -->
                        <div class="navGroup" title="Dashboard and Analytics">
                            <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/notes">Notes</a></li>
                            <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/titles-fix">Title Fix</a></li>
                            <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/sitemap">Sitmap Builder</a></li>
                  </div>

            <!-- Dashboard and Analytics Group -->
            <div class="navGroup" title="Dashboard and Analytics">
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/dashboard">Dashboard</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/analytics">Analytics</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/state-labour-market">State Labour Market</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/ping">Ping</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/page-editor">Page Editor</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/notes">Notes</a></li>
            </div>
            <!-- Management Tools -->
            <div class="navGroup" title="Management Tools">
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/content-management">Content <small>Management</small></a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/user-management">User <small>Management</small></a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/job-management">Job <small>Management</small></a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/application-management">Application <small>Management</small></a></li>
            </div>
            <!-- General Settings and Utilities -->
            <div class="navGroup" title="General Settings and Utilities">
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/contact">Contact</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/settings">Settings</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/support">Support</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/chatbot">Chatbot</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/notifications-management">Notifications <small>Management</small></a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/system-logs">System Logs</a></li>
            </div>
            <!-- Finance and Monetization -->
            <div class="navGroup" title="Finance and Monetization">
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/transactions">Transactions</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/integration-management">Integration <small>Management</small></a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/payments">Payments</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/monetization">Monetization</a></li>
            </div>
            <!-- SEO and Cleanup -->
            <div class="navGroup" title="SEO and Cleanup">
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/delete-dup">Delete Dup</a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/seo-helper">SEO Helper</a></li>
            </div>
            <!-- Role and Personality Management -->
            <div class="navGroup" title="Role and Personality Management">
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/role-management">Role <small>Management</small></a></li>
                <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/trait-personality-management">Trait Personality <small>Management</small></a></li>
            </div>
        </ul>
    </div>
</nav>


<main id="main-content">


<div class="container mt-4">
        <h1>Sitemap Generator</h1>

        <div class="controls">
          <button id="selectAllBtn">Select All</button>
          <button id="startBtn">Start</button>
          <button id="stopBtn">Stop</button>
          <button id="exportCSV">Export CSV</button>
          <button id="exportJSON">Export JSON</button>
</div>

          <div class="controls">

          <span>Total Links: <span id="linkCount">0</span></span>
          <span>Crawled Pages: <span id="crawledPages">0</span></span>
          <span>Pending Urls: <span id="pendingUrls">0</span></span>
        </div>
        
        <label for="crawlSchedule">Schedule Crawling:</label>
        <select id="crawlSchedule">
          <option value="none">None</option>
          <option value="daily">Daily</option>
          <option value="weekly">Weekly</option>
        </select>

        <div id="excludeSubdomainsDiv"></div>

        <div id="progressBarContainer">
            <div id="progressBar" style="width: 0%; background-color: green; color: white; text-align: center;">
              0%
            </div>
        </div>
        
        <div class="filters">
          <label>
            <input type="checkbox" id="filterUnique"> Show only unique links
          </label>
          <label>
            <input type="checkbox" id="filterHTML"> Show only .html links
          </label>
          <label>
            <input type="checkbox" id="filterDuplicates"> Highlight duplicate links
          </label>
        </div>
        
        <div class="table-container">
            <table id="linkTable">
              <thead>
                <tr>
                  <th onclick="sortTable(0)">URL</th>
                  <th onclick="sortTable(1)">Priority</th>
                  <th>Changefreq</th>
                  <th>Last Modified</th>
                  <th onclick="sortTable(4)">Reachability</th> <!-- Added sort click event on Reachability -->
                  <th>Select</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          
        
        <button id="downloadBtn">Download Sitemap</button>
        <textarea id="sitemapOutput" readonly></textarea>
        <button id="copyBtn">Copy to Clipboard</button>
        
        <h2>Preview</h2>
        <div class="preview" id="previewPane">Sitemap preview will appear here.</div>
        
        <h2>Error Log</h2>
        <textarea class="error-log" id="errorLog" rows="10" readonly></textarea>

        
        </main>



        <script>
        const baseDomain = 'https://reelcareer.co';
        let links = new Set();
        let errors = [];
        let crawling = false;
        let totalLinks = 0;
        const subdomainsExcluded = new Set();
const excludeSubdomainsDiv = document.getElementById('excludeSubdomainsDiv');
   
let crawledPages = new Set(); // To track already crawled pages
let pendingUrls = []; // Queue of URLs to fetch

        // Advanced Sorting and Filtering
        const filterUnique = document.getElementById('filterUnique');
        const filterHTML = document.getElementById('filterHTML');
        const filterDuplicates = document.getElementById('filterDuplicates');
        const progressBar = document.getElementById('progressBar');
        const errorLog = document.getElementById('errorLog');
        const crawledPagesDiv = document.getElementById('crawledPages');
        const pendingUrlsDiv = document.getElementById('pendingUrls');

        const fetchLinks = async (url) => {
  try {
    // If the page has already been crawled, skip it
    if (crawledPages.has(url)) {
      console.log(`Skipping already crawled page: ${url}`);
      return;
    }

    // Preprocess the URL before making the fetch request
    let fixedUrl = url;

    // If the URL contains '/backend', remove that part
    fixedUrl = fixedUrl.replace(/\/backend/g, '');  // Remove all '/backend' segments in the URL

    // If the URL contains relative paths like '../', resolve them correctly
    fixedUrl = fixedUrl.replace(/(?:\.\.\/)+/g, '/');  // Replace all '../' with the root (or current folder)

    // Make sure the fixed URL is an absolute URL
    if (!fixedUrl.startsWith('https')) {
      fixedUrl = new URL(fixedUrl, baseDomain).href;
    }

    // Perform the fetch request with the fixed URL
    const response = await fetch(fixedUrl);
    if (!response.ok) {
      throw new Error(`Failed to fetch ${fixedUrl}: ${response.status}`);
    }

    // Mark the page as crawled
    crawledPages.add(fixedUrl);
    // Update the display with the count of crawled pages
    crawledPagesDiv.innerText = crawledPages.size;

    const text = await response.text();
    const parser = new DOMParser();
    const doc = parser.parseFromString(text, 'text/html');
    const anchors = doc.querySelectorAll('a[href]');
    
    
    
    console.log("Fetched URL: ", url);

    console.log("fixedUrl: ", fixedUrl);
    console.log("Found anchors: ", anchors);

 


    let processedLinks = 0;

    // Process anchors and remove '/backend' if present in the href
    const fixedAnchors = Array.from(anchors).map(anchor => {
      let href = anchor.href;
      // Remove '/backend' if it's part of the href
      if (href.includes('/backend')) {
        href = href.replace(/\/backend/g, '');  // Remove all '/backend' segments in the URL
        anchor.href = href;  // Update the anchor's href with the fixed URL
      }

      const urlObj = new URL(href);
      const subdomain = urlObj.hostname.split('.')[0];  // Assuming subdomains are first part of hostname

      createSubdomainCheckbox(subdomain);

      if (href.startsWith(baseDomain) && (!subdomainsExcluded || href.indexOf(baseDomain) === href.lastIndexOf(baseDomain))) {
        if (!links.has(href) && !crawledPages.has(href)) {
          links.add(href);
          addLinkToTable(href, fixedUrl); // Pass the base URL (where anchor was found)
          pendingUrls.push(href);
          pendingUrlsDiv.innerText = pendingUrls.length;
        } else if (filterDuplicates.checked) {
          highlightDuplicate(href);
        }
      }

      processedLinks++;
      updateProgress(processedLinks, anchors.length);
    });
    console.log("Fixed anchors: ", fixedAnchors);

    if (pendingUrls.length > 0) {
      const nextUrl = pendingUrls.shift();
      fetchLinks(nextUrl);
    }

  } catch (error) {
    errors.push(error.message);
    handleError(error, url);
} finally {
    updateProgress();
    updatePreview();

  }
};

// Function to add link to table with dynamic priority and scheduling
const addLinkToTable = (url, sourceUrl) => {
  const tableBody = document.querySelector('#linkTable tbody');
  const row = document.createElement('tr');
  const priority = calculatePriority(url);
  row.innerHTML = `
    <td>${url}</td>
    <td><input type="number" value="${priority}" class="priority" step="0.1" min="0.0" max="1.0"></td>
    <td>
      <select>
        <option value="daily">Daily</option>
        <option value="weekly">Weekly</option>
        <option value="monthly">Monthly</option>
      </select>
    </td>
    <td>${new Date().toISOString().split('T')[0]}</td>
    <td><span class="status">Pending</span></td>
    <td><input type="checkbox"></td>
  `;
  tableBody.appendChild(row);
  totalLinks++;
  document.getElementById('linkCount').textContent = totalLinks;

  // Perform reachability check
  checkReachability(url, row, sourceUrl);
};

// Function to check the reachability of the link
const checkReachability = async (url, row, sourceUrl) => {
  try {
    const response = await fetch(url);
    const statusCell = row.querySelector('.status');
    const urlCell = row.querySelector('td:first-child');

    if (response.ok) {
      statusCell.textContent = 'Reachable';
      statusCell.style.color = 'green';
    } else {
      statusCell.textContent = 'Unreachable';
      statusCell.style.color = 'red';
      // Make the URL clickable, linking back to the source page where the anchor was found
      const clickableLink = document.createElement('a');
      clickableLink.href = sourceUrl;
      clickableLink.textContent = url;
      clickableLink.target = "_blank"; // Open in new tab
      urlCell.innerHTML = '';  // Clear the current URL text
      urlCell.appendChild(clickableLink); // Append the clickable link
    }
  } catch {
    const statusCell = row.querySelector('.status');
    const urlCell = row.querySelector('td:first-child');
    statusCell.textContent = 'Error';
    statusCell.style.color = 'red';

    // Make the URL clickable if unreachable
    const clickableLink = document.createElement('a');
    clickableLink.href = sourceUrl;
    clickableLink.textContent = url;
    clickableLink.target = "_blank"; // Open in new tab
    urlCell.innerHTML = '';  // Clear the current URL text
    urlCell.appendChild(clickableLink); // Append the clickable link
  }
};
   
        
// Sorting function for the table
const sortTable = (columnIndex) => {
  const table = document.getElementById('linkTable');
  const rows = Array.from(table.rows).slice(1);  // Skip the header row

  rows.sort((rowA, rowB) => {
    const cellA = rowA.cells[columnIndex].textContent.trim();
    const cellB = rowB.cells[columnIndex].textContent.trim();

    // Sorting logic for Reachability column (index 4)
    if (columnIndex === 4) {
      // Define custom sorting for 'Reachability' column (Pending > Accessible > Not Accessible)
      const reachabilityOrder = { 'Reachable': 0, 'Unreachable': 1};
      return reachabilityOrder[cellA] - reachabilityOrder[cellB];
    }

    // Default sorting logic for other columns (lexicographical or numerical)
    return cellA.localeCompare(cellB);
  });

  // Append the sorted rows back to the table
  rows.forEach(row => table.appendChild(row));
};

        // Function to dynamically calculate priority based on URL depth and importance
        const calculatePriority = (url) => {
          const depth = url.split('/').length;
          let priority = 1.0;
        
          // Set priority based on depth, homepage gets the highest priority
          if (depth > 3) {
            priority = 0.5;
          }
          if (url.includes('homepage') || url.includes('index')) {
            priority = 1.0;  // Homepages get higher priority
          }
        
          return priority;
        };
        

        // Function to highlight duplicate links
        const highlightDuplicate = (url) => {
          const rows = document.querySelectorAll('#linkTable tbody tr');
          rows.forEach(row => {
            if (row.firstChild.textContent === url) {
              row.style.backgroundColor = '#ffcccc';
            }
          });
        };
        
        // Update progress function
        const updateProgress = (processedLinks = 0, totalLinks = 0) => {
          const progress = totalLinks > 0 ? (processedLinks / totalLinks) * 100 : 0;
          progressBar.style.width = `${progress}%`;
          progressBar.textContent = `${Math.round(progress)}%`;
        };
        
        // Update error log
     
// When an error occurs, include the URL in the error message
const handleError = (error, url) => {
  const errorMessage = `Error on ${url}: ${error.message}`;
  errors.push(errorMessage);
  updateErrorLog(); // Update the error log after pushing the error
};

// Update the error log with the error messages and URLs
const updateErrorLog = () => {
  const errorLog = document.getElementById('errorLog');
  errorLog.value = errors.join(' \n'); // Combine errors with a space and newline for better readability
};

        
        // Event listeners for filters
        filterUnique.addEventListener('change', () => {
          filterLinks();
        });
        
        filterHTML.addEventListener('change', () => {
          filterLinks();
        });
        
        // Function to filter and display links based on selected filters
        const filterLinks = () => {
          const tableRows = document.querySelectorAll('#linkTable tbody tr');
          tableRows.forEach(row => {
            const urlCell = row.querySelector('td:first-child');
            const url = urlCell.textContent;
        
            let showRow = true;
        
            // Filter by unique links
            if (filterUnique.checked) {
              const uniqueLinks = new Set();
              if (uniqueLinks.has(url)) {
                showRow = false;
              } else {
                uniqueLinks.add(url);
              }
            }
        
            // Filter by .html links
            if (filterHTML.checked && !url.endsWith('.html')) {
              showRow = false;
            }
        
            // Show or hide row based on filters
            if (showRow) {
              row.style.display = '';
            } else {
              row.style.display = 'none';
            }
          });
        };
         // Scheduled Crawling Placeholder
  const scheduleCrawling = document.getElementById('crawlSchedule');
  scheduleCrawling.addEventListener('change', (e) => {
    console.log(`Scheduled crawling set to: ${e.target.value}`);
  });
  
  
        // Function to dynamically create checkboxes for subdomains
const createSubdomainCheckbox = (subdomain) => {
  // Check if the checkbox already exists
  if (!document.getElementById(`subdomain-${subdomain}`)) {
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.id = `subdomain-${subdomain}`;
    checkbox.value = subdomain;
    checkbox.addEventListener('change', (e) => {
      toggleSubdomainExclusion(e.target);
    });

    const label = document.createElement('label');
    label.htmlFor = checkbox.id;
    label.innerText = subdomain;

    const container = document.createElement('div');
    container.appendChild(checkbox);
    container.appendChild(label);
    excludeSubdomainsDiv.appendChild(container);

    // Load subdomains from localStorage
    const excludedSubdomains = JSON.parse(localStorage.getItem('excludedSubdomains')) || [];
    if (excludedSubdomains.includes(subdomain)) {
      checkbox.checked = true;
      subdomainsExcluded.add(subdomain);
    }
  }
};

// Function to handle the toggling of subdomain exclusion
const toggleSubdomainExclusion = (checkbox) => {
  const subdomain = checkbox.value;
  if (checkbox.checked) {
    subdomainsExcluded.add(subdomain);
  } else {
    subdomainsExcluded.delete(subdomain);
  }
  // Save the subdomains excluded to localStorage
  localStorage.setItem('excludedSubdomains', JSON.stringify([...subdomainsExcluded]));
};


        // Start and stop crawling
        document.getElementById('startBtn').addEventListener('click', async () => {
          crawling = true;
          totalLinks = 0;
          links.clear();
          errors = [];
          await fetchLinks(baseDomain);
          updatePreview();
        });

        const updatePreview = () => {
  const previewContainer = document.getElementById('previewPane');
  const linksTable = document.querySelector('#linkTable tbody');
  
  // Clear previous preview content
  previewContainer.innerHTML = '';
  
  // Update the preview of fetched links
  links.forEach(link => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${link}</td>
      <td><span class="status">Reachable</span></td>
    `;
    linksTable.appendChild(row);
  });

  // Update the crawled pages display
  crawledPagesDiv.innerText = `Crawled Pages: ${crawledPages.size}`;
};


        // Load the excluded subdomains from localStorage on page load
document.addEventListener('DOMContentLoaded', () => {
  const excludedSubdomains = JSON.parse(localStorage.getItem('excludedSubdomains')) || [];
  excludedSubdomains.forEach(subdomain => {
    const checkbox = document.getElementById(`subdomain-${subdomain}`);
    if (checkbox) {
      checkbox.checked = true;
      subdomainsExcluded.add(subdomain);
    }
  });
});


document.getElementById('selectAllBtn').addEventListener('click', () => {
  const checkboxes = document.querySelectorAll('#linkTable input[type="checkbox"]');
  const allChecked = Array.from(checkboxes).every(checkbox => checkbox.checked);
  
  // Toggle the selection of all checkboxes
  checkboxes.forEach(checkbox => {
    checkbox.checked = !allChecked;
  });
});





// Export as CSV
document.getElementById('exportCSV').addEventListener('click', () => {
  const rows = document.querySelectorAll('#linkTable tbody tr');
  const csvData = [];

  rows.forEach(row => {
    const columns = row.querySelectorAll('td');
    const rowData = Array.from(columns).map(col => col.textContent);
    csvData.push(rowData.join(','));
  });

  const csvBlob = new Blob([csvData.join('\n')], { type: 'text/csv' });
  const csvUrl = URL.createObjectURL(csvBlob);
  const csvLink = document.createElement('a');
  csvLink.href = csvUrl;
  csvLink.download = 'links.csv';
  csvLink.click();
});

// Export as JSON
document.getElementById('exportJSON').addEventListener('click', () => {
  const rows = document.querySelectorAll('#linkTable tbody tr');
  const jsonData = [];

  rows.forEach(row => {
    const columns = row.querySelectorAll('td');
    const linkData = {
      url: columns[0].textContent,
      priority: columns[1].textContent,
      schedule: columns[2].textContent,
      date: columns[3].textContent,
      status: columns[4].textContent,
    };
    jsonData.push(linkData);
  });

  const jsonBlob = new Blob([JSON.stringify(jsonData, null, 2)], { type: 'application/json' });
  const jsonUrl = URL.createObjectURL(jsonBlob);
  const jsonLink = document.createElement('a');
  jsonLink.href = jsonUrl;
  jsonLink.download = 'links.json';
  jsonLink.click();
});










        </script>
             


        </div>

    <!-- Footer -->
    <footer id="dynamic-footer"></footer>
    
    <!-- Firebase configuration/ Login& Out -->
    <script type="module" src="https://reelcareer.co/public/js/main.js"></script> 

    <!-- Firebase JS SDK and Custom Scripts -->

    <script type="module">
        import {
            db, doc, getDoc, query, updateDoc,
            setDoc, ref, signInWithPopup, orderBy,
             
            uploadBytes, OAuthProvider, arrayUnion, getStorage,
            signOut, addDoc, increment, onAuthStateChanged,
            createUserWithEmailAndPassword, signInWithEmailAndPassword,
            where, getDocs, storage, collection, deleteObject, 
            auth, analytics, deleteDoc, getDownloadURL
        } from 'https://reelcareer.co/js/module.js';




        
    </script>
    
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>
</html>
