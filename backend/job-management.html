<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://reelcareer.co/backend/css/styles.css">
    <title>Job Management</title>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

    <style>
        /* Add any additional styles specific to this page here */
    </style>
<!-- Main Script Loader -->
    <script src="https://reelcareer.co/scripts/js/loader.js"></script>
</head>

<body>
    
    <script defer src="https://reelcareer.co/backend/js/admin.js"></script>

    <!-- Navbar section -->
    <nav id="Main_Nav" class="navbar navbar-expand-lg navbar-light bg-light" role="navigation"
        aria-label="Main Navigation">
        <a class="navbar-brand" href="https://reelcareer.co">ReelCareer.co</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
            aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">

                <!-- Dashboard and New Group -->
                <div class="navGroup" title="Dashboard and Analytics">
                    <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/notes">Notes</a></li>
                    <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/titles-fix">Title
                            Fix</a></li>
                </div>

                <!-- Dashboard and Analytics Group -->
                <div class="navGroup" title="Dashboard and Analytics">
                    <li class="nav-item"><a class="nav-link"
                            href="https://reelcareer.co/backend/dashboard">Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link"
                            href="https://reelcareer.co/backend/analytics">Analytics</a></li>
                    <li class="nav-item"><a class="nav-link"
                            href="https://reelcareer.co/backend/state-labour-market">State Labour Market</a></li>
                    <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/ping">Ping</a></li>
                    <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/page-editor">Page
                            Editor</a></li>
                    <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/notes">Notes</a></li>
                </div>
                <!-- Management Tools -->
                <div class="navGroup" title="Management Tools">
                    <li class="nav-item"><a class="nav-link"
                            href="https://reelcareer.co/backend/content-management">Content
                            <small>Management</small></a></li>
                    <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/user-management">User
                            <small>Management</small></a></li>
                    <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/job-management">Job
                            <small>Management</small></a></li>
                    <li class="nav-item"><a class="nav-link"
                            href="https://reelcareer.co/backend/application-management">Application
                            <small>Management</small></a></li>
                </div>
                <!-- General Settings and Utilities -->
                <div class="navGroup" title="General Settings and Utilities">
                    <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/contact">Contact</a>
                    </li>
                    <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/settings">Settings</a>
                    </li>
                    <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/support">Support</a>
                    </li>
                    <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/chatbot">Chatbot</a>
                    </li>
                    <li class="nav-item"><a class="nav-link"
                            href="https://reelcareer.co/backend/notifications-management">Notifications
                            <small>Management</small></a></li>
                    <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/system-logs">System
                            Logs</a></li>
                </div>
                <!-- Finance and Monetization -->
                <div class="navGroup" title="Finance and Monetization">
                    <li class="nav-item"><a class="nav-link"
                            href="https://reelcareer.co/backend/transactions">Transactions</a></li>
                    <li class="nav-item"><a class="nav-link"
                            href="https://reelcareer.co/backend/integration-management">Integration
                            <small>Management</small></a></li>
                    <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/payments">Payments</a>
                    </li>
                    <li class="nav-item"><a class="nav-link"
                            href="https://reelcareer.co/backend/monetization">Monetization</a></li>
                </div>
                <!-- SEO and Cleanup -->
                <div class="navGroup" title="SEO and Cleanup">
                    <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/delete-dup">Delete
                            Dup</a></li>
                    <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/seo-helper">SEO
                            Helper</a></li>
                </div>
                <!-- Role and Personality Management -->
                <div class="navGroup" title="Role and Personality Management">
                    <li class="nav-item"><a class="nav-link" href="https://reelcareer.co/backend/role-management">Role
                            <small>Management</small></a></li>
                    <li class="nav-item"><a class="nav-link"
                            href="https://reelcareer.co/backend/trait-personality-management">Trait Personality
                            <small>Management</small></a></li>
                </div>
            </ul>
        </div>
    </nav>



    <main id="main-content">

        <div class="container mt-4">
            <h1>Job Management</h1>

            <!-- Bulk Actions -->
            <div class="mb-3">
                <button class="btn btn-danger" onclick="deleteSelectedJobs()">Delete Selected Jobs</button>
            </div>

            <!-- Add Job Button -->
            <button class="btn btn-success mb-3" onclick="openJobModal()">Add Job</button>
            <button class="btn btn-success" onclick="fixStatesInJobs()">Fix State Abbreviations</button>

            <!-- Job Table -->
            <!-- Add a search bar and total count display -->
            <div>
                <input type="text" id="jobSearch" placeholder="Search jobs" onkeyup="searchJobs()">
                <span id="totalCount"></span>
                <span id="categoryFixCount"></span>
                <span id="stateFixCount"></span>
            </div>


            <table class="table table-bordered table-striped" id="jobTable">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="selectAll" onclick="toggleAll(this)"></th>
                        <th onclick="sortTable(1)">Title</th>
                        <th onclick="sortTable(2)">Created At</th>
                        <th onclick="sortTable(3)">State</th>
                        <th onclick="sortTable(4)">City</th>



                        <th onclick="sortTable(5)">Category</th>
                        <th onclick="sortTable(6)">Industry</th>

                        <th>Edit</th>
                        <th>Remove</th>
                    </tr>
                </thead>
                <tbody id="jobTableBody">
                    <!-- Job rows will be dynamically populated here -->
                </tbody>
            </table>



        </div>
    </main>

    <!-- Job Modal -->
    <div class="modal fade hide" id="jobModal" tabindex="-1" aria-labelledby="jobModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="jobModalLabel">Add/Edit Job</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="jobForm">
                        <div class="form-group">
                            <label for="jobTitle">Job Title</label>
                            <input type="text" class="form-control" id="jobTitle" required>
                        </div>
                        <div class="form-group">
                            <label for="jobDescription">Job Description</label>
                            <textarea class="form-control" id="jobDescription" rows="3" required></textarea>
                        </div>
                        <div class="form-group"> 
                            <label for="jobCategory">Category</label>
                            <select class="form-control" id="jobCategory" required>
                                <option value="" disabled selected>Select a category</option>
                                <option value="Accounting">Accounting</option>
                                <option value="Administration">Administration</option>
                                <option value="Advertising">Advertising</option>
                                <option value="Healthcare">Healthcare</option>
                                <option value="Engineering">Engineering</option>
                                <option value="Sales">Sales</option>
                                <option value="Human Resources">Human Resources</option>
                                <option value="Technology">Technology</option>
                                <option value="Education">Education</option>
                                <option value="Finance">Finance</option>
                                <option value="Legal">Legal</option>
                                <option value="Creative">Creative</option>
                                <option value="Customer Support">Customer Support</option>
                                <option value="Retail">Retail</option>
                                <option value="Logistics">Logistics</option>
                                <option value="Manufacturing">Manufacturing</option>
                                <option value="Construction">Construction</option>
                                <option value="Hospitality">Hospitality</option>
                                <option value="Real Estate">Real Estate</option>
                                <option value="Transportation">Transportation</option>
                                <option value="Art & Entertainment">Art & Entertainment</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="jobState">State</label>
                            <input type="text" class="form-control" id="jobState" required>
                        </div>
                        <div class="form-group">
                            <label for="jobCity">City</label>
                            <input type="text" class="form-control" id="jobCity" required>
                        </div>
                        <div class="form-group">
                            <label for="jobIndustry">Industry</label>
                            <select class="form-control" id="jobIndustry" required>
                                <option value="" disabled selected>Select an industry</option>
                                <option value="Healthcare">Healthcare</option>
                                <option value="Finance">Finance</option>
                                <option value="Technology">Technology</option>
                                <option value="Education">Education</option>
                                <option value="Construction">Construction</option>
                                <option value="Manufacturing">Manufacturing</option>
                                <option value="Retail">Retail</option>
                                <option value="Transportation">Transportation</option>
                                <option value="Hospitality">Hospitality</option>
                                <option value="Art & Entertainment">Art & Entertainment</option>
                                <option value="Human Resources">Human Resources</option>
                                <option value="Legal">Legal</option>
                                <option value="Sales">Sales</option>
                                <option value="Marketing">Marketing</option>
                                <option value="Engineering">Engineering</option>
                                <option value="Customer Support">Customer Support</option>
                                <option value="Logistics">Logistics</option>
                                <option value="Real Estate">Real Estate</option>
                                <option value="Agriculture">Agriculture</option>
                                <option value="Energy">Energy</option>
                                <option value="Telecommunications">Telecommunications</option>
                                <option value="Security">Security</option>
                                <option value="Environment">Environment</option>
                                <option value="Food & Beverage">Food & Beverage</option>
                                <option value="Government">Government</option>
                                <option value="Non-Profit">Non-Profit</option>
                                <option value="Sports & Fitness">Sports & Fitness</option>
                                <option value="Science & Research">Science & Research</option>
                            </select>
                        </div>

                        <input type="hidden" id="jobId">
                        <button type="submit" class="btn btn-primary">Save</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Category Management -->
    <h2 class="mt-5">Manage Job Categories</h2>
    <div class="mb-3">
        <input type="text" id="categoryInput" class="form-control" placeholder="Add New Category" required>
        <button class="btn btn-primary mt-2" onclick="addCategory()">Add Category</button>
    </div>

    <table class="table table-bordered table-striped" id="categoryTable">
        <thead>
            <tr>
                <th>Category</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="categoryTableBody">
            <!-- Category rows will be dynamically populated here -->
        </tbody>
    </table>



    <!-- Footer -->
    <footer id="dynamic-footer"></footer>

    <!-- Firebase configuration/ Login& Out -->
    

    <!-- Firebase JS SDK and Custom Scripts -->

    <script type="module">
        import {
            db, doc, getDoc, query, updateDoc,
            setDoc, ref, signInWithPopup, orderBy,
            writeBatch,
            uploadBytes, OAuthProvider, arrayUnion, getStorage,
            signOut, addDoc, increment, onAuthStateChanged,
            createUserWithEmailAndPassword, signInWithEmailAndPassword,
            where, getDocs, storage, collection, deleteObject,
            auth, analytics, deleteDoc, getDownloadURL
        } from 'https://reelcareer.co/scripts/js/load/module.js';






        // Load jobs function
        // Function to load jobs from Firestore and populate the table
        // Define the state abbreviation map
        const stateAbbreviations = {
            "AL": "Alabama", "AK": "Alaska", "AZ": "Arizona", "AR": "Arkansas",
            "CA": "California", "CO": "Colorado", "CT": "Connecticut", "DE": "Delaware",
            "FL": "Florida", "GA": "Georgia", "HI": "Hawaii", "ID": "Idaho", "IL": "Illinois",
            "IN": "Indiana", "IA": "Iowa", "KS": "Kansas", "KY": "Kentucky", "LA": "Louisiana",
            "ME": "Maine", "MD": "Maryland", "MA": "Massachusetts", "MI": "Michigan",
            "MN": "Minnesota", "MS": "Mississippi", "MO": "Missouri", "MT": "Montana",
            "NE": "Nebraska", "NV": "Nevada", "NH": "New Hampshire", "NJ": "New Jersey",
            "NM": "New Mexico", "NY": "New York", "NC": "North Carolina", "ND": "North Dakota",
            "OH": "Ohio", "OK": "Oklahoma", "OR": "Oregon", "PA": "Pennsylvania", "RI": "Rhode Island",
            "SC": "South Carolina", "SD": "South Dakota", "TN": "Tennessee", "TX": "Texas",
            "UT": "Utah", "VT": "Vermont", "VA": "Virginia", "WA": "Washington",
            "WV": "West Virginia", "WI": "Wisconsin", "WY": "Wyoming",

            // 3-letter abbreviations
            "ALA": "Alabama", "AKS": "Alaska", "ARS": "Arizona", "ARK": "Arkansas",
            "CAL": "California", "COL": "Colorado", "CON": "Connecticut", "DEL": "Delaware",
            "FLA": "Florida", "GEA": "Georgia", "HAW": "Hawaii", "IDA": "Idaho",
            "ILL": "Illinois", "IND": "Indiana", "IOW": "Iowa", "KAN": "Kansas",
            "KYT": "Kentucky", "LOU": "Louisiana", "MAI": "Maine", "MAR": "Maryland",
            "MAS": "Massachusetts", "MIC": "Michigan", "MIN": "Minnesota", "MIS": "Mississippi",
            "MIZ": "Missouri", "MON": "Montana", "NEB": "Nebraska", "NEV": "Nevada",
            "NEW": "New Hampshire", "NEJ": "New Jersey", "NMX": "New Mexico",
            "NYC": "New York", "NOR": "North Carolina", "NDA": "North Dakota",
            "OHI": "Ohio", "OKL": "Oklahoma", "ORE": "Oregon", "PEN": "Pennsylvania",
            "RHI": "Rhode Island", "SCA": "South Carolina", "SDA": "South Dakota",
            "TEN": "Tennessee", "TEX": "Texas", "UTA": "Utah", "VER": "Vermont",
            "VIR": "Virginia", "WAS": "Washington", "WVA": "West Virginia",
            "WIS": "Wisconsin", "WYO": "Wyoming",
        };
        let categoryFixCount = 0;
        let industryFixCount = 0;
        let stateFixCount = 0;

        const stateAbbreviationDocIds = [];
        const invalidStateDocIds = [];
        const categoryFixes = [];
        const industryFixes = [];

        // Define job industries with associated keywords
        const jobIndustries = {
            'Healthcare': ['health', 'medical', 'nurse', 'doctor', 'hospital', 'medicine', 'patient', 'clinic', 'therapist', 'pharmacy', 'caregiver'],
            'Finance': ['finance', 'bank', 'accounting', 'investment', 'tax', 'wealth', 'broker', 'credit', 'insurance', 'auditor', 'portfolio'],
            'Technology': ['tech', 'software', 'developer', 'it', 'web', 'engineering', 'systems', 'programmer', 'cybersecurity', 'network', 'ai', 'data'],
            'Education': ['education', 'teacher', 'school', 'tutor', 'trainer', 'curriculum', 'lecture', 'academic', 'principal', 'professor', 'student'],
            'Construction': ['construction', 'builder', 'contractor', 'site', 'civil', 'project', 'supervisor', 'architect', 'scaffolding', 'surveying'],
            'Manufacturing': ['manufacturing', 'factory', 'production', 'assembly', 'machinery', 'plant', 'operator', 'warehouse', 'fabrication', 'automation'],
            'Retail': ['retail', 'store', 'sales', 'merchandise', 'shop', 'cashier', 'inventory', 'associate', 'supermarket', 'checkout'],
            'Transportation': ['transport', 'driver', 'logistics', 'truck', 'vehicle', 'shipping', 'courier', 'delivery', 'freight', 'route', 'rail'],
            'Hospitality': ['hotel', 'restaurant', 'hospitality', 'chef', 'waiter', 'concierge', 'host', 'barista', 'catering', 'bartender', 'front desk'],
            'Art & Entertainment': ['entertainment', 'music', 'artist', 'performer', 'actor', 'media', 'production', 'theater', 'film', 'broadcast', 'director'],
            'Human Resources': ['hr', 'recruitment', 'talent', 'employee', 'benefits', 'payroll', 'onboarding', 'staffing', 'relations', 'diversity'],
            'Legal': ['legal', 'law', 'attorney', 'paralegal', 'contract', 'litigation', 'court', 'compliance', 'jurisdiction', 'lawsuit'],
            'Sales': ['sales', 'selling', 'quota', 'account manager', 'representative', 'lead generation', 'closing deals', 'prospecting', 'territory'],
            'Marketing': ['marketing', 'advertising', 'promotion', 'campaign', 'seo', 'brand', 'digital', 'content', 'copywriting', 'social media'],
            'Engineering': ['engineer', 'mechanical', 'civil', 'electrical', 'chemical', 'project', 'design', 'construction', 'structural', 'systems'],
            'Customer Support': ['support', 'customer service', 'helpdesk', 'call center', 'service', 'chat', 'technical support', 'resolution'],
            'Logistics': ['logistics', 'supply chain', 'inventory', 'warehouse', 'shipping', 'transport', 'distribution', 'order', 'storage'],
            'Real Estate': ['real estate', 'property', 'agent', 'broker', 'rental', 'mortgage', 'listing', 'sales', 'commercial', 'residential'],
            'Agriculture': ['agriculture', 'farming', 'livestock', 'crops', 'harvest', 'dairy', 'ranch', 'greenhouse', 'forestry', 'soil'],
            'Energy': ['energy', 'oil', 'gas', 'solar', 'wind', 'renewable', 'power', 'electricity', 'nuclear', 'hydro', 'fuel'],
            'Telecommunications': ['telecom', 'network', 'fiber', 'cellular', 'satellite', 'broadband', 'mobile', 'wireless', 'communication'],
            'Security': ['security', 'surveillance', 'cybersecurity', 'guard', 'protection', 'monitoring', 'safety', 'patrol', 'firewall'],
            'Environment': ['environment', 'sustainability', 'climate', 'ecology', 'conservation', 'waste', 'recycling', 'green', 'wildlife', 'pollution'],
            'Food & Beverage': ['food', 'restaurant', 'chef', 'barista', 'kitchen', 'cook', 'catering', 'beverage', 'server', 'bakery', 'culinary'],
            'Government': ['government', 'policy', 'public', 'municipal', 'council', 'regulation', 'administration', 'governance', 'federal', 'state'],
            'Non-Profit': ['non-profit', 'ngo', 'charity', 'volunteer', 'fundraising', 'donation', 'philanthropy', 'mission', 'community'],
            'Sports & Fitness': ['sports', 'fitness', 'coach', 'trainer', 'athlete', 'gym', 'workout', 'recreation', 'health', 'exercise'],
            'Science & Research': ['science', 'research', 'lab', 'biology', 'chemistry', 'physics', 'experiment', 'clinical', 'data', 'analysis']
        };


        // Function to assign an industry based on category or description
        function assignIndustry(category, description) {
            description = description.toLowerCase();
            category = category ? category.toLowerCase() : '';

            // Match category to industry first
            for (const [industry, keywords] of Object.entries(jobIndustries)) {
                if (keywords.some((keyword) => category.includes(keyword))) {
                    return industry;
                }
            }

            // If no industry found from category, match description
            for (const [industry, keywords] of Object.entries(jobIndustries)) {
                if (keywords.some((keyword) => description.includes(keyword))) {
                    return industry;
                }
            }

            return 'Other'; // Default industry if no match is found
        }

        // Load jobs from Firestore


async function loadJobs() {
    try {
        const q = query(collection(db, 'Jobs'), limit(50));
        const querySnapshot = await getDocs(q);

        const jobTableBody = document.getElementById('jobTableBody');
        jobTableBody.innerHTML = ''; // Clear existing rows

        let totalCount = 0;

        querySnapshot.forEach((doc) => {
            const job = doc.data();
            const truncatedDescription =
                job.description && job.description.length > 50
                    ? job.description.substring(0, 50) + '...'
                    : job.description || 'No Description';

            // Fix category if missing
            if (!job.category) {
                categoryFixCount++;
                const jobCategory = categorizeJob(job.title, job.description);
                categoryFixes.push({ docId: doc.id, jobCategory });
            }

            // Fix industry if missing
            if (!job.industry) {
                industryFixCount++;
                const jobIndustry = assignIndustry(job.category, job.description);
                industryFixes.push({ docId: doc.id, jobIndustry });
            }

            // Fix state abbreviations
            const stateAbbreviation = job.state ? job.state.toUpperCase() : 'N/A';
            let fullStateName = stateAbbreviations[stateAbbreviation];
            let rowClass = '';

            if (fullStateName) {
                rowClass = 'highlight-row'; // Highlight the row
                if (job.state !== fullStateName) {
                    job.state = fullStateName;
                    stateFixCount++;
                }
                stateAbbreviationDocIds.push({ docId: doc.id, fullStateName });
            } else if (!stateAbbreviations[stateAbbreviation]) {
                invalidStateDocIds.push(doc.id);
            }

            // Safe handling of createdAt timestamp
            const createdAt = job.createdAt
                ? job.createdAt.toDate().toLocaleString()
                : 'N/A';

            // Table row rendering
            const row = `
                <tr class="${rowClass}">
                    <td><input type="checkbox" class="jobCheckbox" value="${doc.id}"></td>
                    <td><a href="https://reelcareer.co/jobs/job-details/?id=${doc.id}">${job.title}</a></td>
                    <td>${createdAt}</td>
                    <td>${job.state || 'N/A'}</td>
                    <td>${job.city || 'N/A'}</td>
                    <td>${job.category || 'N/A'}</td>
                    <td>${job.industry || 'N/A'}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" 
                            data-id="${doc.id}" 
                            data-title="${job.title || ''}" 
                            data-description="${job.description || ''}" 
                            data-category="${job.category || ''}" 
                            data-state="${job.state || ''}" 
                            data-city="${job.city || ''}" 
                            data-industry="${job.industry || ''}"
                            onclick="editJob(this)">Edit</button>
                    </td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="deleteJob('${doc.id}')">Delete</button>
                    </td>
                </tr>
            `;

            jobTableBody.insertAdjacentHTML('beforeend', row);
            totalCount++;
        });

        // Update counts in the UI
        document.getElementById('totalCount').textContent = `Total Jobs: ${totalCount}`;
        document.getElementById('categoryFixCount').textContent = `Category Fix Count: ${categoryFixCount}`;
        document.getElementById('industryFixCount').textContent = `Industry Fix Count: ${industryFixCount}`;
        document.getElementById('stateFixCount').textContent = `State Fix Count: ${stateFixCount}`;

        // Perform batch updates
        await batchUpdateFixes();

    } catch (error) {
        console.error('Error loading jobs:', error);
    }
}

        // Batch update categories, industries, and states
        async function batchUpdateFixes() {
            try {
                const batch = writeBatch(db);

                // Update categories
                categoryFixes.forEach(({ docId, jobCategory }) => {
                    const jobRef = doc(db, 'Jobs', docId);
                    batch.update(jobRef, { category: jobCategory });
                    console.log(`Job ID: ${docId}, category updated to: ${jobCategory}`);
                });

                // Update industries
                industryFixes.forEach(({ docId, jobIndustry }) => {
                    const jobRef = doc(db, 'Jobs', docId);
                    batch.update(jobRef, { industry: jobIndustry });
                    console.log(`Job ID: ${docId}, industry updated to: ${jobIndustry}`);
                });

                // Update states
                stateAbbreviationDocIds.forEach(({ docId, fullStateName }) => {
                    const jobRef = doc(db, 'Jobs', docId);
                    batch.update(jobRef, { state: fullStateName });
                    console.log(`Job ID: ${docId}, state updated to: ${fullStateName}`);
                });

                await batch.commit();
                showToast('All categories, industries, and states have been fixed!');
            } catch (error) {
                console.error('Error updating fixes:', error);
            }
        }


        // Function to get the document IDs of jobs with invalid states
        function getJobsWithInvalidStates() {
            console.log('Jobs with invalid states:', invalidStateDocIds);
            showToast(`Found ${invalidStateDocIds.length} jobs with invalid states. Check the console for details.`);
        }

        // Example CSS for row highlighting
        const style = document.createElement('style');
        style.innerHTML = `
    .highlight-row {
        background-color: #f8d7da; /* Light red background for highlighting */
        font-weight: bold;
    }
`;
        document.head.appendChild(style);





        // Function to search jobs by title or description
        function searchJobs() {
            const query = document.getElementById('jobSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#jobTableBody tr:not(.collapse)');

            rows.forEach(row => {
                const title = row.cells[1]?.textContent.toLowerCase() || '';
                const city = row.cells[4]?.textContent.toLowerCase() || '';
                const state = row.cells[3]?.textContent.toLowerCase() || '';

                const match = title.includes(query) || city.includes(query) || state.includes(query);

                row.style.display = match ? '' : 'none';

                // Show/hide collapsible row
                const collapseId = row.getAttribute('data-bs-target');
                const collapseRow = document.querySelector(collapseId);
                if (collapseRow) collapseRow.style.display = match ? '' : 'none';
            });
        }


        // Function to sort table columns
        let sortOrder = true; // true for ascending, false for descending

        function sortTable(columnIndex) {
            const jobRows = Array.from(document.querySelectorAll('#jobTableBody tr'))
                .filter(row => !row.classList.contains('collapse')); // Exclude collapsible rows

            const sortedRows = jobRows.sort((a, b) => {
                const cellA = a.cells[columnIndex]?.textContent.trim().toLowerCase() || '';
                const cellB = b.cells[columnIndex]?.textContent.trim().toLowerCase() || '';

                if (cellA < cellB) return sortOrder ? -1 : 1;
                if (cellA > cellB) return sortOrder ? 1 : -1;
                return 0;
            });

            // Clear and re-render rows
            const jobTableBody = document.getElementById('jobTableBody');
            jobTableBody.innerHTML = '';
            sortedRows.forEach(row => {
                jobTableBody.appendChild(row);

                // Append related collapsible rows
                const collapseId = row.getAttribute('data-bs-target');
                const collapseRow = document.querySelector(collapseId);
                if (collapseRow) jobTableBody.appendChild(collapseRow);
            });

            sortOrder = !sortOrder; // Toggle sort order
        }





        function toggleAll(source) {
            const checkboxes = document.querySelectorAll('.jobCheckbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = source.checked;
            });
        }

        // Update "Select All" when individual checkboxes are clicked
        document.addEventListener('change', (e) => {
            if (e.target.classList.contains('jobCheckbox')) {
                const checkboxes = document.querySelectorAll('.jobCheckbox');
                const selectAllCheckbox = document.getElementById('selectAllCheckbox');
                selectAllCheckbox.checked = Array.from(checkboxes).every(checkbox => checkbox.checked);
            }
        });

        // Delete selected jobs

        // Function to delete selected jobs
        async function deleteSelectedJobs() {
            const selectedJobs = [...document.querySelectorAll('.jobCheckbox:checked')].map(checkbox => checkbox.value);

            if (selectedJobs.length > 0) {
                try {
                    const deletePromises = selectedJobs.map(id => deleteDoc(doc(db, 'Jobs', id)));
                    await Promise.all(deletePromises); // Wait for all deletions to finish
                    showToast("Selected jobs deleted successfully!");
                    loadJobs(); // Reload jobs after deletion
                } catch (error) {
                    console.error("Error removing jobs:", error);
                    alert("An error occurred while deleting jobs.");
                }
            } else {
                alert("Please select at least one job to delete.");
            }
        }


        // Open job modal for adding a job
        function openJobModal() {
            document.getElementById('jobForm').reset();
            document.getElementById('jobId').value = '';
            $('#jobModal').modal('show');
        }

        // Edit job
        function editJob(button) {
            console.log("Editing job...");
            // Access data attributes from the button
            const id = button.getAttribute('data-id');
            const title = button.getAttribute('data-title');
            const description = button.getAttribute('data-description');
            const category = button.getAttribute('data-category');
            const state = button.getAttribute('data-state');
            const city = button.getAttribute('data-city');
            const industry = button.getAttribute('data-industry');

            // Populate form fields
            document.getElementById('jobTitle').value = title;
            document.getElementById('jobDescription').value = description;
            document.getElementById('jobCategory').value = category;
            document.getElementById('jobState').value = state;
            document.getElementById('jobCity').value = city;
            document.getElementById('jobIndustry').value = industry;
            document.getElementById('jobId').value = id;

            // Show modal
            $('#jobModal').modal('show');
        }


        document.getElementById('jobForm').onsubmit = async function (e) {
            e.preventDefault();

            const title = document.getElementById('jobTitle').value;
            const description = document.getElementById('jobDescription').value;
            const category = document.getElementById('jobCategory').value;
            const state = document.getElementById('jobState').value;    // Get state value
            const city = document.getElementById('jobCity').value;      // Get city value
            const industry = document.getElementById('jobIndustry').value;  // Get industry value
            const id = document.getElementById('jobId').value;

            try {
                if (id) {
                    // Update existing job
                    await updateDoc(doc(db, 'Jobs', id), { title, description, category, state, city, industry });
                } else {
                    // Add new job
                    await addDoc(collection(db, 'Jobs'), { title, description, category, state, city, industry });
                }
                loadJobs();
                $('#jobModal').modal('hide');
            } catch (error) {
                console.error('Error saving job:', error);
            }
        };

        // Delete job
        async function deleteJob(id) {
            if (confirm("Are you sure you want to delete this job?")) {
                try {
                    await deleteDoc(doc(db, 'Jobs', id)); // Deleting the job document
                    loadJobs(); // Reload jobs after deletion
                } catch (error) {
                    console.error('Error deleting job:', error);
                }
            }
        }



        // Define job categories with associated keywords
        const jobCategories = {
            'Accounting': ['accounting', 'finance', 'bookkeeping', 'audit', 'tax', 'ledger'],
            'Administration': ['admin', 'administrative', 'office', 'secretary', 'assistant', 'clerical'],
            'Advertising': ['advertising', 'marketing', 'ad', 'campaign', 'promotion', 'media'],
            'Healthcare': ['healthcare', 'medical', 'doctor', 'nurse', 'hospital', 'patient care', 'medicine'],
            'Engineering': ['engineer', 'engineering', 'mechanical', 'civil', 'electrical', 'design', 'construction', 'project'],
            'Sales': ['sales', 'representative', 'business development', 'account manager', 'customer', 'salesperson', 'quota'],
            'Human Resources': ['HR', 'recruiter', 'talent', 'staffing', 'human resources', 'benefits', 'employee relations'],
            'Technology': ['developer', 'engineer', 'IT', 'software', 'programming', 'coder', 'technology', 'systems', 'web'],
            'Education': ['teacher', 'education', 'tutor', 'trainer', 'school', 'curriculum', 'lecture'],
            'Finance': ['investment', 'banking', 'financial', 'analyst', 'portfolio', 'broker', 'credit'],
            'Legal': ['law', 'attorney', 'lawyer', 'legal', 'litigation', 'contract', 'court'],
            'Creative': ['designer', 'graphic design', 'illustrator', 'creative', 'artist', 'visual'],
            'Customer Support': ['support', 'customer service', 'helpdesk', 'assistant', 'call center', 'service'],
            'Retail': ['retail', 'store', 'cashier', 'shop', 'sales associate', 'merchandise', 'customer'],
            'Logistics': ['logistics', 'supply chain', 'delivery', 'warehouse', 'shipping', 'inventory'],
            'Manufacturing': ['production', 'manufacturing', 'assembly', 'factory', 'machinist', 'materials'],
            'Construction': ['construction', 'builder', 'contractor', 'construction manager', 'site supervisor', 'engineering'],
            'Hospitality': ['hotel', 'restaurant', 'hospitality', 'waiter', 'chef', 'barista', 'concierge'],
            'Real Estate': ['real estate', 'agent', 'broker', 'property', 'sales', 'listing', 'agent'],
            'Transportation': ['driver', 'transportation', 'logistics', 'truck', 'vehicle', 'shipping', 'route'],
            'Art & Entertainment': ['artist', 'entertainment', 'music', 'performer', 'actor', 'production', 'media']
        };


        // Function to match job title/description to a category
        function categorizeJob(title, description) {
            title = title.toLowerCase();
            description = description.toLowerCase();

            // Loop through job categories
            for (const [category, keywords] of Object.entries(jobCategories)) {
                // Check if any keyword matches the title or description
                for (const keyword of keywords) {
                    if (title.includes(keyword) || description.includes(keyword)) {
                        return category; // Return the matched category
                    }
                }
            }
            return 'Other'; // Default category if no match found
        }



        // Add category
        async function addCategory() {
            const categoryInput = document.getElementById('categoryInput');
            const categoryName = categoryInput.value.trim();
            if (categoryName) {
                try {
                    await addDoc(collection(db, 'Categories'), { name: categoryName });
                    categoryInput.value = ''; // Clear input
                    loadCategories(); // Reload categories
                } catch (error) {
                    console.error('Error adding category:', error);
                }
            } else {
                alert("Please enter a category name.");
            }
        }

        // Delete category
        async function deleteCategory(id) {
            if (confirm("Are you sure you want to delete this category?")) {
                try {
                    await deleteDoc(doc(db, 'Categories', id)); // Deleting the category document
                    loadCategories(); // Reload categories
                } catch (error) {
                    console.error('Error deleting category:', error);
                }
            }
        }


        // Initialize the functions when the page loads
        document.addEventListener('DOMContentLoaded', () => {


            loadJobs();
            //loadCategories();

        });
        document.addEventListener('DOMContentLoaded', (event) => {
            window.editJob = editJob;
            window.openJobModal = openJobModal;
            window.deleteJob = deleteJob;
            window.categorizeJob = categorizeJob;
            window.deleteSelectedJobs = deleteSelectedJobs;
            window.searchJobs = searchJobs;
            window.sortTable = sortTable;

        });

    </script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>

</html>